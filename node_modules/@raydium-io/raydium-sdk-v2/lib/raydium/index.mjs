var gc=Object.defineProperty,Ac=Object.defineProperties;var wc=Object.getOwnPropertyDescriptors;var Wo=Object.getOwnPropertySymbols;var vs=Object.prototype.hasOwnProperty,Vs=Object.prototype.propertyIsEnumerable;var _s=(r,e,t)=>e in r?gc(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,R=(r,e)=>{for(var t in e||(e={}))vs.call(e,t)&&_s(r,t,e[t]);if(Wo)for(var t of Wo(e))Vs.call(e,t)&&_s(r,t,e[t]);return r},E=(r,e)=>Ac(r,wc(e));var Le=(r,e)=>{var t={};for(var n in r)vs.call(r,n)&&e.indexOf(n)<0&&(t[n]=r[n]);if(r!=null&&Wo)for(var n of Wo(r))e.indexOf(n)<0&&Vs.call(r,n)&&(t[n]=r[n]);return t};import{merge as bp}from"lodash";import Ba from"axios";import{PublicKey as Ds}from"@solana/web3.js";import{get as Fs,set as Pc}from"lodash";var Jr=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Es={},hc={};function ue(r){let e=Fs(Es,r);if(!e){let t=Fs(hc,r);e=new Jr({name:r,logLevel:t}),Pc(Es,r,e)}return e}import{MINT_SIZE as kc,TOKEN_PROGRAM_ID as Tc,getTransferFeeConfig as Ic,unpackMint as Bc}from"@solana/spl-token";var ei=ue("Raydium_accountInfo_util");async function ht(r,e,t){let{batchRequest:n,commitment:o="confirmed",chunkCount:i=100}=R({batchRequest:!1},t),s=ti(e,i),a=new Array(s.length).fill([]);if(n){let c=s.map(m=>{let d=r._buildArgs([m.map(p=>p.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:d}}),u=ti(c,10);a=(await(await Promise.all(u.map(async m=>await r._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&ei.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:y,lamports:f,owner:b,rentEpoch:g}=d;return p.length!==2&&p[1]!=="base64"&&ei.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:y,lamports:f,owner:new Ds(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>r.getMultipleAccountsInfo(c,o)))}catch(c){c instanceof Error&&ei.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function Me(r,e,t){let n=await ht(r,e.map(o=>o.pubkey),t);return e.map((o,i)=>E(R({},o),{accountInfo:n[i]}))}async function Bn({connection:r,mints:e,config:t}){var i,s,a;if(e.length===0)return{};let n=await Me(r,e.map(c=>({pubkey:lt(c)})),t),o={};for(let c of n){if(!c.accountInfo||c.accountInfo.data.length<kc){console.log("invalid mint account",c.pubkey.toBase58());continue}let u=Bc(c.pubkey,c.accountInfo,(i=c.accountInfo)==null?void 0:i.owner);o[c.pubkey.toString()]=E(R({},u),{programId:((s=c.accountInfo)==null?void 0:s.owner)||Tc,feeConfig:(a=Ic(u))!=null?a:void 0})}return o[Ds.default.toBase58()]=o[z.toBase58()],o}import Mt from"bn.js";var xn=9e15,$t=1e9,ni="0123456789abcdef",Uo="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Go="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",oi={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-xn,maxE:xn,crypto:!1},Gs,Nt,re=!0,zo="[DecimalError] ",Zt=zo+"Invalid argument: ",Xs=zo+"Precision limit exceeded",zs=zo+"crypto unavailable",Qs="[object Decimal]",Qe=Math.floor,_e=Math.pow,xc=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,Sc=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,Kc=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,Ys=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Tt=1e7,te=7,Cc=9007199254740991,Rc=Uo.length-1,ri=Go.length-1,V={toStringTag:Qs};V.absoluteValue=V.abs=function(){var r=new this.constructor(this);return r.s<0&&(r.s=1),Z(r)};V.ceil=function(){return Z(new this.constructor(this),this.e+1,2)};V.clampedTo=V.clamp=function(r,e){var t,n=this,o=n.constructor;if(r=new o(r),e=new o(e),!r.s||!e.s)return new o(NaN);if(r.gt(e))throw Error(Zt+e);return t=n.cmp(r),t<0?r:n.cmp(e)>0?e:new o(n)};V.comparedTo=V.cmp=function(r){var e,t,n,o,i=this,s=i.d,a=(r=new i.constructor(r)).d,c=i.s,u=r.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(i.e!==r.e)return i.e>r.e^c<0?1:-1;for(n=s.length,o=a.length,e=0,t=n<o?n:o;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===o?0:n>o^c<0?1:-1};V.cosine=V.cos=function(){var r,e,t=this,n=t.constructor;return t.d?t.d[0]?(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+te,n.rounding=1,t=Lc(n,Js(n,t)),n.precision=r,n.rounding=e,Z(Nt==2||Nt==3?t.neg():t,r,e,!0)):new n(1):new n(NaN)};V.cubeRoot=V.cbrt=function(){var r,e,t,n,o,i,s,a,c,u,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(re=!1,i=l.s*_e(l.s*l,1/3),!i||Math.abs(i)==1/0?(t=Ue(l.d),r=l.e,(i=(r-t.length+1)%3)&&(t+=i==1||i==-2?"0":"00"),i=_e(t,1/3),r=Qe((r+1)/3)-(r%3==(r<0?-1:2)),i==1/0?t="5e"+r:(t=i.toExponential(),t=t.slice(0,t.indexOf("e")+1)+r),n=new m(t),n.s=l.s):n=new m(i.toString()),s=(r=m.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=he(u.plus(l).times(a),u.plus(c),s+2,1),Ue(a.d).slice(0,s)===(t=Ue(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!o&&t=="4999"){if(!o&&(Z(a,r+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,o=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(Z(n,r+1,1),e=!n.times(n).times(n).eq(l));break}return re=!0,Z(n,r,m.rounding,e)};V.decimalPlaces=V.dp=function(){var r,e=this.d,t=NaN;if(e){if(r=e.length-1,t=(r-Qe(this.e/te))*te,r=e[r],r)for(;r%10==0;r/=10)t--;t<0&&(t=0)}return t};V.dividedBy=V.div=function(r){return he(this,new this.constructor(r))};V.dividedToIntegerBy=V.divToInt=function(r){var e=this,t=e.constructor;return Z(he(e,new t(r),0,1,1),t.precision,t.rounding)};V.equals=V.eq=function(r){return this.cmp(r)===0};V.floor=function(){return Z(new this.constructor(this),this.e+1,3)};V.greaterThan=V.gt=function(r){return this.cmp(r)>0};V.greaterThanOrEqualTo=V.gte=function(r){var e=this.cmp(r);return e==1||e===0};V.hyperbolicCosine=V.cosh=function(){var r,e,t,n,o,i=this,s=i.constructor,a=new s(1);if(!i.isFinite())return new s(i.s?1/0:NaN);if(i.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(i.e,i.sd())+4,s.rounding=1,o=i.d.length,o<32?(r=Math.ceil(o/3),e=(1/Yo(4,r)).toString()):(r=16,e="2.3283064365386962890625e-10"),i=Sn(s,1,i.times(e),new s(1),!0);for(var c,u=r,l=new s(8);u--;)c=i.times(i),i=a.minus(c.times(l.minus(c.times(l))));return Z(i,s.precision=t,s.rounding=n,!0)};V.hyperbolicSine=V.sinh=function(){var r,e,t,n,o=this,i=o.constructor;if(!o.isFinite()||o.isZero())return new i(o);if(e=i.precision,t=i.rounding,i.precision=e+Math.max(o.e,o.sd())+4,i.rounding=1,n=o.d.length,n<3)o=Sn(i,2,o,o,!0);else{r=1.4*Math.sqrt(n),r=r>16?16:r|0,o=o.times(1/Yo(5,r)),o=Sn(i,2,o,o,!0);for(var s,a=new i(5),c=new i(16),u=new i(20);r--;)s=o.times(o),o=o.times(a.plus(s.times(c.times(s).plus(u))))}return i.precision=e,i.rounding=t,Z(o,e,t,!0)};V.hyperbolicTangent=V.tanh=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+7,n.rounding=1,he(t.sinh(),t.cosh(),n.precision=r,n.rounding=e)):new n(t.s)};V.inverseCosine=V.acos=function(){var r,e=this,t=e.constructor,n=e.abs().cmp(1),o=t.precision,i=t.rounding;return n!==-1?n===0?e.isNeg()?kt(t,o,i):new t(0):new t(NaN):e.isZero()?kt(t,o+4,i).times(.5):(t.precision=o+6,t.rounding=1,e=e.asin(),r=kt(t,o+4,i).times(.5),t.precision=o,t.rounding=i,r.minus(e))};V.inverseHyperbolicCosine=V.acosh=function(){var r,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(r=n.precision,e=n.rounding,n.precision=r+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,re=!1,t=t.times(t).minus(1).sqrt().plus(t),re=!0,n.precision=r,n.rounding=e,t.ln()):new n(t)};V.inverseHyperbolicSine=V.asinh=function(){var r,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,re=!1,t=t.times(t).plus(1).sqrt().plus(t),re=!0,n.precision=r,n.rounding=e,t.ln())};V.inverseHyperbolicTangent=V.atanh=function(){var r,e,t,n,o=this,i=o.constructor;return o.isFinite()?o.e>=0?new i(o.abs().eq(1)?o.s/0:o.isZero()?o:NaN):(r=i.precision,e=i.rounding,n=o.sd(),Math.max(n,r)<2*-o.e-1?Z(new i(o),r,e,!0):(i.precision=t=n-o.e,o=he(o.plus(1),new i(1).minus(o),t+r,1),i.precision=r+4,i.rounding=1,o=o.ln(),i.precision=r,i.rounding=e,o.times(.5))):new i(NaN)};V.inverseSine=V.asin=function(){var r,e,t,n,o=this,i=o.constructor;return o.isZero()?new i(o):(e=o.abs().cmp(1),t=i.precision,n=i.rounding,e!==-1?e===0?(r=kt(i,t+4,n).times(.5),r.s=o.s,r):new i(NaN):(i.precision=t+6,i.rounding=1,o=o.div(new i(1).minus(o.times(o)).sqrt().plus(1)).atan(),i.precision=t,i.rounding=n,o.times(2)))};V.inverseTangent=V.atan=function(){var r,e,t,n,o,i,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&m+4<=ri)return s=kt(l,m+4,d).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(m+4<=ri)return s=kt(l,m+4,d).times(.5),s.s=u.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/te+2|0),r=t;r;--r)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(re=!1,e=Math.ceil(a/te),n=1,c=u.times(u),s=new l(u),o=u;r!==-1;)if(o=o.times(c),i=s.minus(o.div(n+=2)),o=o.times(c),s=i.plus(o.div(n+=2)),s.d[e]!==void 0)for(r=e;s.d[r]===i.d[r]&&r--;);return t&&(s=s.times(2<<t-1)),re=!0,Z(s,l.precision=m,l.rounding=d,!0)};V.isFinite=function(){return!!this.d};V.isInteger=V.isInt=function(){return!!this.d&&Qe(this.e/te)>this.d.length-2};V.isNaN=function(){return!this.s};V.isNegative=V.isNeg=function(){return this.s<0};V.isPositive=V.isPos=function(){return this.s>0};V.isZero=function(){return!!this.d&&this.d[0]===0};V.lessThan=V.lt=function(r){return this.cmp(r)<0};V.lessThanOrEqualTo=V.lte=function(r){return this.cmp(r)<1};V.logarithm=V.log=function(r){var e,t,n,o,i,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding,p=5;if(r==null)r=new l(10),e=!0;else{if(r=new l(r),t=r.d,r.s<0||!t||!t[0]||r.eq(1))return new l(NaN);e=r.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)i=!0;else{for(o=t[0];o%10===0;)o/=10;i=o!==1}if(re=!1,a=m+p,s=Ht(u,a),n=e?Xo(l,a+10):Ht(r,a),c=he(s,n,a,1),Gn(c.d,o=m,d))do if(a+=10,s=Ht(u,a),n=e?Xo(l,a+10):Ht(r,a),c=he(s,n,a,1),!i){+Ue(c.d).slice(o+1,o+15)+1==1e14&&(c=Z(c,m+1,0));break}while(Gn(c.d,o+=10,d));return re=!0,Z(c,m,d)};V.minus=V.sub=function(r){var e,t,n,o,i,s,a,c,u,l,m,d,p=this,y=p.constructor;if(r=new y(r),!p.d||!r.d)return!p.s||!r.s?r=new y(NaN):p.d?r.s=-r.s:r=new y(r.d||p.s!==r.s?p:NaN),r;if(p.s!=r.s)return r.s=-r.s,p.plus(r);if(u=p.d,d=r.d,a=y.precision,c=y.rounding,!u[0]||!d[0]){if(d[0])r.s=-r.s;else if(u[0])r=new y(p);else return new y(c===3?-0:0);return re?Z(r,a,c):r}if(t=Qe(r.e/te),l=Qe(p.e/te),u=u.slice(),i=l-t,i){for(m=i<0,m?(e=u,i=-i,s=d.length):(e=d,t=l,s=u.length),n=Math.max(Math.ceil(a/te),s)+2,i>n&&(i=n,e.length=1),e.reverse(),n=i;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(u[n]!=d[n]){m=u[n]<d[n];break}i=0}for(m&&(e=u,u=d,d=e,r.s=-r.s),s=u.length,n=d.length-s;n>0;--n)u[s++]=0;for(n=d.length;n>i;){if(u[--n]<d[n]){for(o=n;o&&u[--o]===0;)u[o]=Tt-1;--u[o],u[n]+=Tt}u[n]-=d[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(r.d=u,r.e=Qo(u,t),re?Z(r,a,c):r):new y(c===3?-0:0)};V.modulo=V.mod=function(r){var e,t=this,n=t.constructor;return r=new n(r),!t.d||!r.s||r.d&&!r.d[0]?new n(NaN):!r.d||t.d&&!t.d[0]?Z(new n(t),n.precision,n.rounding):(re=!1,n.modulo==9?(e=he(t,r.abs(),0,3,1),e.s*=r.s):e=he(t,r,0,n.modulo,1),e=e.times(r),re=!0,t.minus(e))};V.naturalExponential=V.exp=function(){return ii(this)};V.naturalLogarithm=V.ln=function(){return Ht(this)};V.negated=V.neg=function(){var r=new this.constructor(this);return r.s=-r.s,Z(r)};V.plus=V.add=function(r){var e,t,n,o,i,s,a,c,u,l,m=this,d=m.constructor;if(r=new d(r),!m.d||!r.d)return!m.s||!r.s?r=new d(NaN):m.d||(r=new d(r.d||m.s===r.s?m:NaN)),r;if(m.s!=r.s)return r.s=-r.s,m.minus(r);if(u=m.d,l=r.d,a=d.precision,c=d.rounding,!u[0]||!l[0])return l[0]||(r=new d(m)),re?Z(r,a,c):r;if(i=Qe(m.e/te),n=Qe(r.e/te),u=u.slice(),o=i-n,o){for(o<0?(t=u,o=-o,s=l.length):(t=l,n=i,s=u.length),i=Math.ceil(a/te),s=i>s?i+1:s+1,o>s&&(o=s,t.length=1),t.reverse();o--;)t.push(0);t.reverse()}for(s=u.length,o=l.length,s-o<0&&(o=s,t=l,l=u,u=t),e=0;o;)e=(u[--o]=u[o]+l[o]+e)/Tt|0,u[o]%=Tt;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return r.d=u,r.e=Qo(u,n),re?Z(r,a,c):r};V.precision=V.sd=function(r){var e,t=this;if(r!==void 0&&r!==!!r&&r!==1&&r!==0)throw Error(Zt+r);return t.d?(e=js(t.d),r&&t.e+1>e&&(e=t.e+1)):e=NaN,e};V.round=function(){var r=this,e=r.constructor;return Z(new e(r),r.e+1,e.rounding)};V.sine=V.sin=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+te,n.rounding=1,t=Nc(n,Js(n,t)),n.precision=r,n.rounding=e,Z(Nt>2?t.neg():t,r,e,!0)):new n(NaN)};V.squareRoot=V.sqrt=function(){var r,e,t,n,o,i,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(re=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=Ue(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=Qe((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(i=n,n=i.plus(he(s,i,t+2,1)).times(.5),Ue(i.d).slice(0,t)===(e=Ue(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!o&&e=="4999"){if(!o&&(Z(i,c+1,0),i.times(i).eq(s))){n=i;break}t+=4,o=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(Z(n,c+1,1),r=!n.times(n).eq(s));break}return re=!0,Z(n,c,l.rounding,r)};V.tangent=V.tan=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+10,n.rounding=1,t=t.sin(),t.s=1,t=he(t,new n(1).minus(t.times(t)).sqrt(),r+10,0),n.precision=r,n.rounding=e,Z(Nt==2||Nt==4?t.neg():t,r,e,!0)):new n(NaN)};V.times=V.mul=function(r){var e,t,n,o,i,s,a,c,u,l=this,m=l.constructor,d=l.d,p=(r=new m(r)).d;if(r.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!r.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?r.s/0:r.s*0);for(t=Qe(l.e/te)+Qe(r.e/te),c=d.length,u=p.length,c<u&&(i=d,d=p,p=i,s=c,c=u,u=s),i=[],s=c+u,n=s;n--;)i.push(0);for(n=u;--n>=0;){for(e=0,o=c+n;o>n;)a=i[o]+p[n]*d[o-n-1]+e,i[o--]=a%Tt|0,e=a/Tt|0;i[o]=(i[o]+e)%Tt|0}for(;!i[--s];)i.pop();return e?++t:i.shift(),r.d=i,r.e=Qo(i,t),re?Z(r,m.precision,m.rounding):r};V.toBinary=function(r,e){return ai(this,2,r,e)};V.toDecimalPlaces=V.toDP=function(r,e){var t=this,n=t.constructor;return t=new n(t),r===void 0?t:(nt(r,0,$t),e===void 0?e=n.rounding:nt(e,0,8),Z(t,r+t.e+1,e))};V.toExponential=function(r,e){var t,n=this,o=n.constructor;return r===void 0?t=Rt(n,!0):(nt(r,0,$t),e===void 0?e=o.rounding:nt(e,0,8),n=Z(new o(n),r+1,e),t=Rt(n,!0,r+1)),n.isNeg()&&!n.isZero()?"-"+t:t};V.toFixed=function(r,e){var t,n,o=this,i=o.constructor;return r===void 0?t=Rt(o):(nt(r,0,$t),e===void 0?e=i.rounding:nt(e,0,8),n=Z(new i(o),r+o.e+1,e),t=Rt(n,!1,r+n.e+1)),o.isNeg()&&!o.isZero()?"-"+t:t};V.toFraction=function(r){var e,t,n,o,i,s,a,c,u,l,m,d,p=this,y=p.d,f=p.constructor;if(!y)return new f(p);if(u=t=new f(1),n=c=new f(0),e=new f(n),i=e.e=js(y)-p.e-1,s=i%te,e.d[0]=_e(10,s<0?te+s:s),r==null)r=i>0?e:u;else{if(a=new f(r),!a.isInt()||a.lt(u))throw Error(Zt+a);r=a.gt(e)?i>0?e:u:a}for(re=!1,a=new f(Ue(y)),l=f.precision,f.precision=i=y.length*te*2;m=he(a,e,0,1,1),o=t.plus(m.times(n)),o.cmp(r)!=1;)t=n,n=o,o=u,u=c.plus(m.times(o)),c=o,o=e,e=a.minus(m.times(o)),a=o;return o=he(r.minus(t),n,0,1,1),c=c.plus(o.times(u)),t=t.plus(o.times(n)),c.s=u.s=p.s,d=he(u,n,i,1).minus(p).abs().cmp(he(c,t,i,1).minus(p).abs())<1?[u,n]:[c,t],f.precision=l,re=!0,d};V.toHexadecimal=V.toHex=function(r,e){return ai(this,16,r,e)};V.toNearest=function(r,e){var t=this,n=t.constructor;if(t=new n(t),r==null){if(!t.d)return t;r=new n(1),e=n.rounding}else{if(r=new n(r),e===void 0?e=n.rounding:nt(e,0,8),!t.d)return r.s?t:r;if(!r.d)return r.s&&(r.s=t.s),r}return r.d[0]?(re=!1,t=he(t,r,0,e,1).times(r),re=!0,Z(t)):(r.s=t.s,t=r),t};V.toNumber=function(){return+this};V.toOctal=function(r,e){return ai(this,8,r,e)};V.toPower=V.pow=function(r){var e,t,n,o,i,s,a=this,c=a.constructor,u=+(r=new c(r));if(!a.d||!r.d||!a.d[0]||!r.d[0])return new c(_e(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,i=c.rounding,r.eq(1))return Z(a,n,i);if(e=Qe(r.e/te),e>=r.d.length-1&&(t=u<0?-u:u)<=Cc)return o=Hs(c,a,t,n),r.s<0?new c(1).div(o):Z(o,n,i);if(s=a.s,s<0){if(e<r.d.length-1)return new c(NaN);if((r.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=_e(+a,u),e=t==0||!isFinite(t)?Qe(u*(Math.log("0."+Ue(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(re=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),o=ii(r.times(Ht(a,n+t)),n),o.d&&(o=Z(o,n+5,1),Gn(o.d,n,i)&&(e=n+10,o=Z(ii(r.times(Ht(a,e+t)),e),e+5,1),+Ue(o.d).slice(n+1,n+15)+1==1e14&&(o=Z(o,n+1,0)))),o.s=s,re=!0,c.rounding=i,Z(o,n,i))};V.toPrecision=function(r,e){var t,n=this,o=n.constructor;return r===void 0?t=Rt(n,n.e<=o.toExpNeg||n.e>=o.toExpPos):(nt(r,1,$t),e===void 0?e=o.rounding:nt(e,0,8),n=Z(new o(n),r,e),t=Rt(n,r<=n.e||n.e<=o.toExpNeg,r)),n.isNeg()&&!n.isZero()?"-"+t:t};V.toSignificantDigits=V.toSD=function(r,e){var t=this,n=t.constructor;return r===void 0?(r=n.precision,e=n.rounding):(nt(r,1,$t),e===void 0?e=n.rounding:nt(e,0,8)),Z(new n(t),r,e)};V.toString=function(){var r=this,e=r.constructor,t=Rt(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()&&!r.isZero()?"-"+t:t};V.truncated=V.trunc=function(){return Z(new this.constructor(this),this.e+1,1)};V.valueOf=V.toJSON=function(){var r=this,e=r.constructor,t=Rt(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()?"-"+t:t};function Ue(r){var e,t,n,o=r.length-1,i="",s=r[0];if(o>0){for(i+=s,e=1;e<o;e++)n=r[e]+"",t=te-n.length,t&&(i+=jt(t)),i+=n;s=r[e],n=s+"",t=te-n.length,t&&(i+=jt(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return i+s}function nt(r,e,t){if(r!==~~r||r<e||r>t)throw Error(Zt+r)}function Gn(r,e,t,n){var o,i,s,a;for(i=r[0];i>=10;i/=10)--e;return--e<0?(e+=te,o=0):(o=Math.ceil((e+1)/te),e%=te),i=_e(10,te-e),a=r[o]%i|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==i||t>3&&a+1==i/2)&&(r[o+1]/i/100|0)==_e(10,e-2)-1||(a==i/2||a==0)&&(r[o+1]/i/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==i||!n&&t>3&&a+1==i/2)&&(r[o+1]/i/1e3|0)==_e(10,e-3)-1,s}function qo(r,e,t){for(var n,o=[0],i,s=0,a=r.length;s<a;){for(i=o.length;i--;)o[i]*=e;for(o[0]+=ni.indexOf(r.charAt(s++)),n=0;n<o.length;n++)o[n]>t-1&&(o[n+1]===void 0&&(o[n+1]=0),o[n+1]+=o[n]/t|0,o[n]%=t)}return o.reverse()}function Lc(r,e){var t,n,o;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),o=(1/Yo(4,t)).toString()):(t=16,o="2.3283064365386962890625e-10"),r.precision+=t,e=Sn(r,1,e.times(o),new r(1));for(var i=t;i--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return r.precision-=t,e}var he=function(){function r(n,o,i){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*o+a,n[c]=s%i|0,a=s/i|0;return a&&n.unshift(a),n}function e(n,o,i,s){var a,c;if(i!=s)c=i>s?1:-1;else for(a=c=0;a<i;a++)if(n[a]!=o[a]){c=n[a]>o[a]?1:-1;break}return c}function t(n,o,i,s){for(var a=0;i--;)n[i]-=a,a=n[i]<o[i]?1:0,n[i]=a*s+n[i]-o[i];for(;!n[0]&&n.length>1;)n.shift()}return function(n,o,i,s,a,c){var u,l,m,d,p,y,f,b,g,A,w,k,I,T,S,B,C,x,L,W,_=n.constructor,$=n.s==o.s?1:-1,G=n.d,q=o.d;if(!G||!G[0]||!q||!q[0])return new _(!n.s||!o.s||(G?q&&G[0]==q[0]:!q)?NaN:G&&G[0]==0||!q?$*0:$/0);for(c?(p=1,l=n.e-o.e):(c=Tt,p=te,l=Qe(n.e/p)-Qe(o.e/p)),L=q.length,C=G.length,g=new _($),A=g.d=[],m=0;q[m]==(G[m]||0);m++);if(q[m]>(G[m]||0)&&l--,i==null?(T=i=_.precision,s=_.rounding):a?T=i+(n.e-o.e)+1:T=i,T<0)A.push(1),y=!0;else{if(T=T/p+2|0,m=0,L==1){for(d=0,q=q[0],T++;(m<C||d)&&T--;m++)S=d*c+(G[m]||0),A[m]=S/q|0,d=S%q|0;y=d||m<C}else{for(d=c/(q[0]+1)|0,d>1&&(q=r(q,d,c),G=r(G,d,c),L=q.length,C=G.length),B=L,w=G.slice(0,L),k=w.length;k<L;)w[k++]=0;W=q.slice(),W.unshift(0),x=q[0],q[1]>=c/2&&++x;do d=0,u=e(q,w,L,k),u<0?(I=w[0],L!=k&&(I=I*c+(w[1]||0)),d=I/x|0,d>1?(d>=c&&(d=c-1),f=r(q,d,c),b=f.length,k=w.length,u=e(f,w,b,k),u==1&&(d--,t(f,L<b?W:q,b,c))):(d==0&&(u=d=1),f=q.slice()),b=f.length,b<k&&f.unshift(0),t(w,f,k,c),u==-1&&(k=w.length,u=e(q,w,L,k),u<1&&(d++,t(w,L<k?W:q,k,c))),k=w.length):u===0&&(d++,w=[0]),A[m++]=d,u&&w[0]?w[k++]=G[B]||0:(w=[G[B]],k=1);while((B++<C||w[0]!==void 0)&&T--);y=w[0]!==void 0}A[0]||A.shift()}if(p==1)g.e=l,Gs=y;else{for(m=1,d=A[0];d>=10;d/=10)m++;g.e=m+l*p-1,Z(g,a?i+g.e+1:i,s,y)}return g}}();function Z(r,e,t,n){var o,i,s,a,c,u,l,m,d,p=r.constructor;e:if(e!=null){if(m=r.d,!m)return r;for(o=1,a=m[0];a>=10;a/=10)o++;if(i=e-o,i<0)i+=te,s=e,l=m[d=0],c=l/_e(10,o-s-1)%10|0;else if(d=Math.ceil((i+1)/te),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=c=0,o=1,i%=te,s=i-te+1}else break e;else{for(l=a=m[d],o=1;a>=10;a/=10)o++;i%=te,s=i-te+o,c=s<0?0:l/_e(10,o-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%_e(10,o-s-1)),u=t<4?(c||n)&&(t==0||t==(r.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(i>0?s>0?l/_e(10,o-s):0:m[d-1])%10&1||t==(r.s<0?8:7)),e<1||!m[0])return m.length=0,u?(e-=r.e+1,m[0]=_e(10,(te-e%te)%te),r.e=-e||0):m[0]=r.e=0,r;if(i==0?(m.length=d,a=1,d--):(m.length=d+1,a=_e(10,te-i),m[d]=s>0?(l/_e(10,o-s)%_e(10,s)|0)*a:0),u)for(;;)if(d==0){for(i=1,s=m[0];s>=10;s/=10)i++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;i!=a&&(r.e++,m[0]==Tt&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=Tt)break;m[d--]=0,a=1}for(i=m.length;m[--i]===0;)m.pop()}return re&&(r.e>p.maxE?(r.d=null,r.e=NaN):r.e<p.minE&&(r.e=0,r.d=[0])),r}function Rt(r,e,t){if(!r.isFinite())return $s(r);var n,o=r.e,i=Ue(r.d),s=i.length;return e?(t&&(n=t-s)>0?i=i.charAt(0)+"."+i.slice(1)+jt(n):s>1&&(i=i.charAt(0)+"."+i.slice(1)),i=i+(r.e<0?"e":"e+")+r.e):o<0?(i="0."+jt(-o-1)+i,t&&(n=t-s)>0&&(i+=jt(n))):o>=s?(i+=jt(o+1-s),t&&(n=t-o-1)>0&&(i=i+"."+jt(n))):((n=o+1)<s&&(i=i.slice(0,n)+"."+i.slice(n)),t&&(n=t-s)>0&&(o+1===s&&(i+="."),i+=jt(n))),i}function Qo(r,e){var t=r[0];for(e*=te;t>=10;t/=10)e++;return e}function Xo(r,e,t){if(e>Rc)throw re=!0,t&&(r.precision=t),Error(Xs);return Z(new r(Uo),e,1,!0)}function kt(r,e,t){if(e>ri)throw Error(Xs);return Z(new r(Go),e,t,!0)}function js(r){var e=r.length-1,t=e*te+1;if(e=r[e],e){for(;e%10==0;e/=10)t--;for(e=r[0];e>=10;e/=10)t++}return t}function jt(r){for(var e="";r--;)e+="0";return e}function Hs(r,e,t,n){var o,i=new r(1),s=Math.ceil(n/te+4);for(re=!1;;){if(t%2&&(i=i.times(e),qs(i.d,s)&&(o=!0)),t=Qe(t/2),t===0){t=i.d.length-1,o&&i.d[t]===0&&++i.d[t];break}e=e.times(e),qs(e.d,s)}return re=!0,i}function Ws(r){return r.d[r.d.length-1]&1}function Zs(r,e,t){for(var n,o=new r(e[0]),i=0;++i<e.length;)if(n=new r(e[i]),n.s)o[t](n)&&(o=n);else{o=n;break}return o}function ii(r,e){var t,n,o,i,s,a,c,u=0,l=0,m=0,d=r.constructor,p=d.rounding,y=d.precision;if(!r.d||!r.d[0]||r.e>17)return new d(r.d?r.d[0]?r.s<0?0:1/0:1:r.s?r.s<0?0:r:0/0);for(e==null?(re=!1,c=y):c=e,a=new d(.03125);r.e>-2;)r=r.times(a),m+=5;for(n=Math.log(_e(2,m))/Math.LN10*2+5|0,c+=n,t=i=s=new d(1),d.precision=c;;){if(i=Z(i.times(r),c,1),t=t.times(++l),a=s.plus(he(i,t,c,1)),Ue(a.d).slice(0,c)===Ue(s.d).slice(0,c)){for(o=m;o--;)s=Z(s.times(s),c,1);if(e==null)if(u<3&&Gn(s.d,c-n,p,u))d.precision=c+=10,t=i=a=new d(1),l=0,u++;else return Z(s,d.precision=y,p,re=!0);else return d.precision=y,s}s=a}}function Ht(r,e){var t,n,o,i,s,a,c,u,l,m,d,p=1,y=10,f=r,b=f.d,g=f.constructor,A=g.rounding,w=g.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(re=!1,l=w):l=e,g.precision=l+=y,t=Ue(b),n=t.charAt(0),Math.abs(i=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(r),t=Ue(f.d),n=t.charAt(0),p++;i=f.e,n>1?(f=new g("0."+t),i++):f=new g(n+"."+t.slice(1))}else return u=Xo(g,l+2,w).times(i+""),f=Ht(new g(n+"."+t.slice(1)),l-y).plus(u),g.precision=w,e==null?Z(f,w,A,re=!0):f;for(m=f,c=s=f=he(f.minus(1),f.plus(1),l,1),d=Z(f.times(f),l,1),o=3;;){if(s=Z(s.times(d),l,1),u=c.plus(he(s,new g(o),l,1)),Ue(u.d).slice(0,l)===Ue(c.d).slice(0,l))if(c=c.times(2),i!==0&&(c=c.plus(Xo(g,l+2,w).times(i+""))),c=he(c,new g(p),l,1),e==null)if(Gn(c.d,l-y,A,a))g.precision=l+=y,u=s=f=he(m.minus(1),m.plus(1),l,1),d=Z(f.times(f),l,1),o=a=1;else return Z(c,g.precision=w,A,re=!0);else return g.precision=w,c;c=u,o+=2}}function $s(r){return String(r.s*r.s/0)}function si(r,e){var t,n,o;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(o=e.length;e.charCodeAt(o-1)===48;--o);if(e=e.slice(n,o),e){if(o-=n,r.e=t=t-n-1,r.d=[],n=(t+1)%te,t<0&&(n+=te),n<o){for(n&&r.d.push(+e.slice(0,n)),o-=te;n<o;)r.d.push(+e.slice(n,n+=te));e=e.slice(n),n=te-e.length}else n-=o;for(;n--;)e+="0";r.d.push(+e),re&&(r.e>r.constructor.maxE?(r.d=null,r.e=NaN):r.e<r.constructor.minE&&(r.e=0,r.d=[0]))}else r.e=0,r.d=[0];return r}function Oc(r,e){var t,n,o,i,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),Ys.test(e))return si(r,e)}else if(e==="Infinity"||e==="NaN")return+e||(r.s=NaN),r.e=NaN,r.d=null,r;if(Sc.test(e))t=16,e=e.toLowerCase();else if(xc.test(e))t=2;else if(Kc.test(e))t=8;else throw Error(Zt+e);for(i=e.search(/p/i),i>0?(c=+e.slice(i+1),e=e.substring(2,i)):e=e.slice(2),i=e.indexOf("."),s=i>=0,n=r.constructor,s&&(e=e.replace(".",""),a=e.length,i=a-i,o=Hs(n,new n(t),i,i*2)),u=qo(e,t,Tt),l=u.length-1,i=l;u[i]===0;--i)u.pop();return i<0?new n(r.s*0):(r.e=Qo(u,l),r.d=u,re=!1,s&&(r=he(r,o,a*4)),c&&(r=r.times(Math.abs(c)<54?_e(2,c):Xn.pow(2,c))),re=!0,r)}function Nc(r,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:Sn(r,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/Yo(5,t)),e=Sn(r,2,e,e);for(var o,i=new r(5),s=new r(16),a=new r(20);t--;)o=e.times(e),e=e.times(i.plus(o.times(s.times(o).minus(a))));return e}function Sn(r,e,t,n,o){var i,s,a,c,u=1,l=r.precision,m=Math.ceil(l/te);for(re=!1,c=t.times(t),a=new r(n);;){if(s=he(a.times(c),new r(e++*e++),l,1),a=o?n.plus(s):n.minus(s),n=he(s.times(c),new r(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(i=m;s.d[i]===a.d[i]&&i--;);if(i==-1)break}i=a,a=n,n=s,s=i,u++}return re=!0,s.d.length=m+1,s}function Yo(r,e){for(var t=r;--e;)t*=r;return t}function Js(r,e){var t,n=e.s<0,o=kt(r,r.precision,1),i=o.times(.5);if(e=e.abs(),e.lte(i))return Nt=n?4:1,e;if(t=e.divToInt(o),t.isZero())Nt=n?3:2;else{if(e=e.minus(t.times(o)),e.lte(i))return Nt=Ws(t)?n?2:3:n?4:1,e;Nt=Ws(t)?n?1:4:n?3:2}return e.minus(o).abs()}function ai(r,e,t,n){var o,i,s,a,c,u,l,m,d,p=r.constructor,y=t!==void 0;if(y?(nt(t,1,$t),n===void 0?n=p.rounding:nt(n,0,8)):(t=p.precision,n=p.rounding),!r.isFinite())l=$s(r);else{for(l=Rt(r),s=l.indexOf("."),y?(o=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):o=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=qo(Rt(d),10,o),d.e=d.d.length),m=qo(l,10,o),i=c=m.length;m[--c]==0;)m.pop();if(!m[0])l=y?"0p+0":"0";else{if(s<0?i--:(r=new p(r),r.d=m,r.e=i,r=he(r,d,t,n,0,o),m=r.d,i=r.e,u=Gs),s=m[t],a=o/2,u=u||m[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(r.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&m[t-1]&1||n===(r.s<0?8:7)),m.length=t,u)for(;++m[--t]>o-1;)m[t]=0,t||(++i,m.unshift(1));for(c=m.length;!m[c-1];--c);for(s=0,l="";s<c;s++)l+=ni.charAt(m[s]);if(y){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(m=qo(l,o,e),c=m.length;!m[c-1];--c);for(s=1,l="1.";s<c;s++)l+=ni.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(i<0?"p":"p+")+i}else if(i<0){for(;++i;)l="0"+l;l="0."+l}else if(++i>c)for(i-=c;i--;)l+="0";else i<c&&(l=l.slice(0,i)+"."+l.slice(i))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return r.s<0?"-"+l:l}function qs(r,e){if(r.length>e)return r.length=e,!0}function Mc(r){return new this(r).abs()}function _c(r){return new this(r).acos()}function vc(r){return new this(r).acosh()}function Vc(r,e){return new this(r).plus(e)}function Fc(r){return new this(r).asin()}function Ec(r){return new this(r).asinh()}function Dc(r){return new this(r).atan()}function Wc(r){return new this(r).atanh()}function qc(r,e){r=new this(r),e=new this(e);var t,n=this.precision,o=this.rounding,i=n+4;return!r.s||!e.s?t=new this(NaN):!r.d&&!e.d?(t=kt(this,i,1).times(e.s>0?.25:.75),t.s=r.s):!e.d||r.isZero()?(t=e.s<0?kt(this,n,o):new this(0),t.s=r.s):!r.d||e.isZero()?(t=kt(this,i,1).times(.5),t.s=r.s):e.s<0?(this.precision=i,this.rounding=1,t=this.atan(he(r,e,i,1)),e=kt(this,i,1),this.precision=n,this.rounding=o,t=r.s<0?t.minus(e):t.plus(e)):t=this.atan(he(r,e,i,1)),t}function Uc(r){return new this(r).cbrt()}function Gc(r){return Z(r=new this(r),r.e+1,2)}function Xc(r,e,t){return new this(r).clamp(e,t)}function zc(r){if(!r||typeof r!="object")throw Error(zo+"Object expected");var e,t,n,o=r.defaults===!0,i=["precision",1,$t,"rounding",0,8,"toExpNeg",-xn,0,"toExpPos",0,xn,"maxE",0,xn,"minE",-xn,0,"modulo",0,9];for(e=0;e<i.length;e+=3)if(t=i[e],o&&(this[t]=oi[t]),(n=r[t])!==void 0)if(Qe(n)===n&&n>=i[e+1]&&n<=i[e+2])this[t]=n;else throw Error(Zt+t+": "+n);if(t="crypto",o&&(this[t]=oi[t]),(n=r[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(zs);else this[t]=!1;else throw Error(Zt+t+": "+n);return this}function Qc(r){return new this(r).cos()}function Yc(r){return new this(r).cosh()}function ea(r){var e,t,n;function o(i){var s,a,c,u=this;if(!(u instanceof o))return new o(i);if(u.constructor=o,Us(i)){u.s=i.s,re?!i.d||i.e>o.maxE?(u.e=NaN,u.d=null):i.e<o.minE?(u.e=0,u.d=[0]):(u.e=i.e,u.d=i.d.slice()):(u.e=i.e,u.d=i.d?i.d.slice():i.d);return}if(c=typeof i,c==="number"){if(i===0){u.s=1/i<0?-1:1,u.e=0,u.d=[0];return}if(i<0?(i=-i,u.s=-1):u.s=1,i===~~i&&i<1e7){for(s=0,a=i;a>=10;a/=10)s++;re?s>o.maxE?(u.e=NaN,u.d=null):s<o.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[i]):(u.e=s,u.d=[i]);return}else if(i*0!==0){i||(u.s=NaN),u.e=NaN,u.d=null;return}return si(u,i.toString())}else if(c!=="string")throw Error(Zt+i);return(a=i.charCodeAt(0))===45?(i=i.slice(1),u.s=-1):(a===43&&(i=i.slice(1)),u.s=1),Ys.test(i)?si(u,i):Oc(u,i)}if(o.prototype=V,o.ROUND_UP=0,o.ROUND_DOWN=1,o.ROUND_CEIL=2,o.ROUND_FLOOR=3,o.ROUND_HALF_UP=4,o.ROUND_HALF_DOWN=5,o.ROUND_HALF_EVEN=6,o.ROUND_HALF_CEIL=7,o.ROUND_HALF_FLOOR=8,o.EUCLID=9,o.config=o.set=zc,o.clone=ea,o.isDecimal=Us,o.abs=Mc,o.acos=_c,o.acosh=vc,o.add=Vc,o.asin=Fc,o.asinh=Ec,o.atan=Dc,o.atanh=Wc,o.atan2=qc,o.cbrt=Uc,o.ceil=Gc,o.clamp=Xc,o.cos=Qc,o.cosh=Yc,o.div=jc,o.exp=Hc,o.floor=Zc,o.hypot=$c,o.ln=Jc,o.log=el,o.log10=nl,o.log2=tl,o.max=ol,o.min=rl,o.mod=il,o.mul=sl,o.pow=al,o.random=ul,o.round=cl,o.sign=ll,o.sin=ml,o.sinh=dl,o.sqrt=pl,o.sub=fl,o.sum=yl,o.tan=bl,o.tanh=gl,o.trunc=Al,r===void 0&&(r={}),r&&r.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)r.hasOwnProperty(t=n[e++])||(r[t]=this[t]);return o.config(r),o}function jc(r,e){return new this(r).div(e)}function Hc(r){return new this(r).exp()}function Zc(r){return Z(r=new this(r),r.e+1,3)}function $c(){var r,e,t=new this(0);for(re=!1,r=0;r<arguments.length;)if(e=new this(arguments[r++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return re=!0,new this(1/0);t=e}return re=!0,t.sqrt()}function Us(r){return r instanceof Xn||r&&r.toStringTag===Qs||!1}function Jc(r){return new this(r).ln()}function el(r,e){return new this(r).log(e)}function tl(r){return new this(r).log(2)}function nl(r){return new this(r).log(10)}function ol(){return Zs(this,arguments,"lt")}function rl(){return Zs(this,arguments,"gt")}function il(r,e){return new this(r).mod(e)}function sl(r,e){return new this(r).mul(e)}function al(r,e){return new this(r).pow(e)}function ul(r){var e,t,n,o,i=0,s=new this(1),a=[];if(r===void 0?r=this.precision:nt(r,1,$t),n=Math.ceil(r/te),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));i<n;)o=e[i],o>=429e7?e[i]=crypto.getRandomValues(new Uint32Array(1))[0]:a[i++]=o%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);i<n;)o=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+((e[i+3]&127)<<24),o>=214e7?crypto.randomBytes(4).copy(e,i):(a.push(o%1e7),i+=4);i=n/4}else throw Error(zs);else for(;i<n;)a[i++]=Math.random()*1e7|0;for(n=a[--i],r%=te,n&&r&&(o=_e(10,te-r),a[i]=(n/o|0)*o);a[i]===0;i--)a.pop();if(i<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=te)a.shift();for(n=1,o=a[0];o>=10;o/=10)n++;n<te&&(t-=te-n)}return s.e=t,s.d=a,s}function cl(r){return Z(r=new this(r),r.e+1,this.rounding)}function ll(r){return r=new this(r),r.d?r.d[0]?r.s:0*r.s:r.s||NaN}function ml(r){return new this(r).sin()}function dl(r){return new this(r).sinh()}function pl(r){return new this(r).sqrt()}function fl(r,e){return new this(r).sub(e)}function yl(){var r=0,e=arguments,t=new this(e[r]);for(re=!1;t.s&&++r<e.length;)t=t.plus(e[r]);return re=!0,Z(t,this.precision,this.rounding)}function bl(r){return new this(r).tan()}function gl(r){return new this(r).tanh()}function Al(r){return Z(r=new this(r),r.e+1,1)}V[Symbol.for("nodejs.util.inspect.custom")]=V.toString;V[Symbol.toStringTag]="Decimal";var Xn=V.constructor=ea(oi);Uo=new Xn(Uo);Go=new Xn(Go);var O=Xn;import xl from"big.js";import Zo from"bn.js";import wl from"toformat";var Pl=wl,zn=Pl;import Ho from"big.js";import kl from"bn.js";import Tl from"decimal.js-light";import Qn from"bn.js";var ta=9007199254740991;function Y(r){let e=ue("Raydium_parseBigNumberish");if(r instanceof Qn)return r;if(typeof r=="string"){if(r.match(/^-?[0-9]+$/))return new Qn(r);e.logWithError(`invalid BigNumberish string: ${r}`)}return typeof r=="number"?(r%1&&e.logWithError(`BigNumberish number underflow: ${r}`),(r>=ta||r<=-ta)&&e.logWithError(`BigNumberish number overflow: ${r}`),new Qn(String(r))):typeof r=="bigint"?new Qn(r.toString()):(e.error(`invalid BigNumberish value: ${r}`),new Qn(0))}var jo=ue("module/fraction"),ui=zn(Ho),Yn=zn(Tl),Il={[0]:Yn.ROUND_DOWN,[1]:Yn.ROUND_HALF_UP,[2]:Yn.ROUND_UP},Bl={[0]:Ho.roundDown,[1]:Ho.roundHalfUp,[2]:Ho.roundUp},pe=class{constructor(e,t=new kl(1)){this.numerator=Y(e),this.denominator=Y(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new pe(this.denominator,this.numerator)}add(e){let t=e instanceof pe?e:new pe(Y(e));return this.denominator.eq(t.denominator)?new pe(this.numerator.add(t.numerator),this.denominator):new pe(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof pe?e:new pe(Y(e));return this.denominator.eq(t.denominator)?new pe(this.numerator.sub(t.numerator),this.denominator):new pe(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof pe?e:new pe(Y(e));return new pe(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof pe?e:new pe(Y(e));return new pe(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||jo.logWithError(`${e} is not an integer.`),e<=0&&jo.logWithError(`${e} is not positive.`),Yn.set({precision:e+1,rounding:Il[n]});let o=new Yn(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return o.toFormat(o.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||jo.logWithError(`${e} is not an integer.`),e<0&&jo.logWithError(`${e} is negative.`),ui.DP=e,ui.RM=Bl[n]||1,new ui(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var Sl=ue("Raydium_amount"),na=zn(xl);function Kl(r,e){let t="0",n="0";if(r.includes(".")){let o=r.split(".");o.length===2?([t,n]=o,n=n.padEnd(e,"0")):Sl.logWithError(`invalid number string, num: ${r}`)}else t=r;return[t,n.slice(0,e)||n]}var ge=class extends pe{constructor(t,n,o=!0,i){let s=new Zo(0),a=ci.pow(new Zo(t.decimals));if(o)s=Y(n);else{let c=new Zo(0),u=new Zo(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=Kl(n.toString(),t.decimals);c=Y(l),u=Y(m)}c=c.mul(a),s=c.add(u)}super(s,a);this.logger=ue(i||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new ge(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new ge(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,o=0){return super.toSignificant(t,n,o)}toFixed(t=this.token.decimals,n,o=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,o)}toExact(t={groupSeparator:""}){return na.DP=this.token.decimals,new na(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as Cl}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as oa}from"@solana/spl-token";var Lt={chainId:101,address:Cl.default.toBase58(),programId:oa.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},ve={chainId:101,address:"So11111111111111111111111111111111111111112",programId:oa.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as fi}from"@solana/web3.js";import{PublicKey as Be,SystemProgram as ra,SYSVAR_RENT_PUBKEY as Rl}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ll}from"@solana/spl-token";function h({pubkey:r,isSigner:e=!1,isWritable:t=!0}){return{pubkey:r,isWritable:t,isSigner:e}}var li=[h({pubkey:Ll,isWritable:!1}),h({pubkey:ra.programId,isWritable:!1}),h({pubkey:Rl,isWritable:!1})];function mi({publicKey:r,transformSol:e}){let t=di(r.toString());if(t instanceof Be)return e&&t.equals(Ve)?z:t;if(e&&t.toString()===Ve.toBase58())return z;if(typeof t=="string"){if(t===Be.default.toBase58())return Be.default;try{return new Be(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function di(r){try{return new Be(r)}catch{return r}}var $o=new Be("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Kn=new Be("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),ot=new Be("SysvarRent111111111111111111111111111111111"),pi=new Be("SysvarC1ock11111111111111111111111111111111"),Cn=new Be("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Jo=new Be("Sysvar1nstructions1111111111111111111111111"),er=ra.programId,sf=new Be("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),af=new Be("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),uf=new Be("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),cf=new Be("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),lf=new Be("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),mf=new Be("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),df=new Be("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),pf=new Be("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),ff=new Be("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),yf=new Be("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),bf=new Be("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),z=new Be("So11111111111111111111111111111111111111112"),Ve=Be.default;function lt(r){return mi({publicKey:r,transformSol:!0})}var yi=class{constructor({mint:e,decimals:t,symbol:n,name:o,skipMint:i=!1,isToken2022:s=!1}){if(e===Ve.toBase58()||e instanceof fi&&Ve.equals(e)){this.decimals=ve.decimals,this.symbol=ve.symbol,this.name=ve.name,this.mint=new fi(ve.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=o||e.toString().substring(0,6),this.mint=i?fi.default:mi({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},xe=yi;xe.WSOL=new yi(E(R({},ve),{mint:ve.address}));var bi=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},tr=bi;tr.SOL=new bi(Lt);import Ol from"bn.js";var ia=new pe(new Ol(100)),Ee=class extends pe{toSignificant(e=5,t,n){return this.mul(ia).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(ia).toFixed(e,t,n)}};var Nl=ue("Raydium_price"),rt=class extends pe{constructor(t){let{baseToken:n,quoteToken:o,numerator:i,denominator:s}=t;super(i,s);this.baseToken=n,this.quoteToken=o,this.scalar=new pe(gi(n.decimals),gi(o.decimals))}get raw(){return new pe(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new rt({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Nl.logWithError("mul token not equals");let n=super.mul(t);return new rt({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,o){return this.adjusted.toSignificant(t,n,o)}toFixed(t=this.quoteToken.decimals,n,o){return this.adjusted.toFixed(t,n,o)}};import{PublicKey as Ml}from"@solana/web3.js";import _l from"bn.js";function sa(r){return typeof r=="object"&&r!==null&&![xe,ge,Ml,pe,_l,rt,Ee].some(e=>typeof e=="object"&&r instanceof e)}function Te(r){return typeof r=="string"?di(r):Array.isArray(r)?r.map(e=>Te(e)):sa(r)?Object.fromEntries(Object.entries(r).map(([e,t])=>[e,Te(t)])):r}var yt=new Mt(0),aa=new Mt(1),my=new Mt(2),dy=new Mt(3),py=new Mt(5),ci=new Mt(10),fy=new Mt(100),yy=new Mt(1e3),by=new Mt(1e4);function gi(r){return ci.pow(Y(r))}function nr(r,e){let t=r.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}var ua=r=>typeof r=="number";function ca(r,e,t){let n=ua(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(r).getTime()<=n}function la(r,e,t){let n=ua(e)?e*((t==null?void 0:t.unit)==="s"?1e3:1):e;return new Date(r).getTime()>n}function ti(r,e=1,t=[]){let n=[...r];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var It=class{constructor(e){this._owner=e}get publicKey(){return It.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return It.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return It.isKeyPair(this._owner)}get isPublicKey(){return It.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!It.isKeyPair(e)}};import{PublicKey as Wl}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ql}from"@solana/spl-token";import{ComputeBudgetProgram as ma,Keypair as da,PublicKey as pa,Transaction as or,TransactionMessage as vl,VersionedTransaction as fa}from"@solana/web3.js";var F={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut"};import{TOKEN_PROGRAM_ID as Vl}from"@solana/spl-token";var _t=ue("Raydium_txUtil"),ya=1644;function rr(r){let e=[],t=[];return r.microLamports&&(e.push(ma.setComputeUnitPrice({microLamports:r.microLamports})),t.push(F.SetComputeUnitPrice)),r.units&&(e.push(ma.setComputeUnitLimit({units:r.units})),t.push(F.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function Rn(r,e){var n,o;let t=e!=null?e:"confirmed";return(o=await((n=r.getLatestBlockhash)==null?void 0:n.call(r,{commitment:t})))==null?void 0:o.blockhash}async function ir(r,e){return r.getSignatureStatuses([e]),new Promise((t,n)=>{let o=setTimeout(n,6e4);r.onSignature(e,i=>{if(clearTimeout(o),!i.err){t("");return}n(i.err.toString())},"confirmed")})}function sr(r,e){r.length<1&&_t.logWithError(`no instructions provided: ${r.toString()}`),e.length<1&&_t.logWithError(`no signers provided:, ${e.toString()}`);let t=new or;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...r);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<ya}catch{return!1}}async function ba(r,e,t,n=!0){let o=new pa("RaydiumSimuLateTransaction11111111111111111"),i=[],s=new or;s.feePayer=o;for(let u of e)sr([...s.instructions,u],[o])||(i.push(s),s=new or,s.feePayer=o),s.add(u);s.instructions.length>0&&i.push(s);let a=[];try{if(a=await Fl(r,i,n),a.find(u=>u.err!==null))throw Error("rpc simulateTransaction error")}catch(u){u instanceof Error&&_t.logWithError("failed to simulate for instructions","RPC_ERROR",{message:u.message})}let c=[];for(let u of a)if(_t.debug("simulate result:",u),u.logs){let l=u.logs.filter(m=>m&&m.includes(t));_t.debug("filteredLog:",c),l.length||_t.logWithError("simulate log not match keyword","keyword",t),c.push(...l)}return c}function ga(r,e){let t=r.match(/{["\w:,]+}/g);return!t||t.length!==1?_t.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function vt(r,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(r);return!n||n.length!==2?_t.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function se(r,e){let[t,n]=pa.findProgramAddressSync(r,e);return{publicKey:t,nonce:n}}async function Fl(r,e,t){let n=[];if(t){let o=await r.getLatestBlockhash(),i=[];for(let u of e){u.recentBlockhash=o.blockhash,u.lastValidBlockHeight=o.lastValidBlockHeight;let m=u._compile().serialize(),p=u._serialize(m).toString("base64");i.push(p)}let s=i.map(u=>{let l=r._buildArgs([u],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],c=20;for(let u=0;u<Math.ceil(s.length/c);u++)a.push(s.slice(u*c,(u+1)*c));n=await(await Promise.all(a.map(async u=>(await r._rpcBatchRequest(u)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async o=>await(await r.simulateTransaction(o)).value))}catch(o){o instanceof Error&&_t.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:o.message})}return n}function jn({instructions:r,payer:e,signers:t}){return sr(r,[e,...t])}function Hn({instructions:r,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=da.generate().publicKey.toString()}){let i=new vl({payerKey:e,recentBlockhash:n,instructions:r}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new fa(i).serialize()).toString("base64").length<ya}catch{return!1}}var El=r=>Buffer.isBuffer(r)?r:r instanceof Uint8Array?Buffer.from(r.buffer,r.byteOffset,r.byteLength):Buffer.from(r),Dl=r=>{let e=r.serialize({requireAllSignatures:!1,verifySignatures:!1});r instanceof fa&&(e=El(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function cn(r){let e=[];return r.forEach(t=>{t instanceof or&&(t.recentBlockhash||(t.recentBlockhash=Vl.toBase58()),t.feePayer||(t.feePayer=da.generate().publicKey)),e.push(Dl(t))}),console.log("simulate tx string:",e),e}function ye(r,e,t){return se([r.toBuffer(),(t!=null?t:ql).toBuffer(),e.toBuffer()],new Wl("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as ce}from"@solana/web3.js";var Aa=new ce("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),wa=new ce("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Zn=new ce("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Vy=new ce("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Fy=new ce("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),Ai=new ce("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Pa=new ce("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),Ey=new ce("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),ha=new ce("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),ar=new ce("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),ur=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),cr=new ce("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),Dy=new ce("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),Wy=new ce("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Ul=new ce("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Gl=new ce("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Xl=new ce("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),zl=new ce("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),ka=new ce("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),qy=new ce("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),Uy=new ce("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Ql=new ce("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Yl=new ce("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),jl=new ce("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),$n={IDO_PROGRAM_ID_V1:Ul,IDO_PROGRAM_ID_V2:Gl,IDO_PROGRAM_ID_V3:Xl,IDO_PROGRAM_ID_V4:zl};var Gy={SERUM_MARKET:ce.default,OPENBOOK_MARKET:new ce("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:ce.default,FarmV3:new ce("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new ce("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new ce("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new ce("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new ce("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new ce("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new ce("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new ce("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Ql,CREATE_CPMM_POOL_AUTH:Yl,CREATE_CPMM_POOL_FEE_ACC:jl,FEE_DESTINATION_ID:new ce("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR")};import Bt from"bn.js";var Jn=1e4;function fe(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let o=E(R({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),i=t.epoch<o.newerTransferFee.epoch?o.olderTransferFee:o.newerTransferFee,s=new Bt(i.maximumFee.toString()),a=t.epoch<o.newerTransferFee.epoch?(Number(o.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(i.transferFeeBasisPoints===Jn){let c=new Bt(i.maximumFee.toString());return{amount:r.add(c),fee:c,expirationTime:a}}else{let c=Jt(r.mul(new Bt(Jn)),new Bt(Jn-i.transferFeeBasisPoints)),u=new Bt(i.maximumFee.toString()),l=c.sub(r).gt(u)?r.add(u):c,m=Jt(l.mul(new Bt(i.transferFeeBasisPoints)),new Bt(Jn)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let c=Jt(r.mul(new Bt(i.transferFeeBasisPoints)),new Bt(Jn)),u=c.gt(s)?s:c;return{amount:r,fee:u,expirationTime:a}}}function xt(r,e){return r===void 0?e:e===void 0?r:Math.min(r,e)}function Jt(r,e){let{div:t,mod:n}=r.divmod(e);return n.gt(new Bt(0))?t.add(new Bt(1)):t}import{PublicKey as Ta,AddressLookupTableAccount as lr}from"@solana/web3.js";async function wi({connection:r,address:e}){let t=await ht(r,[...new Set(e.map(o=>o.toString()))].map(o=>new Ta(o))),n={};for(let o=0;o<e.length;o++){let i=t[o],s=e[o];if(!i)continue;let a=new lr({key:s,state:lr.deserialize(i.data)});n[s.toString()]=a,mr[s.toString()]=a}return n}var mr={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new lr({key:new Ta("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:lr.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};import{PublicKey as eo,sendAndConfirmTransaction as Pi,Transaction as to,TransactionMessage as no,VersionedTransaction as oo}from"@solana/web3.js";import Hl from"axios";var dr=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.api=e.api}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await Hl.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=rr(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:o=[],endInstructionTypes:i=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...o),this.endInstructionTypes.push(...i),this.lookupTableAddress.push(...s.filter(a=>a!==eo.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(R({},t||{})):this.build(t)}build(e){var n;let t=new to;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(o=>o.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async o=>{var u;let{recentBlockHash:i,skipPreflight:s=!0,sendAndConfirm:a}=o||{},c=i!=null?i:await Rn(this.connection,this.blockhashCommitment);if(t.recentBlockhash=c,this.signers.length&&t.sign(...this.signers),cn([t]),(u=this.owner)!=null&&u.isKeyPair)return{txId:a?await Pi(this.connection,t,this.signers.find(m=>m.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:s}),signedTx:t};if(this.signAllTransactions){let l=await this.signAllTransactions([t]);return{txId:await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var u;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:o}=this.build(n),i=t.filter(l=>l.transaction.instructions.length>0),s=[o,...i.map(l=>l.transaction)],a=[this.signers,...i.map(l=>l.signers)],c=[...this.instructionTypes,...i.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async l=>{var b;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:y=!0}=l||{},f=p!=null?p:await Rn(this.connection,this.blockhashCommitment);if((b=this.owner)!=null&&b.isKeyPair){if(m){let g=[];for(let A of s){let w=await Pi(this.connection,A,this.signers.find(k=>k.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:y});g.push(w)}return{txIds:g,signedTxs:s}}return{txIds:await await Promise.all(s.map(async g=>(g.recentBlockhash=f,await this.connection.sendRawTransaction(g.serialize(),{skipPreflight:y})))),signedTxs:s}}if(this.signAllTransactions){let g=s.map((w,k)=>(w.recentBlockhash=f,a[k].length&&w.sign(...a[k]),w));cn(g);let A=await this.signAllTransactions(g);if(m){let w=0,k=[],I=async()=>{if(!A[w])return;let T=await this.connection.sendRawTransaction(A[w].serialize(),{skipPreflight:y});k.push({txId:T,status:"sent",signedTx:A[w]}),d==null||d([...k]),w++,this.connection.onSignature(T,S=>{let B=k.findIndex(C=>C.txId===T);B>-1&&(k[B].status=S.err?"error":"success"),d==null||d([...k]),S.err||I()},"processed"),this.connection.getSignatureStatus(T)};return await I(),{txIds:k.map(T=>T.txId),signedTxs:A}}else{let w=[];for(let k=0;k<A.length;k+=1){let I=await this.connection.sendRawTransaction(A[k].serialize(),{skipPreflight:y});w.push(I)}return{txIds:w,signedTxs:A}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var f;let y=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:o,recentBlockhash:i}=y,s=Le(y,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),a=R(R({},this.cluster==="devnet"?{}:mr),t),c=Array.from(new Set([...n,...this.lookupTableAddress])),u=[];for(let b of c)a[b]===void 0&&u.push(new eo(b));let l=await wi({connection:this.connection,address:u});for(let[b,g]of Object.entries(l))a[b]=g;let m=o?eo.default.toBase58():i!=null?i:await Rn(this.connection,this.blockhashCommitment),d=new no({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(a));((f=this.owner)==null?void 0:f.signer)&&!this.signers.some(b=>b.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new oo(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async b=>{var w;let{skipPreflight:g=!0,sendAndConfirm:A}=b||{};if(cn([p]),(w=this.owner)!=null&&w.isKeyPair){let k=await this.connection.sendTransaction(p,{skipPreflight:g});return A&&await ir(this.connection,k),{txId:k,signedTx:p}}if(this.signAllTransactions){let k=await this.signAllTransactions([p]);return{txId:await this.connection.sendTransaction(k[0],{skipPreflight:g}),signedTx:k[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){var u;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:o}=await this.buildV0(n),i=t.filter(l=>l.builder.instructions.length>0),s=[o,...i.map(l=>l.transaction)],a=[this.signers,...i.map(l=>l.signers)],c=[...this.instructionTypes,...i.map(l=>l.instructionTypes).flat()];return(u=this.owner)!=null&&u.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(l,m)=>{l.sign(a[m])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async l=>{var f;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:y=!0}=l||{};if(p&&s.forEach(b=>b.message.recentBlockhash=p),cn(s),(f=this.owner)!=null&&f.isKeyPair){if(m){let b=[];for(let g of s){let A=await this.connection.sendTransaction(g,{skipPreflight:y});await ir(this.connection,A),b.push(A)}return{txIds:b,signedTxs:s}}return{txIds:await Promise.all(s.map(async b=>await this.connection.sendTransaction(b,{skipPreflight:y}))),signedTxs:s}}if(this.signAllTransactions){let b=await this.signAllTransactions(s);if(m){let g=0,A=[],w=async()=>{if(!b[g])return;let k=await this.connection.sendTransaction(b[g],{skipPreflight:y});A.push({txId:k,status:"sent",signedTx:b[g]}),d==null||d([...A]),g++,this.connection.onSignature(k,I=>{let T=A.findIndex(S=>S.txId===k);T>-1&&(A[T].status=I.err?"error":"success"),d==null||d([...A]),I.err||w()},"processed"),this.connection.getSignatureStatus(k)};return w(),{txIds:[],signedTxs:b}}else{let g=[];for(let A=0;A<b.length;A+=1){let w=await this.connection.sendTransaction(b[A],{skipPreflight:y});g.push(w)}return{txIds:g,signedTxs:b}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var l;let u=e||{},{computeBudgetConfig:t}=u,n=Le(u,["computeBudgetConfig"]),o=t?rr(t):{instructions:[],instructionTypes:[]},i=this.signers.reduce((m,d)=>E(R({},m),{[d.publicKey.toBase58()]:d}),{}),s=[],a=[],c=[];if(this.allInstructions.forEach(m=>{let d=[...c,m],p=t?[...o.instructions,...d]:d,f=[...new Set(d.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat()).values()].map(b=>new eo(b));if(c.length<12&&jn({instructions:p,payer:this.feePayer,signers:f})||jn({instructions:d,payer:this.feePayer,signers:f}))c.push(m);else{if(c.length===0)throw Error("item ins too big");jn({instructions:t?[...o.instructions,...c]:[...c],payer:this.feePayer,signers:f})?s.push(new to().add(...o.instructions,...c)):s.push(new to().add(...c)),a.push(Array.from(new Set(c.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat())).map(b=>i[b]).filter(b=>b!==void 0)),c=[m]}}),c.length>0){let d=[...new Set(c.map(p=>p.keys.filter(y=>y.isSigner).map(y=>y.pubkey.toString())).flat()).values()].map(p=>i[p]).filter(p=>p!==void 0);jn({instructions:t?[...o.instructions,...c]:[...c],payer:this.feePayer,signers:d.map(p=>p.publicKey)})?s.push(new to().add(...o.instructions,...c)):s.push(new to().add(...c)),a.push(d)}return s.forEach(m=>m.feePayer=this.feePayer),(l=this.owner)!=null&&l.signer&&a.forEach(m=>{m.some(d=>d.publicKey.equals(this.owner.publicKey))||m.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:this.instructionTypes,execute:async m=>{var g;let{sequentially:d,onTxUpdate:p,recentBlockHash:y,skipPreflight:f=!0}=m||{},b=y!=null?y:await Rn(this.connection,this.blockhashCommitment);if(s.forEach(async(A,w)=>{A.recentBlockhash=b,a[w].length&&A.sign(...a[w])}),cn(s),(g=this.owner)!=null&&g.isKeyPair){if(d){let A=[];for(let w of s){let k=await Pi(this.connection,w,this.signers.find(I=>I.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:f});A.push(k)}return{txIds:A,signedTxs:s}}return{txIds:await Promise.all(s.map(async A=>await this.connection.sendRawTransaction(A.serialize(),{skipPreflight:f}))),signedTxs:s}}if(this.signAllTransactions){let A=await this.signAllTransactions(s);if(d){let w=0,k=[],I=async()=>{if(!A[w])return;let T=await this.connection.sendRawTransaction(A[w].serialize(),{skipPreflight:f});k.push({txId:T,status:"sent",signedTx:A[w]}),p==null||p([...k]),w++,this.connection.onSignature(T,S=>{let B=k.findIndex(C=>C.txId===T);B>-1&&(k[B].status=S.err?"error":"success"),p==null||p([...k]),S.err||I()},"processed"),this.connection.getSignatureStatus(T)};return await I(),{txIds:k.map(T=>T.txId),signedTxs:A}}else{let w=[];for(let k=0;k<A.length;k+=1){let I=await this.connection.sendRawTransaction(A[k].serialize(),{skipPreflight:f});w.push(I)}return{txIds:w,signedTxs:A}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuildV0(e){var g;let b=e||{},{computeBudgetConfig:t,lookupTableCache:n={},lookupTableAddress:o=[]}=b,i=Le(b,["computeBudgetConfig","lookupTableCache","lookupTableAddress"]),s=R(R({},this.cluster==="devnet"?{}:mr),n),a=Array.from(new Set([...this.lookupTableAddress,...o])),c=[];for(let A of a)s[A]===void 0&&c.push(new eo(A));let u=await wi({connection:this.connection,address:c});for(let[A,w]of Object.entries(u))s[A]=w;let l=t?rr(t):{instructions:[],instructionTypes:[]},m=await Rn(this.connection,this.blockhashCommitment),d=this.signers.reduce((A,w)=>E(R({},A),{[w.publicKey.toBase58()]:w}),{}),p=[],y=[],f=[];if(this.allInstructions.forEach(A=>{let w=[...f,A],k=t?[...l.instructions,...w]:w;if(f.length<12&&Hn({instructions:k,payer:this.feePayer,lookupTableAddressAccount:s})||Hn({instructions:w,payer:this.feePayer,lookupTableAddressAccount:s}))f.push(A);else{if(f.length===0)throw Error("item ins too big");let I={};for(let T of[...new Set(a)])s[T]!==void 0&&(I[T]=s[T]);if(t&&Hn({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let T=new no({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));p.push(new oo(T))}else{let T=new no({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));p.push(new oo(T))}y.push(Array.from(new Set(f.map(T=>T.keys.filter(S=>S.isSigner).map(S=>S.pubkey.toString())).flat())).map(T=>d[T]).filter(T=>T!==void 0)),f=[A]}}),f.length>0){let w=[...new Set(f.map(k=>k.keys.filter(I=>I.isSigner).map(I=>I.pubkey.toString())).flat()).values()].map(k=>d[k]).filter(k=>k!==void 0);if(t&&Hn({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let k=new no({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));p.push(new oo(k))}else{let k=new no({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));p.push(new oo(k))}y.push(w)}return(g=this.owner)!=null&&g.signer&&y.forEach(A=>{A.some(w=>w.publicKey.equals(this.owner.publicKey))||A.push(this.owner.signer)}),{builder:this,transactions:p,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async A=>{var S;let{sequentially:w,onTxUpdate:k,recentBlockHash:I,skipPreflight:T=!0}=A||{};if(p.map(async(B,C)=>{y[C].length&&B.sign(y[C]),I&&(B.message.recentBlockhash=I)}),cn(p),(S=this.owner)!=null&&S.isKeyPair){if(w){let B=[];for(let C of p){let x=await this.connection.sendTransaction(C,{skipPreflight:T});await ir(this.connection,x),B.push(x)}return{txIds:B,signedTxs:p}}return{txIds:await Promise.all(p.map(async B=>await this.connection.sendTransaction(B,{skipPreflight:T}))),signedTxs:p}}if(this.signAllTransactions){let B=await this.signAllTransactions(p);if(w){let C=0,x=[],L=async()=>{if(!B[C])return;let W=await this.connection.sendTransaction(B[C],{skipPreflight:T});x.push({txId:W,status:"sent",signedTx:B[C]}),k==null||k([...x]),C++,this.connection.onSignature(W,_=>{let $=x.findIndex(G=>G.txId===W);$>-1&&(x[$].status=_.err?"error":"success"),k==null||k([...x]),_.err||L()},"processed"),this.connection.getSignatureStatus(W)};return L(),{txIds:[],signedTxs:B}}else{let C=[];for(let x=0;x<B.length;x+=1){let L=await this.connection.sendTransaction(B[x],{skipPreflight:T});C.push(L)}return{txIds:C,signedTxs:B}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}};var Oe={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://tokens.jup.ag/tokens?tags=lst,community",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",JITO:"https://mainnet.block-engine.jito.wtf",JITO_TRANSACTION:"/api/v1/transactions",JITO_BUNDLE:"/api/v1/bundles"},Kb=R({},Oe);var Ia="ray_tab_hash",hi="ray_req_hash",Zl=()=>{if(typeof window===void 0)return"";let r=sessionStorage.getItem(Ia);return r||(r=`ray-${Date.now()}`,sessionStorage.setItem(Ia,r)),r},pr=async n=>{var o=n,{logCount:r=1e3,removeLastLog:e}=o,t=Le(o,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(s=>s());let i=JSON.parse(localStorage.getItem(hi)||"[]").slice(0,r-1);e&&i.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),i.unshift(E(R({},t),{time:Date.now(),session:Zl()}));try{localStorage.setItem(hi,JSON.stringify(i))}catch{if(e){let s=!1,a=JSON.stringify(t.data).substring(0,100);for(i[0].data=a+(a.length>100?"...":"");!s;){i.pop();let c=JSON.stringify(t.data).substring(0,100);i[0].data=c+(c.length>100?"...":"");try{localStorage.setItem(hi,JSON.stringify(i)),s=!0}catch{s=!1}}return new Promise(c=>c())}return pr(E(R({},t),{logCount:r,removeLastLog:!0}))}};var fr=ue("Raydium_Api"),ki=new Map;var yr=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:o,urlConfigs:i}){this.cluster=e,this.urlConfigs=i||{},this.logCount=o||1e3,this.api=Ba.create({baseURL:this.urlConfigs.BASE_HOST||Oe.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return fr.debug(`${a==null?void 0:a.toUpperCase()} ${c}${u}`),s},s=>(fr.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:m,url:d}=a;return n&&pr({status:u,url:`${m}${d}`,params:a.params,data:c,logCount:this.logCount}),fr.debug(`${l==null?void 0:l.toUpperCase()} ${m}${d}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:m,url:d}=a;return n&&pr({status:u,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),fr.error(`${l.toUpperCase()} ${m}${d} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||Oe.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||Oe.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||Oe.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await Ba.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(o=>o.numSlots);return n.reduce((o,i)=>o+i,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||Oe.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||Oe.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||Oe.TOKEN_LIST)).data}async getJupTokenList(){return this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||Oe.JUP_TOKEN_LIST})}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||Oe.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:o="desc",page:i=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||Oe.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${o}&page=${i}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||Oe.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],o=t.filter(s=>ki.has(s)?(n.push(ki.get(s)),!1):!0),i=[];return o.length&&(i=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||Oe.POOL_KEY_BY_ID)+`?ids=${o.join(",")}`)).data.filter(Boolean),i.forEach(a=>{ki.set(a.id,a)})),n.concat(i)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:o="all",sort:i="default",order:s="desc",page:a=1}=e,[c,u]=[t&&lt(t).toBase58(),n&&n!=="undefined"?lt(n).toBase58():""],[l,m]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||Oe.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${o}&poolSortField=${i}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||Oe.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||Oe.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||Oe.CHECK_AVAILABILITY)).data}async sendTxToJito(e,t){let n=t?this.urlConfigs.JITO_BUNDLE||Oe.JITO_BUNDLE:this.urlConfigs.JITO_TRANSACTION||Oe.JITO_TRANSACTION;return(await this.api.post(n,{jsonrpc:"2.0",id:1,method:t?"sendBundle":"sendTransaction",params:e},{baseURL:this.urlConfigs.JITO||Oe.JITO})).data}};var br="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",xa="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as Tr,SystemProgram as xm}from"@solana/web3.js";import{AccountLayout as Nn,createAssociatedTokenAccountInstruction as Ni,TOKEN_PROGRAM_ID as on,TOKEN_2022_PROGRAM_ID as Sm}from"@solana/spl-token";var Ti=(...r)=>r.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Se=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=ue(t)}createTxBuilder(e){return this.scope.checkOwner(),new dr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Ti(e))}logInfo(...e){this.logger.info(Ti(e))}logAndCreateError(...e){let t=Ti(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as Pm,SystemProgram as hm}from"@solana/web3.js";import km from"bn.js";import{createCloseAccountInstruction as Tm,createInitializeAccountInstruction as Im,createTransferInstruction as Bm,TOKEN_PROGRAM_ID as On}from"@solana/spl-token";import{Keypair as bm,PublicKey as Da}from"@solana/web3.js";import gm from"bn.js";import{TOKEN_PROGRAM_ID as Am}from"@solana/spl-token";function $l(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function Ii(r,...e){if(!$l(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function Bi(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Sa(r,e){Ii(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Ar=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),St=(r,e)=>r<<32-e|r>>>e;var lg=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Jl(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function xi(r){return typeof r=="string"&&(r=Jl(r)),Ii(r),r}var gr=class{clone(){return this._cloneInto()}},mg={}.toString;function Ka(r){let e=n=>r().update(xi(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function em(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let o=BigInt(32),i=BigInt(4294967295),s=Number(t>>o&i),a=Number(t&i),c=n?4:0,u=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+u,a,n)}var Ca=(r,e,t)=>r&e^~r&t,Ra=(r,e,t)=>r&e^r&t^e&t,wr=class extends gr{constructor(e,t,n,o){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Ar(this.buffer)}update(e){Bi(this);let{view:t,buffer:n,blockLen:o}=this;e=xi(e);let i=e.length;for(let s=0;s<i;){let a=Math.min(o-this.pos,i-s);if(a===o){let c=Ar(e);for(;o<=i-s;s+=o)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Bi(this),Sa(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:i}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>o-s&&(this.process(n,0),s=0);for(let m=s;m<o;m++)t[m]=0;em(n,o-8,BigInt(this.length*8),i),this.process(n,0);let a=Ar(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<u;m++)a.setUint32(4*m,l[m],i)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:i,destroyed:s,pos:a}=this;return e.length=o,e.pos=a,e.finished=i,e.destroyed=s,o%t&&e.buffer.set(n),e}};var tm=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),en=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),tn=new Uint32Array(64),Si=class extends wr{constructor(){super(64,32,8,!1),this.A=en[0]|0,this.B=en[1]|0,this.C=en[2]|0,this.D=en[3]|0,this.E=en[4]|0,this.F=en[5]|0,this.G=en[6]|0,this.H=en[7]|0}get(){let{A:e,B:t,C:n,D:o,E:i,F:s,G:a,H:c}=this;return[e,t,n,o,i,s,a,c]}set(e,t,n,o,i,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=i|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let m=0;m<16;m++,t+=4)tn[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=tn[m-15],p=tn[m-2],y=St(d,7)^St(d,18)^d>>>3,f=St(p,17)^St(p,19)^p>>>10;tn[m]=f+tn[m-7]+y+tn[m-16]|0}let{A:n,B:o,C:i,D:s,E:a,F:c,G:u,H:l}=this;for(let m=0;m<64;m++){let d=St(a,6)^St(a,11)^St(a,25),p=l+d+Ca(a,c,u)+tm[m]+tn[m]|0,f=(St(n,2)^St(n,13)^St(n,22))+Ra(n,o,i)|0;l=u,u=c,c=a,a=s+p|0,s=i,i=o,o=n,n=p+f|0}n=n+this.A|0,o=o+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,o,i,s,a,c,u,l)}roundClean(){tn.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var La=Ka(()=>new Si);import{PublicKey as pm}from"@solana/web3.js";import va,{isBN as Va}from"bn.js";import{bits as nm,BitStructure as Pg,blob as om,Blob as hg,cstr as kg,f32 as Tg,f32be as Ig,f64 as Bg,f64be as xg,greedy as Sg,Layout as rm,ns64 as Kg,ns64be as Cg,nu64 as im,nu64be as Rg,offset as Lg,s16 as Og,s16be as Ng,s24 as Mg,s24be as _g,s32 as sm,s32be as vg,s40 as Vg,s40be as Fg,s48 as Eg,s48be as Dg,s8 as Wg,seq as am,struct as qg,Structure as um,u16 as cm,u16be as Ug,u24 as Gg,u24be as Xg,u32 as lm,u32be as zg,u40 as Qg,u40be as Yg,u48 as jg,u48be as Hg,u8 as mm,UInt as dm,union as Zg,Union as $g,unionLayoutDiscriminator as Jg,utf8 as eA}from"@solana/buffer-layout";var Pr=rm,Oa=um;var Ki=dm;var Na=mm,Vt=cm;var Ci=lm;var Ma=im;var Ge=sm;var _a=am;var Ae=om;var Ri=nm;var ln=class extends Pr{constructor(t,n,o){super(t,o);this.blob=Ae(t),this.signed=n}decode(t,n=0){let o=new va(this.blob.decode(t,n),10,"le");return this.signed?o.fromTwos(this.span*8).clone():o}encode(t,n,o=0){return typeof t=="number"&&(t=new va(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,o)}},hr=class extends Pr{constructor(t){super(8,t);this._lower=Ri(Ci(),!1),this._upper=Ri(Ci(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let o=this._lower.decode(t,n),i=this._upper.decode(t,n+this._lower.span);return R(R({},o),i)}encode(t,n,o=0){return this._lower.encode(t,n,o)+this._upper.encode(t,n,o+this._lower.span)}};function D(r){return new Ki(1,r)}function Xe(r){return new Ki(4,r)}function P(r){return new ln(8,!1,r)}function J(r){return new ln(16,!1,r)}function Fa(r){return new ln(1,!0,r)}function Ln(r){return new ln(8,!0,r)}function Ea(r){return new ln(16,!0,r)}var kr=class extends Pr{constructor(t,n,o,i){super(t.span,i);this.layout=t,this.decoder=n,this.encoder=o}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,o){return this.layout.encode(this.encoder(t),n,o)}getSpan(t,n){return this.layout.getSpan(t,n)}};function K(r){return new kr(Ae(32),e=>new pm(e),e=>e.toBuffer(),r)}function ze(r){return new kr(Na(),fm,ym,r)}function fm(r){if(r===0)return!1;if(r===1)return!0;throw new Error("Invalid bool: "+r)}function ym(r){return r?1:0}var Li=class extends Oa{decode(e,t){return super.decode(e,t)}};function v(r,e,t){return new Li(r,e,t)}function X(r,e,t){let n,o=typeof e=="number"?e:Va(e)?e.toNumber():new Proxy(e,{get(i,s){if(!n){let a=Reflect.get(i,"count");n=Va(a)?a.toNumber():a,Reflect.set(i,"count",n)}return Reflect.get(i,s)},set(i,s,a){return s==="count"&&(n=a),Reflect.set(i,s,a)}});return _a(r,o,t)}var nn=v([K("mint"),K("owner"),P("amount"),Xe("delegateOption"),K("delegate"),D("state"),Xe("isNativeOption"),P("isNative"),P("delegatedAmount"),Xe("closeAuthorityOption"),K("closeAuthority")]);var kA=ue("Raydium_Util");function Wa({owner:r,solAccountResp:e,tokenAccountResp:t}){let n=[],o=[];for(let{pubkey:i,account:s}of t.value){let a=nn.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:i,mint:c,amount:u,isAssociated:ye(r,c,s.owner).publicKey.equals(i),isNative:!1,programId:s.owner}),o.push({pubkey:i,accountInfo:a,programId:s.owner})}return e&&n.push({mint:Da.default,amount:new gm(e.lamports),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:o}}function it({fromPublicKey:r,programId:e=Am}){let t=bm.generate().publicKey.toBase58().slice(0,32);return{publicKey:wm(r,t,e),seed:t}}function wm(r,e,t){let n=Buffer.concat([r.toBuffer(),Buffer.from(e),t.toBuffer()]),o=La(n);return new Da(o)}function Oi(r){let{mint:e,tokenAccount:t,owner:n,programId:o=On}=r;return Im(t,e,n,o)}function Ft(r){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:o,programId:i=On}=r;return Tm(e,t,o,n,i)}async function Et(r){let{connection:e,amount:t,commitment:n,payer:o,owner:i,skipCloseAccount:s}=r,a=await e.getMinimumBalanceForRentExemption(nn.span,n),c=Y(t).add(new km(a)),u=it({fromPublicKey:o,programId:On});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[hm.createAccountWithSeed({fromPubkey:o,basePubkey:o,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:nn.span,programId:On}),Oi({mint:new Pm(ve.address),tokenAccount:u.publicKey,owner:i,programId:On})],instructionTypes:[F.CreateAccount,F.InitAccount],endInstructionTypes:s?[]:[F.CloseAccount],endInstructions:s?[]:[Ft({tokenAccount:u.publicKey,payer:o,owner:i})]}}function qa({source:r,destination:e,owner:t,amount:n,multiSigners:o=[],tokenProgram:i=On}){return Bm(r,e,t,BigInt(String(n)),o,i)}var io=class extends Se{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;this._accountFetchTime=0;let{tokenAccounts:n,tokenAccountRawInfos:o}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=o||[],this._clientOwnedToken=!!(n||o)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return ye(this.scope.ownerPubKey,t,n).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<1e3*60*3)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let o=R(R({},{}),t),[i,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,o.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:on},o.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Sm},o.commitment)]),{tokenAccounts:c,tokenAccountRawInfos:u}=Wa({owner:this.scope.ownerPubKey,solAccountResp:i,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=c,this._tokenAccountRawInfos=u,this._accountFetchTime=Date.now(),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>this.fetchWalletTokenAccounts({forceUpdate:!0}),t==null?void 0:t.commitment),{tokenAccounts:c,tokenAccountRawInfos:u}}async getCreatedTokenAccount({mint:t,programId:n=on,associatedOnly:o=!0}){await this.fetchWalletTokenAccounts();let i=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,c)=>a.amount.lt(c.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of i){let{publicKey:c}=a;if(c&&(!o||o&&s.equals(c)))return c}}async getOrCreateTokenAccount(t){var y,f,b,g;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:o,associatedOnly:i,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:c=!1,checkCreateATAOwner:u=!1}=t,l=new Tr(t.tokenProgram||on),m=this.getAssociatedTokenAccount(n,new Tr(l)),d=(a?[]:this.tokenAccountRawInfos).filter(A=>A.accountInfo.mint.equals(n)&&(!i||A.pubkey.equals(m))).sort((A,w)=>A.accountInfo.amount.lt(w.accountInfo.amount)?1:-1);if(o===void 0||d.length>0)return d.length>0?{account:d[0].pubkey}:{};let p={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(i){let A=Ni(s,m,s,n,l);if(u){let w=await this.scope.connection.getAccountInfo(m);if(w===null)(y=p.instructions)==null||y.push(A),p.instructionTypes.push(F.CreateATA);else if(!(w.owner.equals(l)&&Nn.decode(w.data).mint.equals(n)&&Nn.decode(w.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${m.toString()}`)}else p.instructions.push(A),p.instructionTypes.push(F.CreateATA);if(n.equals(z)&&o.amount){let w=await Et({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:o.payer||this.scope.ownerPubKey,amount:(f=o.amount)!=null?f:0,skipCloseAccount:c});p.instructions.push(...w.instructions||[]),p.endInstructions.push(...w.endInstructions||[]),p.instructionTypes.push(...w.instructionTypes||[]),p.endInstructionTypes.push(...w.endInstructionTypes||[]),o.amount&&(p.instructions.push(qa({source:w.addresses.newAccount,destination:m,owner:this.scope.ownerPubKey,amount:o.amount,tokenProgram:on})),p.instructionTypes.push(F.TransferAmount))}return c||(p.endInstructions.push(Ft({owner:s,payer:o.payer||s,tokenAccount:m,programId:l})),p.endInstructionTypes.push(F.CloseAccount)),{account:m,instructionParams:p}}else{let A=it({fromPublicKey:s,programId:l}),w=await this.scope.connection.getMinimumBalanceForRentExemption(Nn.span),k=xm.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:A.seed,newAccountPubkey:A.publicKey,lamports:w+Number((g=(b=o.amount)==null?void 0:b.toString())!=null?g:0),space:Nn.span,programId:l});return p.instructions.push(k,Oi({mint:n,tokenAccount:A.publicKey,owner:this.scope.ownerPubKey,programId:l})),p.instructionTypes.push(F.CreateAccount),p.instructionTypes.push(F.InitAccount),c||(p.endInstructions.push(Ft({owner:s,payer:o.payer||s,tokenAccount:A.publicKey,programId:l})),p.endInstructionTypes.push(F.CloseAccount)),{account:A.publicKey,instructionParams:p}}}async checkOrCreateAta({mint:t,programId:n=on,autoUnwrapWSOLToSOL:o}){var c;await this.fetchWalletTokenAccounts();let i=(c=this.scope.account.tokenAccounts.find(({mint:u})=>(u==null?void 0:u.toBase58())===t.toBase58()))==null?void 0:c.publicKey,s=this.scope.ownerPubKey,a={};if(!i){let u=this.getAssociatedTokenAccount(t,n),l=await Ni(s,u,s,t,n);a.instructions=[l],a.instructionTypes=[F.CreateATA],i=u}return o&&z.toBase58()===t.toBase58()&&(a.endInstructions=[Ft({owner:s,payer:s,tokenAccount:i,programId:n})],a.endInstructionTypes=[F.CloseAccount]),{pubKey:i,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:o,mint:i,programId:s=on,tokenAccount:a,payer:c=this.scope.ownerPubKey,bypassAssociatedCheck:u,skipCloseAccount:l,checkCreateATAOwner:m}=t,d=this.getAssociatedTokenAccount(i,s);if(new Tr(z).equals(i)){let p=await Et({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:c,amount:o,skipCloseAccount:l});return R({tokenAccount:p.addresses.newAccount},p)}else if(!a||n==="out"&&!d.equals(a)&&!u){let p=[],y=Ni(this.scope.ownerPubKey,d,this.scope.ownerPubKey,i,s);if(m){let f=await this.scope.connection.getAccountInfo(d);if(f===null)p.push(y);else if(!(f.owner.equals(on)&&Nn.decode(f.data).mint.equals(i)&&Nn.decode(f.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${i.toString()}, ata: ${d.toString()}`)}else p.push(y);return{tokenAccount:d,instructions:p,instructionTypes:[F.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:o=on,amount:i,useSOLBalance:s,handleTokenAccount:a}=t,c,u=this.createTxBuilder();if(n.equals(new Tr(z))&&s){let l=await this.handleTokenAccount({side:"in",amount:i||0,mint:n,bypassAssociatedCheck:!0,programId:o}),{tokenAccount:d}=l,p=Le(l,["tokenAccount"]);c=d,u.addInstruction(p)}else if(c=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:o}),!c&&a){let m=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:o}),{tokenAccount:d}=m,p=Le(m,["tokenAccount"]);c=d,u.addInstruction(p)}return R({tokenAccount:c},u.AllTxData)}};import{PublicKey as we,SystemProgram as Ym}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as jm}from"@solana/spl-token";import{PublicKey as ja}from"@solana/web3.js";var Mi=v([D("instruction")]),_i=v([D("instruction")]),Km=v([P("rewardState"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardLastUpdateTime"),P("totalReward"),P("totalRewardEmissioned"),P("rewardClaimed"),P("rewardPerSecond"),J("accRewardPerShare"),K("rewardVault"),K("rewardMint"),K("rewardSender"),P("rewardType"),X(P(),15,"padding")]),Cm=v([P("state"),P("nonce"),K("lpVault"),K("rewardVault"),K(),K(),P(),P(),P("totalReward"),J("perShareReward"),P("lastSlot"),P("perSlotReward")]),Rm=v([P("state"),P("nonce"),K("lpVault"),K("rewardVaultA"),P("totalRewardA"),J("perShareRewardA"),P("perSlotRewardA"),D("option"),K("rewardVaultB"),Ae(7),P("totalRewardB"),J("perShareRewardB"),P("perSlotRewardB"),P("lastSlot"),K()]),Lm=v([P(),P("state"),P("nonce"),P("validRewardTokenNum"),J("rewardMultiplier"),P("rewardPeriodMax"),P("rewardPeriodMin"),P("rewardPeriodExtend"),K("lpMint"),K("lpVault"),X(Km,5,"rewardInfos"),K("creator"),K(),X(P(),32,"padding")]),Ua=new Proxy(Cm,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return E(R({},o),{version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]})}:Reflect.get(r,e,t)}}),Ga=new Proxy(Rm,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return E(R({},o),{version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]})}:Reflect.get(r,e,t)}}),so=new Proxy(Lm,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return E(R({},o),{version:6,rewardInfos:o.rewardInfos.map(i=>{var s;return E(R({},i),{rewardType:((s=Object.entries(rn).find(a=>String(a[1])===i.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(r,e,t)}}),Om=v([P("isSet"),P("rewardPerSecond"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardType")]),vi=v([D("instruction"),P("nonce"),X(Om,5,"rewardTimeInfo")]),Vi=v([D("instruction"),P("rewardReopenTime"),P("rewardEndTime"),P("rewardPerSecond")]),Fi=v([D("instruction"),P("isSet"),P("rewardPerSecond"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardType")]),ew=v([P("state"),K("id"),K("owner"),P("deposited"),X(P(),1,"rewardDebts")]),ao=v([P("state"),K("id"),K("owner"),P("deposited"),X(J(),1,"rewardDebts"),P(""),P("voteLockedBalance"),X(P(),15)]),tw=v([P("state"),K("id"),K("owner"),P("deposited"),X(P(),2,"rewardDebts")]),Xa=v([P("state"),K("id"),K("owner"),P("deposited"),X(J(),2,"rewardDebts"),X(P(),17)]),za=v([P(),P("state"),K("id"),K("owner"),P("deposited"),X(J(),5,"rewardDebts"),X(P(),16)]),Je=v([D("instruction"),P("amount")]),Nm=v([K("mint"),K("grantAuthority"),P("baselineVoteWeightScaledFactor"),P("maxExtraLockupVoteWeightScaledFactor"),P("lockupSaturationSecs"),Fa("digitShift"),X(D(),7,"reserved1"),X(P(),7,"reserved2")]),Qa=v([Ae(8),K("governanceProgramId"),K("realm"),K("realmGoverningTokenMint"),K("realmAuthority"),X(D(),32,"reserved1"),X(Nm,4,"votingMints"),Ln("timeOffset"),D("bump"),X(D(),7,"reserved2"),X(P(),11,"reserved3")]),Mm=v([Ln("startTime"),Ln("endTime"),D("kind"),X(D(),15,"reserved")]),_m=v([X(Mm,1,"lockup"),P("amountDeposited_native"),P("amountInitiallyLockedNative"),ze("isUsed"),ze("allowClawback"),D("votingMintConfigIdx"),X(D(),29,"reserved")]),Ya=v([Ae(8),K("voterAuthority"),K("registrar"),X(_m,32,"deposits"),D("voterBump"),D("voterWweightRecordBump"),X(D(),94,"reserved")]);var cw=ue("Raydium_farm_config"),Ha=new ja("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Za=new ja("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),$a={3:Ua,5:Ga,6:so},Ja={3:ao,5:Xa,6:za},Ei=r=>[3,5,6].indexOf(r)!==-1,Di=r=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=r,o=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,i={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}};return(s=i[e])==null?void 0:s.call(i)},rn={"Standard SPL":0,"Option tokens":1},bt={[Aa.toString()]:3,[wa.toString()]:5,[Zn.toString()]:6};import{PublicKey as ae,SystemProgram as mn,SYSVAR_CLOCK_PUBKEY as lo,SYSVAR_RENT_PUBKEY as Fm,TransactionInstruction as De}from"@solana/web3.js";import Ir from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Em,createAssociatedTokenAccountInstruction as Dm,TOKEN_PROGRAM_ID as mt}from"@solana/spl-token";function Wi(r,e,t){return se([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],r)}function qi(r,e){return se([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],r)}function Ui(r,e){return se([e.toBuffer()],r)}function Gi(r,e,t){return se([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],r)}function Xi(r,e,t){return se([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],r)}function zi(r,e,t,n){return se([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}import st from"bn.js";var uo=ue("Raydium.farm.util");function co({programId:r,poolId:e,mint:t,type:n}){let{publicKey:o}=se([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],r);return o}function Ye({programId:r,poolId:e,owner:t,version:n}){let{publicKey:o}=se([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],r);return o}var eu=({programId:r,poolId:e})=>se([e.toBuffer()],r);function tu(r){return{isSet:new st(1),rewardPerSecond:Y(r.perSecond),rewardOpenTime:Y(r.openTime),rewardEndTime:Y(r.endTime),rewardType:Y(rn[r.rewardType])}}function Qi(r){return Y(r.endTime).sub(Y(r.openTime)).mul(Y(r.perSecond))}function Mn(r){let e=Ja[r];return e||uo.logWithError("invalid version",r),e}function vm(r){let e=$a[r];return e||uo.logWithError("invalid version",r),e}function Vm(r,e,t,n){if(r.version===3||r.version===5){if(r.lastSlot.gte(new st(t)))return r;let o=new st(t).sub(r.lastSlot);r.lastSlot=new st(t);for(let i of r.rewardInfos){if(e.amount.eq(new st(0)))continue;let s=i.perSlotReward.mul(o);i.perShareReward=i.perShareReward.add(s.mul(new st(10).pow(new st(r.version===3?9:15))).div(e.amount)),i.totalReward=i.totalReward.add(s)}}else if(r.version===6)for(let o of r.rewardInfos){if(o.rewardState.eq(new st(0)))continue;let i=st.min(new st(n),o.rewardEndTime);if(o.rewardOpenTime.gte(i))continue;let a=i.sub(o.rewardLastUpdateTime).mul(o.rewardPerSecond),c=o.totalReward.sub(o.totalRewardEmissioned);c.lt(a)?(a=c,o.rewardLastUpdateTime=o.rewardLastUpdateTime.add(c.div(o.rewardPerSecond))):o.rewardLastUpdateTime=i,!e.amount.eq(new st(0))&&(o.accRewardPerShare=o.accRewardPerShare.add(a.mul(r.rewardMultiplier).div(e.amount)),o.totalRewardEmissioned=o.totalRewardEmissioned.add(a))}return r}async function xw({connection:r,farmPools:e,owner:t,config:n,chainTime:o}){let i=!1,s=!1,a=new st(10),c=[];for(let d of e){let p=Te(d);p.version===6?s=!0:i=!0,c.push({pubkey:p.id,version:p.version,key:"state",poolId:p.id},{pubkey:p.lpVault,version:p.version,key:"lpVault",poolId:p.id}),t&&c.push({pubkey:Ye({programId:p.programId,poolId:p.id,owner:t,version:d.version}),version:p.version,key:"ledger",poolId:p.id})}let u={},l=await Me(r,c,n);for(let{pubkey:d,version:p,key:y,poolId:f,accountInfo:b}of l){let g=f.toBase58();if(u[g]=R({},u[g]),y==="state"){let A=vm(p);(!b||!b.data||b.data.length!==A.span)&&uo.logWithError(`invalid farm state account info, pools.id, ${d}`),u[g].state=A.decode(b.data)}else if(y==="lpVault")(!b||!b.data||b.data.length!==nn.span)&&uo.logWithError(`invalid farm lp vault account info, pools.lpVault, ${d}`),u[g].lpVault=nn.decode(b.data);else if(y==="ledger"){let A=Mn(p);b&&b.data&&(b.data.length!==A.span&&uo.logWithError(`invalid farm ledger account info, ledger, ${d}`),u[g].ledger=A.decode(b.data))}}let m=s||i?await r.getSlot():0;for(let d of Object.keys(u))u[d]!==void 0&&(u[d].state=Vm(u[d].state,u[d].lpVault,m,o));for(let[d,{state:p,ledger:y}]of Object.entries(u))if(y){let f=p.version===6?p.rewardMultiplier:p.rewardInfos.length===1?a.pow(new st(9)):a.pow(new st(15)),b=p.rewardInfos.map((g,A)=>{let w=y.rewardDebts[A];return y.deposited.mul(p.version===6?g.accRewardPerShare:g.perShareReward).div(f).sub(w)});u[d].wrapped=E(R({},u[d].wrapped),{pendingRewards:b})}return u}function Sw(r,e=Date.now()){if(r.version===6){let t=r.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>ca(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>la(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=r.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function Yi(r,e,t,n){let o=await r.getAccountInfo(e);if(o===null)throw Error("registrar info check error");let s=Qa.decode(o.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await r.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let u=Ya.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return u===-1?{index:s,isInit:!1}:{index:u,isInit:!0}}var Wm=ue("Raydium_farm_instruction"),mo={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function po(r){let{version:e,id:t,ledger:n,programId:o,owner:i}=r,s={3:9,5:10}[e];s||Wm.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(Mi.span);Mi.encode({instruction:s},a);let c=[h({pubkey:t}),h({pubkey:n}),h({pubkey:i,isWritable:!1}),h({pubkey:mn.programId,isWritable:!1}),h({pubkey:Fm,isWritable:!1})];return{instruction:new De({programId:o,keys:c,data:a}),instructionType:F.FarmV3CreateLedger}}function nu(r){var n;let e=Buffer.alloc(vi.span);vi.encode({instruction:0,nonce:new Ir(r.nonce),rewardTimeInfo:r.rewardInfoConfig},e);let t=[...li,h({pubkey:r.farmId}),h({pubkey:r.farmAuthority,isWritable:!1}),h({pubkey:r.lpVault}),h({pubkey:r.lpMint,isWritable:!1}),h({pubkey:r.lockVault}),h({pubkey:r.lockMint,isWritable:!1}),h({pubkey:(n=r.lockUserAccount)!=null?n:Ve}),h({pubkey:r.owner,isWritable:!1,isSigner:!0})];for(let o of r.rewardInfo)t.push(h({pubkey:o.rewardMint,isWritable:!1}),h({pubkey:o.rewardVault}),h({pubkey:o.userRewardToken}));return{instruction:new De({programId:r.programId,keys:t,data:e}),instructionType:F.FarmV6Create}}function ou(r){let e=Buffer.alloc(_i.span);_i.encode({instruction:5},e);let t=[h({pubkey:mt,isWritable:!1}),h({pubkey:r.id}),h({pubkey:r.authority,isWritable:!1}),h({pubkey:r.lpVault,isWritable:!1}),h({pubkey:r.rewardVault}),h({pubkey:r.userRewardToken}),h({pubkey:r.owner,isWritable:!1,isSigner:!0})];return{instruction:new De({programId:r.programId,keys:t,data:e}),instructionType:F.FarmV6CreatorWithdraw}}function qm(r,e,t,n,o,i,s,a,c,u,l,m,d){let p=v([D("depositEntryIndex"),P("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:mt,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:Jo,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({depositEntryIndex:m,amount:d},f);let b=Buffer.from([...mo.voterStakeRegistryDeposit,...f]);return new De({keys:y,programId:r,data:b})}function Um(r,e,t,n){let o=v([]),i=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:mn.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([...mo.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new De({keys:i,programId:r,data:a})}function Gm(r,e,t,n,o,i,s,a,c,u,l,m,d,p,y){let f=v([D("depositEntryIndex"),P("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:mt,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:Jo,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({depositEntryIndex:p,amount:y},g);let A=Buffer.from([...mo.voterStakeRegistryWithdraw,...g]);return new De({keys:b,programId:r,data:A})}function Xm(r,e,t,n,o,i){let s=v([D("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:mn.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({ins:23},c),new De({keys:a,programId:r,data:c})}function zm(r,e,t,n,o,i,s,a){let c=v([D("voterBump"),D("voterWeightRecordBump")]),u=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:mn.programId,isSigner:!1,isWritable:!1},{pubkey:ot,isSigner:!1,isWritable:!1},{pubkey:Jo,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({voterBump:s,voterWeightRecordBump:a},l);let m=Buffer.from([...mo.voterStakeRegistryCreateVoter,...l]);return new De({keys:u,programId:r,data:m})}function Qm(r,e,t,n,o,i,s,a,c,u,l,m){let d=v([D("depositEntryIndex"),D("kind"),D("option"),P("startTs"),Xe("periods"),ze("allowClawback")]),p=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:mn.programId,isSigner:!1,isWritable:!1},{pubkey:mt,isSigner:!1,isWritable:!1},{pubkey:Em,isSigner:!1,isWritable:!1},{pubkey:ot,isSigner:!1,isWritable:!1}],y=Buffer.alloc(d.span);d.encode({depositEntryIndex:a,kind:c,option:u===void 0?0:1,startTs:u,periods:l,allowClawback:m},y);let f=Buffer.from([...mo.voterStakeRegistryCreateDepositEntry,...y]);return new De({keys:p,programId:r,data:f})}async function Uw({connection:r,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:i,owner:s,poolId:a,tokenProgram:c}){let u=Wi(n,o,i).publicKey,l=Ye({programId:e,poolId:a,owner:s,version:3}),m=await r.getAccountInfo(l);if(m===null)throw Error("user is not staker");let d=ao.decode(m.data),p=d.deposited.sub(d.voteLockedBalance);if(console.log("amount",p.toString()),p.eq(new Ir(0)))throw Error("user do not has new stake amount");let y=qi(e,a).publicKey,f=Ui(e,a).publicKey,{publicKey:b,nonce:g}=Gi(n,u,s),A=ye(b,y,c).publicKey,{publicKey:w,nonce:k}=Xi(n,u,s),I=zi(t,o,i,s).publicKey,T=[],S=ye(s,y,c).publicKey;if(await r.getAccountInfo(S)===null&&T.push(Dm(s,S,s,y)),await r.getAccountInfo(b)===null){let W=Xm(t,o,s,i,s,I);T.push(W,zm(n,u,b,w,s,s,g,k))}let{index:x,isInit:L}=await Yi(r,u,b,y);return L||T.push(Qm(n,u,b,A,s,s,y,x,0,void 0,0,!1)),T.push(qm(n,u,b,A,S,s,l,a,y,f,e,x,p),Um(n,u,b,w)),T}async function Gw({connection:r,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:i,owner:s,poolId:a,tokenProgram:c}){let u=Wi(n,o,i).publicKey,l=Ye({programId:e,poolId:a,owner:s,version:3}),m=await r.getAccountInfo(l);if(m===null)throw Error("user is not staker");let d=ao.decode(m.data);if(d.voteLockedBalance.eq(new Ir(0)))throw Error("user has vote locked balance = 0");let p=qi(e,a).publicKey,y=Ui(e,a).publicKey,{publicKey:f}=Gi(n,u,s),b=ye(f,p,c).publicKey,{publicKey:g}=Xi(n,u,s),A=zi(t,o,i,s).publicKey,w=[],{index:k,isInit:I}=await Yi(r,u,f,p);if(!I)throw Error("deposit entry index check error");return w.push(Gm(n,u,f,s,A,g,b,ye(s,p,c).publicKey,l,a,p,y,e,k,d.voteLockedBalance)),w}function ji({payer:r,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:o}){let i=Buffer.alloc(Vi.span);Vi.encode({instruction:3,rewardReopenTime:Y(o.openTime),rewardEndTime:Y(o.endTime),rewardPerSecond:Y(o.perSecond)},i);let s=[h({pubkey:mt,isWritable:!1}),h({pubkey:n.id}),h({pubkey:n.lpVault,isWritable:!1}),h({pubkey:e}),h({pubkey:t}),h({pubkey:r,isWritable:!1,isSigner:!0})];return new De({programId:n.programId,keys:s,data:i})}function Hi({payer:r,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:o}){let i=Buffer.alloc(Fi.span);Fi.encode({instruction:4,isSet:new Ir(1),rewardPerSecond:Y(o.perSecond),rewardOpenTime:Y(o.openTime),rewardEndTime:Y(o.endTime),rewardType:Y(rn[o.rewardType])},i);let s=[...li,h({pubkey:t.id}),h({pubkey:t.authority,isWritable:!1}),h({pubkey:o.mint,isWritable:!1}),h({pubkey:n}),h({pubkey:e}),h({pubkey:r,isWritable:!1,isSigner:!0})];return new De({programId:t.programId,keys:s,data:i})}function Xw(r){let{farmInfo:e,farmKeys:t,version:n,lpAccount:o,rewardAccounts:i,owner:s,instruction:a,amount:c,deposit:u}=r,[l,m]=[new ae(e.programId),new ae(e.id)],d=Ye({programId:l,poolId:m,owner:s,version:n}),p=Buffer.alloc(Je.span);Je.encode({instruction:a,amount:c},p);let y=n===6?[h({pubkey:mt,isWritable:!1}),...u?[h({pubkey:mn.programId,isWritable:!1})]:[],h({pubkey:m}),h({pubkey:new ae(t.authority),isWritable:!1}),h({pubkey:new ae(t.lpVault)}),h({pubkey:d}),h({pubkey:s,isWritable:!1,isSigner:!0}),h({pubkey:o})]:[h({pubkey:m}),h({pubkey:new ae(t.authority),isWritable:!1}),h({pubkey:d}),h({pubkey:s,isWritable:!1,isSigner:!0}),h({pubkey:o}),h({pubkey:new ae(t.lpVault)}),h({pubkey:i[0]}),h({pubkey:new ae(t.rewardInfos[0].vault)}),h({pubkey:lo,isWritable:!1}),h({pubkey:mt,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)y.push(h({pubkey:i[f]})),y.push(h({pubkey:new ae(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)y.push(h({pubkey:new ae(t.rewardInfos[f].vault)})),y.push(h({pubkey:i[f]}));return new De({programId:l,keys:y,data:p})}function fo(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s}=r,[a,c]=[new ae(e.programId),new ae(e.id)],u=Ye({programId:a,poolId:c,owner:i,version:6}),l=Buffer.alloc(Je.span);Je.encode({instruction:2,amount:Y(s)},l);let m=[h({pubkey:mt,isWritable:!1}),h({pubkey:c}),h({pubkey:new ae(t.authority),isWritable:!1}),h({pubkey:new ae(t.lpVault)}),h({pubkey:u}),h({pubkey:i,isWritable:!1,isSigner:!0}),h({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(h({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(h({pubkey:o[d]}));return new De({programId:a,keys:m,data:l})}function yo(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new ae(e.programId),new ae(e.id)],l=Ye({programId:c,poolId:u,owner:i,version:5}),m=Buffer.alloc(Je.span);Je.encode({instruction:12,amount:Y(s)},m);let d=[h({pubkey:u}),h({pubkey:new ae(t.authority),isWritable:!1}),h({pubkey:l}),h({pubkey:i,isWritable:!1,isSigner:!0}),h({pubkey:n}),h({pubkey:new ae(t.lpVault)}),h({pubkey:o[0]}),h({pubkey:new ae(t.rewardInfos[0].vault)}),h({pubkey:lo,isWritable:!1}),h({pubkey:mt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(h({pubkey:o[p]})),d.push(h({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(h({pubkey:p}));return new De({programId:c,keys:d,data:m})}function bo(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new ae(e.programId),new ae(e.id)],l=Ye({programId:c,poolId:u,owner:i,version:3}),m=Buffer.alloc(Je.span);Je.encode({instruction:11,amount:Y(s)},m);let d=[h({pubkey:u}),h({pubkey:new ae(t.authority),isWritable:!1}),h({pubkey:l}),h({pubkey:i,isWritable:!1,isSigner:!0}),h({pubkey:n}),h({pubkey:new ae(t.lpVault)}),h({pubkey:o[0]}),h({pubkey:new ae(t.rewardInfos[0].vault)}),h({pubkey:lo,isWritable:!1}),h({pubkey:mt,isWritable:!1})];if(a)for(let p of a)d.push(h({pubkey:p}));return new De({programId:c,keys:d,data:m})}function ru(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new ae(e.programId),new ae(e.id)],l=Ye({programId:c,poolId:u,owner:i,version:3}),m=Buffer.alloc(Je.span);Je.encode({instruction:10,amount:Y(s)},m);let d=[h({pubkey:u}),h({pubkey:new ae(t.authority),isWritable:!1}),h({pubkey:l}),h({pubkey:i,isWritable:!1,isSigner:!0}),h({pubkey:n}),h({pubkey:new ae(t.lpVault)}),h({pubkey:o[0]}),h({pubkey:new ae(t.rewardInfos[0].vault)}),h({pubkey:lo,isWritable:!1}),h({pubkey:mt,isWritable:!1})];if(a)for(let p of a)d.push(h({pubkey:p}));return new De({programId:c,keys:d,data:m})}function iu(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new ae(e.programId),new ae(e.id)],l=Ye({programId:c,poolId:u,owner:i,version:5}),m=Buffer.alloc(Je.span);Je.encode({instruction:11,amount:Y(s)},m);let d=[h({pubkey:u}),h({pubkey:new ae(t.authority),isWritable:!1}),h({pubkey:l}),h({pubkey:i,isWritable:!1,isSigner:!0}),h({pubkey:n}),h({pubkey:new ae(t.lpVault)}),h({pubkey:o[0]}),h({pubkey:new ae(t.rewardInfos[0].vault)}),h({pubkey:lo,isWritable:!1}),h({pubkey:mt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(h({pubkey:o[p]})),d.push(h({pubkey:new ae(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(h({pubkey:p}));return new De({programId:c,keys:d,data:m})}function su(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s}=r,[a,c]=[new ae(e.programId),new ae(e.id)],u=Ye({programId:a,poolId:c,owner:i,version:6}),l=Buffer.alloc(Je.span);Je.encode({instruction:1,amount:Y(s)},l);let m=[h({pubkey:mt,isWritable:!1}),h({pubkey:mn.programId,isWritable:!1}),h({pubkey:c}),h({pubkey:new ae(t.authority),isWritable:!1}),h({pubkey:new ae(t.lpVault)}),h({pubkey:u}),h({pubkey:i,isWritable:!1,isSigner:!0}),h({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(h({pubkey:new ae(t.rewardInfos[d].vault)})),m.push(h({pubkey:o[d]}));return new De({programId:a,keys:m,data:l})}var go=class extends Se{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(Ve)){let n=await Et({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:Qi(E(R({},t),{openTime:t.openTime.toString(),endTime:t.endTime.toString()}))});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:o=Zn,txVersion:i}){this.checkDisabled(),this.scope.checkOwner();let a={lpMint:new we(e.lpMint.address),lockInfo:{lockMint:Ha,lockVault:Za},version:6,rewardInfos:t,programId:o},c=this.createTxBuilder(),u=n!=null?n:this.scope.ownerPubKey,l=it({fromPublicKey:u,programId:a.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(so.span);c.addInstruction({instructions:[Ym.createAccountWithSeed({fromPubkey:u,basePubkey:u,seed:l.seed,newAccountPubkey:l.publicKey,lamports:m,space:so.span,programId:a.programId})]});let{publicKey:d,nonce:p}=eu({programId:new we(a.programId),poolId:l.publicKey}),y=co({programId:a.programId,poolId:l.publicKey,mint:a.lpMint,type:"lpVault"}),f=[],b=[];for(let I of a.rewardInfos){I.openTime>=I.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",I.openTime.toString()),isNaN(rn[I.rewardType])&&this.logAndCreateError("rewardType error",I.rewardType),Number(I.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",I.perSecond),f.push(tu(I));let{rewardPubKey:T,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:I,payer:u});S&&c.addInstruction(S),T||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let B=I.mint.equals(Ve)?new we(ve.address):I.mint;b.push({rewardMint:B,rewardVault:co({programId:a.programId,poolId:l.publicKey,mint:B,type:"rewardVault"}),userRewardToken:T})}let{account:g,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({mint:new we(a.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});A&&c.addInstruction(A),g||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:w,instructionType:k}=nu({farmId:l.publicKey,owner:this.scope.ownerPubKey,farmAuthority:d,lpVault:y,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:g,programId:a.programId,rewardInfo:b,rewardInfoConfig:f,nonce:p});return c.addInstruction({instructions:[w],instructionTypes:[k]}).versionBuild({txVersion:i,extInfo:{farmId:l.publicKey,farmAuthority:d,lpVault:y,lockUserAccount:g,nonce:p}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:o}){var b;let i=bt[e.programId];i!==6&&this.logAndCreateError("invalid farm version ",i);let s=Te((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let c=t||this.scope.ownerPubKey,u=n.mint.equals(Ve)?new we(ve.address):n.mint,l=a.rewardInfos.findIndex(g=>new we(g.mint.address).equals(u)),m=s.rewardInfos[l];m||this.logAndCreateError("configuration does not exist","rewardMint",u);let d=(b=m.vault)!=null?b:Ve,p=this.createTxBuilder(),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:n,payer:c});return f&&p.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),p.addInstruction({instructions:[ji({payer:this.scope.ownerPubKey,rewardVault:d,userRewardTokenPub:y,farmKeys:a,rewardInfo:n})],instructionTypes:[F.FarmV6Restart]}).versionBuild({txVersion:o})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:o}){var l;let i=bt[e.programId];i!==6&&this.logAndCreateError("invalid farm version ",i);let s=Te((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.forEach(m=>{m.openTime>=m.endTime&&this.logAndCreateError("start time error","newRewardInfo",m)});let c=t||this.scope.ownerPubKey,u=this.createTxBuilder();for(let m of n){let d=m.mint.equals(Ve)?new we(ve.address):m.mint,p=a.rewardInfos.findIndex(w=>new we(w.mint.address).equals(d)),y=s.rewardInfos[p];y||this.logAndCreateError("configuration does not exist","rewardMint",d);let f=(l=y.vault)!=null?l:Ve,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:m,payer:c});g&&u.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let A=ji({payer:this.scope.ownerPubKey,rewardVault:f,userRewardTokenPub:b,farmKeys:a,rewardInfo:m});u.addInstruction({instructions:[A],instructionTypes:[F.FarmV6Restart]})}return u.versionBuild({txVersion:o})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:o,payer:i}=e,s=bt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Te((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),c=i!=null?i:this.scope.ownerPubKey,u=this.createTxBuilder(),l=o.mint.equals(Ve)?new we(ve.address):o.mint,m=co({programId:new we(n.programId),poolId:new we(n.id),mint:l,type:"rewardVault"}),{rewardPubKey:d,newInstruction:p}=await this._getUserRewardInfo({rewardInfo:o,payer:c});return p&&u.addInstruction(p),d||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),o.mint=l,u.addInstruction({instructions:[Hi({payer:this.scope.ownerPubKey,userRewardTokenPub:d,farmKeys:a,rewardVault:m,rewardInfo:o})],instructionTypes:[F.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:o,payer:i}=e,s=bt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Te((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),c=i!=null?i:this.scope.ownerPubKey,u=this.createTxBuilder();for(let l of o){let m=l.mint.equals(Ve)?new we(ve.address):l.mint,d=co({programId:new we(n.programId),poolId:new we(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:l,payer:c});y&&u.addInstruction(y),p||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let f=Hi({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:a,rewardVault:d,rewardInfo:E(R({},l),{mint:m})});u.addInstruction({instructions:[f],instructionTypes:[F.FarmV6CreatorAddReward]})}return u.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:o,feePayer:i,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:d}=n,p=bt[d];Ei(p)||this.logAndCreateError("invalid farm program:",n.programId);let[y,f]=[new we(n.programId),new we(n.id)],b=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],g=Ye({programId:y,poolId:f,owner:this.scope.ownerPubKey,version:p}),A=this.createTxBuilder();A.addCustomComputeBudget(l);let w={};for(let _ of this.scope.account.tokenAccounts)if(a){let $=ye(this.scope.ownerPubKey,_.mint,_.programId).publicKey;_.publicKey&&$.equals(_.publicKey)&&(w[_.mint.toString()]=_.publicKey)}else w[_.mint.toString()]=_.publicKey;let k=b.lpMint,I=w[k.address];I||this.logAndCreateError("you don't have any lp","lp zero",w);let T=[];for(let _ of m){let $=s&&_.mint.address===z.toString(),G=w[_.mint.address];if(!G){let{account:q,instructionParams:$e}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:_.mint.programId,mint:new we(_.mint.address),notUseTokenAccount:$,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!$,associatedOnly:$?!1:a,checkCreateATAOwner:c});G=q,$e&&A.addInstruction($e)}w[_.mint.address]=G,T.push(G)}let S,B=await this.scope.connection.getAccountInfo(g);if(B&&(S=Mn(p).decode(B.data)),n.programId!==Zn.toString()&&!S){let{instruction:_,instructionType:$}=po({id:f,programId:y,version:p,ledger:g,owner:this.scope.ownerPubKey});A.addInstruction({instructions:[_],instructionTypes:[$]})}let C=Di({version:p,rewardInfos:m,rewardTokenAccountsPublicKeys:T});C&&this.logAndCreateError(C);let x={amount:Y(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:b,lpAccount:I,rewardAccounts:T,userAuxiliaryLedgers:u==null?void 0:u.map(_=>new we(_))},L=p===6?su(x):p===5?iu(x):ru(x),W={3:F.FarmV3Deposit,5:F.FarmV5Deposit,6:F.FarmV6Deposit};return A.addInstruction({instructions:[L],instructionTypes:[W[p]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:o,deposited:i,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m}=e,{rewardInfos:d}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let p=bt[n.programId];Ei(p)||this.logAndCreateError("invalid farm program:",n.programId);let y=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],f=this.createTxBuilder();f.addCustomComputeBudget(m);let b={};for(let C of this.scope.account.tokenAccounts)if(c){let x=ye(this.scope.ownerPubKey,C.mint).publicKey;C.publicKey&&x.equals(C.publicKey)&&(b[C.mint.toString()]=C.publicKey)}else b[C.mint.toString()]=C.publicKey;if(i)i.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else{let C=Ye({programId:new we(n.programId),poolId:new we(n.id),owner:this.scope.ownerPubKey,version:p}),x=await this.scope.connection.getAccountInfo(C);if(x)Mn(p).decode(x.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(p!==6&&(l||[]).length>0){let{instruction:L,instructionType:W}=po({id:new we(y.id),programId:new we(y.programId),version:p,ledger:C,owner:this.scope.ownerPubKey});f.addInstruction({instructions:[L],instructionTypes:[W]})}else this.logAndCreateError("no lp data",{farmId:n.id,version:p,ledgerData:x})}let g=y.lpMint.address,A=s&&g===z.toString(),w=b[g.toString()];if(!w){let{account:C,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.lpMint.programId,mint:new we(g),notUseTokenAccount:A,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:A?!1:c,checkCreateATAOwner:u});w=C,x&&f.addInstruction(x)}b[g.toString()]=w;let k=[];for(let C of d){let x=s&&C.mint.address===z.toString(),L=b[C.mint.address];if(!L){let{account:W,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:C.mint.programId,mint:new we(C.mint.address),notUseTokenAccount:x,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!x,associatedOnly:x?!1:c,checkCreateATAOwner:u});L=W,_&&f.addInstruction(_)}b[C.mint.address]=L,k.push(L)}let I=Di({version:p,rewardInfos:d,rewardTokenAccountsPublicKeys:k});I&&this.logAndCreateError(I);let T={amount:Y(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:y,lpAccount:w,rewardAccounts:k,userAuxiliaryLedgers:l==null?void 0:l.map(C=>new we(C))},S=p===6?fo(T):p===5?yo(T):bo(T),B={3:F.FarmV3Withdraw,5:F.FarmV5Withdraw,6:F.FarmV6Withdraw};return f.addInstruction({instructions:[S],instructionTypes:[B[p]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n}){var p;this.scope.checkOwner();let o=Te((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),i=bt[e.programId];i!==6&&this.logAndCreateError("invalid farm version",i);let s=e.rewardInfos.findIndex(y=>y.mint.address===Ve.toString()?new we(ve.address):t),a=o.rewardInfos[s];a||this.logAndCreateError("withdraw mint error","rewardInfos",e);let c=(p=a==null?void 0:a.vault)!=null?p:Ve,u=this.createTxBuilder(),l;if(t.equals(Ve)){let y=await Et({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:Qi(E(R({},a),{openTime:a.openTime,endTime:a.endTime,perSecond:new O(a.perSecond).mul(10**a.mint.decimals).toString()}))});l=y.addresses.newAccount,u.addInstruction(y)}else{let y=await this.scope.account.getCreatedTokenAccount({mint:t});y===null?(l=await this.scope.account.getAssociatedTokenAccount(t),u.addInstruction({instructions:[jm(this.scope.ownerPubKey,l,this.scope.ownerPubKey,t)],instructionTypes:[F.CreateATA]})):l=y}let{instruction:m,instructionType:d}=ou({programId:o.programId,id:o.id,authority:o.authority,lpVault:o.lpVault,rewardVault:c,userRewardToken:l,owner:this.scope.ownerPubKey});return u.addInstruction({instructions:[m],instructionTypes:[d]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(),m={};for(let y of this.scope.account.tokenAccounts)if(i){let f=ye(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(m[y.mint.toString()]=y.publicKey)}else m[y.mint.toString()]=y.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>E(R({},y),{[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:g,id:A}=y,w=bt[f],k=b.address,I=n&&k===z.toString(),T=m[k];if(!T){let{account:W,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new we(k),notUseTokenAccount:I,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:I?!1:i,checkCreateATAOwner:s});T=W,_&&l.addInstruction(_)}m[k.toString()]=T;let S=[];for(let W of g){let _=n&&W.mint.address===z.toString(),$=m[W.mint.address];if(!$){let{account:G,instructionParams:q}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:W.mint.programId,mint:new we(W.mint.address),notUseTokenAccount:_,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!_,associatedOnly:_?!1:i,checkCreateATAOwner:s});$=G,q&&l.addInstruction(q)}m[W.mint.address]=$,S.push($)}let B=p[A],C={amount:yt,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:B,lpAccount:T,rewardAccounts:S,userAuxiliaryLedgers:a==null?void 0:a.map(W=>new we(W))},x=w===6?fo(C):w===5?yo(C):bo(C),L={3:F.FarmV3Withdraw,5:F.FarmV5Withdraw,6:F.FarmV6Withdraw};l.addInstruction({instructions:[x],instructionTypes:[L[w]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as He}from"@solana/web3.js";import{AccountLayout as Dd,NATIVE_MINT as Gu,TOKEN_PROGRAM_ID as En}from"@solana/spl-token";import{Keypair as is,PublicKey as U,SystemProgram as _n,TransactionInstruction as ft}from"@solana/web3.js";import xu from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Su,TOKEN_2022_PROGRAM_ID as qt,TOKEN_PROGRAM_ID as Ne}from"@solana/spl-token";import ud from"bn.js";import gt from"bn.js";var de=new gt(0),dt=new gt(1),Dt=new gt(-1),pt=new gt(1).shln(64),Br=new gt(1).shln(128),Zi=pt.sub(dt),Ao=64,au=Br.subn(1),je=-443636,et=-je,At=new gt("4295048016"),wt=new gt("79226673521066979257578248091"),xr=new gt("4295048017"),Sr=new gt("79226673521066979257578248090"),uu=16,cu="59543866431248",lu="184467440737095516",mu="15793534762490258745",Kr=new gt(10).pow(new gt(6)),Hm=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(Hm||{}),kP={[500]:10,[3e3]:60,[1e4]:200},TP={version:6,liquidity:de,tickCurrent:0,feeGrowthGlobalX64A:de,feeGrowthGlobalX64B:de,protocolFeesTokenA:de,protocolFeesTokenB:de,swapInAmountTokenA:de,swapOutAmountTokenB:de,swapInAmountTokenB:de,swapOutAmountTokenA:de,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},du={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},IP=new gt("18446744073700000000");import ie from"bn.js";function pu(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r,!1),new Uint8Array(e)}function xP(r){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,r,!1),new Uint8Array(e)}function SP(r){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,r,!1),new Uint8Array(e)}function Cr(r){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,r,!1),new Uint8Array(e)}function $i(r,e){let t=0;for(let n=r-1;n>=0&&!e.testn(n);n--)t++;return t}function Ji(r,e){let t=0;for(let n=0;n<r&&!e.testn(n);n++)t++;return t}function wo(r,e){for(let t=0;t<r;t++)if(e.testn(t))return!1;return!0}function fu(r,e){return wo(r,e)?null:$i(r,e)}function yu(r,e){return wo(r,e)?null:Ji(r,e)}var Zm=Buffer.from("amm_config","utf8"),$m=Buffer.from("pool","utf8"),Jm=Buffer.from("pool_vault","utf8"),ed=Buffer.from("pool_reward_vault","utf8"),bu=Buffer.from("position","utf8"),td=Buffer.from("tick_array","utf8"),nd=Buffer.from("operation","utf8"),od=Buffer.from("pool_tick_array_bitmap_extension","utf8"),rd=Buffer.from("observation","utf8");function LP(r,e){return se([Zm,pu(e)],r)}function gu(r,e,t,n){return se([$m,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function es(r,e,t){return se([Jm,e.toBuffer(),t.toBuffer()],r)}function Au(r,e,t){return se([ed,e.toBuffer(),t.toBuffer()],r)}function be(r,e,t){return se([td,e.toBuffer(),Cr(t)],r)}function sn(r,e,t,n){return se([bu,e.toBuffer(),Cr(t),Cr(n)],r)}function at(r,e){return se([bu,e.toBuffer()],r)}function Rr(r){return se([Buffer.from("metadata","utf8"),Cn.toBuffer(),r.toBuffer()],Cn)}function Po(r){return se([nd],r)}function ut(r,e){return se([od,e.toBuffer()],r)}function wu(r,e){return se([rd,e.toBuffer()],r)}var id=Buffer.from("locked_position","utf8");function ts(r,e){return se([id,e.toBuffer()],r)}import{PublicKey as Kt}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as Pu}from"@solana/spl-token";import Ie from"bn.js";import Ot from"bn.js";var ho=class{static getfeeGrowthInside(e,t,n){let o=new Ot(0),i=new Ot(0);e.tickCurrent>=t.tick?(o=t.feeGrowthOutsideX64A,i=t.feeGrowthOutsideX64B):(o=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),i=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new Ot(0),a=new Ot(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=ne.wrappingSubU128(ne.wrappingSubU128(e.feeGrowthGlobalX64A,o),s),u=ne.wrappingSubU128(ne.wrappingSubU128(e.feeGrowthGlobalX64B,i),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,o){let{feeGrowthInsideX64A:i,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=ne.mulDivFloor(ne.wrappingSubU128(i,t.feeGrowthInsideLastX64A),t.liquidity,pt),c=t.tokenFeesOwedA.add(a),u=ne.mulDivFloor(ne.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,pt),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,o){let{feeGrowthInsideX64A:i,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=ne.mulDivFloor(ne.wrappingSubU128(i,t.feeGrowthInsideLastX64A),t.liquidity,pt),c=t.tokenFeesOwedA.add(a),u=ne.mulDivFloor(ne.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,pt),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,o){let i=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ne.wrappingSubU128(c,u.growthInsideLastX64),m=ne.mulDivFloor(l,t.liquidity,pt),d=u.rewardAmountOwed.add(m);i.push(d)}return i}static GetPositionRewards(e,t,n,o){let i=[],s=this.getRewardGrowthInside(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ne.wrappingSubU128(c,u.growthInsideLastX64),m=ne.mulDivFloor(l,t.liquidity,pt),d=u.rewardAmountOwed.add(m);i.push(d)}return i}static getRewardGrowthInside(e,t,n,o){let i=[];for(let s=0;s<o.length;s++){let a=new Ot(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new Ot(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),i.push(ne.wrappingSubU128(ne.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return i}static getRewardGrowthInsideV2(e,t,n,o){let i=[];for(let s=0;s<o.length;s++){let a=new Ot(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new Ot(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),i.push(ne.wrappingSubU128(ne.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return i}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:o,add:i,epochInfo:s}){var b,g,A,w;let a=ee.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),c=ee.getSqrtPriceX64FromTick(t.tickLower),u=ee.getSqrtPriceX64FromTick(t.tickUpper),l=i?1+o:1-o,m=le.getAmountsFromLiquidity(a,c,u,n,i),[d,p]=[fe(m.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,s,!0),fe(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[y,f]=[fe(new Ot(new O(m.amountA.toString()).mul(l).toFixed(0)),(A=e.mintA.extensions)==null?void 0:A.feeConfig,s,!0),fe(new Ot(new O(m.amountB.toString()).mul(l).toFixed(0)),(w=e.mintB.extensions)==null?void 0:w.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:xt(d.expirationTime,p.expirationTime)}}};var sd=15,me=class{static async getTickArrays(e,t,n,o,i,s,a){let c=[],u=j.getTickArrayStartIndexByTick(o,i),l=j.getInitializedTickArrayInRange(s,a,i,u,Math.floor(sd/2));for(let p=0;p<l.length;p++){let{publicKey:y}=be(t,n,l[p]);c.push(y)}let m=(await ht(e,c)).map(p=>p!==null?ko.decode(p.data):null),d={};for(let p=0;p<c.length;p++){let y=m[p];y!==null&&(d[y.startTickIndex]=E(R({},y),{address:c[p]}))}return d}static nextInitializedTick(e,t,n,o,i,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,o,i,s);for(;a==null||a.liquidityGross.lten(0);){if(u=j.getNextTickArrayStartIndex(u,i,s),this.checkIsValidStartIndex(u,i))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,o,i){let s=Math.floor(e/me.tickCount(t)),a=n?j.searchLowBitFromStart(o,i,s-1,1,t):j.searchHightBitFromStart(o,i,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,o){let i;if(o){let a=Fe-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){i=c;break}a=a-1}}else{let a=0;for(;a<Fe;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){i=c;break}a=a+1}}let{publicKey:s}=be(e,t,n.startTickIndex);return{nextTick:i,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,o,i,s){let a=j.getTickArrayStartIndexByTick(o,i),c=Math.floor((o-a)/i),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c-1}else for(c=c+1;c<Fe;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c+1}let{publicKey:m}=be(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(j.checkIsOutOfBoundary(e)){if(e>et)return!1;let n=j.getTickArrayStartIndexByTick(je,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Fe*e}};var ns=14,Wt=class{static maxTickInTickarrayBitmap(e){return e*Fe*dn}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(o+=1);let i=n*o;return e<0?{minValue:-i,maxValue:-i+n}:{minValue:i,maxValue:i+n}}static nextInitializedTickArrayStartIndex(e,t,n,o){if(!me.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let i=this.maxTickInTickarrayBitmap(n),s=o?t-me.tickCount(n):t+me.tickCount(n);if(s<-i||s>=i)return{isInit:!1,tickIndex:t};let a=n*Fe,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(o){let l=e.shln(1024-u-1),m=fu(1024,l);if(m!==null){let d=(u-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-i}}else{let l=e.shrn(u),m=yu(1024,l);if(m!==null){let d=(u+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:i-me.tickCount(n)}}}},To=class{static getBitmapOffset(e,t){if(!me.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Wt.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&o--,o}static getBitmap(e,t,n){let o=this.getBitmapOffset(e,t);return e<0?{offset:o,tickarrayBitmap:n.negativeTickArrayBitmap[o]}:{offset:o,tickarrayBitmap:n.positiveTickArrayBitmap[o]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:o}=this.extensionTickBoundary(t);if(e>=o&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Wt.maxTickInTickarrayBitmap(e),n=-t;if(et<=t)throw Error(`extensionTickBoundary check error: ${et}, ${t}`);if(n<=je)throw Error(`extensionTickBoundary check error: ${n}, ${je}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:o}=this.getBitmap(e,t,n),i=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:j.mergeTickArrayBitmap(o).testn(i),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,o){let i=me.tickCount(t),s=n?e-i:e+i,{tickarrayBitmap:a}=this.getBitmap(s,t,o);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,o){let{minValue:i,maxValue:s}=Wt.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(o){let c=j.mergeTickArrayBitmap(e).shln(dn-1-a),u=wo(512,c)?null:$i(512,c);if(u!==null){let l=t-u*me.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:i}}else{let c=j.mergeTickArrayBitmap(e).shrn(a),u=wo(512,c)?null:Ji(512,c);if(u!==null){let l=t+u*me.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-me.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Wt.maxTickInTickarrayBitmap(t),o=Math.floor(n/me.tickCount(t));return e<0&&n!=0&&(o=dn-o),o}};var Ke=class{static getOutputAmountAndRemainAccounts(e,t,n,o,i,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!m)throw new Error("Invalid tick array");c.push(m);let{allTrade:d,amountCalculated:p,accounts:y,sqrtPriceX64:f,feeAmount:b}=pn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o,l,i,s);return c.push(...y),{allTrade:d,expectedAmountOut:p.mul(Dt),remainingAccounts:c,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,o,i){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=be(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:y}=pn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o.mul(Dt),u,i);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:o}=Ke.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?To.checkTickArrayIsInit(me.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):j.checkTickArrayIsInitialized(j.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=be(e.programId,e.id,o);return{isExist:!0,startIndex:o,nextAccountMeta:a}}let{isExist:i,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,me.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(i){let{publicKey:a}=be(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/me.tickCount(e.tickSpacing)),o=t?j.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):j.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return o.length>0?{isExist:!0,nextStartIndex:o[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=me.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:o,tickIndex:i}=Wt.nextInitializedTickArrayStartIndex(j.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(o)return{isExist:!0,nextStartIndex:i};t=i;let{isInit:s,tickIndex:a}=To.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<je||t>et)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:o,rewardInfos:i}){var a,c,u;let s=[];for(let l=0;l<i.length;l++){let m=i[l],d=(u=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?u:(c=await e.getAccountInfo(m.tokenMint))==null?void 0:c.owner;if(d===void 0)throw Error("get new reward mint info error");let p=E(R({},m),{perSecond:ne.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Kt(d)});if(p.tokenMint.equals(Kt.default))continue;if(n<=p.openTime.toNumber()||o.eq(de)){s.push(p);continue}let y=new Ie(Math.min(p.endTime.toNumber(),n)),f=y.sub(p.lastUpdateTime),b=ne.mulDivFloor(f,p.emissionsPerSecondX64,o),g=p.rewardGrowthGlobalX64.add(b),A=ne.mulDivFloor(f,p.emissionsPerSecondX64,pt),w=p.rewardTotalEmissioned.add(A);s.push(E(R({},p),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:w,lastUpdateTime:y}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:o}=this.tickRange(e);for(let i of t){let s=j.getTickArrayStartIndexByTick(i,e);if(s>=n||s<o)return!0}return!1}static tickRange(e){let t=Wt.maxTickInTickarrayBitmap(e),n=-t;return t>et&&(t=me.getArrayStartIndex(et,e)+me.tickCount(e)),n<je&&(n=me.getArrayStartIndex(je,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!me.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/me.tickCount(t)*dn}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let o=await Me(e,t.map(s=>({pubkey:s})),{batchRequest:n}),i={};for(let s of o)s.accountInfo!==null&&(i[s.pubkey.toString()]=ku.decode(s.accountInfo.data));return i}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let o={},i=[];for(let c of t){let u=j.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=j.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let m of l){let{publicKey:d}=be(c.programId,c.id,m);i.push({pubkey:d}),o[d.toString()]=c.id}}let s=await Me(e,i,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=o[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=ko.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]=E(R({},l),{address:c.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:o=!1,updateOwnerRewardAndFee:i=!0}){var a;let s=[];for(let c=0;c<e.length;c++){let u=e[c];u!==null&&(s.find(l=>l.equals(u.state.programId))||s.push(u.state.programId))}if(n){let c=n.tokenAccounts.map(d=>d.accountInfo.mint),u=[];for(let d of c)for(let p of s)u.push(at(p,d).publicKey);let l=await ht(t,u,{batchRequest:o}),m={};for(let d of l){if(d===null)continue;let p=Lr.decode(d.data),y=p.poolId.toString(),f=e.find(B=>B.state.id.toBase58()===y);if(f===void 0)continue;let b=f.state,g=j._getTickPriceLegacy({poolInfo:b,tick:p.tickLower,baseIn:!0}),A=j._getTickPriceLegacy({poolInfo:b,tick:p.tickUpper,baseIn:!0}),{amountA:w,amountB:k}=le.getAmountsFromLiquidity(b.sqrtPriceX64,g.tickSqrtPriceX64,A.tickSqrtPriceX64,p.liquidity,!1),I=1/(1-Math.sqrt(Math.sqrt(g.price.div(A.price).toNumber())));f.positionAccount=[...(a=f.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:g.price,priceUpper:A.price,amountA:w,amountB:k,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(B=>E(R({},B),{pendingReward:new Ie(0)})),leverage:I,tokenFeeAmountA:new Ie(0),tokenFeeAmountB:new Ie(0)}];let T=await j.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickLower,f.state.tickSpacing),S=await j.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickUpper,f.state.tickSpacing);m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=T,m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=S}if(i){let d=Object.values(m),p=await ht(t,d,{batchRequest:o}),y={};for(let f=0;f<d.length;f++){let b=p[f];if(b===null)continue;let g=d[f].toString();y[g]=ko.decode(b.data)}for(let{state:f,positionAccount:b}of e)if(!!b)for(let g of b){let A=`${f.programId.toString()}-${f.id.toString()}-${g.tickLower}`,w=`${f.programId.toString()}-${f.id.toString()}-${g.tickUpper}`,k=y[m[A].toString()],I=y[m[w].toString()],T=k.ticks[j.getTickOffsetInArray(g.tickLower,f.tickSpacing)],S=I.ticks[j.getTickOffsetInArray(g.tickUpper,f.tickSpacing)],{tokenFeeAmountA:B,tokenFeeAmountB:C}=await ho.GetPositionFees(f,g,T,S),x=await ho.GetPositionRewards(f,g,T,S);g.tokenFeeAmountA=B.gte(new Ie(0))?B:new Ie(0),g.tokenFeeAmountB=C.gte(new Ie(0))?C:new Ie(0);for(let L=0;L<x.length;L++)g.rewardInfos[L].pendingReward=x[L].gte(new Ie(0))?x[L]:new Ie(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountIn:i,slippage:s,priceLimit:a=new O(0),catchLiquidityInsufficient:c=!1}){var W;let u,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new O(0))?u=l?At.add(new Ie(1)):wt.sub(new Ie(1)):u=ee.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=fe(i,m,o,!1),{allTrade:y,expectedAmountOut:f,remainingAccounts:b,executionPrice:g,feeAmount:A}=Ke.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((W=p.fee)!=null?W:de),u,c),w=fe(f,d,o,!1),k=ee.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),I=l?k:new O(1).div(k),T=f.mul(new Ie(Math.floor((1-s)*1e10))).div(new Ie(1e10)),S=fe(T,d,o,!1),B=l?e.currentPrice:new O(1).div(e.currentPrice),C=new O(I).sub(B).abs(),x=B,L=new Ee(new O(C).mul(10**15).toFixed(0),new O(x).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:p,amountOut:w,minAmountOut:S,expirationTime:xt(p.expirationTime,w.expirationTime),currentPrice:e.currentPrice,executionPrice:I,priceImpact:L,fee:A,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:o,slippage:i,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=o.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new xe(E(R({},u),{mint:u.address,isToken2022:u.programId===Pu.toBase58()})),new xe(E(R({},l),{mint:l.address,isToken2022:l.programId===Pu.toBase58()}))],{allTrade:p,realAmountIn:y,amountOut:f,minAmountOut:b,expirationTime:g,currentPrice:A,executionPrice:w,priceImpact:k,fee:I,remainingAccounts:T,executionPriceX64:S}=Ke.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Kt(u.address),amountIn:n,slippage:i,epochInfo:s,catchLiquidityInsufficient:a}),B=E(R({},y),{amount:new ge(m,y.amount),fee:y.fee===void 0?void 0:new ge(m,y.fee)}),C=E(R({},f),{amount:new ge(d,f.amount),fee:f.fee===void 0?void 0:new ge(d,f.fee)}),x=E(R({},b),{amount:new ge(d,b.amount),fee:b.fee===void 0?void 0:new ge(d,b.fee)}),L=new rt({baseToken:m,denominator:new Ie(10).pow(new Ie(20+m.decimals)),quoteToken:d,numerator:A.mul(new O(10**(20+d.decimals))).toFixed(0)}),W=new rt({baseToken:m,denominator:new Ie(10).pow(new Ie(20+m.decimals)),quoteToken:d,numerator:w.mul(new O(10**(20+d.decimals))).toFixed(0)}),_=new ge(m,I);return{allTrade:p,realAmountIn:B,amountOut:C,minAmountOut:x,expirationTime:g,currentPrice:L,executionPrice:W,priceImpact:k,fee:_,remainingAccounts:T,executionPriceX64:S}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountOut:i,slippage:s,priceLimit:a=new O(0)}){var x;let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new O(0))?l=c?wt.sub(new Ie(1)):At.add(new Ie(1)):l=ee.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=fe(i,u[n.toString()],o,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:y,feeAmount:f}=Ke.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((x=m.fee)!=null?x:de),l),b=c?e.mintB.address:e.mintA.address,g=fe(d,u[b],o,!1),A=ee.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),w=c?A:new O(1).div(A),k=d.mul(new Ie(Math.floor((1+s)*1e10))).div(new Ie(1e10)),I=fe(k,u[b],o,!0),T=c?e.currentPrice:new O(1).div(e.currentPrice),S=new O(w).sub(T).abs(),B=T,C=new Ee(new O(S).mul(10**15).toFixed(0),new O(B).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:I,realAmountOut:m,expirationTime:xt(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:w,priceImpact:C,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:o}){var y,f,b;let i=e[t],s=j.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=j.getTickPrice({poolInfo:e,tick:o,baseIn:!0}).price.toNumber(),c=Math.max(s,i.priceMin),l=Math.min(a,i.priceMax)-c,m=a-s,d=i.priceMax-i.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:i.feeApr*p,rewardsApr:[((y=i.rewardApr[0])!=null?y:0)*p,((f=i.rewardApr[1])!=null?f:0)*p,((b=i.rewardApr[2])!=null?b:0)*p],apr:i.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:o,liquidity:i,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=o[lt(e.mintA.address).toString()],d=o[lt(e.mintB.address).toString()],p=e.mintA.decimals,y=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=ee.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),b=ee.getSqrtPriceX64FromTick(s),g=ee.getSqrtPriceX64FromTick(a),{amountSlippageA:A,amountSlippageB:w}=le.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:k,amountSlippageB:I}=le.getAmountsFromLiquidityWithSlippage(f,b,g,i,!1,!1,0),T=new O(A.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(w.toString()).div(new O(10).pow(y)).mul(d.value)),S=new O(k.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(I.toString()).div(new O(10).pow(y)).mul(d.value)),B=new O(1).div(T.add(S)),x=new O(l.volumeFee).mul(365).div(u).mul(B).mul(100).toNumber(),L=3600*24*365,W=e.rewardDefaultInfos.map(_=>{var q,$e;let $=_.mint.decimals,G=o[_.mint.address];return c<((q=_.startTime)!=null?q:0)||c>(($e=_.endTime)!=null?$e:0)||!_.perSecond||!G||$===void 0?0:new O(G.value).mul(new O(_.perSecond).mul(L)).div(new O(10).pow($)).mul(B).mul(100).toNumber()});return{feeApr:x,rewardsApr:W,apr:x+W.reduce((_,$)=>_+$,0)}}static getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:o,amount:i,slippage:s,add:a,epochInfo:c,amountHasFee:u}){var g,A;let l=ee.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),m=ee.getSqrtPriceX64FromTick(n),d=ee.getSqrtPriceX64FromTick(o),p=a?1-s:1+s,y=fe(i,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,c,!u),f=new Ie(new O(y.amount.sub((A=y.fee)!=null?A:de).toString()).mul(p).toFixed(0)),b;if(l.lte(m))b=t?le.getLiquidityFromTokenAmountA(m,d,f,!a):new Ie(0);else if(l.lte(d)){let w=le.getLiquidityFromTokenAmountA(l,d,f,!a),k=le.getLiquidityFromTokenAmountB(m,l,f);b=t?w:k}else b=t?new Ie(0):le.getLiquidityFromTokenAmountB(m,d,f);return Ke.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:o,liquidity:b,slippage:s,add:a})}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:o,liquidity:i,slippage:s,add:a}){var b,g,A,w;let c=ee.getSqrtPriceX64FromTick(n),u=ee.getSqrtPriceX64FromTick(o),l=a?1+s:1-s,m=le.getAmountsFromLiquidity(ee.priceToSqrtPriceX64(new O(t.price),t.mintA.decimals,t.mintB.decimals),c,u,i,a),[d,p]=[fe(m.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),fe(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[y,f]=[fe(m.amountA.muln(l),(A=t.mintA.extensions)==null?void 0:A.feeConfig,e,!0),fe(m.amountB.muln(l),(w=t.mintB.extensions)==null?void 0:w.feeConfig,e,!0)];return{liquidity:i,amountA:d,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:xt(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let o=t.filter(c=>!n[c.id]).map(c=>new Kt(c.id));(await ht(e,o)).forEach((c,u)=>{!c||(n[o[u].toBase58()]=fn.decode(c.data))});let s=t.map(c=>ut(new Kt(c.programId),new Kt(c.id)).publicKey),a=await Ke.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>E(R({},c),{[u.id]:E(R({},n[u.id]),{id:new Kt(u.id),version:6,programId:new Kt(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:E(R({},u.config),{id:new Kt(u.config.id),fundOwner:""}),currentPrice:new O(u.price),exBitmapInfo:a[ut(new Kt(u.programId),new Kt(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber()})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function bh({poolInfo:r,tickLower:e,tickUpper:t,amountA:n,amountB:o,slippage:i,add:s,epochInfo:a,amountHasFee:c}){var w,k,I,T;let[u,l,m,d]=e<t?[e,t,n,o]:[t,e,o,n],p=ee.priceToSqrtPriceX64(new O(r.price),r.mintA.decimals,r.mintB.decimals),y=ee.getSqrtPriceX64FromTick(u),f=ee.getSqrtPriceX64FromTick(l),[b,g]=[fe(m,(w=r.mintA.extensions)==null?void 0:w.feeConfig,a,!c),fe(d,(k=r.mintB.extensions)==null?void 0:k.feeConfig,a,!c)],A=le.getLiquidityFromTokenAmounts(p,y,f,b.amount.sub((I=b.fee)!=null?I:de),g.amount.sub((T=g.fee)!=null?T:de));return le.getAmountsOutFromLiquidity({poolInfo:r,tickLower:e,tickUpper:t,liquidity:A,slippage:i,add:s,epochInfo:a,amountAddFee:!c})}var os={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function hu(r){return E(R({},r),{type:"Concentrated",programId:r.programId.toString(),id:r.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:r.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:r.ammConfig.tradeFeeRate,openTime:r.startTime.toString(),tvl:0,day:os,week:os,month:os,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:E(R({},r.ammConfig),{id:r.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var ne=class{static mulDivRoundingUp(e,t,n){let o=e.mul(t),i=o.div(n);return o.mod(n).eq(de)||(i=i.add(dt)),i}static mulDivFloor(e,t,n){if(n.eq(de))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(de))throw new Error("division by 0");return e.mul(t).add(n.sub(dt)).div(n)}static x64ToDecimal(e,t){return new O(e.toString()).div(O.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new ie(e.mul(O.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Br).sub(t).mod(Br)}};function We(r,e){return rs(r.mul(e),64,256)}function ad(r,e,t){let n=r.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function rs(r,e,t){let n=r.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var ee=class{static sqrtPriceX64ToPrice(e,t,n){return ne.x64ToDecimal(e).pow(2).mul(O.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ne.decimalToX64(e.mul(O.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,o){if(!e.gt(de))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(de))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,o){if(!e.gt(de))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(de))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,o){if(n.eq(de))return e;let i=t.shln(Ao);if(o){let s=i,a=i.add(n.mul(e));return a.gte(s)?ne.mulDivCeil(s,e,a):ne.mulDivRoundingUp(s,dt,s.div(e).add(n))}else{let s=n.mul(e);if(!i.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=i.sub(s);return ne.mulDivCeil(i,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,o){let i=n.shln(Ao);if(o)return e.add(i.div(t));{let s=ne.mulDivRoundingUp(i,dt,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<je||e>et)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new ie("18445821805675395072"):new ie("18446744073709551616");return(t&2)!=0&&(n=We(n,new ie("18444899583751176192"))),(t&4)!=0&&(n=We(n,new ie("18443055278223355904"))),(t&8)!=0&&(n=We(n,new ie("18439367220385607680"))),(t&16)!=0&&(n=We(n,new ie("18431993317065453568"))),(t&32)!=0&&(n=We(n,new ie("18417254355718170624"))),(t&64)!=0&&(n=We(n,new ie("18387811781193609216"))),(t&128)!=0&&(n=We(n,new ie("18329067761203558400"))),(t&256)!=0&&(n=We(n,new ie("18212142134806163456"))),(t&512)!=0&&(n=We(n,new ie("17980523815641700352"))),(t&1024)!=0&&(n=We(n,new ie("17526086738831433728"))),(t&2048)!=0&&(n=We(n,new ie("16651378430235570176"))),(t&4096)!=0&&(n=We(n,new ie("15030750278694412288"))),(t&8192)!=0&&(n=We(n,new ie("12247334978884435968"))),(t&16384)!=0&&(n=We(n,new ie("8131365268886854656"))),(t&32768)!=0&&(n=We(n,new ie("3584323654725218816"))),(t&65536)!=0&&(n=We(n,new ie("696457651848324352"))),(t&131072)!=0&&(n=We(n,new ie("26294789957507116"))),(t&262144)!=0&&(n=We(n,new ie("37481735321082"))),e>0&&(n=au.div(n)),n}static getTickFromPrice(e,t,n){return ee.getTickFromSqrtPriceX64(ee.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(wt)||e.lt(At))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new ie(t-64),o=ad(n,32,128),i=new ie("8000000000000000","hex"),s=0,a=new ie(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;i.gt(new ie(0))&&s<uu;){c=c.mul(c);let y=c.shrn(127);c=c.shrn(63+y.toNumber()),a=a.add(i.mul(y)),i=i.shrn(1),s+=1}let u=a.shrn(32),m=o.add(u).mul(new ie(cu)),d=rs(m.sub(new ie(lu)),64,128).toNumber(),p=rs(m.add(new ie(mu)),64,128).toNumber();return d==p?d:ee.getSqrtPriceX64FromTick(p).lte(e)?p:d}},yn=class{static getTickWithPriceAndTickspacing(e,t,n,o){let s=ee.getTickFromSqrtPriceX64(ee.priceToSqrtPriceX64(e,n,o))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,o){let i=yn.getTickWithPriceAndTickspacing(e,t,n,o),s=ee.getSqrtPriceX64FromTick(i);return ee.sqrtPriceX64ToPrice(s,n,o)}},le=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(de))throw new Error("sqrtPriceX64A must greater than 0");let i=n.ushln(Ao),s=t.sub(e);return o?ne.mulDivRoundingUp(ne.mulDivCeil(i,s,t),dt,e):ne.mulDivFloor(i,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(de))throw new Error("sqrtPriceX64A must greater than 0");return o?ne.mulDivCeil(n,t.sub(e),pt):ne.mulDivFloor(n,t.sub(e),pt)}static getLiquidityFromTokenAmountA(e,t,n,o){e.gt(t)&&([e,t]=[t,e]);let i=n.mul(e).mul(t),s=t.sub(e),a=i.div(s);return o?ne.mulDivRoundingUp(a,dt,Zi):a.shrn(Ao)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ne.mulDivFloor(n,Zi,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,o,i){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return le.getLiquidityFromTokenAmountA(t,n,o,!1);if(e.lt(n)){let s=le.getLiquidityFromTokenAmountA(e,n,o,!1),a=le.getLiquidityFromTokenAmountB(t,e,i);return s.lt(a)?s:a}else return le.getLiquidityFromTokenAmountB(t,n,i)}static getAmountsFromLiquidity(e,t,n,o,i){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:le.getTokenAmountAFromLiquidity(t,n,o,i),amountB:new ie(0)};if(e.lt(n)){let s=le.getTokenAmountAFromLiquidity(e,n,o,i),a=le.getTokenAmountBFromLiquidity(t,e,o,i);return{amountA:s,amountB:a}}else return{amountA:new ie(0),amountB:le.getTokenAmountBFromLiquidity(t,n,o,i)}}static getAmountsFromLiquidityWithSlippage(e,t,n,o,i,s,a){let{amountA:c,amountB:u}=le.getAmountsFromLiquidity(e,t,n,o,s),l=i?1+a:1-a,m=new ie(new O(c.toString()).mul(l).toFixed(0)),d=new ie(new O(u.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:o,slippage:i,add:s,epochInfo:a,amountAddFee:c}){var A,w,k,I;let u=ee.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),l=ee.getSqrtPriceX64FromTick(t),m=ee.getSqrtPriceX64FromTick(n),d=s?1+i:1-i,p=le.getAmountsFromLiquidity(u,l,m,o,s),[y,f]=[fe(p.amountA,(A=e.mintA.extensions)==null?void 0:A.feeConfig,a,c),fe(p.amountB,(w=e.mintB.extensions)==null?void 0:w.feeConfig,a,c)],[b,g]=[fe(new ie(new O(p.amountA.toString()).mul(d).toFixed(0)),(k=e.mintA.extensions)==null?void 0:k.feeConfig,a,c),fe(new ie(new O(p.amountB.toString()).mul(d).toFixed(0)),(I=e.mintB.extensions)==null?void 0:I.feeConfig,a,c)];return{liquidity:o,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:xt(y.expirationTime,f.expirationTime)}}},pn=class{static swapCompute(e,t,n,o,i,s,a,c,u,l,m,d,p,y,f=!1){if(d.eq(de))throw new Error("amountSpecified must not be 0");if(y||(y=s?At.add(dt):wt.sub(dt)),s){if(y.lt(At))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(wt))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let b=d.gt(de),g={amountSpecifiedRemaining:d,amountCalculated:de,sqrtPriceX64:m,tick:u>p?Math.min(p+me.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new ie(0)},A=p,w=n[p],k=0,I=!s&&w.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(de)&&!g.sqrtPriceX64.eq(y);){k>10;let T={};T.sqrtPriceStartX64=g.sqrtPriceX64;let S=j.nextInitTick(w,g.tick,l,s,I),B=S||null,C=null;if(!(B!=null&&B.liquidityGross.gtn(0))){let L=Ke.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:o,exBitmapInfo:i},A,s);if(!L.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}A=L.nextStartIndex;let{publicKey:W}=be(e,t,A);C=W,w=n[A];try{B=j.firstInitializedTick(w,s)}catch{throw Error("not found next tick info")}}T.tickNext=B.tick,T.initialized=B.liquidityGross.gtn(0),p!==A&&C&&(g.accounts.push(C),p=A),T.tickNext<je?T.tickNext=je:T.tickNext>et&&(T.tickNext=et),T.sqrtPriceNextX64=ee.getSqrtPriceX64FromTick(T.tickNext);let x;if(s&&T.sqrtPriceNextX64.lt(y)||!s&&T.sqrtPriceNextX64.gt(y)?x=y:x=T.sqrtPriceNextX64,[g.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=pn.swapStepCompute(g.sqrtPriceX64,x,g.liquidity,g.amountSpecifiedRemaining,a),g.feeAmount=g.feeAmount.add(T.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),g.amountCalculated=g.amountCalculated.sub(T.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(T.amountOut),g.amountCalculated=g.amountCalculated.add(T.amountIn.add(T.feeAmount))),g.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let L=B.liquidityNet;s&&(L=L.mul(Dt)),g.liquidity=le.addDelta(g.liquidity,L)}I=T.tickNext!=g.tick&&!s&&w.startTickIndex===T.tickNext,g.tick=s?T.tickNext-1:T.tickNext}else if(g.sqrtPriceX64!=T.sqrtPriceStartX64){let L=ee.getTickFromSqrtPriceX64(g.sqrtPriceX64);I=L!=g.tick&&!s&&w.startTickIndex===L,g.tick=L}++k}try{let{nextStartIndex:T,isExist:S}=me.nextInitializedTickArray(g.tick,l,s,o,i);S&&p!==T&&(g.accounts.push(be(e,t,T).publicKey),p=T)}catch{}return{allTrade:!0,amountSpecifiedRemaining:de,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,o,i){let s={sqrtPriceX64Next:new ie(0),amountIn:new ie(0),amountOut:new ie(0),feeAmount:new ie(0)},a=e.gte(t),c=o.gte(de);if(c){let l=ne.mulDivFloor(o,Kr.sub(new ie(i.toString())),Kr);s.amountIn=a?le.getTokenAmountAFromLiquidity(t,e,n,!0):le.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=ee.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?le.getTokenAmountBFromLiquidity(t,e,n,!1):le.getTokenAmountAFromLiquidity(e,t,n,!1),o.mul(Dt).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=ee.getNextSqrtPriceX64FromOutput(e,n,o.mul(Dt),a);let u=t.eq(s.sqrtPriceX64Next);return a?(u&&c||(s.amountIn=le.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),u&&!c||(s.amountOut=le.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=u&&c?s.amountIn:le.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=u&&!c?s.amountOut:le.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!c&&s.amountOut.gt(o.mul(Dt))&&(s.amountOut=o.mul(Dt)),c&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=o.sub(s.amountIn):s.feeAmount=ne.mulDivCeil(s.amountIn,new ie(i),Kr.sub(new ie(i))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};var Fe=60,dn=512,j=class{static getTickArrayAddressByTick(e,t,n,o){let i=j.getTickArrayStartIndexByTick(n,o),{publicKey:s}=be(e,t,i);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=j.getTickArrayStartIndexByTick(e,t),o=Math.floor((e-n)/t);if(o<0||o>=Fe)throw new Error("tick offset in array overflow");return o}static getTickArrayBitIndex(e,t){let n=me.tickCount(t),o=e/n;return e<0&&e%n!=0?o=Math.ceil(o)-1:o=Math.floor(o),o}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*me.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Fe,o=Math.floor(e/n)+512;return Math.abs(o)}static checkTickArrayIsInitialized(e,t,n){let o=n*Fe,i=Math.floor(t/o)+512,s=Math.abs(i);return{isInitialized:e.testn(s),startIndex:(s-512)*o}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Fe:e+t*Fe}static mergeTickArrayBitmap(e){let t=new ud(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,o,i){let s=Math.floor(o/(n*Fe));return[...j.searchLowBitFromStart(e,t,s-1,i,n),...j.searchHightBitFromStart(e,t,s,i,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return j.searchHightBitFromStart(e,t,0,dn,n)}static getAllInitializedTickArrayInfo(e,t,n,o,i){let s=[],a=j.getAllInitializedTickArrayStartIndex(n,o,i);for(let c of a){let{publicKey:u}=be(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,o,i){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>j.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===o)break}let c=me.tickCount(i);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,o,i){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>j.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===o)break}let c=me.tickCount(i);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<je||e>et}static nextInitTick(e,t,n,o,i){if(me.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(o)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(i||(a=a+1);a<Fe;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=Fe-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Fe;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let o=ee.getSqrtPriceX64FromTick(t),i=ee.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:i,tickSqrtPriceX64:o}:{tick:t,price:new O(1).div(i),tickSqrtPriceX64:o}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let o=n?t:new O(1).div(t),i=yn.getTickWithPriceAndTickspacing(o,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ee.getSqrtPriceX64FromTick(i),a=ee.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:i,price:a}:{tick:i,price:new O(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let o=ee.getSqrtPriceX64FromTick(t),i=ee.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:i,tickSqrtPriceX64:o}:{tick:t,price:new O(1).div(i),tickSqrtPriceX64:o}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let o=n?t:new O(1).div(t),i=yn.getTickWithPriceAndTickspacing(o,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ee.getSqrtPriceX64FromTick(i),a=ee.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:i,price:a}:{tick:i,price:new O(1).div(a)}}};var Tu=v([Ae(8),D("bump"),Vt("index"),K(""),Xe("protocolFeeRate"),Xe("tradeFeeRate"),Vt("tickSpacing"),X(P(),8,"")]),cd=v([Xe("blockTimestamp"),Ln("tickCumulative"),X(P(),4)]),Iu=v([Ae(8),ze("initialized"),P("recentEpoch"),Vt("observationIndex"),K("poolId"),X(cd,100,"observations"),X(P(),4)]),ld=v([D("rewardState"),P("openTime"),P("endTime"),P("lastUpdateTime"),J("emissionsPerSecondX64"),P("rewardTotalEmissioned"),P("rewardClaimed"),K("tokenMint"),K("tokenVault"),K("creator"),J("rewardGrowthGlobalX64")]),fn=v([Ae(8),D("bump"),K("ammConfig"),K("creator"),K("mintA"),K("mintB"),K("vaultA"),K("vaultB"),K("observationId"),D("mintDecimalsA"),D("mintDecimalsB"),Vt("tickSpacing"),J("liquidity"),J("sqrtPriceX64"),Ge("tickCurrent"),Xe(),J("feeGrowthGlobalX64A"),J("feeGrowthGlobalX64B"),P("protocolFeesTokenA"),P("protocolFeesTokenB"),J("swapInAmountTokenA"),J("swapOutAmountTokenB"),J("swapInAmountTokenB"),J("swapOutAmountTokenA"),D("status"),X(D(),7,""),X(ld,3,"rewardInfos"),X(P(),16,"tickArrayBitmap"),P("totalFeesTokenA"),P("totalFeesClaimedTokenA"),P("totalFeesTokenB"),P("totalFeesClaimedTokenB"),P("fundFeesTokenA"),P("fundFeesTokenB"),P("startTime"),X(P(),15*4-3,"padding")]),md=v([J("growthInsideLastX64"),P("rewardAmountOwed")]),Lr=v([Ae(8),D("bump"),K("nftMint"),K("poolId"),Ge("tickLower"),Ge("tickUpper"),J("liquidity"),J("feeGrowthInsideLastX64A"),J("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),X(md,3,"rewardInfos"),X(P(),8,"")]),Dh=v([Ae(8),D("bump"),K("poolId"),Ge("tickLowerIndex"),Ge("tickUpperIndex"),J("liquidity"),J("feeGrowthInsideLastX64A"),J("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),X(J(),3,"rewardGrowthInside"),X(P(),8,"")]),dd=v([Ge("tick"),Ea("liquidityNet"),J("liquidityGross"),J("feeGrowthOutsideX64A"),J("feeGrowthOutsideX64B"),X(J(),3,"rewardGrowthsOutsideX64"),X(Xe(),13,"")]),ko=v([Ae(8),K("poolId"),Ge("startTickIndex"),X(dd,Fe,"ticks"),D("initializedTickCount"),X(D(),115,"")]),Bu=v([Ae(329),X(K(),100,"whitelistMints")]),ku=v([Ae(8),K("poolId"),X(X(P(),8),ns,"positiveTickArrayBitmap"),X(X(P(),8),ns,"negativeTickArrayBitmap")]),Wh=v([P(),D("bump"),K("owner"),K("poolId"),K("positionId"),K("nftAccount"),X(P(),8)]);Iu.span;var Ku=ue("Raydium_Clmm"),Ct={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},pd=[188,37,179,131,82,150,84,73],fd=[16,72,250,198,14,162,212,19],ke=class{static createPoolInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,y){let f=v([J("sqrtPriceX64"),P("startTime")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:_n.programId,isSigner:!1,isWritable:!1},{pubkey:ot,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,startTime:y},g);let A=Buffer.from([...Ct.createPool,...g]);return new ft({keys:b,programId:e,data:A})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:o,mintB:i,ammConfigId:s,initialPriceX64:a,startTime:c}=e,[u,l]=[new U(o.address),new U(i.address)],{publicKey:m}=gu(t,s,u,l),{publicKey:d}=wu(t,m),{publicKey:p}=es(t,m,u),{publicKey:y}=es(t,m,l),f=[this.createPoolInstruction(t,m,n,s,d,u,p,new U(o.programId||Ne),l,y,new U(i.programId||Ne),ut(t,m).publicKey,a,c)];return{signers:[],instructions:f,instructionTypes:[F.CreateAccount,F.ClmmCreatePool],address:{poolId:m,observationId:d,mintAVault:p,mintBVault:y},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,y,f,b,g,A,w,k,I,T,S,B,C,x){let L=v([Ge("tickLowerIndex"),Ge("tickUpperIndex"),Ge("tickArrayLowerStartIndex"),Ge("tickArrayUpperStartIndex"),J("liquidity"),P("amountMaxA"),P("amountMaxB"),ze("withMetadata"),D("optionBaseFlag"),ze("baseFlag")]),W=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[]],_=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:ot,isSigner:!1,isWritable:!1},{pubkey:_n.programId,isSigner:!1,isWritable:!1},{pubkey:Ne,isSigner:!1,isWritable:!1},{pubkey:Su,isSigner:!1,isWritable:!1},{pubkey:Cn,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...W],$=Buffer.alloc(L.span);L.encode({tickLowerIndex:A,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:I,liquidity:T,amountMaxA:S,amountMaxB:B,withMetadata:C==="create",baseFlag:!1,optionBaseFlag:0},$);let G=Buffer.from([...Ct.openPosition,...$]);return new ft({keys:_,programId:e,data:G})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l}){let m=[],[d,p]=[new U(e.programId),new U(e.id)],y;if(l)y=new U((await l(1))[0]);else{let B=is.generate();m.push(B),y=B.publicKey}let f=j.getTickArrayStartIndexByTick(o,e.config.tickSpacing),b=j.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:g}=be(d,p,f),{publicKey:A}=be(d,p,b),{publicKey:w}=ye(n.wallet,y,Ne),{publicKey:k}=Rr(y),{publicKey:I}=at(d,y),{publicKey:T}=sn(d,p,o,i),S=this.openPositionFromLiquidityInstruction(d,n.feePayer,p,n.wallet,y,w,k,T,g,A,I,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,i,f,b,s,a,c,u);return{signers:m,instructions:[S],instructionTypes:[F.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:y,tickArrayLower:g,tickArrayUpper:A,positionNftAccount:w,metadataAccount:k,personalPosition:I,protocolPosition:T}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l}){let m=[],[d,p]=[new U(e.programId),new U(e.id)],y;if(l)y=new U((await l(1))[0]);else{let B=is.generate();m.push(B),y=B.publicKey}let f=j.getTickArrayStartIndexByTick(o,e.config.tickSpacing),b=j.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:g}=be(d,p,f),{publicKey:A}=be(d,p,b),{publicKey:w}=ye(n.wallet,y,Ne),{publicKey:k}=Rr(y),{publicKey:I}=at(d,y),{publicKey:T}=sn(d,p,o,i),S=this.openPositionFromBaseInstruction(d,n.feePayer,p,n.wallet,y,w,k,T,g,A,I,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,i,f,b,u,s,a,c,Ke.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?ut(d,p).publicKey:void 0);return{address:{nftMint:y,tickArrayLower:g,tickArrayUpper:A,positionNftAccount:w,metadataAccount:k,personalPosition:I,protocolPosition:T},instructions:[S],signers:m,instructionTypes:[F.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,y,f,b,g,A,w,k,I,T,S,B,C,x){let L=v([Ge("tickLowerIndex"),Ge("tickUpperIndex"),Ge("tickArrayLowerStartIndex"),Ge("tickArrayUpperStartIndex"),J("liquidity"),P("amountMaxA"),P("amountMaxB"),ze("withMetadata"),D("optionBaseFlag"),ze("baseFlag")]),W=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[]],_=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:ot,isSigner:!1,isWritable:!1},{pubkey:_n.programId,isSigner:!1,isWritable:!1},{pubkey:Ne,isSigner:!1,isWritable:!1},{pubkey:Su,isSigner:!1,isWritable:!1},{pubkey:Cn,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...W],$=Buffer.alloc(L.span);L.encode({tickLowerIndex:A,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:I,liquidity:new xu(0),amountMaxA:S==="MintA"?B:C,amountMaxB:S==="MintA"?C:B,withMetadata:T==="create",baseFlag:S==="MintA",optionBaseFlag:1},$);let G=Buffer.from([...Ct.openPosition,...$]);return new ft({keys:_,programId:e,data:G})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l}){let m,d=[];if(l)m=new U((await l(1))[0]);else{let B=is.generate();d.push(B),m=B.publicKey}let[p,y]=[new U(e.programId),new U(e.id)],f=j.getTickArrayStartIndexByTick(o,e.config.tickSpacing),b=j.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:g}=be(p,y,f),{publicKey:A}=be(p,y,b),{publicKey:w}=ye(n.wallet,m,Ne),{publicKey:k}=Rr(m),{publicKey:I}=at(p,m),{publicKey:T}=sn(p,y,o,i),S=this.openPositionFromLiquidityInstruction(p,n.wallet,y,n.wallet,m,w,k,T,g,A,I,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),o,i,f,b,s,a,c,u,Ke.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?ut(p,y).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:g,tickArrayUpper:A,positionNftAccount:w,metadataAccount:k,personalPosition:I,protocolPosition:T},instructions:[S],signers:d,instructionTypes:[F.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,o,i){let s=v([]),a=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:_n.programId,isSigner:!1,isWritable:!1},{pubkey:Ne,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);s.encode({},c);let u=Buffer.from([...Ct.closePosition,...c]);return new ft({keys:a,programId:e,data:u})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:o}){let i=new U(e.programId),{publicKey:s}=ye(n.wallet,o.nftMint,Ne),{publicKey:a}=at(i,o.nftMint),c=[];return c.push(this.closePositionInstruction(i,n.wallet,o.nftMint,s,a)),{address:{positionNftAccount:s,personalPosition:a},signers:[],instructions:c,instructionTypes:[F.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,y,f,b,g,A){let w=v([J("liquidity"),P("amountMaxA"),P("amountMaxB"),D("optionBaseFlag"),ze("baseFlag")]),k=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Ne,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...k],T=Buffer.alloc(w.span);w.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},T);let S=Buffer.from([...Ct.increaseLiquidity,...T]);return new ft({keys:I,programId:e,data:S})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:i,amountMaxA:s,amountMaxB:a}){let[c,u]=[new U(e.programId),new U(e.id)],l=j.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=j.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=be(c,u,l),{publicKey:p}=be(c,u,m),{publicKey:y}=ye(o.wallet,n.nftMint,Ne),{publicKey:f}=at(c,n.nftMint),{publicKey:b}=sn(c,u,n.tickLower,n.tickUpper),g=this.increasePositionFromLiquidityInstruction(c,o.wallet,y,f,u,b,d,p,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),i,s,a,Ke.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?ut(c,u).publicKey:void 0);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:y,personalPosition:f,protocolPosition:b},signers:[],instructions:[g],instructionTypes:[F.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,base:i,baseAmount:s,otherAmountMax:a}){let[c,u]=[new U(e.programId),new U(e.id)],l=j.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=j.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=be(c,u,l),{publicKey:p}=be(c,u,m),{publicKey:y}=ye(o.wallet,n.nftMint,Ne),{publicKey:f}=at(c,n.nftMint),{publicKey:b}=sn(c,u,n.tickLower,n.tickUpper);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:y,personalPosition:f,protocolPosition:b},instructions:[this.increasePositionFromBaseInstruction(c,o.wallet,y,f,u,b,d,p,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),i,s,a,Ke.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?ut(c,u).publicKey:void 0)],signers:[],instructionTypes:[F.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,y,f,b,g,A){let w=v([J("liquidity"),P("amountMaxA"),P("amountMaxB"),D("optionBaseFlag"),ze("baseFlag")]),k=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Ne,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...k],T=Buffer.alloc(w.span);w.encode({liquidity:new xu(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},T);let S=Buffer.from([...Ct.increaseLiquidity,...T]);return new ft({keys:I,programId:e,data:S})}static decreaseLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,y,f,b,g,A,w){let k=v([J("liquidity"),P("amountMinA"),P("amountMinB")]),I=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[],...f.map(C=>[{pubkey:C.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:C.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:C.rewardMint,isSigner:!1,isWritable:!1}]).flat()],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Ne,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:$o,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...I],S=Buffer.alloc(k.span);k.encode({liquidity:b,amountMinA:g,amountMinB:A},S);let B=Buffer.from([...Ct.decreaseLiquidity,...S]);return new ft({keys:T,programId:e,data:B})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:i,amountMinA:s,amountMinB:a,programId:c}){let[u,l]=[new U(e.programId),new U(e.id)],m=j.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=j.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=be(u,l,m),{publicKey:y}=be(u,l,d),{publicKey:f}=ye(o.wallet,n.nftMint,c),{publicKey:b}=at(u,n.nftMint),{publicKey:g}=sn(u,l,n.tickLower,n.tickUpper),A=[];for(let I=0;I<e.rewardDefaultInfos.length;I++)A.push({poolRewardVault:new U(t.rewardInfos[I].vault),ownerRewardVault:o.rewardAccounts[I],rewardMint:new U(e.rewardDefaultInfos[I].mint.address)});let w=[],k=this.decreaseLiquidityInstruction(u,o.wallet,f,b,l,g,p,y,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),A,i,s,a,Ke.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?ut(u,l).publicKey:void 0);return w.push(k),{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:w,instructionTypes:[F.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,y,f,b,g){let A=v([P("amount"),P("otherAmountThreshold"),J("sqrtPriceLimitX64"),ze("isBaseInput")]),w=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(S=>({pubkey:S,isSigner:!1,isWritable:!0}))],k=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Ne,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:$o,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...w],I=Buffer.alloc(A.span);A.encode({amount:p,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},I);let T=Buffer.from([...Ct.swap,...I]);return new ft({keys:k,programId:e,data:T})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,inputMint:i,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new U(e.programId),new U(e.id)],[d,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===i.toString(),g=[this.swapInstruction(l,o.wallet,m,new U(e.config.id),b?o.tokenAccountA:o.tokenAccountB,b?o.tokenAccountB:o.tokenAccountA,b?d:p,b?p:d,b?y:f,b?f:y,u,n,s,a,c,!0,ut(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[F.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,outputMint:i,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new U(e.programId),new U(e.id)],[d,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===i.toBase58(),g=[this.swapInstruction(l,o.wallet,m,new U(e.config.id),b?o.tokenAccountB:o.tokenAccountA,b?o.tokenAccountA:o.tokenAccountB,b?p:d,b?d:p,b?f:y,b?y:f,u,n,s,a,c,!1,ut(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[F.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,o,i,s,a,c,u,l,m,d){let p=v([P("openTime"),P("endTime"),J("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:_n.programId,isSigner:!1,isWritable:!1},{pubkey:ot,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:Y(l),endTime:Y(m),emissionsPerSecondX64:d},f);let b=Buffer.from([...Ct.initReward,...f]);return new ft({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[i,s]=[new U(e.programId),new U(e.id)],a=Au(i,s,o.mint).publicKey,c=Po(i).publicKey,u=[this.initRewardInstruction(i,n.wallet,s,c,new U(e.config.id),n.tokenAccount,o.programId,o.mint,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[F.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,o,i,s,a,c,u,l,m,d){let p=v([D("rewardIndex"),J("emissionsPerSecondX64"),P("openTime"),P("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Ne,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:d,openTime:Y(l),endTime:Y(m)},f);let b=Buffer.from([...Ct.setRewardEmissions,...f]);return new ft({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[i,s]=[new U(e.programId),new U(e.id)],a,c,u;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===o.mint.toString()&&(a=d,c=new U(t.rewardInfos[d].vault),u=new U(t.rewardInfos[d].mint.address));(a===void 0||c===void 0)&&Ku.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=Po(i).publicKey,m=[this.setRewardInstruction(i,n.wallet,s,l,new U(e.config.id),n.tokenAccount,c,u,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:m,instructionTypes:[F.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,o,i,s,a){let c=v([D("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Ne,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:$o,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let m=Buffer.from([...Ct.collectReward,...l]);return new ft({keys:u,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:o}){let[i,s]=[new U(e.programId),new U(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===o.toString()&&(a=l,c=new U(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&Ku.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(i,n.wallet,s,n.tokenAccount,c,o,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[F.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:o,positionNft:i}){let{publicKey:s}=ye(o,i,Ne),{publicKey:a}=at(n,i),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:ts(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:Ne,isSigner:!1,isWritable:!1},{pubkey:_n.programId,isSigner:!1,isWritable:!1}];return new ft({keys:c,programId:e,data:Buffer.from(pd)})}static harvestLockPositionInstruction(e){let[t,n]=[new U(e.poolKeys.programId),new U(e.poolKeys.id)],o=j.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),i=j.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=be(t,n,o),{publicKey:a}=be(t,n,i),{publicKey:c}=ye(e.owner,e.ownerPosition.nftMint,Ne),{publicKey:u}=at(t,e.ownerPosition.nftMint),{publicKey:l}=sn(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let y=0;y<e.poolKeys.rewardInfos.length;y++)m.push({poolRewardVault:new U(e.poolKeys.rewardInfos[y].vault),ownerRewardVault:e.ownerRewardAccounts[y],rewardMint:new U(e.poolKeys.rewardInfos[y].mint.address)});let d=[...m.map(y=>[{pubkey:y.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:ts(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:Ne,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:Kn,isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...d];return new ft({keys:p,programId:e.programId,data:Buffer.from(fd)})}};var ok=v([Xe("mintAuthorityOption"),K("mintAuthority"),P("supply"),D("decimals"),D("isInitialized"),Xe("freezeAuthorityOption"),K("freezeAuthority")]);import{PublicKey as yd}from"@solana/web3.js";import{MintLayout as Cu,TOKEN_PROGRAM_ID as bd}from"@solana/spl-token";var pk=async({connection:r,mint:e})=>{let t=await r.getAccountInfo(new yd(e));return!t||t.data.length!==Cu.span?void 0:Cu.decode(t.data)},fk=({mint:r,decimals:e,programId:t=bd,logoURI:n="",priority:o=3})=>{let i=r.toBase58().substring(0,6);return{address:r.toBase58(),decimals:e,symbol:i,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:i,tags:[],priority:o}},Or=r=>new xe({mint:r.address,decimals:r.decimals,symbol:r.symbol,name:r.name}),Io=o=>{var i=o,{amount:r,isRaw:e,name:t}=i,n=Le(i,["amount","isRaw","name"]);return new ge(new xe({mint:lt(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),r,e,t)};function yk(r){return r.address===Lt.address?ve:r}function bk(r){return r.address===ve.address?Lt:r}var tt=o=>{var i=o,{address:r,programId:e,decimals:t}=i,n=Le(i,["address","programId","decimals"]);return R({chainId:101,address:lt(r).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},an=r=>r?E(R({},r),{transferFeeConfigAuthority:r.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:r.withdrawWithheldAuthority.toBase58(),withheldAmount:r.withheldAmount.toString(),olderTransferFee:E(R({},r.olderTransferFee),{epoch:r.olderTransferFee.epoch.toString(),maximumFee:r.olderTransferFee.maximumFee.toString()}),newerTransferFee:E(R({},r.newerTransferFee),{epoch:r.newerTransferFee.epoch.toString(),maximumFee:r.newerTransferFee.maximumFee.toString()})}):void 0;import Ru from"bn.js";var ss=new Ru(25),Nr=new Ru(1e4),gd={4:3,5:3};import{PublicKey as Pe,SystemProgram as Fu,SYSVAR_RENT_PUBKEY as Ld,TransactionInstruction as Ut}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Od,TOKEN_PROGRAM_ID as Fn}from"@solana/spl-token";var as=v([D("instruction"),P("amountIn"),P("minAmountOut")]),us=v([D("instruction"),P("maxAmountIn"),P("amountOut")]),Sk=v([D("instruction"),D("nonce")]),cs=v([D("instruction"),D("nonce"),P("startTime")]),Bo=v([P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalValue"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),P("swapBase2QuoteFee"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),P("swapQuote2BaseFee"),K("baseVault"),K("quoteVault"),K("baseMint"),K("quoteMint"),K("lpMint"),K("openOrders"),K("marketId"),K("marketProgramId"),K("targetOrders"),K("withdrawQueue"),K("lpVault"),K("owner"),P("lpReserve"),X(P(),3,"padding")]),Ad=v([P("accountType"),P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalsValue"),P("abortTradeFactor"),P("priceTickMultiplier"),P("priceTick"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),P("swapQuote2BaseFee"),P("swapBase2QuoteFee"),K("baseVault"),K("quoteVault"),K("baseMint"),K("quoteMint"),K("lpMint"),K("modelDataAccount"),K("openOrders"),K("marketId"),K("marketProgramId"),K("targetOrders"),K("owner"),X(P(),64,"padding")]),ls=v([D("instruction"),P("baseAmountIn"),P("quoteAmountIn"),P("fixedSide"),P("otherAmountMin")]),ms=v([D("instruction"),P("lpAmount"),P("baseAmountMin"),P("quoteAmountMin")]),Kk={4:Bo,5:Ad},Lu=v([P("fee")]);import{PublicKey as wd}from"@solana/web3.js";var Vn=new wd("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),gn=5e4,Pd=v([P("x"),P("y"),P("price")]),hd=v([P("accountType"),P("status"),P("multiplier"),P("validDataCount"),X(Pd,gn,"DataElement")]);function kd(r,e){return[0,gn-2]}function Td(r){return[0,gn-2]}function Id(r){return[0,gn-2]}function Bd(r,e,t){let[n,o]=kd(e,t),i=n,s=o,a=0,c=e*r.multiplier/t;for(;i<=s;){if(a=Math.floor((s+i)/2),a===0||a>=gn-2)return[a,a,!1];let u=r.DataElement[a].x*r.multiplier/r.DataElement[a].y,l=r.DataElement[a-1].x*r.multiplier/r.DataElement[a-1].y,m=r.DataElement[a+1].x*r.multiplier/r.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===m)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<m)return[a,a+1,!0];i=a+1}}return[a,a,!1]}function ds(r,e,t){let[n,o,i]=Bd(r,e,t);if(!i)return 0;if(n===o){let s=r.DataElement[n].x;return e*r.multiplier/s}else{let s=r.DataElement[n].x,a=r.DataElement[n].y,c=r.DataElement[o].x,u=r.DataElement[o].y,l=t*(c*a-s*u),m=s*l,d=(c-s)*(e*a-s*t)*u,p=m+d;return e*r.multiplier*l/p}}function bn(r,e,t){return e*r.multiplier/t}function Ou(r,e,t){return e*t/r.multiplier}function xd(r,e){let[t,n]=Td(e),o=t,i=n,s=0,a=e;for(;o<i;){if(s=Math.floor((i+o)/2),s<=0||s>gn-2)return[s,s,!1];let c=r.DataElement[s].x,u=r.DataElement[s-1].x,l=r.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)i=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];o=s+1}}return[s,s,!1]}function Sd(r,e){let[t,n]=Id(e),o=t,i=n,s=0,a=e;for(;o<=i;){if(s=Math.floor((i+o)/2),s<=0||s>=gn-2)return[s,s,!1];let c=r.DataElement[s].y,u=r.DataElement[s-1].y,l=r.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)o=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];i=s-1}}return[s,s,!1]}function Nu(r,e,t,n){let o=n?e+t:e-t,[i,s,a]=xd(r,o);if(!a)return[0,0,!1,a];if(i===s)return[r.DataElement[s].price,r.DataElement[s].y,!1,a];{let c=r.DataElement[i].x,u=r.DataElement[s].x,l=r.DataElement[i].price,m=r.DataElement[s].price,d=r.DataElement[i].y,p=r.DataElement[s].y;if(e>=c&&e<=u)return n?[m,p,!0,a]:[l,d,!0,a];{let y,f;return n?(y=l+(m-l)*(e-c)/(u-c),f=d-(o-c)*r.multiplier/m):(y=l+(m-l)*(e-c)/(u-c),f=p+(u-o)*r.multiplier/l),[y,f,!1,a]}}}function Kd(r,e,t,n){let o=n?e-t:e+t,[i,s,a]=Sd(r,o);if(!a)return[0,0,!1,a];if(i===s)return[r.DataElement[s].price,r.DataElement[s].x,!1,a];{let c=r.DataElement[i].x,u=r.DataElement[s].x,l=r.DataElement[i].price,m=r.DataElement[s].price,d=r.DataElement[i].y,p=r.DataElement[s].y;if(e>=p&&e<=d)return n?[m,u,!0,a]:[l,c,!0,a];{let y,f;return n?(y=l+(m-l)*(d-e)/(d-p),f=c+m*(d-o)/r.multiplier):(y=l+(m-l)*(d-e)/(d-p),f=u-l*(o-p)/r.multiplier),[y,f,!1,a]}}}function Cd(r,e){let t=Nu(r,e,0,!1);return t[3]?t[0]:0}function Mu(r,e,t,n){let o=ds(r,e,t),i=bn(r,e,o),s=bn(r,t,o),a=bn(r,n,o),c=!0,[u,l,m,d]=Nu(r,i,a,c);if(!d)return 0;if(m)return n*r.multiplier/u;{let p=s-l;return Ou(r,p,o)}}function _u(r,e,t,n){let o=ds(r,e,t),i=bn(r,e,o),s=bn(r,t,o),a=bn(r,n,o),c=!1,[u,l,m,d]=Kd(r,s,a,c);if(!d)return 0;if(m)return n*u/r.multiplier;{let p=i-l;return Ou(r,p,o)}}function Rd(r){let e=hd.decode(r);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function vu(r,e,t,n){let o=Cd(r,bn(r,e,ds(r,e,t)))/r.multiplier;return n?o:1/o}var vn=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(Vn);e&&(this._layoutData=Rd(e==null?void 0:e.data))}}};var Vu=ue("Raydium_liquidity_instruction");function Eu(r){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:o,quoteAmountIn:i,fixedSide:s,otherAmountMin:a}=r,c=Buffer.alloc(ls.span);ls.encode({instruction:3,baseAmountIn:Y(o),quoteAmountIn:Y(i),otherAmountMin:Y(a),fixedSide:s==="base"?yt:aa},c);let u=[h({pubkey:Fn,isWritable:!1}),h({pubkey:new Pe(e.id)}),h({pubkey:new Pe(t.authority),isWritable:!1}),h({pubkey:new Pe(t.openOrders),isWritable:!1}),h({pubkey:new Pe(t.targetOrders)}),h({pubkey:new Pe(e.lpMint.address)}),h({pubkey:new Pe(t.vault.A)}),h({pubkey:new Pe(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(h({pubkey:Vn})),u.push(h({pubkey:new Pe(e.marketId),isWritable:!1}),h({pubkey:n.baseTokenAccount}),h({pubkey:n.quoteTokenAccount}),h({pubkey:n.lpTokenAccount}),h({pubkey:n.owner,isWritable:!1,isSigner:!0}),h({pubkey:new Pe(t.marketEventQueue),isWritable:!1})),new Ut({programId:new Pe(e.programId),keys:u,data:c})}function ps(r){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:o,baseAmountMin:i,quoteAmountMin:s}=r,a=Te(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(ms.span);ms.encode({instruction:4,lpAmount:Y(o),baseAmountMin:Y(i),quoteAmountMin:Y(s)},u);let l=[h({pubkey:Fn,isWritable:!1}),h({pubkey:a.id}),h({pubkey:a.authority,isWritable:!1}),h({pubkey:a.openOrders}),h({pubkey:a.targetOrders}),h({pubkey:a.mintLp.address}),h({pubkey:a.vault.A}),h({pubkey:a.vault.B})];return c===5?l.push(h({pubkey:Vn})):(l.push(h({pubkey:a.id})),l.push(h({pubkey:a.id}))),l.push(h({pubkey:a.marketProgramId,isWritable:!1}),h({pubkey:a.marketId}),h({pubkey:a.marketBaseVault}),h({pubkey:a.marketQuoteVault}),h({pubkey:a.marketAuthority,isWritable:!1}),h({pubkey:n.lpTokenAccount}),h({pubkey:n.baseTokenAccount}),h({pubkey:n.quoteTokenAccount}),h({pubkey:n.owner,isWritable:!1,isSigner:!0}),h({pubkey:a.marketEventQueue}),h({pubkey:a.marketBids}),h({pubkey:a.marketAsks})),new Ut({programId:a.programId,keys:l,data:u})}return new Ut({programId:a.programId,keys:[]})}function Du({programId:r,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:o,coinMint:i,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:g,nonce:A,openTime:w,coinAmount:k,pcAmount:I,ammConfigId:T,feeDestinationId:S}){let B=v([D("instruction"),D("nonce"),P("openTime"),P("pcAmount"),P("coinAmount")]),C=[{pubkey:Fn,isSigner:!1,isWritable:!1},{pubkey:Od,isSigner:!1,isWritable:!1},{pubkey:Fu.programId,isSigner:!1,isWritable:!1},{pubkey:ot,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:T,isSigner:!1,isWritable:!1},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],x=Buffer.alloc(B.span);return B.encode({instruction:1,nonce:A,openTime:w,coinAmount:k,pcAmount:I},x),{instruction:new Ut({keys:C,programId:r,data:x}),instructionType:F.AmmV4CreatePool}}function Gk(r){let e=v([D("instruction"),D("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[h({pubkey:new Pe(r.id),isWritable:!1}),h({pubkey:new Pe(r.authority),isWritable:!1}),h({pubkey:new Pe(r.openOrders),isWritable:!1}),h({pubkey:new Pe(r.vault.A),isWritable:!1}),h({pubkey:new Pe(r.vault.B),isWritable:!1}),h({pubkey:new Pe(r.mintLp.address),isWritable:!1}),h({pubkey:new Pe(r.marketId),isWritable:!1}),h({pubkey:new Pe(r.marketEventQueue),isWritable:!1})];return new Ut({programId:new Pe(r.programId),keys:n,data:t})}function Nd({poolKeys:r,userKeys:e,amountIn:t,minAmountOut:n},o){let i=Te(r),s=Buffer.alloc(as.span);as.encode({instruction:9,amountIn:Y(t),minAmountOut:Y(n)},s);let a=[h({pubkey:Fn,isWritable:!1}),h({pubkey:i.id}),h({pubkey:i.authority,isWritable:!1}),h({pubkey:i.openOrders})];return o===4&&a.push(h({pubkey:i.targetOrders})),a.push(h({pubkey:i.vault.A}),h({pubkey:i.vault.B})),o===5&&a.push(h({pubkey:Vn})),a.push(h({pubkey:i.marketProgramId,isWritable:!1}),h({pubkey:i.marketId}),h({pubkey:i.marketBids}),h({pubkey:i.marketAsks}),h({pubkey:i.marketEventQueue}),h({pubkey:i.marketBaseVault}),h({pubkey:i.marketQuoteVault}),h({pubkey:i.marketAuthority,isWritable:!1}),h({pubkey:e.tokenAccountIn}),h({pubkey:e.tokenAccountOut}),h({pubkey:e.owner,isWritable:!1})),new Ut({programId:i.programId,keys:a,data:s})}function Md({poolKeys:r,userKeys:e,maxAmountIn:t,amountOut:n},o){let i=Te(r),s=Buffer.alloc(us.span);us.encode({instruction:11,maxAmountIn:Y(t),amountOut:Y(n)},s);let a=[h({pubkey:Fn,isWritable:!1}),h({pubkey:i.id}),h({pubkey:i.authority,isWritable:!1}),h({pubkey:i.openOrders}),h({pubkey:i.targetOrders}),h({pubkey:i.vault.A}),h({pubkey:i.vault.B})];return o===5&&a.push(h({pubkey:Vn})),a.push(h({pubkey:i.marketProgramId,isWritable:!1}),h({pubkey:i.marketId}),h({pubkey:i.marketBids}),h({pubkey:i.marketAsks}),h({pubkey:i.marketEventQueue}),h({pubkey:i.marketBaseVault}),h({pubkey:i.marketQuoteVault}),h({pubkey:i.marketAuthority,isWritable:!1}),h({pubkey:e.tokenAccountIn}),h({pubkey:e.tokenAccountOut}),h({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Ut({programId:i.programId,keys:a,data:s})}function Mr(r){let{poolKeys:e,version:t,userKeys:n,amountIn:o,amountOut:i,fixedSide:s}=r;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return Nd(E(R({},a),{amountIn:o,minAmountOut:i}),t);if(s==="out")return Md(E(R({},a),{maxAmountIn:o,amountOut:i}),t);Vu.logWithError("invalid params","params",r)}throw Vu.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function Xk({poolKeys:r,userKeys:e,startTime:t}){let n=Buffer.alloc(cs.span);cs.encode({instruction:0,nonce:5,startTime:Y(t)},n);let o=Te(r),i=[h({pubkey:Fn,isWritable:!1}),h({pubkey:Fu.programId,isWritable:!1}),h({pubkey:Ld,isWritable:!1}),h({pubkey:o.id}),h({pubkey:o.authority,isWritable:!1}),h({pubkey:o.openOrders}),h({pubkey:o.mintLp.address}),h({pubkey:o.mintA.address,isWritable:!1}),h({pubkey:o.mintB.address,isWritable:!1}),h({pubkey:o.vault.A,isWritable:!1}),h({pubkey:o.vault.B,isWritable:!1}),h({pubkey:o.id}),h({pubkey:o.targetOrders}),h({pubkey:e.lpTokenAccount}),h({pubkey:o.id,isWritable:!1}),h({pubkey:o.marketProgramId,isWritable:!1}),h({pubkey:o.marketId,isWritable:!1}),h({pubkey:e.payer,isSigner:!0})];return new Ut({programId:o.programId,keys:i,data:n})}function Wu({poolKeys:r}){let e=v([D("instruction"),D("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[h({pubkey:new Pe(r.id),isWritable:!1}),h({pubkey:new Pe(r.authority),isWritable:!1}),h({pubkey:new Pe(r.openOrders),isWritable:!1}),h({pubkey:new Pe(r.vault.A),isWritable:!1}),h({pubkey:new Pe(r.vault.B),isWritable:!1}),h({pubkey:new Pe(r.mintLp.address),isWritable:!1}),h({pubkey:new Pe(r.marketId),isWritable:!1}),h({pubkey:new Pe(r.marketEventQueue),isWritable:!1})];return{instruction:new Ut({programId:new Pe(r.programId),keys:n,data:t})}}import{PublicKey as Vd}from"@solana/web3.js";import xo from"bn.js";import{TOKEN_PROGRAM_ID as Fd}from"@solana/spl-token";import{PublicKey as _d}from"@solana/web3.js";var vd=ue("Raydium_liquidity_serum");function qu({programId:r,marketId:e}){let t=[e.toBuffer()],n=0,o;for(;n<100;){try{let i=t.concat(Buffer.from([n]),Buffer.alloc(7));o=_d.createProgramAddressSync(i,r)}catch(i){if(i instanceof TypeError)throw i;n++;continue}return{publicKey:o,nonce:n}}throw vd.logWithError("unable to find a viable program address nonce","params",{programId:r,marketId:e}),new Error("unable to find a viable program address nonce")}function _r({programId:r}){let{publicKey:e}=se([Buffer.from("amm_config_account_seed","utf-8")],r);return e}function An({name:r,programId:e,marketId:t}){let{publicKey:n}=se([e.toBuffer(),t.toBuffer(),Buffer.from(r,"utf-8")],e);return n}function Ed({programId:r,marketId:e}){let{publicKey:t}=se([r.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],r);return t}function bs({programId:r}){return se([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],r)}function Uu({version:r,marketVersion:e,marketId:t,baseMint:n,quoteMint:o,baseDecimals:i,quoteDecimals:s,programId:a,marketProgramId:c}){let u=An({name:"amm_associated_seed",programId:a,marketId:t}),l=An({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=bs({programId:a}),p=An({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=An({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=An({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=Ed({programId:a,marketId:t}),g=An({name:"target_associated_seed",programId:a,marketId:t}),A=An({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:w}=qu({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:o,lpMint:l,baseDecimals:i,quoteDecimals:s,lpDecimals:i,version:r,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:y,lpVault:f,openOrders:b,targetOrders:g,withdrawQueue:A,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:w,lookupTableAccount:Vd.default,configId:_r({programId:a})}}var fs;async function aT({connection:r,poolKeysList:e,config:t}){fs||(fs=new vn({connection:r}),await fs.initStableModelLayout());let n=e.map(s=>Wu({poolKeys:s}));return(await ba(r,n.map(s=>s.instruction),"GetPoolData")).map(s=>{let a=ga(s,"GetPoolData"),c=new xo(vt(a,"status")),u=Number(vt(a,"coin_decimals")),l=Number(vt(a,"pc_decimals")),m=Number(vt(a,"lp_decimals")),d=new xo(vt(a,"pool_coin_amount")),p=new xo(vt(a,"pool_pc_amount")),y=new xo(vt(a,"pool_lp_supply")),f="0";try{f=vt(a,"pool_open_time")}catch{}return{status:c,baseDecimals:u,quoteDecimals:l,lpDecimals:m,baseReserve:d,quoteReserve:p,lpSupply:y,startTime:new xo(f)}})}var ys={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},vr=r=>{let e={},t=Fd.toBase58();return Object.keys(r).map(n=>{let o=r[n],[i,s]=[o.baseMint.toBase58(),o.quoteMint.toBase58()];e[n]={id:n,version:4,status:o.status.toNumber(),programId:o.programId.toBase58(),mintA:tt({address:i,programId:t,decimals:o.baseDecimal.toNumber()}),mintB:tt({address:s,programId:t,decimals:o.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:o.poolPrice.toNumber(),mintAmountA:new O(o.mintAAmount.toString()).div(10**o.baseDecimal.toNumber()).toNumber(),mintAmountB:new O(o.mintBAmount.toString()).div(10**o.quoteDecimal.toNumber()).toNumber(),baseReserve:o.baseReserve,quoteReserve:o.quoteReserve,feeRate:new O(o.tradeFeeNumerator.toString()).div(o.tradeFeeDenominator.toString()).toNumber(),openTime:o.poolOpenTime.toString(),tvl:0,day:ys,week:ys,month:ys,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:o.marketId.toBase58(),configId:_r({programId:o.programId}).toBase58(),lpPrice:0,lpAmount:0,lpMint:tt({address:o.lpMint.toBase58(),programId:t,decimals:Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())}),burnPercent:0}}),e};import qe from"bn.js";var So=class extends Se{constructor(t){super(t);this.stableLayout=new vn({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:o,baseIn:i}){let s=new qe(new O(n).mul(10**t[i?"mintA":"mintB"].decimals).toFixed(0)),a=Or(t[i?"mintB":"mintA"]),[c,u]=[new qe(new O(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new qe(new O(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new qe(new O(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",c.toString(),"quoteReserve:",u.toString()),this.logDebug("tokenIn:",i?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",i?t.mintB.symbol:t.mintA.symbol,"slippage:",`${o.toSignificant()}%`,"baseReserve",c.toString(),"quoteReserve",u.toString());let m=i?"base":"quote";this.logDebug("input side:",m);let d=yt;s.isZero()||(d=m==="base"?nr(s.mul(u),c):nr(s.mul(c),u)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",l.toString());let p=nr(s.mul(l),m==="base"?c:u);this.logDebug("liquidity:",p.toString());let y=new Ee(new qe(1)).add(o),f=new Ee(new qe(1)).sub(o),b=y.mul(d).quotient,g=f.mul(d).quotient,A=new ge(a,d),w=new ge(a,b),k=new ge(a,g);return this.logDebug("anotherAmount:",A.toFixed(),"maxAnotherAmount:",w.toFixed()),{anotherAmount:A,maxAnotherAmount:w,minAnotherAmount:k,liquidity:p}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,poolKeys:o,amountInA:i,amountInB:s,otherAmountMin:a,fixedSide:c,config:u,txVersion:l,computeBudgetConfig:m}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",i,"amountInB:",s),(i.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:i.toFixed(),amountInB:s.toFixed()});let{account:d}=this.scope,{bypassAssociatedCheck:p,checkCreateATAOwner:y}=R({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),[f,b]=[i.token,s.token],g=await d.getCreatedTokenAccount({mint:f.mint,associatedOnly:!1}),A=await d.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1});!g&&!A&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",d.tokenAccounts);let w=await d.getCreatedTokenAccount({mint:new He(n.lpMint.address)}),k=[f,b],I=[g,A],T=[i.raw,s.raw],S=i.token.mint.toBase58()===n.mintA.address?"base":"quote",B="base";["quote","base"].includes(S)||this.logAndCreateError("invalid fixedSide","fixedSide",c),S==="quote"?(k.reverse(),I.reverse(),T.reverse(),B=c==="a"?"quote":"base"):S==="base"&&(B=c==="a"?"base":"quote");let[C,x]=k,[L,W]=I,[_,$]=T,G=o!=null?o:await this.getAmmPoolKeys(n.id),q=this.createTxBuilder(),In=await d.handleTokenAccount({side:"in",amount:_,mint:C.mint,tokenAccount:L,bypassAssociatedCheck:p,checkCreateATAOwner:y}),{tokenAccount:$e}=In,kn=Le(In,["tokenAccount"]);q.addInstruction(kn);let Eo=await d.handleTokenAccount({side:"in",amount:$,mint:x.mint,tokenAccount:W,bypassAssociatedCheck:p,checkCreateATAOwner:y}),{tokenAccount:un}=Eo,zt=Le(Eo,["tokenAccount"]);q.addInstruction(zt);let Do=await d.handleTokenAccount({side:"out",amount:0,mint:new He(n.lpMint.address),tokenAccount:w,bypassAssociatedCheck:p,checkCreateATAOwner:y}),{tokenAccount:Tn}=Do,Qt=Le(Do,["tokenAccount"]);return q.addInstruction(Qt),q.addInstruction({instructions:[Eu({poolInfo:n,poolKeys:G,userKeys:{baseTokenAccount:$e,quoteTokenAccount:un,lpTokenAccount:Tn,owner:this.scope.ownerPubKey},baseAmountIn:_,quoteAmountIn:$,otherAmountMin:a.raw,fixedSide:B})],instructionTypes:[n.pooltype.includes("StablePool")?F.AmmV5AddLiquidity:F.AmmV4AddLiquidity],lookupTableAddress:G.lookupTableAccount?[G.lookupTableAccount]:[]}),q.addCustomComputeBudget(m),l===0&&await q.buildV0(),q.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,poolKeys:o,lpAmount:i,baseAmountMin:s,quoteAmountMin:a,config:c,txVersion:u,computeBudgetConfig:l}=t,m=o!=null?o:await this.getAmmPoolKeys(n.id),[d,p,y]=[new He(n.mintA.address),new He(n.mintB.address),new He(n.lpMint.address)];this.logDebug("lpAmount:",i),this.logDebug("baseAmountMin:",s),this.logDebug("quoteAmountMin:",a),i.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",i.toString());let{account:f}=this.scope,b=await f.getCreatedTokenAccount({mint:y,associatedOnly:!1});b||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",f.tokenAccounts);let g=await f.getCreatedTokenAccount({mint:d}),A=await f.getCreatedTokenAccount({mint:p}),w=this.createTxBuilder(),{bypassAssociatedCheck:k,checkCreateATAOwner:I}=R({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),x=await f.handleTokenAccount({side:"out",amount:0,mint:d,tokenAccount:g,bypassAssociatedCheck:k,checkCreateATAOwner:I}),{tokenAccount:T}=x,S=Le(x,["tokenAccount"]);w.addInstruction(S);let L=await f.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:A,bypassAssociatedCheck:k,checkCreateATAOwner:I}),{tokenAccount:B}=L,C=Le(L,["tokenAccount"]);return w.addInstruction(C),w.addInstruction({instructions:[ps({poolInfo:n,poolKeys:m,userKeys:{lpTokenAccount:b,baseTokenAccount:T,quoteTokenAccount:B,owner:this.scope.ownerPubKey},lpAmount:i,baseAmountMin:s,quoteAmountMin:a})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?F.AmmV5RemoveLiquidity:F.AmmV4RemoveLiquidity]}),w.addCustomComputeBudget(l),u===0?await w.buildV0():w.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:o,createPositionInfo:i,farmInfo:s,userFarmLpAmount:a,base:c,computeBudgetConfig:u,payer:l,userAuxiliaryLedgers:m,tokenProgram:d=En,checkCreateATAOwner:p=!0,getEphemeralSigners:y,txVersion:f}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let b=this.createTxBuilder();b.addCustomComputeBudget(u);let g={};for(let q of this.scope.account.tokenAccountRawInfos)(g[q.accountInfo.mint.toString()]===void 0||ye(this.scope.ownerPubKey,q.accountInfo.mint,En).publicKey.equals(q.pubkey))&&(g[q.accountInfo.mint.toString()]=q.pubkey);let A=g[t.lpMint.address];if(A===void 0)throw Error("find lp account error in trade accounts");let w=o.add(a!=null?a:new qe(0)),k=t.mintA.address===xe.WSOL.mint.toString(),I=t.mintB.address===xe.WSOL.mint.toString(),{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:En,mint:new He(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:k?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!0,checkCreateATAOwner:p});if(b.addInstruction(S||{}),T===void 0)throw new Error("base token account not found");let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:En,mint:new He(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:I?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!0,checkCreateATAOwner:p});if(b.addInstruction(C||{}),B===void 0)throw new Error("quote token account not found");if(g[t.mintA.address]=T,g[t.mintB.address]=B,s!==void 0&&!(a!=null&&a.isZero())){let q=bt[s.programId],$e=Ye({programId:new He(s.programId),poolId:new He(s.id),owner:this.scope.ownerPubKey,version:q}),kn,un=await this.scope.connection.getAccountInfo($e);if(un&&(kn=Mn(q).decode(un.data)),q!==6&&!kn){let{instruction:Yt,instructionType:$r}=po({id:new He(s.id),programId:new He(s.programId),version:q,ledger:$e,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[Yt],instructionTypes:[$r]})}let zt=[];for(let Yt of s.rewardInfos){let $r=Yt.mint.address===xe.WSOL.mint.toString();if(g[Yt.mint.address])zt.push(g[Yt.mint.address]);else{let{account:Ns,instructionParams:Ms}=await this.scope.account.getOrCreateTokenAccount({mint:new He(Yt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!$r,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:p});Ns||this.logAndCreateError("farm reward account not found:",Yt.mint.address),Ms&&b.addInstruction(Ms),zt.push(Ns)}}let Tn=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],Qt={userAuxiliaryLedgers:m,amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:Tn,lpAccount:A,rewardAccounts:zt},In=bt[s.programId],Eo=In===6?fo(Qt):In===5?yo(Qt):bo(Qt),Do={3:F.FarmV3Withdraw,5:F.FarmV5Withdraw,6:F.FarmV6Withdraw};b.addInstruction({instructions:[Eo],instructionTypes:[Do[In]]})}let x=await this.getAmmPoolKeys(t.id),L=ps({poolInfo:t,poolKeys:x,userKeys:{lpTokenAccount:A,baseTokenAccount:T,quoteTokenAccount:B,owner:this.scope.ownerPubKey},lpAmount:w,baseAmountMin:0,quoteAmountMin:0});b.addInstruction({instructions:[L],instructionTypes:[t.pooltype.includes("StablePool")?F.AmmV5RemoveLiquidity:F.AmmV4RemoveLiquidity],lookupTableAddress:x.lookupTableAccount?[x.lookupTableAccount]:[]});let[W,_]=t.mintA.address===n.mintA.address?[T,B]:[B,T],$=await this.scope.clmm.getClmmPoolKeys(n.id),G=await ke.openPositionFromBaseInstructions(E(R({poolInfo:n,poolKeys:$,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:W,tokenAccountB:_},withMetadata:"create"},i),{base:c,getEphemeralSigners:y}));return b.addInstruction({instructions:[...G.instructions],signers:G.signers,instructionTypes:[...G.instructionTypes],lookupTableAddress:$.lookupTableAccount?[$.lookupTableAccount]:[]}),f===0?b.sizeCheckBuildV0():b.sizeCheckBuild()}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:o,quoteMintInfo:i,baseAmount:s,quoteAmount:a,startTime:c,ownerInfo:u,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:d,txVersion:p,feeDestinationId:y,computeBudgetConfig:f}){var W;let b=u.feePayer||((W=this.scope.owner)==null?void 0:W.publicKey),g=u.useSOLBalance&&o.mint.equals(Gu),A=u.useSOLBalance&&i.mint.equals(Gu),w=this.createTxBuilder(),{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:g?{payer:b,amount:s}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:l,checkCreateATAOwner:m});w.addInstruction(I||{});let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:A?{payer:b,amount:a}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:l,checkCreateATAOwner:m});if(w.addInstruction(S||{}),k===void 0||T===void 0)throw Error("you don't has some token account");let B=Uu({version:4,marketVersion:3,marketId:n.marketId,baseMint:o.mint,quoteMint:i.mint,baseDecimals:o.decimals,quoteDecimals:i.decimals,programId:t,marketProgramId:n.programId}),C={programId:t,ammId:B.id,ammAuthority:B.authority,ammOpenOrders:B.openOrders,lpMint:B.lpMint,coinMint:B.baseMint,pcMint:B.quoteMint,coinVault:B.baseVault,pcVault:B.quoteVault,withdrawQueue:B.withdrawQueue,ammTargetOrders:B.targetOrders,poolTempLp:B.lpVault,marketProgramId:B.marketProgramId,marketId:B.marketId,ammConfigId:B.configId,feeDestinationId:y},{instruction:x,instructionType:L}=Du(E(R({},C),{userWallet:this.scope.ownerPubKey,userCoinVault:k,userPcVault:T,userLpVault:ye(this.scope.ownerPubKey,B.lpMint,d).publicKey,nonce:B.nonce,openTime:c,coinAmount:s,pcAmount:a}));return w.addInstruction({instructions:[x],instructionTypes:[L]}),w.addCustomComputeBudget(f),w.versionBuild({txVersion:p,extInfo:{address:C}})}async getCreatePoolFee({programId:t}){let n=_r({programId:t}),o=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(o===null)throw Error("get config account error");return Lu.decode(o.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:o,mintOut:i,slippage:s}){let[a,c]=[o.toString(),i.toString()];if(a!==t.mintA.address&&a!==t.mintB.address)throw new Error("toke not match");if(c!==t.mintA.address&&c!==t.mintB.address)throw new Error("toke not match");let{baseReserve:u,quoteReserve:l}=t,m=[u,l],d=[t.mintA.decimals,t.mintB.decimals],p=a==t.mintA.address?"base":"quote";p==="quote"&&(m.reverse(),d.reverse());let[y,f]=m,[b,g]=d,A=t.version===4,w;if(A)w=new O(f.toString()).div(10**g).div(new O(y.toString()).div(10**b));else{let _=vu(this.stableLayout.stableModelData,u.toNumber(),l.toNumber(),!1);p==="quote"?w=new O(1e6).div(_*1e6):w=new O(_*1e6).div(1e6)}let k=n,I=new qe(0),T=new qe(0);if(!k.isZero())if(A){T=Jt(k.mul(ss),Nr);let _=k.sub(T),$=y.add(_);I=f.mul(_).div($)}else{T=k.mul(new qe(2)).div(new qe(1e4));let _=k.sub(T);p==="quote"?I=new qe(Mu(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),_.toNumber())):I=new qe(_u(this.stableLayout.stableModelData,l.toNumber(),u.toNumber(),_.toNumber()))}let S=new qe(new O(I.toString()).mul(1-s).toFixed(0)),B=I,C=S,x=new O(I.toString()).div(new O(k.sub(T).toString()).toFixed(0));!k.isZero()&&!I.isZero()&&(x=new O(I.toString()).div(10**g).div(new O(k.sub(T).toString()).div(10**b)));let L=w.sub(x).div(w).mul(100);return{amountOut:B,minAmountOut:C,currentPrice:w,executionPrice:x,priceImpact:L,fee:T}}computeAmountIn({poolInfo:t,amountOut:n,mintIn:o,mintOut:i,slippage:s}){let{baseReserve:a,quoteReserve:c}=t;o.toString()!==t.mintA.address&&o.toString()!==t.mintB.address&&this.logAndCreateError("mintIn does not match pool"),i.toString()!==t.mintA.address&&i.toString()!==t.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",a.toString()),this.logDebug("quoteReserve:",c.toString());let u=o.toString()===t.mintA.address,[l,m]=u?[t.mintA,t.mintB]:[t.mintB,t.mintA];this.logDebug("currencyOut:",m.symbol||m.address),this.logDebug("amountOut:",new O(n.toString()).div(10**m.decimals).toDecimalPlaces(m.decimals).toString(),l.symbol||l.address),this.logDebug("slippage:",`${s*100}%`);let d=[a,c],p=u?"quote":"base";p==="base"&&d.reverse(),this.logDebug("output side:",p);let[y,f]=d,b=new O(f.toString()).div(10**t[u?"mintB":"mintA"].decimals).div(new O(y.toString()).div(10**t[u?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${l.symbol||l.address} \u2248 ${b.toString()} ${m.symbol||m.address}`),this.logDebug("currentPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(b).toString()} ${l.symbol||l.address}`);let g=new qe(0),A=n;if(!A.isZero()){A.gt(f)&&(A=f.sub(new qe(1)));let C=f.sub(A);g=y.mul(A).div(C).mul(Nr).div(Nr.sub(ss))}let w=new qe(new O(g.toString()).mul(1+s).toFixed(0)),k=g,I=w;this.logDebug("amountIn:",new O(k.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString()),this.logDebug("maxAmountIn:",new O(I.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString());let T=null;!g.isZero()&&!A.isZero()&&(T=new O(A.toString()).div(10**m.decimals).div(new O(g.toString()).div(10**l.decimals)),this.logDebug("executionPrice:",`1 ${m.symbol||m.address} \u2248 ${T.toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`),this.logDebug("executionPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(T).toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`));let S=b.mul(k.toString()),B=S.sub(n.toString()).abs().div(S);return this.logDebug("priceImpact:",`${B.toString()}%`),{amountIn:k,maxAmountIn:I,currentPrice:b,executionPrice:T,priceImpact:B}}async swap({poolInfo:t,poolKeys:n,amountIn:o,amountOut:i,inputMint:s,fixedSide:a,txVersion:c,config:u,computeBudgetConfig:l}){let m=this.createTxBuilder(),{associatedOnly:d=!0,inputUseSolBalance:p=!0,outputUseSolBalance:y=!0}=u||{},[f,b]=s===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],g=p&&f.address===z.toBase58(),A=y&&b.address===z.toBase58(),{account:w,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:En,mint:new He(f.address),owner:this.scope.ownerPubKey,createInfo:g?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!g,notUseTokenAccount:g,associatedOnly:d});m.addInstruction(k||{}),w||this.logAndCreateError("input token account not found",{token:f.symbol||f.address,tokenAccountIn:w,inputTokenUseSolBalance:g,associatedOnly:d});let{account:I,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:En,mint:new He(b.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:d});m.addInstruction(T||{}),I===void 0&&this.logAndCreateError("output token account not found",{token:b.symbol||b.address,tokenAccountOut:I,outputTokenUseSolBalance:A,associatedOnly:d});let S=n||await this.getAmmPoolKeys(t.id),B=4;return t.pooltype.includes("StablePool")&&(B=5),m.addInstruction({instructions:[Mr({version:B,poolKeys:S,userKeys:{tokenAccountIn:w,tokenAccountOut:I,owner:this.scope.ownerPubKey},amountIn:o,amountOut:i,fixedSide:a})],instructionTypes:[B===4?F.AmmV4SwapBaseIn:F.AmmV5SwapBaseIn]}),m.addCustomComputeBudget(l),m.versionBuild({txVersion:c})}async getRpcPoolInfo(t){return(await this.getRpcPoolInfos([t]))[t]}async getRpcPoolInfos(t,n){let o=await Me(this.scope.connection,t.map(l=>({pubkey:new He(l)})),n),i={},s=[];for(let l=0;l<t.length;l++){let m=o[l];if(m===null||!m.accountInfo)throw Error("fetch pool info error: "+String(t[l]));let d=Bo.decode(m.accountInfo.data);i[String(t[l])]=E(R({},d),{programId:m.accountInfo.owner}),s.push(d.baseVault,d.quoteVault)}let a={},c=await Me(this.scope.connection,s.map(l=>({pubkey:new He(l)})),n);for(let l=0;l<s.length;l++){let m=c[l].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[l]);a[String(s[l])]=new qe(Dd.decode(m.data).amount.toString())}let u={};for(let[l,m]of Object.entries(i)){let d=a[m.baseVault.toString()].sub(m.baseNeedTakePnl),p=a[m.quoteVault.toString()].sub(m.quoteNeedTakePnl);u[l]=E(R({},m),{baseReserve:d,mintAAmount:a[m.baseVault.toString()],mintBAmount:a[m.quoteVault.toString()],quoteReserve:p,poolPrice:new O(p.toString()).div(new O(10).pow(m.quoteDecimal.toString())).div(new O(d.toString()).div(new O(10).pow(m.baseDecimal.toString())))})}return u}async getPoolInfoFromRpc({poolId:t}){let n=await this.getRpcPoolInfo(t),o=vr({[t]:n}),i=o[t],s=await this.scope.tradeV2.computePoolToPoolKeys({pools:[o[t]],ammRpcData:{[t]:n}});return{poolRpcData:n,poolInfo:i,poolKeys:s[0]}}};import{PublicKey as oe}from"@solana/web3.js";import ct from"bn.js";import{AccountLayout as Xu,TOKEN_PROGRAM_ID as zu}from"@solana/spl-token";var Ko=class extends Se{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var w;let{programId:t,owner:n=((w=this.scope.owner)==null?void 0:w.publicKey)||oe.default,mint1:o,mint2:i,ammConfig:s,initialPrice:a,startTime:c,computeBudgetConfig:u,forerunCreate:l,getObserveState:m,txVersion:d}=e,p=this.createTxBuilder(),[y,f,b]=new ct(new oe(o.address).toBuffer()).gt(new ct(new oe(i.address).toBuffer()))?[i,o,new O(1).div(a)]:[o,i,a],g=ee.priceToSqrtPriceX64(b,y.decimals,f.decimals),A=await ke.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:y,mintB:f,ammConfigId:s.id,initialPriceX64:g,startTime:c,forerunCreate:!m&&l});return p.addInstruction(A),p.addCustomComputeBudget(u),p.versionBuild({txVersion:d,extInfo:{address:E(R({},A.address),{programId:t.toString(),id:A.address.poolId.toString(),mintA:y,mintB:f,openTime:c.toString(),vault:{A:A.address.mintAVault.toString(),B:A.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:R({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:A.address.poolId.toString(),mintA:y,mintB:f,feeRate:s.tradeFeeRate,openTime:c.toString(),programId:t.toString(),price:b.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0},du),forerunCreate:l}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",getEphemeralSigners:d,computeBudgetConfig:p,txVersion:y}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let f=this.createTxBuilder(),b=null,g=null,A=n.useSOLBalance&&e.mintA.address===z.toString(),w=n.useSOLBalance&&e.mintB.address===z.toString(),[k,I]=s==="MintA"?[a,c]:[c,a],{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new oe(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:A||k.isZero()?{payer:this.scope.ownerPubKey,amount:k}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:u,checkCreateATAOwner:l});T&&(b=T),f.addInstruction(S||{});let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new oe(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||I.isZero()?{payer:this.scope.ownerPubKey,amount:I}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:u,checkCreateATAOwner:l});B&&(g=B),f.addInstruction(C||{}),(!b||!g)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:b==null?void 0:b.toBase58(),ownerTokenAccountB:g==null?void 0:g.toBase58()});let x=t||await this.getClmmPoolKeys(e.id),L=await ke.openPositionFromBaseInstructions({poolInfo:e,poolKeys:x,ownerInfo:E(R({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g}),tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,withMetadata:m,getEphemeralSigners:d});return f.addInstruction(L),f.addCustomComputeBudget(p),f.versionBuild({txVersion:y,extInfo:R({},L.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:o,amountMaxB:i,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,computeBudgetConfig:p,getEphemeralSigners:y}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let f=this.createTxBuilder(),b=null,g=null,A=n.useSOLBalance&&e.mintA.address===z.toBase58(),w=n.useSOLBalance&&e.mintB.address===z.toBase58(),{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new oe(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:A||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:u,checkCreateATAOwner:l});k&&(b=k),f.addInstruction(I||{});let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new oe(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:u,checkCreateATAOwner:l});T&&(g=T),f.addInstruction(S||{}),(b===void 0||g===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let B=t||await this.getClmmPoolKeys(e.id),C=await ke.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:B,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:o,amountMaxB:i,withMetadata:m,getEphemeralSigners:y});return f.addInstruction(C),f.addCustomComputeBudget(p),f.versionBuild({txVersion:d,extInfo:{address:C.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,amountMaxA:i,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txVersion:d}=e,p=this.createTxBuilder(),y,f,b=c.useSOLBalance&&t.mintA.address===z.toString(),g=c.useSOLBalance&&t.mintB.address===z.toString(),{account:A,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new oe(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:b||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:l});A&&(y=A),p.addInstruction(w||{});let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new oe(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:g||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});k&&(f=k),p.addInstruction(I||{}),!y&&!f&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let T=n!=null?n:await this.getClmmPoolKeys(t.id),S=ke.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:T,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:f},liquidity:a,amountMaxA:i,amountMaxB:s});return p.addInstruction(S),p.addCustomComputeBudget(m),p.versionBuild({txVersion:d,extInfo:{address:S.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:o,baseAmount:i,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txVersion:m}=e,d=this.createTxBuilder(),p,y,f=a.useSOLBalance&&t.mintA.address===z.toString(),b=a.useSOLBalance&&t.mintB.address===z.toString(),{account:g,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new oe(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f||(o==="MintA"?i:s).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?i:s}:void 0,skipCloseAccount:!f,associatedOnly:f?!1:c,checkCreateATAOwner:u});g&&(p=g),d.addInstruction(A||{});let{account:w,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new oe(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b||(o==="MintA"?s:i).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?s:i}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:c,checkCreateATAOwner:u});w&&(y=w),d.addInstruction(k||{}),!p&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let I=await this.getClmmPoolKeys(t.id),T=ke.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:I,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:p,tokenAccountB:y},base:o,baseAmount:i,otherAmountMax:s});return d.addInstruction(T),d.addCustomComputeBudget(l),d.versionBuild({txVersion:m,extInfo:{address:T.address}})}async decreaseLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,ownerInfo:i,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txVersion:d}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let p=this.createTxBuilder(),y=i.useSOLBalance&&t.mintA.address===z.toString(),f=i.useSOLBalance&&t.mintB.address===z.toString(),b,g,{account:A,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new oe(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:y?!1:u,checkCreateATAOwner:l});b=A,w&&p.addInstruction(w);let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new oe(t.mintB.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,associatedOnly:f?!1:u,checkCreateATAOwner:l});g=k,I&&p.addInstruction(I);let T=[];for(let x of t.rewardDefaultInfos){let L=i.useSOLBalance&&x.mint.address===z.toString(),W;if(x.mint.address===t.mintA.address)W=b;else if(x.mint.address===t.mintB.address)W=g;else{let{account:_,instructionParams:$}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new oe(x.mint.programId),mint:new oe(x.mint.address),notUseTokenAccount:L,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!L,associatedOnly:L?!1:u,checkCreateATAOwner:l});W=_,$&&p.addInstruction($)}T.push(W)}!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let S=n!=null?n:await this.getClmmPoolKeys(t.id),B=await ke.decreaseLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g,rewardAccounts:T},liquidity:c,amountMinA:s,amountMinB:a});p.addInstruction({instructions:B.instructions,instructionTypes:[F.ClmmDecreasePosition]});let C=R({},B.address);if(i.closePosition){let x=await ke.closePositionInstructions({poolInfo:t,poolKeys:S,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:o});p.addInstruction({endInstructions:x.instructions,endInstructionTypes:x.instructionTypes}),C=R(R({},C),x.address)}return p.addCustomComputeBudget(m),p.versionBuild({txVersion:d,extInfo:{address:C}})}async lockPosition(e){let{programId:t=ur,authProgramId:n=cr,poolProgramId:o=ar,ownerPosition:i,computeBudgetConfig:s,txVersion:a}=e,c=this.createTxBuilder(),u=await ke.lockPositionInstruction({programId:t,authProgramId:n,poolProgramId:o,owner:this.scope.ownerPubKey,positionNft:i.nftMint});return c.addInstruction({instructions:[u],instructionTypes:[F.ClmmLockPosition]}),c.addCustomComputeBudget(s),c.versionBuild({txVersion:a})}async harvestLockPosition(e){let{programId:t=ur,authProgramId:n=cr,ownerPosition:o,ownerInfo:i={useSOLBalance:!0},associatedOnly:s=!0,checkCreateATAOwner:a=!1,computeBudgetConfig:c,txVersion:u}=e,l=await this.getClmmPoolKeys(o.poolId.toString()),m=this.createTxBuilder(),d=i.useSOLBalance&&l.mintA.address===z.toString(),p=i.useSOLBalance&&l.mintB.address===z.toString(),y,f,{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.mintA.programId,mint:new oe(l.mintA.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!d,associatedOnly:d?!1:s,checkCreateATAOwner:a});y=b,g&&m.addInstruction(g);let{account:A,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.mintB.programId,mint:new oe(l.mintB.address),notUseTokenAccount:p,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!p,associatedOnly:p?!1:s,checkCreateATAOwner:a});f=A,w&&m.addInstruction(w);let k={},I=[];for(let S of l.rewardInfos){let B=i.useSOLBalance&&S.mint.address===z.toString(),C=k[S.mint.address];if(!C){let{account:x,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new oe(S.mint.programId),mint:new oe(S.mint.address),notUseTokenAccount:B,owner:this.scope.ownerPubKey,skipCloseAccount:!B,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:B?!1:s});C=x,L&&m.addInstruction(L)}k[S.mint.address]=C,I.push(C)}let T=await ke.harvestLockPositionInstruction({programId:t,authProgramId:n,poolKeys:l,ownerPosition:o,owner:this.scope.ownerPubKey,ownerRewardAccounts:I,userVaultA:y,userVaultB:f});return m.addInstruction({instructions:[T],instructionTypes:[F.ClmmHarvestLockPosition]}),m.addCustomComputeBudget(c),m.versionBuild({txVersion:u})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:o}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let i=this.createTxBuilder(),s=t!=null?t:await this.getClmmPoolKeys(e.id),a=ke.closePositionInstructions({poolInfo:e,poolKeys:s,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n});return i.addInstruction(a).versionBuild({txVersion:o,extInfo:{address:a.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let c=this.createTxBuilder(),u=t.useSOLBalance&&n.mint.address.toString()===z.toString(),l=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new oe(n.mint.address),mint:new oe(n.mint.address),notUseTokenAccount:!!u,skipCloseAccount:!u,owner:this.scope.ownerPubKey,createInfo:u?{payer:t.feePayer||this.scope.ownerPubKey,amount:new ct(new O(l.toFixed(0)).gte(l)?l.toFixed(0):l.add(1).toFixed(0))}:void 0,associatedOnly:u?!1:o,checkCreateATAOwner:i});d&&c.addInstruction(d),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let p=await this.getClmmPoolKeys(e.id),y=ke.initRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new oe(n.mint.programId),mint:new oe(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ne.decimalToX64(n.perSecond)}});return c.addInstruction(y),c.addCustomComputeBudget(s),c.versionBuild({txVersion:a,extInfo:{address:y.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txVersion:c}){for(let m of o)m.endTime<=m.openTime&&this.logAndCreateError("reward time error","rewardInfo",m);let u=this.createTxBuilder(),l={};for(let m of o){let d=n.useSOLBalance&&m.mint.address===z.toString(),p=m.perSecond.mul(m.endTime-m.openTime),{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new oe(m.mint.programId),mint:new oe(m.mint.address),notUseTokenAccount:!!d,skipCloseAccount:!d,owner:this.scope.ownerPubKey,createInfo:d?{payer:n.feePayer||this.scope.ownerPubKey,amount:new ct(new O(p.toFixed(0)).gte(p)?p.toFixed(0):p.add(1).toFixed(0))}:void 0,associatedOnly:d?!1:i,checkCreateATAOwner:s});f&&u.addInstruction(f),y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let b=t!=null?t:await this.getClmmPoolKeys(e.id),g=ke.initRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardInfo:{programId:new oe(m.mint.programId),mint:new oe(m.mint.address),openTime:m.openTime,endTime:m.endTime,emissionsPerSecondX64:ne.decimalToX64(m.perSecond)}});l=R(R({},l),g.address),u.addInstruction(g)}return u.addCustomComputeBudget(a),u.versionBuild({txVersion:c,extInfo:{address:l}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let c=this.createTxBuilder(),u=t.useSOLBalance&&n.mint.equals(z),{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:u,owner:this.scope.ownerPubKey,createInfo:u?{payer:t.feePayer||this.scope.ownerPubKey,amount:new ct(new O(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:u?!1:o,checkCreateATAOwner:i});m&&c.addInstruction(m),l||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let d=await this.getClmmPoolKeys(e.id),p=ke.setRewardInstructions({poolInfo:e,poolKeys:d,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:l},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ne.decimalToX64(n.perSecond)}});return c.addInstruction(p),c.addCustomComputeBudget(s),c.versionBuild({txVersion:a,extInfo:{address:p.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txVersion:c}){let u=this.createTxBuilder(),l={};for(let m of o){m.endTime<=m.openTime&&this.logAndCreateError("reward time error","rewardInfo",m);let d=n.useSOLBalance&&m.mint.address===z.toString(),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new oe(m.mint.programId),mint:new oe(m.mint.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:d?{payer:n.feePayer||this.scope.ownerPubKey,amount:new ct(new O(m.perSecond.sub(m.endTime-m.openTime).toFixed(0)).gte(m.perSecond.sub(m.endTime-m.openTime))?m.perSecond.sub(m.endTime-m.openTime).toFixed(0):m.perSecond.sub(m.endTime-m.openTime).add(1).toFixed(0))}:void 0,associatedOnly:d?!1:i,checkCreateATAOwner:s});y&&u.addInstruction(y),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=t!=null?t:await this.getClmmPoolKeys(e.id),b=ke.setRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardInfo:{mint:new oe(m.mint.address),openTime:m.openTime,endTime:m.endTime,emissionsPerSecondX64:ne.decimalToX64(m.perSecond)}});u.addInstruction(b),l=R(R({},l),b.address)}return u.addCustomComputeBudget(a),u.versionBuild({txVersion:c,extInfo:{address:l}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1}){let s=e.rewardDefaultInfos.find(p=>p.mint.address===n.toString());s||this.logAndCreateError("reward mint error","not found reward mint",n);let a=this.createTxBuilder(),c=t.useSOLBalance&&n.equals(z),{account:u,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new oe(s.mint.programId),mint:n,notUseTokenAccount:c,owner:this.scope.ownerPubKey,skipCloseAccount:!c,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:c?!1:o,checkCreateATAOwner:i});l&&a.addInstruction(l),u||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let m=await this.getClmmPoolKeys(e.id),d=ke.collectRewardInstructions({poolInfo:e,poolKeys:m,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:u},rewardMint:n});return a.addInstruction(d),a.build({address:d.address})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1}){let s=this.createTxBuilder(),a={};for(let c of n){let u=e.rewardDefaultInfos.find(f=>f.mint.address===c.toString());if(!u){this.logAndCreateError("reward mint error","not found reward mint",c);continue}let l=t.useSOLBalance&&c.equals(z),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new oe(u.mint.programId),mint:c,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:l?!1:o,checkCreateATAOwner:i});m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),d&&s.addInstruction(d);let p=await this.getClmmPoolKeys(e.id),y=ke.collectRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardMint:c});s.addInstruction(y),a=R(R({},a),y.address)}return s.build({address:a})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:o,amountOutMin:i,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p}){let y=this.createTxBuilder(),f=n.toString()===e.mintA.address,b=c.useSOLBalance&&e.mintA.address===z.toBase58(),g=c.useSOLBalance&&e.mintB.address===z.toBase58(),A;!s||s.equals(new O(0))?A=f?At.add(new ct(1)):wt.sub(new ct(1)):A=ee.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let w;if(!w){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new oe(e.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:b||!f?{payer:c.feePayer||this.scope.ownerPubKey,amount:f?o:0}:void 0,associatedOnly:b?!1:l,checkCreateATAOwner:m});w=T,S&&y.addInstruction(S)}let k;if(!k){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new oe(e.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,skipCloseAccount:!g,createInfo:g||f?{payer:c.feePayer||this.scope.ownerPubKey,amount:f?0:o}:void 0,associatedOnly:g?!1:l,checkCreateATAOwner:m});k=T,S&&y.addInstruction(S)}(!w||!k)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:w,ownerTokenAccountB:k,mintAUseSOLBalance:b,mintBUseSOLBalance:g,associatedOnly:l});let I=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(ke.makeSwapBaseInInstructions({poolInfo:e,poolKeys:I,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:k},inputMint:new oe(n),amountIn:o,amountOutMin:i,sqrtPriceLimitX64:A,remainingAccounts:u})),y.addCustomComputeBudget(p),y.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:o,amountInMax:i,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p}){let y=this.createTxBuilder(),f=n.toString()===e.mintB.address,b=c.useSOLBalance&&e.mintA.address===z.toBase58(),g=c.useSOLBalance&&e.mintB.address===z.toBase58(),A;!s||s.equals(new O(0))?A=n.toString()===e.mintB.address?At.add(new ct(1)):wt.sub(new ct(1)):A=ee.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let w;if(!w){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new oe(e.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:b||!f?{payer:c.feePayer||this.scope.ownerPubKey,amount:f?i:0}:void 0,associatedOnly:b?!1:l,checkCreateATAOwner:m});w=T,S&&y.addInstruction(S)}let k;if(!k){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new oe(e.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,skipCloseAccount:!g,createInfo:g||f?{payer:c.feePayer||this.scope.ownerPubKey,amount:f?0:i}:void 0,associatedOnly:g?!1:l,checkCreateATAOwner:m});k=T,S&&y.addInstruction(S)}(!w||!k)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:w,ownerTokenAccountB:k,mintAUseSOLBalance:b,mintBUseSOLBalance:g,associatedOnly:l});let I=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(ke.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:I,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:k},outputMint:new oe(n),amountOut:o,amountInMax:i,sqrtPriceLimitX64:A,remainingAccounts:u})),y.addCustomComputeBudget(p),y.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u}){let l={};for(let d of this.scope.account.tokenAccountRawInfos)i?ye(this.scope.ownerPubKey,d.accountInfo.mint,a).publicKey.equals(d.pubkey)&&(l[d.accountInfo.mint.toString()]=d.pubkey):l[d.accountInfo.mint.toString()]=d.pubkey;let m=this.createTxBuilder();for(let d of Object.values(e)){if(t[d.id]===void 0||!t[d.id].find(k=>!k.liquidity.isZero()||k.rewardInfos.find(I=>!I.rewardAmountOwed.isZero())))continue;let p=d,y=o.useSOLBalance&&p.mintA.address===z.toString(),f=o.useSOLBalance&&p.mintB.address===z.toString(),b=l[p.mintA.address];if(!b){let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:p.mintA.programId,mint:new oe(p.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,skipCloseAccount:!y,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:y?!1:i,checkCreateATAOwner:s});b=k,I&&m.addInstruction(I)}let g=l[p.mintB.address];if(!g){let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:p.mintB.programId,mint:new oe(p.mintB.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,skipCloseAccount:!f,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:f?!1:i,checkCreateATAOwner:s});g=k,I&&m.addInstruction(I)}l[p.mintA.address]=b,l[p.mintB.address]=g;let A=[];for(let k of p.rewardDefaultInfos){let I=o.useSOLBalance&&k.mint.address===z.toString(),T=l[k.mint.address];if(!T){let{account:S,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new oe(k.mint.programId),mint:new oe(k.mint.address),notUseTokenAccount:I,owner:this.scope.ownerPubKey,skipCloseAccount:!I,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:I?!1:i});T=S,B&&m.addInstruction(B)}l[k.mint.address]=T,A.push(T)}let w=await this.getClmmPoolKeys(p.id);for(let k of t[d.id])if(n&&n[d.id]&&n[d.id][k.nftMint.toBase58()]){let I=ke.harvestLockPositionInstruction({poolKeys:w,owner:this.scope.ownerPubKey,ownerPosition:k,ownerRewardAccounts:A,programId:ur,authProgramId:cr,userVaultA:b,userVaultB:g});m.addInstruction({instructions:[I],instructionTypes:[F.ClmmHarvestLockPosition],lookupTableAddress:w.lookupTableAccount?[w.lookupTableAccount]:[]})}else{let I=ke.decreaseLiquidityInstructions({poolInfo:p,poolKeys:w,ownerPosition:k,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g,rewardAccounts:A},liquidity:new ct(0),amountMinA:new ct(0),amountMinB:new ct(0)});m.addInstruction(I)}}return c===0?m.sizeCheckBuildV0({computeBudgetConfig:u}):m.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(Po(e).publicKey);return t?Bu.decode(t.data).whitelistMints.filter(o=>!o.equals(oe.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new ct(1))).map(s=>at(new oe(e),s.accountInfo.mint).publicKey),o=await this.scope.connection.getMultipleAccountsInfo(n),i=[];return o.forEach(s=>{if(!s)return;let a=Lr.decode(s.data);i.push(a)}),i}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Me(this.scope.connection,e.map(i=>({pubkey:new oe(i)})),t),o={};for(let i=0;i<e.length;i++){let s=n[i];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[i]));let a=fn.decode(s.accountInfo.data),c=ee.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();o[String(e[i])]=E(R({},a),{currentPrice:c,programId:s.accountInfo.owner})}return o}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),o=await Me(this.scope.connection,Array.from(n).map(c=>({pubkey:new oe(c)}))),i={};o.forEach(c=>{!c.accountInfo||(i[c.pubkey.toBase58()]=Tu.decode(c.accountInfo.data))});let s=await Ke.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{var m,d,p,y;let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:tt({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||zu.toBase58(),extensions:{feeConfig:(m=t[u])!=null&&m.feeConfig?an((d=t[u])==null?void 0:d.feeConfig):void 0}}),mintB:tt({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||zu.toBase58(),extensions:{feeConfig:(p=t[l])!=null&&p.feeConfig?an((y=t[l])==null?void 0:y.feeConfig):void 0}}),price:e[c].currentPrice,config:E(R({},i[e[c].ammConfig.toBase58()]),{id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),a=await Ke.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),o=await Bn({connection:this.scope.connection,mints:Array.from(n).map(m=>new oe(m))}),{computeClmmPoolInfo:i,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:o}),a=await Me(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=hu(i[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(Xu.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(Xu.decode((l=a[1].accountInfo)==null?void 0:l.data).amount.toString());let u=E(R({},i[e]),{id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},rewardInfos:[],config:c.config});return{poolInfo:c,poolKeys:u,computePoolInfo:i[e],tickData:s}}};import{PublicKey as Q}from"@solana/web3.js";import{AccountLayout as Jd,NATIVE_MINT as Xr,TOKEN_PROGRAM_ID as Gt}from"@solana/spl-token";import As from"bn.js";import Dr from"decimal.js-light";import Co from"bn.js";function Vr(r,e){if(e.isZero())throw Error("divisor is zero");return r.mod(e)}function Wd(r,e){if(e.isZero())throw Error("rhs is zero");let t=r.div(e);if(t.isZero())throw Error("quotient is zero");let n=Vr(r,e);return n.gt(Dn)&&(t=t.add(new Co(1)),e=r.div(t),n=Vr(r,t),n.gt(Dn)&&(e=e.add(new Co(1)))),[t,e]}var Dn=new Co(0),Fr=class{static swapWithoutFees(e,t,n){let o=t.mul(n),i=t.add(e),[s,a]=Wd(o,i),c=a.sub(t),u=n.sub(s);if(u.isZero())throw Error("destinationAmountSwapped is zero");return{sourceAmountSwapped:c,destinationAmountSwapped:u}}static lpTokensToTradingTokens(e,t,n,o,i){let s=e.mul(n).div(t),a=e.mul(o).div(t);if(i===0)return{tokenAmount0:s,tokenAmount1:a};if(i===1)return Vr(e.mul(n),t).gt(Dn)&&s.gt(Dn)&&(s=s.add(new Co(1))),Vr(e.mul(o),t).gt(Dn)&&a.gt(Dn)&&(a=a.add(new Co(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};import ju from"bn.js";var gs=new ju(1e6);function qd(r,e,t){return r.mul(e).add(t).sub(new ju(1)).div(t)}function Yu(r,e,t){return r.mul(e).div(t)}var Er=class{static tradingFee(e,t){return qd(e,t,gs)}static protocolFee(e,t){return Yu(e,t,gs)}static fundFee(e,t){return Yu(e,t,gs)}};var Qu=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(Qu||{}),Wr=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,o){let i=Er.tradingFee(e,o),s=e.sub(i),{sourceAmountSwapped:a,destinationAmountSwapped:c}=Fr.swapWithoutFees(s,t,n),u=a.add(i);return{newSwapSourceAmount:t.add(u),newSwapDestinationAmount:n.sub(c),sourceAmountSwapped:u,destinationAmountSwapped:c,tradeFee:i}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:o,quoteReserve:i,outputMint:s,outputAmount:a}){let[c,u,l,m,d]=t.address===s.toString()?[o,i,e.decimals,t.decimals,e.address]:[i,o,t.decimals,e.decimals,t.address],p=new Dr(u.toString()).div(10**m).div(new Dr(c.toString()).div(10**l)),y=a.gte(u)?u.sub(new As(1)):a,f=u.sub(y),b=Jt(c.mul(y),f),g=Jt(b.mul(new As(1e6)),new As(1e6).sub(n)),A=g.sub(b),w=new Dr(y.toString()).div(10**m).div(new Dr(g.toString()).div(10**l)),k=p.isZero()?0:w.sub(p).div(p).abs().toNumber();return{amountRealOut:y,amountIn:g,amountInWithoutFee:b,tradeFee:A,priceImpact:k}}};import Ce from"bn.js";import{TransactionInstruction as Ro}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Zd,TOKEN_2022_PROGRAM_ID as $u,TOKEN_PROGRAM_ID as Ps}from"@solana/spl-token";var Ud=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),Gd=Buffer.from("amm_config","utf8"),Xd=Buffer.from("pool","utf8"),zd=Buffer.from("pool_lp_mint","utf8"),Qd=Buffer.from("pool_vault","utf8"),Yd=Buffer.from("observation","utf8");function Wn(r){return se([Ud],r)}function KI(r,e){return se([Gd,Hd(e)],r)}function ws(r,e,t,n){return se([Xd,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function jd(r,e){return se([zd,e.toBuffer()],r)}function Hu(r,e,t){return se([Qd,e.toBuffer(),t.toBuffer()],r)}function qr(r,e){return se([Yd,e.toBuffer()],r)}function Hd(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r,!1),new Uint8Array(e)}function Zu({poolId:r,programId:e,configId:t,mintA:n,mintB:o}){let i=Wn(e).publicKey,s=r||ws(e,t,n,o).publicKey,a=jd(e,s).publicKey,c=Hu(e,s,n).publicKey,u=Hu(e,s,o).publicKey,l=qr(e,s).publicKey;return{poolId:s,configId:t,authority:i,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var $d=ue("Raydium_cpmm"),Lo={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173]};function Ju(r,e,t,n,o,i,s,a,c,u,l,m,d,p,y,f,b,g,A,w){let k=v([P("amountMaxA"),P("amountMaxB"),P("openTime")]),I=ws(r,t,i,s).publicKey,T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!o.equals(I),isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Ps,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:Zd,isSigner:!1,isWritable:!1},{pubkey:er,isSigner:!1,isWritable:!1},{pubkey:ot,isSigner:!1,isWritable:!1}],S=Buffer.alloc(k.span);return k.encode({amountMaxA:g,amountMaxB:A,openTime:w},S),new Ro({keys:T,programId:r,data:Buffer.from([...Lo.initialize,...S])})}function ec(r,e,t,n,o,i,s,a,c,u,l,m,d,p,y){let f=v([P("lpAmount"),P("amountMaxA"),P("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Ps,isSigner:!1,isWritable:!1},{pubkey:$u,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return $d.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:y.toString()}),f.encode({lpAmount:d,amountMaxA:p,amountMaxB:y},g),new Ro({keys:b,programId:r,data:Buffer.from([...Lo.deposit,...g])})}function tc(r,e,t,n,o,i,s,a,c,u,l,m,d,p,y){let f=v([P("lpAmount"),P("amountMinA"),P("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Ps,isSigner:!1,isWritable:!1},{pubkey:$u,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Kn,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:d,amountMinA:p,amountMinB:y},g),new Ro({keys:b,programId:r,data:Buffer.from([...Lo.withdraw,...g])})}function Ur(r,e,t,n,o,i,s,a,c,u,l,m,d,p,y,f){let b=v([P("amountIn"),P("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},A),new Ro({keys:g,programId:r,data:Buffer.from([...Lo.swapBaseInput,...A])})}function nc(r,e,t,n,o,i,s,a,c,u,l,m,d,p,y,f){let b=v([P("amountInMax"),P("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],A=Buffer.alloc(b.span);return b.encode({amountInMax:y,amountOut:f},A),new Ro({keys:g,programId:r,data:Buffer.from([...Lo.swapBaseOutput,...A])})}var oc=v([Ae(8),D("bump"),ze("disableCreatePool"),Vt("index"),P("tradeFeeRate"),P("protocolFeeRate"),P("fundFeeRate"),P("createPoolFee"),K("protocolOwner"),K("fundOwner"),X(P(),16)]),Gr=v([Ae(8),K("configId"),K("poolCreator"),K("vaultA"),K("vaultB"),K("mintLp"),K("mintA"),K("mintB"),K("mintProgramA"),K("mintProgramB"),K("observationId"),D("bump"),D("status"),D("lpDecimals"),D("mintDecimalA"),D("mintDecimalB"),P("lpAmount"),P("protocolFeesMintA"),P("protocolFeesMintB"),P("fundFeesMintA"),P("fundFeesMintB"),P("openTime"),X(P(),32)]);var Oo=class extends Se{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){return(await this.getRpcPoolInfos([e],t))[e]}async getRpcPoolInfos(e,t){let n=await Me(this.scope.connection,e.map(m=>({pubkey:new Q(m)}))),o={},i=new Set,s=[];for(let m=0;m<e.length;m++){let d=n[m];if(d.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let p=Gr.decode(d.accountInfo.data);o[String(e[m])]=E(R({},p),{programId:d.accountInfo.owner}),i.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let m=[...i],d=await Me(this.scope.connection,m.map(p=>({pubkey:new Q(p)})));for(let p=0;p<m.length;p++){let y=d[p].accountInfo;if(y===null)throw Error("fetch pool config error: "+m[p]);a[m[p]]=oc.decode(y.data)}}let c={},u=await Me(this.scope.connection,s.map(m=>({pubkey:new Q(m)})));for(let m=0;m<s.length;m++){let d=u[m].accountInfo;if(d===null)throw Error("fetch vault info error: "+s[m]);c[String(s[m])]=new Ce(Jd.decode(d.data).amount.toString())}let l={};for(let[m,d]of Object.entries(o)){let p=c[d.vaultA.toString()].sub(d.protocolFeesMintA).sub(d.fundFeesMintA),y=c[d.vaultB.toString()].sub(d.protocolFeesMintB).sub(d.fundFeesMintB);l[m]=E(R({},d),{baseReserve:p,quoteReserve:y,vaultAAmount:c[d.vaultA.toString()],vaultBAmount:c[d.vaultB.toString()],configInfo:a[d.configId.toString()],poolPrice:new O(y.toString()).div(new O(10).pow(d.mintDecimalB)).div(new O(p.toString()).div(new O(10).pow(d.mintDecimalA)))})}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,o)=>{var c,u,l,m;let i=e[o],[s,a]=[i.mintA.toBase58(),i.mintB.toBase58()];return E(R({},n),{[o]:E(R({},i),{id:new Q(o),configInfo:i.configInfo,version:7,authority:Wn(i.programId).publicKey,mintA:tt({address:s,decimals:i.mintDecimalA,programId:i.mintProgramA.toBase58(),extensions:{feeConfig:(c=t[s])!=null&&c.feeConfig?an((u=t[s])==null?void 0:u.feeConfig):void 0}}),mintB:tt({address:a,decimals:i.mintDecimalB,programId:i.mintProgramB.toBase58(),extensions:{feeConfig:(l=t[a])!=null&&l.feeConfig?an((m=t[a])==null?void 0:m.feeConfig):void 0}})})})},{})}async getPoolInfoFromRpc(e){let t=await this.getRpcPoolInfo(e,!0),n=await Bn({connection:this.scope.connection,mints:[t.mintA,t.mintB]}),o=tt({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?an(n[t.mintA.toBase58()].feeConfig):void 0}}),i=tt({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?an(n[t.mintB.toBase58()].feeConfig):void 0}}),s=tt({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:Gt.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:o,mintB:i,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new O(t.vaultAAmount.toString()).div(10**o.decimals).toNumber(),mintAmountB:new O(t.vaultBAmount.toString()).div(10**i.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:o,mintB:i,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Wn(t.programId).publicKey.toBase58(),mintLp:s,config:a},rpcData:t}}async createPool(d){var p=d,{poolId:e,programId:t,poolFeeAccount:n,startTime:o,ownerInfo:i,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l}=p,m=Le(p,["poolId","programId","poolFeeAccount","startTime","ownerInfo","associatedOnly","checkCreateATAOwner","txVersion","feeConfig","computeBudgetConfig"]);var $,G,q;let y=i.feePayer||(($=this.scope.owner)==null?void 0:$.publicKey),f=new Ce(new Q(m.mintA.address).toBuffer()).lte(new Ce(new Q(m.mintB.address).toBuffer())),[b,g]=f?[m.mintA,m.mintB]:[m.mintB,m.mintA],[A,w]=f?[m.mintAAmount,m.mintBAmount]:[m.mintBAmount,m.mintAAmount],k=i.useSOLBalance&&b.address===Xr.toBase58(),I=i.useSOLBalance&&g.address===Xr.toBase58(),[T,S]=[new Q(b.address),new Q(g.address)],B=this.createTxBuilder(),{account:C,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({mint:T,tokenProgram:b.programId,owner:this.scope.ownerPubKey,createInfo:k?{payer:y,amount:A}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:s,checkCreateATAOwner:a});B.addInstruction(x||{});let{account:L,instructionParams:W}=await this.scope.account.getOrCreateTokenAccount({mint:new Q(g.address),tokenProgram:g.programId,owner:this.scope.ownerPubKey,createInfo:I?{payer:y,amount:w}:void 0,notUseTokenAccount:I,skipCloseAccount:!I,associatedOnly:I?!1:s,checkCreateATAOwner:a});if(B.addInstruction(W||{}),C===void 0||L===void 0)throw Error("you don't has some token account");let _=Zu({poolId:e,programId:t,configId:new Q(u.id),mintA:T,mintB:S});return B.addInstruction({instructions:[Ju(t,this.scope.ownerPubKey,new Q(u.id),_.authority,_.poolId,T,S,_.lpMint,C,L,ye(this.scope.ownerPubKey,_.lpMint).publicKey,_.vaultA,_.vaultB,n,new Q((G=b.programId)!=null?G:Gt),new Q((q=g.programId)!=null?q:Gt),_.observationId,A,w,o)],instructionTypes:[F.CpmmCreatePool]}),B.addCustomComputeBudget(l),B.versionBuild({txVersion:c,extInfo:{address:E(R({},_),{mintA:b,mintB:g,programId:t,poolFeeAccount:n,feeConfig:u})}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:o,baseIn:i,slippage:s,computeResult:a,computeBudgetConfig:c,config:u,txVersion:l}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),o.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:o.toString()});let{account:m}=this.scope,{bypassAssociatedCheck:d,checkCreateATAOwner:p}=R({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),y=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:f,inputAmountFee:b,anotherAmount:g}=a||this.computePairAmount({poolInfo:E(R({},t),{lpAmount:new O(y.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()}),baseReserve:y.baseReserve,quoteReserve:y.quoteReserve,slippage:new Ee(0),baseIn:i,epochInfo:await this.scope.fetchEpochInfo(),amount:new O(o.toString()).div(10**(i?t.mintA.decimals:t.mintB.decimals))}),A=g.amount,w=t.mintA.address===Xr.toString(),k=t.mintB.address===Xr.toString(),I=this.createTxBuilder(),[T,S]=[new Q(t.mintA.address),new Q(t.mintB.address)],{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:w||(i?o:A).isZero()?{payer:this.scope.ownerPubKey,amount:i?o:A}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:!1,checkCreateATAOwner:p});I.addInstruction(C||{});let{account:x,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||(i?A:o).isZero()?{payer:this.scope.ownerPubKey,amount:i?A:o}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!1,checkCreateATAOwner:p});I.addInstruction(L||{}),!B&&!x&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",m.tokenAccounts);let W=await m.getCreatedTokenAccount({mint:new Q(t.lpMint.address)}),$e=await m.handleTokenAccount({side:"out",amount:0,mint:new Q(t.lpMint.address),tokenAccount:W,bypassAssociatedCheck:d,checkCreateATAOwner:p}),{tokenAccount:_}=$e,$=Le($e,["tokenAccount"]);I.addInstruction($);let G=n!=null?n:await this.getCpmmPoolKeys(t.id),q=new Ee(new Ce(1)).sub(s);return I.addInstruction({instructions:[ec(new Q(t.programId),this.scope.ownerPubKey,new Q(G.authority),new Q(t.id),_,B,x,new Q(G.vault.A),new Q(G.vault.B),T,S,new Q(t.lpMint.address),a?a==null?void 0:a.liquidity:q.mul(f).quotient,i?b.amount:A,i?A:b.amount)],instructionTypes:[F.CpmmAddLiquidity],lookupTableAddress:G.lookupTableAccount?[G.lookupTableAccount]:[]}),I.addCustomComputeBudget(c),I.versionBuild({txVersion:l})}async withdrawLiquidity(e){var _,$;let{poolInfo:t,poolKeys:n,lpAmount:o,slippage:i,computeBudgetConfig:s,txVersion:a}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let c=new Ee(new Ce(1)).sub(i),u=await this.getRpcPoolInfo(t.id),[l,m]=[c.mul(o.mul(u.baseReserve).div(u.lpAmount)).quotient,c.mul(o.mul(u.quoteReserve).div(u.lpAmount)).quotient],d=await this.scope.fetchEpochInfo(),[p,y]=[fe(l,t.mintA.extensions.feeConfig,d,!1),fe(m,t.mintB.extensions.feeConfig,d,!1)],{account:f}=this.scope,b=this.createTxBuilder(),[g,A]=[new Q(t.mintA.address),new Q(t.mintB.address)],w=g.equals(z),k=A.equals(z),I,T,{account:S,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,associatedOnly:!w,checkCreateATAOwner:!1});I=S,B&&b.addInstruction(B);let{account:C,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:!k,checkCreateATAOwner:!1});T=C,x&&b.addInstruction(x),(!I||!T)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",f.tokenAccounts);let L=await f.getCreatedTokenAccount({mint:new Q(t.lpMint.address)});L||this.logAndCreateError("cannot found lp token account","tokenAccounts",f.tokenAccounts);let W=n!=null?n:await this.getCpmmPoolKeys(t.id);return b.addInstruction({instructions:[tc(new Q(t.programId),this.scope.ownerPubKey,new Q(W.authority),new Q(t.id),L,I,T,new Q(W.vault.A),new Q(W.vault.B),g,A,new Q(t.lpMint.address),o,l.sub((_=p.fee)!=null?_:new Ce(0)),m.sub(($=y.fee)!=null?$:new Ce(0)))],instructionTypes:[F.CpmmWithdrawLiquidity],lookupTableAddress:W.lookupTableAccount?[W.lookupTableAccount]:[]}),b.addCustomComputeBudget(s),b.versionBuild({txVersion:a})}async swap(e){var C,x,L,W,_,$;let{poolInfo:t,poolKeys:n,baseIn:o,fixedOut:i,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txVersion:m}=e,{bypassAssociatedCheck:d,checkCreateATAOwner:p,associatedOnly:y}=R({bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0},u),f=this.createTxBuilder(),[b,g]=[new Q(t.mintA.address),new Q(t.mintB.address)];i?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new Ce((1+c)*1e4)).div(new Ce(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new Ce((1-c)*1e4)).div(new Ce(1e4));let A=t.mintA.address===z.toBase58(),w=t.mintB.address===z.toBase58(),{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:b,tokenProgram:new Q((C=t.mintA.programId)!=null?C:Gt),owner:this.scope.ownerPubKey,createInfo:A||!o?{payer:this.scope.ownerPubKey,amount:o?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:y,checkCreateATAOwner:p});I&&f.addInstruction(I);let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:g,tokenProgram:new Q((x=t.mintB.programId)!=null?x:Gt),owner:this.scope.ownerPubKey,createInfo:w||o?{payer:this.scope.ownerPubKey,amount:o?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:y,checkCreateATAOwner:p});S&&f.addInstruction(S),(!k||!T)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:k,mintBTokenAcc:T,mintAUseSOLBalance:A,mintBUseSOLBalance:w,associatedOnly:y});let B=n!=null?n:await this.getCpmmPoolKeys(t.id);return f.addInstruction({instructions:[i?nc(new Q(t.programId),this.scope.ownerPubKey,new Q(B.authority),new Q(B.config.id),new Q(t.id),o?k:T,o?T:k,new Q(B.vault[o?"A":"B"]),new Q(B.vault[o?"B":"A"]),new Q((_=t[o?"mintA":"mintB"].programId)!=null?_:Gt),new Q(($=t[o?"mintB":"mintA"].programId)!=null?$:Gt),o?b:g,o?g:b,qr(new Q(t.programId),new Q(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):Ur(new Q(t.programId),this.scope.ownerPubKey,new Q(B.authority),new Q(B.config.id),new Q(t.id),o?k:T,o?T:k,new Q(B.vault[o?"A":"B"]),new Q(B.vault[o?"B":"A"]),new Q((L=t[o?"mintA":"mintB"].programId)!=null?L:Gt),new Q((W=t[o?"mintB":"mintA"].programId)!=null?W:Gt),o?b:g,o?g:b,qr(new Q(t.programId),new Q(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[i?F.CpmmSwapBaseOut:F.ClmmSwapBaseIn]}),f.addCustomComputeBudget(l),f.versionBuild({txVersion:m})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:o}){let i=n.toString()===e.mintB.address,s=Wr.swap(t,i?e.baseReserve:e.quoteReserve,i?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new O(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new Ce((1-o)*1e4)).div(new Ce(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:o,slippage:i,epochInfo:s,baseIn:a}){var k,I,T,S,B,C,x,L,W;let c=1-Number(i.toSignificant())/100,u=new Ce(new O(o).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=fe(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),m=u.sub((k=l.fee)!=null?k:new Ce(0)),d=new Ce(new O(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",(T=(I=l.fee)==null?void 0:I.toString())!=null?T:0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${i.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let y=m.mul(d).div(p==="base"?t:n),f={amount:yt,fee:void 0,expirationTime:void 0};if(!m.isZero()){let _=ep(y,t,n,d);this.logDebug("lpAmountData:",{amountA:_.amountA.toString(),amountB:_.amountB.toString()}),f=fe(_[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new Ee(new Ce(1)).add(i),g=new Ee(new Ce(1)).sub(i),A=fe(b.mul(f.amount.sub((S=f.fee)!=null?S:new Ce(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),w=fe(g.mul(f.amount.sub((B=f.fee)!=null?B:new Ce(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",(x=(C=f.fee)==null?void 0:C.toString())!=null?x:0,"maxAnotherAmount:",A.amount.toString(),"maxAnotherAmountFee:",(W=(L=A.fee)==null?void 0:L.toString())!=null?W:0),{inputAmountFee:l,anotherAmount:f,maxAnotherAmount:A,minAnotherAmount:w,liquidity:y}}};function ep(r,e,t,n){let o=r.mul(e).div(n);!o.isZero()&&!r.mul(e).mod(n).isZero()&&(o=o.add(new Ce(1)));let i=r.mul(t).div(n);return!i.isZero()&&!r.mul(t).mod(n).isZero()&&(i=i.add(new Ce(1))),{amountA:o,amountB:i}}import{PublicKey as Pn}from"@solana/web3.js";import{createTransferInstruction as cc,TOKEN_PROGRAM_ID as Re,TOKEN_2022_PROGRAM_ID as Yr}from"@solana/spl-token";import jr from"bn.js";var rc={[Ai.toBase58()]:3},ic={3:Ai};var hs=v([Ae(5),Ae(8),K("ownAddress"),P("vaultSignerNonce"),K("baseMint"),K("quoteMint"),K("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),K("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),K("requestQueue"),K("eventQueue"),K("bids"),K("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),Ae(7)]),sc={3:hs};import{PublicKey as ac}from"@solana/web3.js";var zr=ue("Serum"),Qr=class{static getProgramId(e){let t=ic[e];return t||zr.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=rc[t];return n||zr.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=sc[e];return t||zr.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],o=0,i;for(;o<100;){try{let s=n.concat(Buffer.from([o]),Buffer.alloc(7));i=ac.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;o++;continue}return{publicKey:i,nonce:o}}return zr.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:ac.default,nonce:o}}};import{PublicKey as H,SystemProgram as ks,TransactionInstruction as Ts}from"@solana/web3.js";import wn from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as tp,TOKEN_2022_PROGRAM_ID as np,TOKEN_PROGRAM_ID as Is}from"@solana/spl-token";function XB(r,e,t,n,o,i,s,a,c,u,l,m){let d=v([D("instruction"),P("amountIn"),P("amountOut")]),p=[{pubkey:ks.programId,isSigner:!1,isWritable:!1},{pubkey:Is,isSigner:!1,isWritable:!1},{pubkey:new H(t.programId),isSigner:!1,isWritable:!1},{pubkey:new H(t.id),isSigner:!1,isWritable:!0},{pubkey:new H(n.id),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=Te(t);p.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...m.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=Te(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new H("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=Te(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let y=Buffer.alloc(d.span);return d.encode({instruction:4,amountIn:u,amountOut:l},y),new Ts({keys:p,programId:r,data:y})}function zB(r,e,t,n,o,i,s,a,c,u){let l=v([D("instruction")]),m=[{pubkey:ks.programId,isSigner:!1,isWritable:!1},{pubkey:Is,isSigner:!1,isWritable:!1},{pubkey:new H(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new H(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new H(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let p=Te(n);m.push({pubkey:p.config.id,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.A:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.B:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},...u.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let p=Te(n);m.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:new H("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0})}else{let p=Te(n);m.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},...p.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:p.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:p.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0}])}let d=Buffer.alloc(l.span);return l.encode({instruction:5},d),new Ts({keys:m,programId:r,data:d})}function op(r,e,t,n,o,i,s,a,c,u,l,m,d,p,y){var T;let f=[],b=[h({pubkey:Is,isWritable:!1}),h({pubkey:np,isWritable:!1}),h({pubkey:tp,isWritable:!1}),h({pubkey:ks.programId,isWritable:!1}),h({pubkey:e,isSigner:!0})];b.push(h({pubkey:t})),b.push(h({pubkey:o}));let g=[c,u],A=[l,m],w=[i,s,a];for(let S=0;S<g.length;S++){let B=g[S],C=w[S]===B.mintA.address;if(b.push(h({pubkey:new H(B.programId),isWritable:!1})),S===g.length-1?b.push(h({pubkey:o})):b.push(h({pubkey:n})),b.push(h({pubkey:new H(w[S])})),b.push(h({pubkey:new H(w[S+1])})),B.version===6){let x=A[S];b.push(h({pubkey:new H(x.config.id)})),b.push(h({pubkey:new H(x.id)})),b.push(h({pubkey:new H(C?x.vault.A:x.vault.B)})),b.push(h({pubkey:new H(C?x.vault.B:x.vault.A)})),b.push(h({pubkey:new H(B.observationId)})),b.push(h({pubkey:Kn})),b.push(h({pubkey:ut(new H(B.programId),new H(B.id)).publicKey})),f.push(rp(B.sqrtPriceX64.toString(),C));for(let L of(T=y[S])!=null?T:[])b.push(h({pubkey:new H(L)}))}else if(B.version===5){let x=A[S];b.push(h({pubkey:new H(x.id)})),b.push(h({pubkey:new H(x.authority),isWritable:!1})),b.push(h({pubkey:new H(x.marketProgramId)})),b.push(h({pubkey:new H(x.marketAuthority)})),b.push(h({pubkey:ha,isWritable:!1})),b.push(h({pubkey:new H(x.openOrders)})),b.push(h({pubkey:new H(x.vault.A)})),b.push(h({pubkey:new H(x.vault.B)})),b.push(h({pubkey:new H(x.id)})),b.push(h({pubkey:new H(x.id)})),b.push(h({pubkey:new H(x.id)})),b.push(h({pubkey:new H(x.id)})),b.push(h({pubkey:new H(x.id)})),b.push(h({pubkey:new H(x.id)})),b.push(h({pubkey:new H(x.marketId)})),b.push(h({pubkey:new H(x.marketBids)})),b.push(h({pubkey:new H(x.marketAsks)})),b.push(h({pubkey:new H(x.marketEventQueue)})),b.push(h({pubkey:new H(x.marketBaseVault)})),b.push(h({pubkey:new H(x.marketQuoteVault)}))}else if(B.version===4){let x=A[S],L=B.status!==1;b.push(h({pubkey:new H(x.id)})),b.push(h({pubkey:new H(x.authority),isWritable:!1})),b.push(h({pubkey:new H(L?x.id:x.marketProgramId)})),b.push(h({pubkey:new H(L?x.id:x.marketAuthority)})),b.push(h({pubkey:new H(L?x.id:x.openOrders)})),b.push(h({pubkey:new H(x.vault.A)})),b.push(h({pubkey:new H(x.vault.B)})),b.push(h({pubkey:new H(L?x.id:x.marketId)})),b.push(h({pubkey:new H(L?x.id:x.marketBids)})),b.push(h({pubkey:new H(L?x.id:x.marketAsks)})),b.push(h({pubkey:new H(L?x.id:x.marketEventQueue)})),b.push(h({pubkey:new H(L?x.id:x.marketBaseVault)})),b.push(h({pubkey:new H(L?x.id:x.marketQuoteVault)}))}else if(B.version===7){let x=A[S];b.push(h({pubkey:new H(x.authority)})),b.push(h({pubkey:new H(x.config.id)})),b.push(h({pubkey:new H(x.id)})),b.push(h({pubkey:new H(C?x.vault.A:x.vault.B)})),b.push(h({pubkey:new H(C?x.vault.B:x.vault.A)})),b.push(h({pubkey:new H(B.observationId)}))}else throw Error("pool type error")}let k=v([D("insId"),P("amountIn"),P("amountOut"),X(J(),f.length,"clmmPriceLimit")]),I=Buffer.alloc(k.span);return k.encode({insId:0,amountIn:d,amountOut:p,clmmPriceLimit:f},I),new Ts({keys:b,programId:r,data:I})}function rp(r,e){if(r)if(e){let t=new wn(r).div(new wn(25));return t.gt(xr)?t:xr}else{let t=new wn(r).mul(new wn(25));return t.lt(Sr)?t:Sr}else return e?xr:Sr}function uc({routeProgram:r,ownerInfo:e,inputMint:t,swapInfo:n}){var o,i,s,a,c,u,l;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let m=n.poolKey[0],d=Te(m),p=t.equals(d.mintA.address)?At.add(dt):wt.sub(dt);return ke.makeSwapBaseInInstructions({poolInfo:m,poolKeys:m,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:d.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:d.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((i=(o=n.minAmountOut.fee)==null?void 0:o.raw)!=null?i:new wn(0)),sqrtPriceLimitX64:p,remainingAccounts:(s=n.remainingAccounts[0])!=null?s:[]})}else if(n.poolInfo[0].version===7){let m=n.poolInfo[0],d=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[Ur(m.programId,e.wallet,m.authority,m.configId,m.id,e.sourceToken,e.destinationToken,d?m.vaultA:m.vaultB,d?m.vaultB:m.vaultA,d?m.mintProgramA:m.mintProgramB,d?m.mintProgramB:m.mintProgramA,new H(m[d?"mintA":"mintB"].address),new H(m[d?"mintB":"mintA"].address),m.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[d?F.CpmmSwapBaseIn:F.CpmmSwapBaseOut],address:{}}}else{let m=n.poolKey[0];return{signers:[],instructions:[Mr({poolKeys:m,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((c=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?c:new wn(0)),fixedSide:"in"})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?F.AmmV5SwapBaseIn:F.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let m=n.poolInfo[0],d=n.poolInfo[1],p=n.poolKey[0],y=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[op(r,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),m,d,p,y,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((l=(u=n.minAmountOut.fee)==null?void 0:u.raw)!=null?l:new wn(0)),n.remainingAccounts)],instructionTypes:[F.RouteSwap],lookupTableAddress:[p.lookupTableAccount,y.lookupTableAccount].filter(f=>f!==void 0),address:{}}}else throw Error("route type error")}var Xt=new jr(0),No=class extends Se{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(z));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:o=1}=e,i=await this.getWSolAccounts(),s=this.createTxBuilder();s.addCustomComputeBudget(e.computeBudgetConfig);let a=await Et({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:0});s.addInstruction(a);let c=Y(t);for(let u=0;u<i.length;u++)c.gte(i[u].amount)?(s.addInstruction({instructions:[Ft({tokenAccount:i[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(i[u].amount)):s.addInstruction({instructions:[Ft({tokenAccount:i[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return s.versionBuild({txVersion:o})}async wrapWSol(e,t,n){let o=this.createTxBuilder(),i=await Et({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return o.addInstruction(i),o.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:o,routeProgram:i,txVersion:s}){let a=this.createTxBuilder(),c=e.amountIn,u=e.amountOut,l=c.amount.token.mint.equals(z),m=u.amount.token.mint.equals(z),d=c.amount.token.mint,p=u.amount.token.mint,{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:c.amount.token.isToken2022?Yr:Re,mint:d,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:l?{payer:this.scope.ownerPubKey,amount:c.amount.raw}:void 0,associatedOnly:l?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(f&&a.addInstruction(f),y===void 0)throw Error("input account check error");let b;if(e.routeType==="route")b=this.scope.account.getAssociatedTokenAccount(p,u.amount.token.isToken2022?Yr:Re);else{let{account:k,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?Yr:Re,mint:p,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});b=k,I&&a.addInstruction(I)}m&&a.addInstruction({endInstructions:[Ft({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:b,programId:Re})],endInstructionTypes:[F.CloseAccount]});let g;if(e.routeType==="route"){let k=e.middleToken;g=this.scope.account.getAssociatedTokenAccount(k.mint,k.isToken2022?Yr:Re)}let A=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),w=uc({routeProgram:i,inputMint:d,swapInfo:E(R({},e),{poolInfo:[...e.poolInfoList],poolKey:A,outputMint:p}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:y,routeToken:g,destinationToken:b}});if(e.feeConfig!==void 0){let k=this.createTxBuilder();k.addInstruction({instructions:[cc(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[F.TransferAmount]}),k.addInstruction(w);let{transactions:I}=s===0?await k.sizeCheckBuildV0():await k.sizeCheckBuild();I.length<2&&a.addInstruction({instructions:[cc(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[F.TransferAmount]})}return a.addInstruction(w),s===0?a.sizeCheckBuildV0({computeBudgetConfig:o,address:w.address}):a.sizeCheckBuild({computeBudgetConfig:o,address:w.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Pa,clmm:n=ar,cpmm:o=ka}=e||{},i=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:Bo.offsetOf("baseMint"),length:64}}),s=v([K("baseMint"),K("quoteMint")]),a=i.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=v([K("mintA"),K("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:fn.span}],dataSlice:{offset:fn.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:y.mintA,mintB:y.mintB}}),d=(await this.scope.connection.getProgramAccounts(o,{dataSlice:{offset:Gr.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:y.mintA,mintB:y.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:d}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:o,cpmmPools:i}){e=e.toString()===Pn.default.toString()?z:e,t=t.toString()===Pn.default.toString()?z:t;let s={},a={},c={},u=[],l={};for(let d of n!=null?n:[]){if((d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),a[d.id.toString()]=d),d.mintA.equals(e)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintB.equals(e)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintA.equals(t)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[p].out.push(d)}if(d.mintB.equals(t)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[p].out.push(d)}}let m=[];for(let d of o)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),s[d.id.toBase58()]=d,m.push(d)),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of i)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),c[d.id.toBase58()]=d),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Re,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of Object.keys(l)){if(l[d].in.length===1&&l[d].out.length===1&&l[d].in[0].id.equals(l[d].out[0].id)){delete l[d];continue}if(l[d].in.length===0||l[d].out.length===0){delete l[d];continue}let p=l[d];for(let y of p.in)for(let f of p.out)y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&c[y.id.toString()]===void 0?c[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y),f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f)}return{directPath:u,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let o=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let i=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),s=vr(i),a={};Object.values(s).forEach(f=>{o.delete(f.mintA.address),a[f.mintA.address]={address:new Pn(f.mintA.address),programId:Re,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},o.delete(f.mintB.address),a[f.mintB.address]={address:new Pn(f.mintB.address),programId:Re,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(c).forEach(f=>{let[b,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(Re)?(o.delete(b),a[b]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(b),f.mintProgramB.equals(Re)?(o.delete(g),a[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(g)}),console.log("fetching mints info, total: ",o.size);let u=await Bn({connection:this.scope.connection,mints:Array.from(o).map(f=>new Pn(f))});a=R(R({},a),u);let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:d,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:a}),y=Object.keys(e.routePathDict).reduce((f,b)=>E(R({},f),{[b]:E(R({},e.routePathDict[b]),{mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()])})}),{});return{mintInfos:a,ammPoolsRpcInfo:i,ammSimulateCache:s,clmmPoolsRpcInfo:m,computeClmmPoolInfo:d,computePoolTickData:p,computeCpmmData:l,routePathDict:y}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:o,simulateCache:i,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){var g,A,w,k,I,T,S,B,C;let m=l===void 0?new jr(0):e.raw.mul(new jr(l.feeBps.toNumber())).div(new jr(1e4)),d=e.raw.sub(m),p=new ge(e.token,d),y=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},f=E(R({},t),{address:lt(t.address).toString()}),b=[];for(let x of n)try{b.push(E(R({},this.computeAmountOut({itemPool:x,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:p})),{feeConfig:y}))}catch(L){this.logDebug("direct error",x.version,x.id.toString(),L.message)}this.logDebug("direct done");for(let[x,L]of Object.entries(o)){let W={chainId:101,address:x,programId:L.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:L.mDecimals,tags:[],extensions:{}},_=L.in.map(G=>{try{return{pool:G,data:this.computeAmountOut({itemPool:G,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:W,amountIn:p})}}catch(q){this.logDebug("route in error",G.version,G.id.toString(),q.message);return}}).sort((G,q)=>{var un,zt,Tn,Qt;let $e=G===void 0?Xt:G.data.amountOut.amount.raw.sub((zt=(un=G.data.amountOut.fee)==null?void 0:un.raw)!=null?zt:Xt),kn=q===void 0?Xt:q.data.amountOut.amount.raw.sub((Qt=(Tn=q.data.amountOut.fee)==null?void 0:Tn.raw)!=null?Qt:Xt);return $e.lt(kn)?1:-1})[0];if(_===void 0)continue;let $=new ge(Or(W),_.data.amountOut.amount.raw.sub((A=(g=_.data.amountOut.fee)==null?void 0:g.raw)!=null?A:Xt));for(let G of L.out)try{let q=this.computeAmountOut({itemPool:G,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:$});b.push(E(R({},q),{allTrade:!!(_.data.allTrade&&q.allTrade),amountIn:_.data.amountIn,amountOut:q.amountOut,minAmountOut:q.minAmountOut,currentPrice:void 0,executionPrice:new O(new rt({baseToken:_.data.amountIn.amount.token,denominator:_.data.amountIn.amount.raw,quoteToken:q.amountOut.amount.token,numerator:q.amountOut.amount.raw.sub((k=(w=q.amountOut.fee)==null?void 0:w.raw)!=null?k:Xt)}).toFixed()),priceImpact:new O(_.data.priceImpact.add(q.priceImpact).toFixed()),fee:[_.data.fee[0],q.fee[0]],routeType:"route",poolInfoList:[_.pool,G],remainingAccounts:[_.data.remainingAccounts[0],q.remainingAccounts[0]],minMiddleAmountFee:(I=q.amountOut.fee)!=null&&I.raw?new ge(_.data.amountOut.amount.token,((S=(T=_.data.amountOut.fee)==null?void 0:T.raw)!=null?S:Xt).add((C=(B=q.amountOut.fee)==null?void 0:B.raw)!=null?C:Xt)):void 0,middleToken:_.data.amountOut.amount.token,poolReady:_.data.poolReady&&q.poolReady,poolType:[_.data.poolType,q.poolType],feeConfig:y,expirationTime:xt(_.data.expirationTime,q.expirationTime)}))}catch(q){this.logDebug("route out error",G.version,G.id.toString(),q.message)}}return b.filter(x=>(x.allTrade||this.logDebug(`pool ${x.poolInfoList.map(L=>L.id.toString()).join(",")} filter out since not all trade`),x.allTrade)).sort((x,L)=>x.amountOut.amount.raw.sub(L.amountOut.amount.raw).gt(Xt)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:o,epochInfo:i,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:m,minAmountOut:d,expirationTime:p,currentPrice:y,executionPrice:f,priceImpact:b,fee:g,remainingAccounts:A,executionPriceX64:w}=Ke.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:i,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:m,minAmountOut:d,currentPrice:new O(y.toFixed()),executionPrice:new O(f.toFixed()),priceImpact:new O(b.toFixed()),fee:[g],remainingAccounts:[A],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<o,poolType:"CLMM",slippage:s,clmmExPriceX64:[w],expirationTime:xt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:m,minAmountOut:d,priceImpact:p,fee:y}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Io(E(R({},a),{amount:m})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Io(E(R({},a),{amount:d})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new ge(c.token,y)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<o,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:m,executionPrice:d,priceImpact:p,fee:y}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Io(E(R({},a),{amount:u})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Io(E(R({},a),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:d,priceImpact:p,fee:[new ge(c.token,y)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<o,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let o=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(o.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(o)});Object.keys(u).forEach(l=>{t[l]=u[l]})}if(new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString())).size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(o));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await Me(this.scope.connection,Array.from(s).map(l=>({pubkey:new Pn(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=hs.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:Qr.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],m={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:E(R({},u.ammConfig),{id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[]};c.push(m)}else if(u.version===4){let l=n[u.id.toString()],m=R({programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:bs({programId:new Pn(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint},a[u.marketId]);c.push(m)}else u.version===7&&c.push({programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:Wn(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:tt({address:u.mintLp.toBase58(),programId:Re.toBase58(),decimals:u.lpDecimals}),config:E(R({id:u.configId.toBase58()},u.configInfo),{protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()})})}),c}};import{PublicKey as ip,Transaction as Bs,TransactionInstruction as sp}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ap}from"@solana/spl-token";import lc from"bn.js";var Ze=class extends Se{static getPdaPoolId(e,t){return se([Ze.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,o){return se([Ze.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new lc(o).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:o,chainTime:i}){if(n.length===0)return[];let s=n.map(l=>Ze.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<Ze.VERSION_PROJECT.length;l++)a.push(...s.map(m=>Ze.getPdaOwnerId(t,m,o,l).publicKey));let c=await ht(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],y=a[l],f=c[d],b=c[n.length+l];if(!(f&&b)||f.data.length!==Ze.POOL_LAYOUT.span||b.data.length!==Ze.OWNER_LAYOUT.span)continue;let g=Ze.POOL_LAYOUT.decode(f.data),A=Ze.OWNER_LAYOUT.decode(b.data),w=g.openTime.toNumber(),k=g.endTime.toNumber(),I=A.tokenInfo.map(B=>B.debtAmount.gt(new lc(0))).filter(B=>!B).length!==3,T=i>w&&i<k&&g.status===1,S=I&&T;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:y,snapshotLpAmount:A.lpAmount,project:Ze.VERSION_PROJECT[m],openTime:w,endTime:k,canClaim:S,canClaimErrorType:I?T?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((B,C)=>({mintAddress:B.mintAddress,mintVault:B.mintVault,mintDecimals:B.mintDecimals,perLpLoss:B.perLpLoss,debtAmount:A.tokenInfo[C].debtAmount.add(A.tokenInfo[C].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t}){t.wallet||this.scope.checkOwner();let n=this.createTxBuilder(),o=t.wallet||this.scope.ownerPubKey,i=[];for(let c of e.tokenInfo){let{account:u,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({mint:c.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:c.mintAddress.equals(xe.WSOL.mint),createInfo:{payer:o,amount:0},skipCloseAccount:!c.mintAddress.equals(xe.WSOL.mint),associatedOnly:c.mintAddress.equals(xe.WSOL.mint)?!1:t.associatedOnly});l&&n.addInstruction(l),i.push(u)}n.addInstruction({instructions:[Ze.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:o,ownerPda:e.ownerAccountId,claimAddress:i}})]});let{transaction:s,signers:a}=n.build();return[{transaction:s,signer:a}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t}){let n=this.createTxBuilder(),o=t.wallet||this.scope.ownerPubKey,i={};for(let u of e){let l=[];for(let m of u.tokenInfo){let{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(xe.WSOL.mint),createInfo:{payer:o,amount:0},skipCloseAccount:!m.mintAddress.equals(xe.WSOL.mint),associatedOnly:m.mintAddress.equals(xe.WSOL.mint)?!1:t.associatedOnly});p&&n.addInstruction(p),d&&(i[m.mintAddress.toString()]=d,l.push(d))}n.addInstruction({instructions:[Ze.makeClaimInstruction({programId:u.programId,poolInfo:u,ownerInfo:{wallet:o,ownerPda:u.ownerAccountId,claimAddress:l}})]})}let{transaction:s,signers:a}=n.build(),c=n.allInstructions;return sr(c,[o,...a.map(u=>u.publicKey)])?[{transaction:s,signer:a}]:[{transaction:new Bs().add(...c.slice(0,n.AllTxData.instructions.length-1)),signer:a},{transaction:new Bs().add(...c.slice(n.AllTxData.instructions.length-1)),signer:[]},{transaction:new Bs().add(...n.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let o=v([]),i=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:ap,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new sp({keys:i,programId:e,data:a})}},Pt=Ze;Pt.CLAIMED_NUM=3,Pt.POOL_LAYOUT=v([Ae(8),D("bump"),D("status"),P("openTime"),P("endTime"),K("ammId"),X(v([D("mintDecimals"),K("mintAddress"),K("mintVault"),P("perLpLoss"),P("totalClaimedAmount")]),Ze.CLAIMED_NUM,"tokenInfo"),X(P(),10,"padding")]),Pt.OWNER_LAYOUT=v([Ae(8),D("bump"),D("version"),K("poolId"),K("owner"),P("lpAmount"),X(v([K("mintAddress"),P("debtAmount"),P("claimedAmount")]),Ze.CLAIMED_NUM,"tokenInfo"),X(P(),4,"padding")]),Pt.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new ip(e)),Pt.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},Pt.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as Mo}from"@solana/web3.js";import _o from"bn.js";import{TOKEN_PROGRAM_ID as yc}from"@solana/spl-token";import{SystemProgram as hn,SYSVAR_RENT_PUBKEY as cp,Transaction as mc,TransactionInstruction as lp}from"@solana/web3.js";import{createInitializeAccountInstruction as dc,TOKEN_PROGRAM_ID as pc}from"@solana/spl-token";function up(r="accountFlags"){let e=new hr(r);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var xs=v([Ae(5),up("accountFlags"),K("ownAddress"),P("vaultSignerNonce"),K("baseMint"),K("quoteMint"),K("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),K("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),K("requestQueue"),K("eventQueue"),K("bids"),K("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),Ae(7)]);function mp({programId:r,marketInfo:e}){let t=v([D("version"),Xe("instruction"),P("baseLotSize"),P("quoteLotSize"),Vt("feeRateBps"),P("vaultSignerNonce"),P("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:cp,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),o=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},o),new lp({keys:n,programId:r,data:o})}async function fc({connection:r,wallet:e,marketInfo:t}){var s,a,c,u,l,m,d,p;let n=new mc,o=await r.getMinimumBalanceForRentExemption(165);n.add(hn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:o,space:165,programId:pc}),hn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:o,space:165,programId:pc}),dc(t.baseVault.publicKey,t.baseMint,t.vaultOwner),dc(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner));let i=new mc;return i.add(hn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await r.getMinimumBalanceForRentExemption(xs.span),space:xs.span,programId:t.programId}),hn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:await r.getMinimumBalanceForRentExemption((s=t.requestQueueSpace)!=null?s:5120+12),space:(a=t.requestQueueSpace)!=null?a:5120+12,programId:t.programId}),hn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:await r.getMinimumBalanceForRentExemption((c=t.eventQueueSpace)!=null?c:262144+12),space:(u=t.eventQueueSpace)!=null?u:262144+12,programId:t.programId}),hn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:await r.getMinimumBalanceForRentExemption((l=t.orderbookQueueSpace)!=null?l:65536+12),space:(m=t.orderbookQueueSpace)!=null?m:65536+12,programId:t.programId}),hn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:await r.getMinimumBalanceForRentExemption((d=t.orderbookQueueSpace)!=null?d:65536+12),space:(p=t.orderbookQueueSpace)!=null?p:65536+12,programId:t.programId}),mp({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[F.CreateAccount,F.CreateAccount,F.InitAccount,F.InitAccount]},{transaction:i,signer:[],instructionTypes:[F.CreateAccount,F.CreateAccount,F.CreateAccount,F.CreateAccount,F.CreateAccount,F.InitMarket]}]}var qn=class extends Se{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:o,dexProgramId:i,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,txVersion:u,computeBudgetConfig:l}){let m=this.scope.ownerPubKey,d=it({fromPublicKey:m,programId:i}),p=it({fromPublicKey:m,programId:i}),y=it({fromPublicKey:m,programId:i}),f=it({fromPublicKey:m,programId:i}),b=it({fromPublicKey:m,programId:i}),g=it({fromPublicKey:m,programId:yc}),A=it({fromPublicKey:m,programId:yc}),w=0,k=new _o(100);function I(){let W=new _o(0);for(;;)try{return{vaultOwner:Mo.createProgramAddressSync([d.publicKey.toBuffer(),W.toArrayLike(Buffer,"le",8)],i),vaultSignerNonce:W}}catch{if(W.iaddn(1),W.gt(new _o(25555)))throw Error("find vault owner error")}}let{vaultOwner:T,vaultSignerNonce:S}=I(),B=new _o(Math.round(10**e.decimals*n)),C=new _o(Math.round(n*10**t.decimals*o));if(B.eq(yt))throw Error("lot size is too small");if(C.eq(yt))throw Error("tick size or lot size is too small");let x=await fc({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:i,id:d,baseMint:e.mint,quoteMint:t.mint,baseVault:g,quoteVault:A,vaultOwner:T,requestQueue:p,eventQueue:y,bids:f,asks:b,feeRateBps:w,quoteDustThreshold:k,vaultSignerNonce:S,baseLotSize:B,quoteLotSize:C,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c}}),L=this.createTxBuilder();L.addInstruction({instructions:x[0].transaction.instructions,signers:x[0].signer});for await(let W of x.slice(1,x.length))L.addInstruction({instructions:W.transaction.instructions,signers:W.signer,instructionTypes:W.instructionTypes});return u===0?L.sizeCheckBuildV0({computeBudgetConfig:l,address:{marketId:d.publicKey,requestQueue:p.publicKey,eventQueue:y.publicKey,bids:f.publicKey,asks:b.publicKey,baseVault:g.publicKey,quoteVault:A.publicKey,baseMint:new Mo(e.mint),quoteMin:new Mo(t.mint)}}):L.sizeCheckBuild({computeBudgetConfig:l,address:{marketId:d.publicKey,requestQueue:p.publicKey,eventQueue:y.publicKey,bids:f.publicKey,asks:b.publicKey,baseVault:g.publicKey,quoteVault:A.publicKey,baseMint:new Mo(e.mint),quoteMin:new Mo(t.mint)}})}};import{PublicKey as Vo}from"@solana/web3.js";import bc from"bn.js";import{SYSVAR_CLOCK_PUBKEY as dp,TransactionInstruction as Ks}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Cs}from"@solana/spl-token";var Ss=v([D("instruction"),Ma("amount")]),vo=v([D("instruction")]);function lS({programId:r,amount:e,instructionKeys:t}){let n=[{pubkey:er,isSigner:!1,isWritable:!1},{pubkey:Cs,isSigner:!1,isWritable:!1},{pubkey:ot,isSigner:!1,isWritable:!1},{pubkey:pi,isSigner:!1,isWritable:!1},...Object.entries(t).map(([i,s])=>({pubkey:s,isSigner:i==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(i)}))],o=Buffer.alloc(Ss.span);return Ss.encode({instruction:1,amount:Number(e)},o),new Ks({keys:n,programId:r,data:o})}function Hr({programId:r},e){let t=[{pubkey:Cs,isSigner:!1,isWritable:!1},{pubkey:pi,isSigner:!1,isWritable:!1},...Object.entries(e).map(([o,i])=>({pubkey:i,isSigner:o==="userOwner",isWritable:!["authority","userOwner"].includes(o)}))],n=Buffer.alloc(vo.span);return vo.encode({instruction:2},n),new Ks({keys:t,programId:r,data:n})}function Rs(r){let{poolConfig:e,userKeys:t,side:n}=r,o=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,i=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(vo.span);vo.encode({instruction:2},s);let a=[{pubkey:Cs,isWritable:!1,isSigner:!1},{pubkey:dp,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new Ks({programId:e.programId,keys:a,data:s})}var pp={[$n.IDO_PROGRAM_ID_V1.toString()]:1,[$n.IDO_PROGRAM_ID_V2.toString()]:2,[$n.IDO_PROGRAM_ID_V3.toString()]:3,[$n.IDO_PROGRAM_ID_V4.toString()]:4},Un=class extends Se{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:o=!1,txVersion:i}){let s=this.createTxBuilder(),a=pp[t.programId];a||this.logAndCreateError("invalid version",a);let c=Te(t),[u,l]=[!new bc(e.coin).isZero(),!new bc(e.pc).isZero()],m=c.projectInfo.mint.address.equals(z),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:c.projectInfo.mint.programId,mint:c.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:o});!d&&u&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),u&&p&&s.addInstruction(p);let y=c.buyInfo.mint.address.equals(z),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:c.buyInfo.mint.programId,mint:c.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,notUseTokenAccount:y,associatedOnly:y?!1:n,checkCreateATAOwner:o});if(!d&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&b&&s.addInstruction(b),(!d||!f)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),a===3)return s.addInstruction({instructions:[...u?[Hr({programId:c.programId},{idoId:c.id,authority:c.authority,poolTokenAccount:c.projectInfo.vault,userTokenAccount:d,userIdoInfo:new Vo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...l?[Hr({programId:new Vo(t.programId)},{idoId:c.id,authority:c.authority,poolTokenAccount:c.buyInfo.vault,userTokenAccount:f,userIdoInfo:new Vo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:i});if(a<3)return!u&&!l&&this.logAndCreateError("no claimable rewards"),s.addInstruction({instructions:[Hr({programId:c.programId},{idoId:c.id,authority:c.authority,poolQuoteTokenAccount:c.buyInfo.vault,poolBaseTokenAccount:c.projectInfo.vault,userQuoteTokenAccount:f,userBaseTokenAccount:d,userIdoInfo:new Vo(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:i});let g={poolConfig:{id:c.id,programId:c.programId,authority:c.authority,baseVault:c.projectInfo.vault,quoteVault:c.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:d,quoteTokenAccount:f,ledgerAccount:new Vo(e.userIdoInfo),owner:this.scope.ownerPubKey}};return s.addInstruction({instructions:[...u?[Rs(E(R({},g),{side:"base"}))]:[],...l?[Rs(E(R({},g),{side:"quote"}))]:[]]}).versionBuild({txVersion:i})}};import{PublicKey as fp}from"@solana/web3.js";import{MintLayout as yp,TOKEN_2022_PROGRAM_ID as Ls,TOKEN_PROGRAM_ID as Os}from"@solana/spl-token";var Fo=class extends Se{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Map;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:o="strict"}=t||{},{mintList:i,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),c=await this.scope.fetchJupTokenList(n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Map,this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(Lt.address,Lt),this._mintGroup.official.add(Lt.address),s.forEach(u=>{this._blackTokenMap.set(u.address,E(R({},u),{priority:-1}))}),i.forEach(u=>{var l;this._blackTokenMap.has(u.address)||(this._tokenMap.set(u.address,E(R({},u),{type:"raydium",priority:2,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?Ls.toBase58():Os.toBase58()})),this._mintGroup.official.add(u.address))}),c.forEach(u=>{var l;this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,E(R({},u),{type:"jupiter",priority:1,programId:(l=u.programId)!=null?l:u.tags.includes("token-2022")?Ls.toBase58():Os.toBase58(),tags:u.freezeAuthority?[...u.tags||[],"hasFreeze"]:u.tags})),this._mintGroup.jup.add(u.address))}),this._extraTokenList.forEach(u=>{this._blackTokenMap.has(u.address)||this._tokenMap.has(u.address)||(this._tokenMap.set(u.address,E(R({},u),{type:"extra",priority:1,programId:u.programId||u.tags.includes("token-2022")?Ls.toBase58():Os.toBase58()})),this._mintGroup.extra.add(u.address))}),this._tokenList=Array.from(this._tokenMap).map(u=>u[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),o=this._tokenMap.get(n);if(o)return o;if(n.toLocaleUpperCase()==="SOL")return Lt;let i=(await this.scope.api.getTokenInfo([n]))[0];if(i)return this._mintGroup.extra.add(n),this._tokenMap.set(n,E(R({},i),{priority:2})),i;let s=await this.scope.connection.getAccountInfo(new fp(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=yp.decode(s.data),c=n.toString().substring(0,6),u={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:c,name:c,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,u),u}};var Zr=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:o,api:i,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed"}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=o?new It(o):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.api=i,this._apiCacheTime=c||5*60*1e3,this.logger=ue("Raydium"),this.farm=new go({scope:this,moduleName:"Raydium_Farm"}),this.account=new io({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new So({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new Fo({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new No({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new Ko({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new Oo({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Pt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new qn({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new Un({scope:this,moduleName:"Raydium_ido"}),this.availability={};let l=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:l,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=bp({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:o,logCount:i,logRequests:s,urlConfigs:a}=t,c=new yr({cluster:n,timeout:o,urlConfigs:a,logCount:i,logRequests:s}),u=new Zr(E(R({},t),{api:c}));return await u.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(br);return this._owner.publicKey}setOwner(e){return this._owner=e?new It(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(xa);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw this.logger.error(br),new Error(br)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(o=>E(R({},o),{mintAuthority:o.mint_authority||void 0,freezeAuthority:o.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};var pK=r=>r;export{Zm as AMM_CONFIG_SEED,uu as BIT_PRECISION,Ko as Clmm,Tu as ClmmConfigLayout,ke as ClmmInstrument,Fr as ConstantProductCurve,oc as CpmmConfigInfoLayout,Er as CpmmFee,Gr as CpmmPoolInfoLayout,Wr as CurveCalculator,Pd as DataElement,ns as EXTENSION_TICKARRAY_BITMAP_SIZE,Ha as FARM_LOCK_MINT,Za as FARM_LOCK_VAULT,bt as FARM_PROGRAM_TO_VERSION,Ja as FARM_VERSION_TO_LEDGER_LAYOUT,$a as FARM_VERSION_TO_STATE_LAYOUT,Kr as FEE_RATE_DENOMINATOR,gs as FEE_RATE_DENOMINATOR_VALUE,sd as FETCH_TICKARRAY_COUNT,Hm as Fee,Nr as LIQUIDITY_FEES_DENOMINATOR,ss as LIQUIDITY_FEES_NUMERATOR,gd as LIQUIDITY_VERSION_TO_SERUM_VERSION,Kk as LIQUIDITY_VERSION_TO_STATE_LAYOUT,cu as LOG_B_2_X32,lu as LOG_B_P_ERR_MARGIN_LOWER_X64,mu as LOG_B_P_ERR_MARGIN_UPPER_X64,le as LiquidityMath,Wh as LockPositionLayout,xs as MARKET_STATE_LAYOUT_V2,hs as MARKET_STATE_LAYOUT_V3,sc as MARKET_VERSION_TO_STATE_LAYOUT,wt as MAX_SQRT_PRICE_X64,Sr as MAX_SQRT_PRICE_X64_SUB_ONE,et as MAX_TICK,At as MIN_SQRT_PRICE_X64,xr as MIN_SQRT_PRICE_X64_ADD_ONE,je as MIN_TICK,Vn as MODEL_DATA_PUBKEY,Qr as Market,ne as MathUtil,Zi as MaxU64,au as MaxUint128,Dt as NEGATIVE_ONE,rd as OBSERVATION_SEED,dt as ONE,nd as OPERATION_SEED,Iu as ObservationInfoLayout,cd as ObservationLayout,Bu as OperationLayout,id as POOL_LOCK_ID_SEED,ed as POOL_REWARD_VAULT_SEED,$m as POOL_SEED,od as POOL_TICK_ARRAY_BITMAP_SEED,Jm as POOL_VAULT_SEED,bu as POSITION_SEED,fn as PoolInfoLayout,Ke as PoolUtils,Lr as PositionInfoLayout,md as PositionRewardInfoLayout,ho as PositionUtils,Dh as ProtocolPositionLayout,Br as Q128,pt as Q64,Zr as Raydium,ld as RewardInfo,Qu as RoundDirection,rc as SERUM_PROGRAMID_TO_VERSION,ic as SERUM_VERSION_TO_PROGRAMID,Lt as SOL_INFO,ok as SPL_MINT_LAYOUT,ee as SqrtPriceMath,vn as StableLayout,pn as SwapMath,dn as TICK_ARRAY_BITMAP_SIZE,td as TICK_ARRAY_SEED,Fe as TICK_ARRAY_SIZE,kP as TICK_SPACINGS,ve as TOKEN_WSOL,Wt as TickArrayBitmap,ku as TickArrayBitmapExtensionLayout,To as TickArrayBitmapExtensionUtils,ko as TickArrayLayout,dd as TickLayout,yn as TickMath,me as TickQuery,j as TickUtils,Ao as U64Resolution,IP as U64_IGNORE_RANGE,Ya as Voter,_m as VoterDepositEntry,Mm as VoterLockup,Qa as VoterRegistrar,Nm as VoterVotingMintConfig,de as ZERO,ls as addLiquidityLayout,Mi as associatedLedgerAccountLayout,Qi as calFarmRewardAmount,qd as ceilDiv,vo as claimLayout,hu as clmmComputeInfoToApiInfo,Ft as closeAccountInstruction,po as createAssociatedLedgerAccountInstruction,Lu as createPoolFeeLayout,Du as createPoolV4InstructionV2,Sk as createPoolV4Layout,Et as createWSolAccountInstructions,Je as dwLayout,Fi as farmAddRewardLayout,ew as farmLedgerLayoutV3_1,ao as farmLedgerLayoutV3_2,tw as farmLedgerLayoutV5_1,Xa as farmLedgerLayoutV5_2,za as farmLedgerLayoutV6_1,tu as farmRewardInfoToConfig,vi as farmRewardLayout,Vi as farmRewardRestartLayout,Om as farmRewardTimeInfoLayout,Ua as farmStateV3Layout,Ga as farmStateV5Layout,so as farmStateV6Layout,xw as fetchMultipleFarmInfoAndUpdate,aT as fetchMultipleInfo,as as fixedSwapInLayout,us as fixedSwapOutLayout,Yu as floorDiv,Rd as formatLayout,it as generatePubKey,eu as getAssociatedAuthority,_r as getAssociatedConfigId,Ye as getAssociatedLedgerAccount,co as getAssociatedLedgerPoolAccount,Ed as getAssociatedOpenOrders,Uu as getAssociatedPoolKeys,KI as getCpmmPdaAmmConfigId,ws as getCpmmPdaPoolId,Zu as getCreatePoolKeys,Yi as getDepositEntryIndex,_u as getDxByDyBaseIn,Mu as getDyByDxBaseIn,Mn as getFarmLedgerLayout,vm as getFarmStateLayout,bs as getLiquidityAssociatedAuthority,An as getLiquidityAssociatedId,bh as getLiquidityFromAmounts,LP as getPdaAmmConfigId,ut as getPdaExBitmapAccount,ts as getPdaLockPositionId,jd as getPdaLpMint,Rr as getPdaMetadataKey,wu as getPdaObservationAccount,qr as getPdaObservationId,Po as getPdaOperationAccount,at as getPdaPersonalPositionAddress,Wn as getPdaPoolAuthority,gu as getPdaPoolId,Au as getPdaPoolRewardVaulId,es as getPdaPoolVaultId,sn as getPdaProtocolPositionAddress,be as getPdaTickArrayAddress,Hu as getPdaVault,Wi as getRegistrarAddress,vu as getStablePrice,zi as getTokenOwnerRecordAddress,Gi as getVoterAddress,Xi as getVoterWeightRecordAddress,Ui as getVotingMintAuthority,qi as getVotingTokenMint,Xm as governanceCreateTokenOwnerRecord,xP as i16ToBytes,Cr as i32ToBytes,cs as initPoolLayout,Oi as initTokenAccountInstruction,mp as initializeMarket,Ei as isValidFarmVersion,wo as isZero,Sw as judgeFarmType,$i as leadingZeros,yu as leastSignificantBit,Bo as liquidityStateV4Layout,Ad as liquidityStateV5Layout,Mr as makeAMMSwapInstruction,Eu as makeAddLiquidityInstruction,Hi as makeAddNewRewardInstruction,Hr as makeClaimInstruction,Rs as makeClaimInstructionV4,Ju as makeCreateCpmmPoolInInstruction,nu as makeCreateFarmInstruction,fc as makeCreateMarketInstruction,ou as makeCreatorWithdrawFarmRewardInstruction,ec as makeDepositCpmmInInstruction,ru as makeDepositInstructionV3,iu as makeDepositInstructionV5,su as makeDepositInstructionV6,Uw as makeDepositTokenInstruction,Xw as makeDepositWithdrawInstruction,Xk as makeInitPoolInstructionV4,lS as makePurchaseInstruction,ji as makeRestartRewardInstruction,Wu as makeSimulatePoolInfoInstruction,Ur as makeSwapCpmmBaseInInInstruction,nc as makeSwapCpmmBaseOutInInstruction,Nd as makeSwapFixedInInstruction,Md as makeSwapFixedOutInstruction,uc as makeSwapInstruction,qa as makeTransferInstruction,tc as makeWithdrawCpmmInInstruction,bo as makeWithdrawInstructionV3,yo as makeWithdrawInstructionV5,fo as makeWithdrawInstructionV6,Gw as makeWithdrawTokenInstruction,TP as mockCreatePoolInfo,du as mockV3CreatePoolInfo,hd as modelDataInfoLayout,fu as mostSignificantBit,Wa as parseTokenAccountResp,pk as parseTokenInfo,rn as poolTypeV6,Ss as purchaseLayout,Cm as realFarmStateV3Layout,Rm as realFarmStateV5Layout,Lm as realFarmV6Layout,ps as removeLiquidityInstruction,ms as removeLiquidityLayout,XB as route1Instruction,zB as route2Instruction,op as routeInstruction,Gk as simulatePoolInfoInstruction,yk as solToWSolToken,nn as splAccountLayout,vr as toAmmComputePoolInfo,tt as toApiV3Token,an as toFeeConfig,Or as toToken,Io as toTokenAmount,fk as toTokenInfo,Ji as trailingZeros,pu as u16ToBytes,SP as u32ToBytes,pK as unionArr,Vm as updateFarmPoolInfo,Di as validateFarmRewards,Qm as voterStakeRegistryCreateDepositEntry,zm as voterStakeRegistryCreateVoter,qm as voterStakeRegistryDeposit,Um as voterStakeRegistryUpdateVoterWeightRecord,Gm as voterStakeRegistryWithdraw,bk as wSolToSolToken,_i as withdrawRewardLayout};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map