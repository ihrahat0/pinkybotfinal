var vu=Object.defineProperty,Vu=Object.defineProperties;var Eu=Object.getOwnPropertyDescriptors;var Ci=Object.getOwnPropertySymbols;var ls=Object.prototype.hasOwnProperty,ms=Object.prototype.propertyIsEnumerable;var cs=(o,e,t)=>e in o?vu(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,R=(o,e)=>{for(var t in e||(e={}))ls.call(e,t)&&cs(o,t,e[t]);if(Ci)for(var t of Ci(e))ms.call(e,t)&&cs(o,t,e[t]);return o},F=(o,e)=>Vu(o,Eu(e));var Ce=(o,e)=>{var t={};for(var n in o)ls.call(o,n)&&e.indexOf(n)<0&&(t[n]=o[n]);if(o!=null&&Ci)for(var n of Ci(o))e.indexOf(n)<0&&ms.call(o,n)&&(t[n]=o[n]);return t};import{merge as Cd}from"lodash";import Hs from"axios";import{PublicKey as fs}from"@solana/web3.js";import{get as ds,set as Fu}from"lodash";var Do=class{constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},ps={},Du={};function se(o){let e=ds(ps,o);if(!e){let t=ds(Du,o);e=new Do({name:o,logLevel:t}),Fu(ps,o,e)}return e}import{MINT_SIZE as Wu,TOKEN_PROGRAM_ID as qu,getTransferFeeConfig as Uu,unpackMint as Gu}from"@solana/spl-token";var Wo=se("Raydium_accountInfo_util");async function bt(o,e,t){let{batchRequest:n,commitment:i="confirmed",chunkCount:r=100}=R({batchRequest:!1},t),s=qo(e,r),a=new Array(s.length).fill([]);if(n){let u=s.map(m=>{let d=o._buildArgs([m.map(p=>p.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:d}}),c=qo(u,10);a=(await(await Promise.all(c.map(async m=>await o._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&Wo.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:y,lamports:f,owner:b,rentEpoch:g}=d;return p.length!==2&&p[1]!=="base64"&&Wo.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:y,lamports:f,owner:new fs(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(u=>o.getMultipleAccountsInfo(u,i)))}catch(u){u instanceof Error&&Wo.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${u.message}`)}return a.flat()}async function _e(o,e,t){let n=await bt(o,e.map(i=>i.pubkey),t);return e.map((i,r)=>F(R({},i),{accountInfo:n[r]}))}async function An({connection:o,mints:e,config:t}){var r,s,a;if(e.length===0)return{};let n=await _e(o,e.map(u=>({pubkey:ot(u)})),t),i={};for(let u of n){if(!u.accountInfo||u.accountInfo.data.length<Wu){console.log("invalid mint account",u.pubkey.toBase58());continue}let c=Gu(u.pubkey,u.accountInfo,(r=u.accountInfo)==null?void 0:r.owner);i[u.pubkey.toString()]=F(R({},c),{programId:((s=u.accountInfo)==null?void 0:s.owner)||qu,feeConfig:(a=Uu(c))!=null?a:void 0})}return i[fs.default.toBase58()]=i[z.toBase58()],i}import Lt from"bn.js";var Pn=9e15,zt=1e9,Uo="0123456789abcdef",Li="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Oi="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",Go={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-Pn,maxE:Pn,crypto:!1},ws,Rt,oe=!0,Mi="[DecimalError] ",Xt=Mi+"Invalid argument: ",As=Mi+"Precision limit exceeded",Ps=Mi+"crypto unavailable",hs="[object Decimal]",Ue=Math.floor,Oe=Math.pow,Xu=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,zu=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,Qu=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,ks=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,wt=1e7,J=7,Yu=9007199254740991,ju=Li.length-1,Xo=Oi.length-1,v={toStringTag:hs};v.absoluteValue=v.abs=function(){var o=new this.constructor(this);return o.s<0&&(o.s=1),H(o)};v.ceil=function(){return H(new this.constructor(this),this.e+1,2)};v.clampedTo=v.clamp=function(o,e){var t,n=this,i=n.constructor;if(o=new i(o),e=new i(e),!o.s||!e.s)return new i(NaN);if(o.gt(e))throw Error(Xt+e);return t=n.cmp(o),t<0?o:n.cmp(e)>0?e:new i(n)};v.comparedTo=v.cmp=function(o){var e,t,n,i,r=this,s=r.d,a=(o=new r.constructor(o)).d,u=r.s,c=o.s;if(!s||!a)return!u||!c?NaN:u!==c?u:s===a?0:!s^u<0?1:-1;if(!s[0]||!a[0])return s[0]?u:a[0]?-c:0;if(u!==c)return u;if(r.e!==o.e)return r.e>o.e^u<0?1:-1;for(n=s.length,i=a.length,e=0,t=n<i?n:i;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^u<0?1:-1;return n===i?0:n>i^u<0?1:-1};v.cosine=v.cos=function(){var o,e,t=this,n=t.constructor;return t.d?t.d[0]?(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+J,n.rounding=1,t=Hu(n,Ss(n,t)),n.precision=o,n.rounding=e,H(Rt==2||Rt==3?t.neg():t,o,e,!0)):new n(1):new n(NaN)};v.cubeRoot=v.cbrt=function(){var o,e,t,n,i,r,s,a,u,c,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(oe=!1,r=l.s*Oe(l.s*l,1/3),!r||Math.abs(r)==1/0?(t=Fe(l.d),o=l.e,(r=(o-t.length+1)%3)&&(t+=r==1||r==-2?"0":"00"),r=Oe(t,1/3),o=Ue((o+1)/3)-(o%3==(o<0?-1:2)),r==1/0?t="5e"+o:(t=r.toExponential(),t=t.slice(0,t.indexOf("e")+1)+o),n=new m(t),n.s=l.s):n=new m(r.toString()),s=(o=m.precision)+3;;)if(a=n,u=a.times(a).times(a),c=u.plus(l),n=we(c.plus(l).times(a),c.plus(u),s+2,1),Fe(a.d).slice(0,s)===(t=Fe(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!i&&t=="4999"){if(!i&&(H(a,o+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(H(n,o+1,1),e=!n.times(n).times(n).eq(l));break}return oe=!0,H(n,o,m.rounding,e)};v.decimalPlaces=v.dp=function(){var o,e=this.d,t=NaN;if(e){if(o=e.length-1,t=(o-Ue(this.e/J))*J,o=e[o],o)for(;o%10==0;o/=10)t--;t<0&&(t=0)}return t};v.dividedBy=v.div=function(o){return we(this,new this.constructor(o))};v.dividedToIntegerBy=v.divToInt=function(o){var e=this,t=e.constructor;return H(we(e,new t(o),0,1,1),t.precision,t.rounding)};v.equals=v.eq=function(o){return this.cmp(o)===0};v.floor=function(){return H(new this.constructor(this),this.e+1,3)};v.greaterThan=v.gt=function(o){return this.cmp(o)>0};v.greaterThanOrEqualTo=v.gte=function(o){var e=this.cmp(o);return e==1||e===0};v.hyperbolicCosine=v.cosh=function(){var o,e,t,n,i,r=this,s=r.constructor,a=new s(1);if(!r.isFinite())return new s(r.s?1/0:NaN);if(r.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(r.e,r.sd())+4,s.rounding=1,i=r.d.length,i<32?(o=Math.ceil(i/3),e=(1/vi(4,o)).toString()):(o=16,e="2.3283064365386962890625e-10"),r=hn(s,1,r.times(e),new s(1),!0);for(var u,c=o,l=new s(8);c--;)u=r.times(r),r=a.minus(u.times(l.minus(u.times(l))));return H(r,s.precision=t,s.rounding=n,!0)};v.hyperbolicSine=v.sinh=function(){var o,e,t,n,i=this,r=i.constructor;if(!i.isFinite()||i.isZero())return new r(i);if(e=r.precision,t=r.rounding,r.precision=e+Math.max(i.e,i.sd())+4,r.rounding=1,n=i.d.length,n<3)i=hn(r,2,i,i,!0);else{o=1.4*Math.sqrt(n),o=o>16?16:o|0,i=i.times(1/vi(5,o)),i=hn(r,2,i,i,!0);for(var s,a=new r(5),u=new r(16),c=new r(20);o--;)s=i.times(i),i=i.times(a.plus(s.times(u.times(s).plus(c))))}return r.precision=e,r.rounding=t,H(i,e,t,!0)};v.hyperbolicTangent=v.tanh=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+7,n.rounding=1,we(t.sinh(),t.cosh(),n.precision=o,n.rounding=e)):new n(t.s)};v.inverseCosine=v.acos=function(){var o,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,r=t.rounding;return n!==-1?n===0?e.isNeg()?gt(t,i,r):new t(0):new t(NaN):e.isZero()?gt(t,i+4,r).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),o=gt(t,i+4,r).times(.5),t.precision=i,t.rounding=r,o.minus(e))};v.inverseHyperbolicCosine=v.acosh=function(){var o,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(o=n.precision,e=n.rounding,n.precision=o+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,oe=!1,t=t.times(t).minus(1).sqrt().plus(t),oe=!0,n.precision=o,n.rounding=e,t.ln()):new n(t)};v.inverseHyperbolicSine=v.asinh=function(){var o,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,oe=!1,t=t.times(t).plus(1).sqrt().plus(t),oe=!0,n.precision=o,n.rounding=e,t.ln())};v.inverseHyperbolicTangent=v.atanh=function(){var o,e,t,n,i=this,r=i.constructor;return i.isFinite()?i.e>=0?new r(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(o=r.precision,e=r.rounding,n=i.sd(),Math.max(n,o)<2*-i.e-1?H(new r(i),o,e,!0):(r.precision=t=n-i.e,i=we(i.plus(1),new r(1).minus(i),t+o,1),r.precision=o+4,r.rounding=1,i=i.ln(),r.precision=o,r.rounding=e,i.times(.5))):new r(NaN)};v.inverseSine=v.asin=function(){var o,e,t,n,i=this,r=i.constructor;return i.isZero()?new r(i):(e=i.abs().cmp(1),t=r.precision,n=r.rounding,e!==-1?e===0?(o=gt(r,t+4,n).times(.5),o.s=i.s,o):new r(NaN):(r.precision=t+6,r.rounding=1,i=i.div(new r(1).minus(i.times(i)).sqrt().plus(1)).atan(),r.precision=t,r.rounding=n,i.times(2)))};v.inverseTangent=v.atan=function(){var o,e,t,n,i,r,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding;if(c.isFinite()){if(c.isZero())return new l(c);if(c.abs().eq(1)&&m+4<=Xo)return s=gt(l,m+4,d).times(.25),s.s=c.s,s}else{if(!c.s)return new l(NaN);if(m+4<=Xo)return s=gt(l,m+4,d).times(.5),s.s=c.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/J+2|0),o=t;o;--o)c=c.div(c.times(c).plus(1).sqrt().plus(1));for(oe=!1,e=Math.ceil(a/J),n=1,u=c.times(c),s=new l(c),i=c;o!==-1;)if(i=i.times(u),r=s.minus(i.div(n+=2)),i=i.times(u),s=r.plus(i.div(n+=2)),s.d[e]!==void 0)for(o=e;s.d[o]===r.d[o]&&o--;);return t&&(s=s.times(2<<t-1)),oe=!0,H(s,l.precision=m,l.rounding=d,!0)};v.isFinite=function(){return!!this.d};v.isInteger=v.isInt=function(){return!!this.d&&Ue(this.e/J)>this.d.length-2};v.isNaN=function(){return!this.s};v.isNegative=v.isNeg=function(){return this.s<0};v.isPositive=v.isPos=function(){return this.s>0};v.isZero=function(){return!!this.d&&this.d[0]===0};v.lessThan=v.lt=function(o){return this.cmp(o)<0};v.lessThanOrEqualTo=v.lte=function(o){return this.cmp(o)<1};v.logarithm=v.log=function(o){var e,t,n,i,r,s,a,u,c=this,l=c.constructor,m=l.precision,d=l.rounding,p=5;if(o==null)o=new l(10),e=!0;else{if(o=new l(o),t=o.d,o.s<0||!t||!t[0]||o.eq(1))return new l(NaN);e=o.eq(10)}if(t=c.d,c.s<0||!t||!t[0]||c.eq(1))return new l(t&&!t[0]?-1/0:c.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)r=!0;else{for(i=t[0];i%10===0;)i/=10;r=i!==1}if(oe=!1,a=m+p,s=Gt(c,a),n=e?Ni(l,a+10):Gt(o,a),u=we(s,n,a,1),Vn(u.d,i=m,d))do if(a+=10,s=Gt(c,a),n=e?Ni(l,a+10):Gt(o,a),u=we(s,n,a,1),!r){+Fe(u.d).slice(i+1,i+15)+1==1e14&&(u=H(u,m+1,0));break}while(Vn(u.d,i+=10,d));return oe=!0,H(u,m,d)};v.minus=v.sub=function(o){var e,t,n,i,r,s,a,u,c,l,m,d,p=this,y=p.constructor;if(o=new y(o),!p.d||!o.d)return!p.s||!o.s?o=new y(NaN):p.d?o.s=-o.s:o=new y(o.d||p.s!==o.s?p:NaN),o;if(p.s!=o.s)return o.s=-o.s,p.plus(o);if(c=p.d,d=o.d,a=y.precision,u=y.rounding,!c[0]||!d[0]){if(d[0])o.s=-o.s;else if(c[0])o=new y(p);else return new y(u===3?-0:0);return oe?H(o,a,u):o}if(t=Ue(o.e/J),l=Ue(p.e/J),c=c.slice(),r=l-t,r){for(m=r<0,m?(e=c,r=-r,s=d.length):(e=d,t=l,s=c.length),n=Math.max(Math.ceil(a/J),s)+2,r>n&&(r=n,e.length=1),e.reverse(),n=r;n--;)e.push(0);e.reverse()}else{for(n=c.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(c[n]!=d[n]){m=c[n]<d[n];break}r=0}for(m&&(e=c,c=d,d=e,o.s=-o.s),s=c.length,n=d.length-s;n>0;--n)c[s++]=0;for(n=d.length;n>r;){if(c[--n]<d[n]){for(i=n;i&&c[--i]===0;)c[i]=wt-1;--c[i],c[n]+=wt}c[n]-=d[n]}for(;c[--s]===0;)c.pop();for(;c[0]===0;c.shift())--t;return c[0]?(o.d=c,o.e=_i(c,t),oe?H(o,a,u):o):new y(u===3?-0:0)};v.modulo=v.mod=function(o){var e,t=this,n=t.constructor;return o=new n(o),!t.d||!o.s||o.d&&!o.d[0]?new n(NaN):!o.d||t.d&&!t.d[0]?H(new n(t),n.precision,n.rounding):(oe=!1,n.modulo==9?(e=we(t,o.abs(),0,3,1),e.s*=o.s):e=we(t,o,0,n.modulo,1),e=e.times(o),oe=!0,t.minus(e))};v.naturalExponential=v.exp=function(){return zo(this)};v.naturalLogarithm=v.ln=function(){return Gt(this)};v.negated=v.neg=function(){var o=new this.constructor(this);return o.s=-o.s,H(o)};v.plus=v.add=function(o){var e,t,n,i,r,s,a,u,c,l,m=this,d=m.constructor;if(o=new d(o),!m.d||!o.d)return!m.s||!o.s?o=new d(NaN):m.d||(o=new d(o.d||m.s===o.s?m:NaN)),o;if(m.s!=o.s)return o.s=-o.s,m.minus(o);if(c=m.d,l=o.d,a=d.precision,u=d.rounding,!c[0]||!l[0])return l[0]||(o=new d(m)),oe?H(o,a,u):o;if(r=Ue(m.e/J),n=Ue(o.e/J),c=c.slice(),i=r-n,i){for(i<0?(t=c,i=-i,s=l.length):(t=l,n=r,s=c.length),r=Math.ceil(a/J),s=r>s?r+1:s+1,i>s&&(i=s,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(s=c.length,i=l.length,s-i<0&&(i=s,t=l,l=c,c=t),e=0;i;)e=(c[--i]=c[i]+l[i]+e)/wt|0,c[i]%=wt;for(e&&(c.unshift(e),++n),s=c.length;c[--s]==0;)c.pop();return o.d=c,o.e=_i(c,n),oe?H(o,a,u):o};v.precision=v.sd=function(o){var e,t=this;if(o!==void 0&&o!==!!o&&o!==1&&o!==0)throw Error(Xt+o);return t.d?(e=Ts(t.d),o&&t.e+1>e&&(e=t.e+1)):e=NaN,e};v.round=function(){var o=this,e=o.constructor;return H(new e(o),o.e+1,e.rounding)};v.sine=v.sin=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+Math.max(t.e,t.sd())+J,n.rounding=1,t=$u(n,Ss(n,t)),n.precision=o,n.rounding=e,H(Rt>2?t.neg():t,o,e,!0)):new n(NaN)};v.squareRoot=v.sqrt=function(){var o,e,t,n,i,r,s=this,a=s.d,u=s.e,c=s.s,l=s.constructor;if(c!==1||!a||!a[0])return new l(!c||c<0&&(!a||a[0])?NaN:a?s:1/0);for(oe=!1,c=Math.sqrt(+s),c==0||c==1/0?(e=Fe(a),(e.length+u)%2==0&&(e+="0"),c=Math.sqrt(e),u=Ue((u+1)/2)-(u<0||u%2),c==1/0?e="5e"+u:(e=c.toExponential(),e=e.slice(0,e.indexOf("e")+1)+u),n=new l(e)):n=new l(c.toString()),t=(u=l.precision)+3;;)if(r=n,n=r.plus(we(s,r,t+2,1)).times(.5),Fe(r.d).slice(0,t)===(e=Fe(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&(H(r,u+1,0),r.times(r).eq(s))){n=r;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(H(n,u+1,1),o=!n.times(n).eq(s));break}return oe=!0,H(n,u,l.rounding,o)};v.tangent=v.tan=function(){var o,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(o=n.precision,e=n.rounding,n.precision=o+10,n.rounding=1,t=t.sin(),t.s=1,t=we(t,new n(1).minus(t.times(t)).sqrt(),o+10,0),n.precision=o,n.rounding=e,H(Rt==2||Rt==4?t.neg():t,o,e,!0)):new n(NaN)};v.times=v.mul=function(o){var e,t,n,i,r,s,a,u,c,l=this,m=l.constructor,d=l.d,p=(o=new m(o)).d;if(o.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!o.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?o.s/0:o.s*0);for(t=Ue(l.e/J)+Ue(o.e/J),u=d.length,c=p.length,u<c&&(r=d,d=p,p=r,s=u,u=c,c=s),r=[],s=u+c,n=s;n--;)r.push(0);for(n=c;--n>=0;){for(e=0,i=u+n;i>n;)a=r[i]+p[n]*d[i-n-1]+e,r[i--]=a%wt|0,e=a/wt|0;r[i]=(r[i]+e)%wt|0}for(;!r[--s];)r.pop();return e?++t:r.shift(),o.d=r,o.e=_i(r,t),oe?H(o,m.precision,m.rounding):o};v.toBinary=function(o,e){return Yo(this,2,o,e)};v.toDecimalPlaces=v.toDP=function(o,e){var t=this,n=t.constructor;return t=new n(t),o===void 0?t:($e(o,0,zt),e===void 0?e=n.rounding:$e(e,0,8),H(t,o+t.e+1,e))};v.toExponential=function(o,e){var t,n=this,i=n.constructor;return o===void 0?t=St(n,!0):($e(o,0,zt),e===void 0?e=i.rounding:$e(e,0,8),n=H(new i(n),o+1,e),t=St(n,!0,o+1)),n.isNeg()&&!n.isZero()?"-"+t:t};v.toFixed=function(o,e){var t,n,i=this,r=i.constructor;return o===void 0?t=St(i):($e(o,0,zt),e===void 0?e=r.rounding:$e(e,0,8),n=H(new r(i),o+i.e+1,e),t=St(n,!1,o+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};v.toFraction=function(o){var e,t,n,i,r,s,a,u,c,l,m,d,p=this,y=p.d,f=p.constructor;if(!y)return new f(p);if(c=t=new f(1),n=u=new f(0),e=new f(n),r=e.e=Ts(y)-p.e-1,s=r%J,e.d[0]=Oe(10,s<0?J+s:s),o==null)o=r>0?e:c;else{if(a=new f(o),!a.isInt()||a.lt(c))throw Error(Xt+a);o=a.gt(e)?r>0?e:c:a}for(oe=!1,a=new f(Fe(y)),l=f.precision,f.precision=r=y.length*J*2;m=we(a,e,0,1,1),i=t.plus(m.times(n)),i.cmp(o)!=1;)t=n,n=i,i=c,c=u.plus(m.times(i)),u=i,i=e,e=a.minus(m.times(i)),a=i;return i=we(o.minus(t),n,0,1,1),u=u.plus(i.times(c)),t=t.plus(i.times(n)),u.s=c.s=p.s,d=we(c,n,r,1).minus(p).abs().cmp(we(u,t,r,1).minus(p).abs())<1?[c,n]:[u,t],f.precision=l,oe=!0,d};v.toHexadecimal=v.toHex=function(o,e){return Yo(this,16,o,e)};v.toNearest=function(o,e){var t=this,n=t.constructor;if(t=new n(t),o==null){if(!t.d)return t;o=new n(1),e=n.rounding}else{if(o=new n(o),e===void 0?e=n.rounding:$e(e,0,8),!t.d)return o.s?t:o;if(!o.d)return o.s&&(o.s=t.s),o}return o.d[0]?(oe=!1,t=we(t,o,0,e,1).times(o),oe=!0,H(t)):(o.s=t.s,t=o),t};v.toNumber=function(){return+this};v.toOctal=function(o,e){return Yo(this,8,o,e)};v.toPower=v.pow=function(o){var e,t,n,i,r,s,a=this,u=a.constructor,c=+(o=new u(o));if(!a.d||!o.d||!a.d[0]||!o.d[0])return new u(Oe(+a,c));if(a=new u(a),a.eq(1))return a;if(n=u.precision,r=u.rounding,o.eq(1))return H(a,n,r);if(e=Ue(o.e/J),e>=o.d.length-1&&(t=c<0?-c:c)<=Yu)return i=Is(u,a,t,n),o.s<0?new u(1).div(i):H(i,n,r);if(s=a.s,s<0){if(e<o.d.length-1)return new u(NaN);if((o.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Oe(+a,c),e=t==0||!isFinite(t)?Ue(c*(Math.log("0."+Fe(a.d))/Math.LN10+a.e+1)):new u(t+"").e,e>u.maxE+1||e<u.minE-1?new u(e>0?s/0:0):(oe=!1,u.rounding=a.s=1,t=Math.min(12,(e+"").length),i=zo(o.times(Gt(a,n+t)),n),i.d&&(i=H(i,n+5,1),Vn(i.d,n,r)&&(e=n+10,i=H(zo(o.times(Gt(a,e+t)),e),e+5,1),+Fe(i.d).slice(n+1,n+15)+1==1e14&&(i=H(i,n+1,0)))),i.s=s,oe=!0,u.rounding=r,H(i,n,r))};v.toPrecision=function(o,e){var t,n=this,i=n.constructor;return o===void 0?t=St(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):($e(o,1,zt),e===void 0?e=i.rounding:$e(e,0,8),n=H(new i(n),o,e),t=St(n,o<=n.e||n.e<=i.toExpNeg,o)),n.isNeg()&&!n.isZero()?"-"+t:t};v.toSignificantDigits=v.toSD=function(o,e){var t=this,n=t.constructor;return o===void 0?(o=n.precision,e=n.rounding):($e(o,1,zt),e===void 0?e=n.rounding:$e(e,0,8)),H(new n(t),o,e)};v.toString=function(){var o=this,e=o.constructor,t=St(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()&&!o.isZero()?"-"+t:t};v.truncated=v.trunc=function(){return H(new this.constructor(this),this.e+1,1)};v.valueOf=v.toJSON=function(){var o=this,e=o.constructor,t=St(o,o.e<=e.toExpNeg||o.e>=e.toExpPos);return o.isNeg()?"-"+t:t};function Fe(o){var e,t,n,i=o.length-1,r="",s=o[0];if(i>0){for(r+=s,e=1;e<i;e++)n=o[e]+"",t=J-n.length,t&&(r+=Ut(t)),r+=n;s=o[e],n=s+"",t=J-n.length,t&&(r+=Ut(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return r+s}function $e(o,e,t){if(o!==~~o||o<e||o>t)throw Error(Xt+o)}function Vn(o,e,t,n){var i,r,s,a;for(r=o[0];r>=10;r/=10)--e;return--e<0?(e+=J,i=0):(i=Math.ceil((e+1)/J),e%=J),r=Oe(10,J-e),a=o[i]%r|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==r||t>3&&a+1==r/2)&&(o[i+1]/r/100|0)==Oe(10,e-2)-1||(a==r/2||a==0)&&(o[i+1]/r/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==r||!n&&t>3&&a+1==r/2)&&(o[i+1]/r/1e3|0)==Oe(10,e-3)-1,s}function Ri(o,e,t){for(var n,i=[0],r,s=0,a=o.length;s<a;){for(r=i.length;r--;)i[r]*=e;for(i[0]+=Uo.indexOf(o.charAt(s++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function Hu(o,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/vi(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),o.precision+=t,e=hn(o,1,e.times(i),new o(1));for(var r=t;r--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return o.precision-=t,e}var we=function(){function o(n,i,r){var s,a=0,u=n.length;for(n=n.slice();u--;)s=n[u]*i+a,n[u]=s%r|0,a=s/r|0;return a&&n.unshift(a),n}function e(n,i,r,s){var a,u;if(r!=s)u=r>s?1:-1;else for(a=u=0;a<r;a++)if(n[a]!=i[a]){u=n[a]>i[a]?1:-1;break}return u}function t(n,i,r,s){for(var a=0;r--;)n[r]-=a,a=n[r]<i[r]?1:0,n[r]=a*s+n[r]-i[r];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,r,s,a,u){var c,l,m,d,p,y,f,b,g,P,A,h,I,T,S,B,C,x,L,W,N=n.constructor,Z=n.s==i.s?1:-1,G=n.d,D=i.d;if(!G||!G[0]||!D||!D[0])return new N(!n.s||!i.s||(G?D&&G[0]==D[0]:!D)?NaN:G&&G[0]==0||!D?Z*0:Z/0);for(u?(p=1,l=n.e-i.e):(u=wt,p=J,l=Ue(n.e/p)-Ue(i.e/p)),L=D.length,C=G.length,g=new N(Z),P=g.d=[],m=0;D[m]==(G[m]||0);m++);if(D[m]>(G[m]||0)&&l--,r==null?(T=r=N.precision,s=N.rounding):a?T=r+(n.e-i.e)+1:T=r,T<0)P.push(1),y=!0;else{if(T=T/p+2|0,m=0,L==1){for(d=0,D=D[0],T++;(m<C||d)&&T--;m++)S=d*u+(G[m]||0),P[m]=S/D|0,d=S%D|0;y=d||m<C}else{for(d=u/(D[0]+1)|0,d>1&&(D=o(D,d,u),G=o(G,d,u),L=D.length,C=G.length),B=L,A=G.slice(0,L),h=A.length;h<L;)A[h++]=0;W=D.slice(),W.unshift(0),x=D[0],D[1]>=u/2&&++x;do d=0,c=e(D,A,L,h),c<0?(I=A[0],L!=h&&(I=I*u+(A[1]||0)),d=I/x|0,d>1?(d>=u&&(d=u-1),f=o(D,d,u),b=f.length,h=A.length,c=e(f,A,b,h),c==1&&(d--,t(f,L<b?W:D,b,u))):(d==0&&(c=d=1),f=D.slice()),b=f.length,b<h&&f.unshift(0),t(A,f,h,u),c==-1&&(h=A.length,c=e(D,A,L,h),c<1&&(d++,t(A,L<h?W:D,h,u))),h=A.length):c===0&&(d++,A=[0]),P[m++]=d,c&&A[0]?A[h++]=G[B]||0:(A=[G[B]],h=1);while((B++<C||A[0]!==void 0)&&T--);y=A[0]!==void 0}P[0]||P.shift()}if(p==1)g.e=l,ws=y;else{for(m=1,d=P[0];d>=10;d/=10)m++;g.e=m+l*p-1,H(g,a?r+g.e+1:r,s,y)}return g}}();function H(o,e,t,n){var i,r,s,a,u,c,l,m,d,p=o.constructor;e:if(e!=null){if(m=o.d,!m)return o;for(i=1,a=m[0];a>=10;a/=10)i++;if(r=e-i,r<0)r+=J,s=e,l=m[d=0],u=l/Oe(10,i-s-1)%10|0;else if(d=Math.ceil((r+1)/J),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=u=0,i=1,r%=J,s=r-J+1}else break e;else{for(l=a=m[d],i=1;a>=10;a/=10)i++;r%=J,s=r-J+i,u=s<0?0:l/Oe(10,i-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%Oe(10,i-s-1)),c=t<4?(u||n)&&(t==0||t==(o.s<0?3:2)):u>5||u==5&&(t==4||n||t==6&&(r>0?s>0?l/Oe(10,i-s):0:m[d-1])%10&1||t==(o.s<0?8:7)),e<1||!m[0])return m.length=0,c?(e-=o.e+1,m[0]=Oe(10,(J-e%J)%J),o.e=-e||0):m[0]=o.e=0,o;if(r==0?(m.length=d,a=1,d--):(m.length=d+1,a=Oe(10,J-r),m[d]=s>0?(l/Oe(10,i-s)%Oe(10,s)|0)*a:0),c)for(;;)if(d==0){for(r=1,s=m[0];s>=10;s/=10)r++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;r!=a&&(o.e++,m[0]==wt&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=wt)break;m[d--]=0,a=1}for(r=m.length;m[--r]===0;)m.pop()}return oe&&(o.e>p.maxE?(o.d=null,o.e=NaN):o.e<p.minE&&(o.e=0,o.d=[0])),o}function St(o,e,t){if(!o.isFinite())return xs(o);var n,i=o.e,r=Fe(o.d),s=r.length;return e?(t&&(n=t-s)>0?r=r.charAt(0)+"."+r.slice(1)+Ut(n):s>1&&(r=r.charAt(0)+"."+r.slice(1)),r=r+(o.e<0?"e":"e+")+o.e):i<0?(r="0."+Ut(-i-1)+r,t&&(n=t-s)>0&&(r+=Ut(n))):i>=s?(r+=Ut(i+1-s),t&&(n=t-i-1)>0&&(r=r+"."+Ut(n))):((n=i+1)<s&&(r=r.slice(0,n)+"."+r.slice(n)),t&&(n=t-s)>0&&(i+1===s&&(r+="."),r+=Ut(n))),r}function _i(o,e){var t=o[0];for(e*=J;t>=10;t/=10)e++;return e}function Ni(o,e,t){if(e>ju)throw oe=!0,t&&(o.precision=t),Error(As);return H(new o(Li),e,1,!0)}function gt(o,e,t){if(e>Xo)throw Error(As);return H(new o(Oi),e,t,!0)}function Ts(o){var e=o.length-1,t=e*J+1;if(e=o[e],e){for(;e%10==0;e/=10)t--;for(e=o[0];e>=10;e/=10)t++}return t}function Ut(o){for(var e="";o--;)e+="0";return e}function Is(o,e,t,n){var i,r=new o(1),s=Math.ceil(n/J+4);for(oe=!1;;){if(t%2&&(r=r.times(e),bs(r.d,s)&&(i=!0)),t=Ue(t/2),t===0){t=r.d.length-1,i&&r.d[t]===0&&++r.d[t];break}e=e.times(e),bs(e.d,s)}return oe=!0,r}function ys(o){return o.d[o.d.length-1]&1}function Bs(o,e,t){for(var n,i=new o(e[0]),r=0;++r<e.length;)if(n=new o(e[r]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function zo(o,e){var t,n,i,r,s,a,u,c=0,l=0,m=0,d=o.constructor,p=d.rounding,y=d.precision;if(!o.d||!o.d[0]||o.e>17)return new d(o.d?o.d[0]?o.s<0?0:1/0:1:o.s?o.s<0?0:o:0/0);for(e==null?(oe=!1,u=y):u=e,a=new d(.03125);o.e>-2;)o=o.times(a),m+=5;for(n=Math.log(Oe(2,m))/Math.LN10*2+5|0,u+=n,t=r=s=new d(1),d.precision=u;;){if(r=H(r.times(o),u,1),t=t.times(++l),a=s.plus(we(r,t,u,1)),Fe(a.d).slice(0,u)===Fe(s.d).slice(0,u)){for(i=m;i--;)s=H(s.times(s),u,1);if(e==null)if(c<3&&Vn(s.d,u-n,p,c))d.precision=u+=10,t=r=a=new d(1),l=0,c++;else return H(s,d.precision=y,p,oe=!0);else return d.precision=y,s}s=a}}function Gt(o,e){var t,n,i,r,s,a,u,c,l,m,d,p=1,y=10,f=o,b=f.d,g=f.constructor,P=g.rounding,A=g.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(oe=!1,l=A):l=e,g.precision=l+=y,t=Fe(b),n=t.charAt(0),Math.abs(r=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(o),t=Fe(f.d),n=t.charAt(0),p++;r=f.e,n>1?(f=new g("0."+t),r++):f=new g(n+"."+t.slice(1))}else return c=Ni(g,l+2,A).times(r+""),f=Gt(new g(n+"."+t.slice(1)),l-y).plus(c),g.precision=A,e==null?H(f,A,P,oe=!0):f;for(m=f,u=s=f=we(f.minus(1),f.plus(1),l,1),d=H(f.times(f),l,1),i=3;;){if(s=H(s.times(d),l,1),c=u.plus(we(s,new g(i),l,1)),Fe(c.d).slice(0,l)===Fe(u.d).slice(0,l))if(u=u.times(2),r!==0&&(u=u.plus(Ni(g,l+2,A).times(r+""))),u=we(u,new g(p),l,1),e==null)if(Vn(u.d,l-y,P,a))g.precision=l+=y,c=s=f=we(m.minus(1),m.plus(1),l,1),d=H(f.times(f),l,1),i=a=1;else return H(u,g.precision=A,P,oe=!0);else return g.precision=A,u;u=c,i+=2}}function xs(o){return String(o.s*o.s/0)}function Qo(o,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,o.e=t=t-n-1,o.d=[],n=(t+1)%J,t<0&&(n+=J),n<i){for(n&&o.d.push(+e.slice(0,n)),i-=J;n<i;)o.d.push(+e.slice(n,n+=J));e=e.slice(n),n=J-e.length}else n-=i;for(;n--;)e+="0";o.d.push(+e),oe&&(o.e>o.constructor.maxE?(o.d=null,o.e=NaN):o.e<o.constructor.minE&&(o.e=0,o.d=[0]))}else o.e=0,o.d=[0];return o}function Zu(o,e){var t,n,i,r,s,a,u,c,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),ks.test(e))return Qo(o,e)}else if(e==="Infinity"||e==="NaN")return+e||(o.s=NaN),o.e=NaN,o.d=null,o;if(zu.test(e))t=16,e=e.toLowerCase();else if(Xu.test(e))t=2;else if(Qu.test(e))t=8;else throw Error(Xt+e);for(r=e.search(/p/i),r>0?(u=+e.slice(r+1),e=e.substring(2,r)):e=e.slice(2),r=e.indexOf("."),s=r>=0,n=o.constructor,s&&(e=e.replace(".",""),a=e.length,r=a-r,i=Is(n,new n(t),r,r*2)),c=Ri(e,t,wt),l=c.length-1,r=l;c[r]===0;--r)c.pop();return r<0?new n(o.s*0):(o.e=_i(c,l),o.d=c,oe=!1,s&&(o=we(o,i,a*4)),u&&(o=o.times(Math.abs(u)<54?Oe(2,u):En.pow(2,u))),oe=!0,o)}function $u(o,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:hn(o,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/vi(5,t)),e=hn(o,2,e,e);for(var i,r=new o(5),s=new o(16),a=new o(20);t--;)i=e.times(e),e=e.times(r.plus(i.times(s.times(i).minus(a))));return e}function hn(o,e,t,n,i){var r,s,a,u,c=1,l=o.precision,m=Math.ceil(l/J);for(oe=!1,u=t.times(t),a=new o(n);;){if(s=we(a.times(u),new o(e++*e++),l,1),a=i?n.plus(s):n.minus(s),n=we(s.times(u),new o(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(r=m;s.d[r]===a.d[r]&&r--;);if(r==-1)break}r=a,a=n,n=s,s=r,c++}return oe=!0,s.d.length=m+1,s}function vi(o,e){for(var t=o;--e;)t*=o;return t}function Ss(o,e){var t,n=e.s<0,i=gt(o,o.precision,1),r=i.times(.5);if(e=e.abs(),e.lte(r))return Rt=n?4:1,e;if(t=e.divToInt(i),t.isZero())Rt=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(r))return Rt=ys(t)?n?2:3:n?4:1,e;Rt=ys(t)?n?1:4:n?3:2}return e.minus(i).abs()}function Yo(o,e,t,n){var i,r,s,a,u,c,l,m,d,p=o.constructor,y=t!==void 0;if(y?($e(t,1,zt),n===void 0?n=p.rounding:$e(n,0,8)):(t=p.precision,n=p.rounding),!o.isFinite())l=xs(o);else{for(l=St(o),s=l.indexOf("."),y?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=Ri(St(d),10,i),d.e=d.d.length),m=Ri(l,10,i),r=u=m.length;m[--u]==0;)m.pop();if(!m[0])l=y?"0p+0":"0";else{if(s<0?r--:(o=new p(o),o.d=m,o.e=r,o=we(o,d,t,n,0,i),m=o.d,r=o.e,c=ws),s=m[t],a=i/2,c=c||m[t+1]!==void 0,c=n<4?(s!==void 0||c)&&(n===0||n===(o.s<0?3:2)):s>a||s===a&&(n===4||c||n===6&&m[t-1]&1||n===(o.s<0?8:7)),m.length=t,c)for(;++m[--t]>i-1;)m[t]=0,t||(++r,m.unshift(1));for(u=m.length;!m[u-1];--u);for(s=0,l="";s<u;s++)l+=Uo.charAt(m[s]);if(y){if(u>1)if(e==16||e==8){for(s=e==16?4:3,--u;u%s;u++)l+="0";for(m=Ri(l,i,e),u=m.length;!m[u-1];--u);for(s=1,l="1.";s<u;s++)l+=Uo.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(r<0?"p":"p+")+r}else if(r<0){for(;++r;)l="0"+l;l="0."+l}else if(++r>u)for(r-=u;r--;)l+="0";else r<u&&(l=l.slice(0,r)+"."+l.slice(r))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return o.s<0?"-"+l:l}function bs(o,e){if(o.length>e)return o.length=e,!0}function Ju(o){return new this(o).abs()}function ec(o){return new this(o).acos()}function tc(o){return new this(o).acosh()}function nc(o,e){return new this(o).plus(e)}function ic(o){return new this(o).asin()}function oc(o){return new this(o).asinh()}function rc(o){return new this(o).atan()}function sc(o){return new this(o).atanh()}function ac(o,e){o=new this(o),e=new this(e);var t,n=this.precision,i=this.rounding,r=n+4;return!o.s||!e.s?t=new this(NaN):!o.d&&!e.d?(t=gt(this,r,1).times(e.s>0?.25:.75),t.s=o.s):!e.d||o.isZero()?(t=e.s<0?gt(this,n,i):new this(0),t.s=o.s):!o.d||e.isZero()?(t=gt(this,r,1).times(.5),t.s=o.s):e.s<0?(this.precision=r,this.rounding=1,t=this.atan(we(o,e,r,1)),e=gt(this,r,1),this.precision=n,this.rounding=i,t=o.s<0?t.minus(e):t.plus(e)):t=this.atan(we(o,e,r,1)),t}function uc(o){return new this(o).cbrt()}function cc(o){return H(o=new this(o),o.e+1,2)}function lc(o,e,t){return new this(o).clamp(e,t)}function mc(o){if(!o||typeof o!="object")throw Error(Mi+"Object expected");var e,t,n,i=o.defaults===!0,r=["precision",1,zt,"rounding",0,8,"toExpNeg",-Pn,0,"toExpPos",0,Pn,"maxE",0,Pn,"minE",-Pn,0,"modulo",0,9];for(e=0;e<r.length;e+=3)if(t=r[e],i&&(this[t]=Go[t]),(n=o[t])!==void 0)if(Ue(n)===n&&n>=r[e+1]&&n<=r[e+2])this[t]=n;else throw Error(Xt+t+": "+n);if(t="crypto",i&&(this[t]=Go[t]),(n=o[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(Ps);else this[t]=!1;else throw Error(Xt+t+": "+n);return this}function dc(o){return new this(o).cos()}function pc(o){return new this(o).cosh()}function Ks(o){var e,t,n;function i(r){var s,a,u,c=this;if(!(c instanceof i))return new i(r);if(c.constructor=i,gs(r)){c.s=r.s,oe?!r.d||r.e>i.maxE?(c.e=NaN,c.d=null):r.e<i.minE?(c.e=0,c.d=[0]):(c.e=r.e,c.d=r.d.slice()):(c.e=r.e,c.d=r.d?r.d.slice():r.d);return}if(u=typeof r,u==="number"){if(r===0){c.s=1/r<0?-1:1,c.e=0,c.d=[0];return}if(r<0?(r=-r,c.s=-1):c.s=1,r===~~r&&r<1e7){for(s=0,a=r;a>=10;a/=10)s++;oe?s>i.maxE?(c.e=NaN,c.d=null):s<i.minE?(c.e=0,c.d=[0]):(c.e=s,c.d=[r]):(c.e=s,c.d=[r]);return}else if(r*0!==0){r||(c.s=NaN),c.e=NaN,c.d=null;return}return Qo(c,r.toString())}else if(u!=="string")throw Error(Xt+r);return(a=r.charCodeAt(0))===45?(r=r.slice(1),c.s=-1):(a===43&&(r=r.slice(1)),c.s=1),ks.test(r)?Qo(c,r):Zu(c,r)}if(i.prototype=v,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=mc,i.clone=Ks,i.isDecimal=gs,i.abs=Ju,i.acos=ec,i.acosh=tc,i.add=nc,i.asin=ic,i.asinh=oc,i.atan=rc,i.atanh=sc,i.atan2=ac,i.cbrt=uc,i.ceil=cc,i.clamp=lc,i.cos=dc,i.cosh=pc,i.div=fc,i.exp=yc,i.floor=bc,i.hypot=gc,i.ln=wc,i.log=Ac,i.log10=hc,i.log2=Pc,i.max=kc,i.min=Tc,i.mod=Ic,i.mul=Bc,i.pow=xc,i.random=Sc,i.round=Kc,i.sign=Cc,i.sin=Rc,i.sinh=Lc,i.sqrt=Oc,i.sub=Nc,i.sum=Mc,i.tan=_c,i.tanh=vc,i.trunc=Vc,o===void 0&&(o={}),o&&o.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)o.hasOwnProperty(t=n[e++])||(o[t]=this[t]);return i.config(o),i}function fc(o,e){return new this(o).div(e)}function yc(o){return new this(o).exp()}function bc(o){return H(o=new this(o),o.e+1,3)}function gc(){var o,e,t=new this(0);for(oe=!1,o=0;o<arguments.length;)if(e=new this(arguments[o++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return oe=!0,new this(1/0);t=e}return oe=!0,t.sqrt()}function gs(o){return o instanceof En||o&&o.toStringTag===hs||!1}function wc(o){return new this(o).ln()}function Ac(o,e){return new this(o).log(e)}function Pc(o){return new this(o).log(2)}function hc(o){return new this(o).log(10)}function kc(){return Bs(this,arguments,"lt")}function Tc(){return Bs(this,arguments,"gt")}function Ic(o,e){return new this(o).mod(e)}function Bc(o,e){return new this(o).mul(e)}function xc(o,e){return new this(o).pow(e)}function Sc(o){var e,t,n,i,r=0,s=new this(1),a=[];if(o===void 0?o=this.precision:$e(o,1,zt),n=Math.ceil(o/J),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));r<n;)i=e[r],i>=429e7?e[r]=crypto.getRandomValues(new Uint32Array(1))[0]:a[r++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);r<n;)i=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+((e[r+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,r):(a.push(i%1e7),r+=4);r=n/4}else throw Error(Ps);else for(;r<n;)a[r++]=Math.random()*1e7|0;for(n=a[--r],o%=J,n&&o&&(i=Oe(10,J-o),a[r]=(n/i|0)*i);a[r]===0;r--)a.pop();if(r<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=J)a.shift();for(n=1,i=a[0];i>=10;i/=10)n++;n<J&&(t-=J-n)}return s.e=t,s.d=a,s}function Kc(o){return H(o=new this(o),o.e+1,this.rounding)}function Cc(o){return o=new this(o),o.d?o.d[0]?o.s:0*o.s:o.s||NaN}function Rc(o){return new this(o).sin()}function Lc(o){return new this(o).sinh()}function Oc(o){return new this(o).sqrt()}function Nc(o,e){return new this(o).sub(e)}function Mc(){var o=0,e=arguments,t=new this(e[o]);for(oe=!1;t.s&&++o<e.length;)t=t.plus(e[o]);return oe=!0,H(t,this.precision,this.rounding)}function _c(o){return new this(o).tan()}function vc(o){return new this(o).tanh()}function Vc(o){return H(o=new this(o),o.e+1,1)}v[Symbol.for("nodejs.util.inspect.custom")]=v.toString;v[Symbol.toStringTag]="Decimal";var En=v.constructor=Ks(Go);Li=new En(Li);Oi=new En(Oi);var O=En;import Xc from"big.js";import Fi from"bn.js";import Ec from"toformat";var Fc=Ec,Fn=Fc;import Ei from"big.js";import Wc from"bn.js";import qc from"decimal.js-light";import Dn from"bn.js";var Cs=9007199254740991;function j(o){let e=se("Raydium_parseBigNumberish");if(o instanceof Dn)return o;if(typeof o=="string"){if(o.match(/^-?[0-9]+$/))return new Dn(o);e.logWithError(`invalid BigNumberish string: ${o}`)}return typeof o=="number"?(o%1&&e.logWithError(`BigNumberish number underflow: ${o}`),(o>=Cs||o<=-Cs)&&e.logWithError(`BigNumberish number overflow: ${o}`),new Dn(String(o))):typeof o=="bigint"?new Dn(o.toString()):(e.error(`invalid BigNumberish value: ${o}`),new Dn(0))}var Vi=se("module/fraction"),jo=Fn(Ei),Wn=Fn(qc),Uc={[0]:Wn.ROUND_DOWN,[1]:Wn.ROUND_HALF_UP,[2]:Wn.ROUND_UP},Gc={[0]:Ei.roundDown,[1]:Ei.roundHalfUp,[2]:Ei.roundUp},de=class{constructor(e,t=new Wc(1)){this.numerator=j(e),this.denominator=j(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new de(this.denominator,this.numerator)}add(e){let t=e instanceof de?e:new de(j(e));return this.denominator.eq(t.denominator)?new de(this.numerator.add(t.numerator),this.denominator):new de(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof de?e:new de(j(e));return this.denominator.eq(t.denominator)?new de(this.numerator.sub(t.numerator),this.denominator):new de(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof de?e:new de(j(e));return new de(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof de?e:new de(j(e));return new de(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Vi.logWithError(`${e} is not an integer.`),e<=0&&Vi.logWithError(`${e} is not positive.`),Wn.set({precision:e+1,rounding:Uc[n]});let i=new Wn(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Vi.logWithError(`${e} is not an integer.`),e<0&&Vi.logWithError(`${e} is negative.`),jo.DP=e,jo.RM=Gc[n]||1,new jo(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var zc=se("Raydium_amount"),Rs=Fn(Xc);function Qc(o,e){let t="0",n="0";if(o.includes(".")){let i=o.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):zc.logWithError(`invalid number string, num: ${o}`)}else t=o;return[t,n.slice(0,e)||n]}var fe=class extends de{constructor(t,n,i=!0,r){let s=new Fi(0),a=Ho.pow(new Fi(t.decimals));if(i)s=j(n);else{let u=new Fi(0),c=new Fi(0);if(typeof n=="string"||typeof n=="number"||typeof n=="bigint"){let[l,m]=Qc(n.toString(),t.decimals);u=j(l),c=j(m)}u=u.mul(a),s=u.add(c)}super(s,a);this.logger=se(r||"TokenAmount"),this.token=t}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(t){return this.token.equals(t.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(t.raw)}lt(t){return this.token.equals(t.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(t.raw)}add(t){return this.token.equals(t.token)||this.logger.logWithError("add token not equals"),new fe(this.token,this.raw.add(t.raw))}subtract(t){return this.token.equals(t.token)||this.logger.logWithError("sub token not equals"),new fe(this.token,this.raw.sub(t.raw))}toSignificant(t=this.token.decimals,n,i=0){return super.toSignificant(t,n,i)}toFixed(t=this.token.decimals,n,i=0){return t>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(t,n,i)}toExact(t={groupSeparator:""}){return Rs.DP=this.token.decimals,new Rs(this.numerator.toString()).div(this.denominator.toString()).toFormat(t)}};import{PublicKey as Yc}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ls}from"@solana/spl-token";var Qt={chainId:101,address:Yc.default.toBase58(),programId:Ls.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},De={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Ls.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as tr}from"@solana/web3.js";import{PublicKey as ke,SystemProgram as Os,SYSVAR_RENT_PUBKEY as jc}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Hc}from"@solana/spl-token";function k({pubkey:o,isSigner:e=!1,isWritable:t=!0}){return{pubkey:o,isWritable:t,isSigner:e}}var Zo=[k({pubkey:Hc,isWritable:!1}),k({pubkey:Os.programId,isWritable:!1}),k({pubkey:jc,isWritable:!1})];function $o({publicKey:o,transformSol:e}){let t=Jo(o.toString());if(t instanceof ke)return e&&t.equals(Ne)?z:t;if(e&&t.toString()===Ne.toBase58())return z;if(typeof t=="string"){if(t===ke.default.toBase58())return ke.default;try{return new ke(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Jo(o){try{return new ke(o)}catch{return o}}var Di=new ke("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),kn=new ke("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),At=new ke("SysvarRent111111111111111111111111111111111"),Ns=new ke("SysvarC1ock11111111111111111111111111111111"),Tn=new ke("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Zc=new ke("Sysvar1nstructions1111111111111111111111111"),er=Os.programId,wp=new ke("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Ap=new ke("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Pp=new ke("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),hp=new ke("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),kp=new ke("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Tp=new ke("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Ip=new ke("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Bp=new ke("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),xp=new ke("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Sp=new ke("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Kp=new ke("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),z=new ke("So11111111111111111111111111111111111111112"),Ne=ke.default;function ot(o){return $o({publicKey:o,transformSol:!0})}var nr=class{constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:r=!1,isToken2022:s=!1}){if(e===Ne.toBase58()||e instanceof tr&&Ne.equals(e)){this.decimals=De.decimals,this.symbol=De.symbol,this.name=De.name,this.mint=new tr(De.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=r?tr.default:$o({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Te=nr;Te.WSOL=new nr(F(R({},De),{mint:De.address}));var ir=class{constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Wi=ir;Wi.SOL=new ir(Qt);import $c from"bn.js";var Ms=new de(new $c(100)),ve=class extends de{toSignificant(e=5,t,n){return this.mul(Ms).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Ms).toFixed(e,t,n)}};var Jc=se("Raydium_price"),Je=class extends de{constructor(t){let{baseToken:n,quoteToken:i,numerator:r,denominator:s}=t;super(r,s);this.baseToken=n,this.quoteToken=i,this.scalar=new de(or(n.decimals),or(i.decimals))}get raw(){return new de(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new Je({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(t){this.quoteToken!==t.baseToken&&Jc.logWithError("mul token not equals");let n=super.mul(t);return new Je({baseToken:this.baseToken,quoteToken:t.quoteToken,denominator:n.denominator,numerator:n.numerator})}toSignificant(t=this.quoteToken.decimals,n,i){return this.adjusted.toSignificant(t,n,i)}toFixed(t=this.quoteToken.decimals,n,i){return this.adjusted.toFixed(t,n,i)}};import{PublicKey as el}from"@solana/web3.js";import tl from"bn.js";function _s(o){return typeof o=="object"&&o!==null&&![Te,fe,el,de,tl,Je,ve].some(e=>typeof e=="object"&&o instanceof e)}function We(o){return typeof o=="string"?Jo(o):Array.isArray(o)?o.map(e=>We(e)):_s(o)?Object.fromEntries(Object.entries(o).map(([e,t])=>[e,We(t)])):o}var ct=new Lt(0),vs=new Lt(1),If=new Lt(2),Bf=new Lt(3),xf=new Lt(5),Ho=new Lt(10),Sf=new Lt(100),Kf=new Lt(1e3),Cf=new Lt(1e4);function or(o){return Ho.pow(j(o))}function qi(o,e){let t=o.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function qo(o,e=1,t=[]){let n=[...o];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var Pt=class{constructor(e){this._owner=e}get publicKey(){return Pt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Pt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Pt.isKeyPair(this._owner)}get isPublicKey(){return Pt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Pt.isKeyPair(e)}};import{PublicKey as al}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ul}from"@solana/spl-token";import{ComputeBudgetProgram as Vs,Keypair as Fs,PublicKey as nl,Transaction as Ds,TransactionMessage as il,VersionedTransaction as Ws}from"@solana/web3.js";var V={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut"};import{TOKEN_PROGRAM_ID as ol}from"@solana/spl-token";var Es=se("Raydium_txUtil"),qs=1644;function Ui(o){let e=[],t=[];return o.microLamports&&(e.push(Vs.setComputeUnitPrice({microLamports:o.microLamports})),t.push(V.SetComputeUnitPrice)),o.units&&(e.push(Vs.setComputeUnitLimit({units:o.units})),t.push(V.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function In(o,e){var n,i;let t=e!=null?e:"confirmed";return(i=await((n=o.getLatestBlockhash)==null?void 0:n.call(o,{commitment:t})))==null?void 0:i.blockhash}async function Gi(o,e){return o.getSignatureStatuses([e]),new Promise((t,n)=>{let i=setTimeout(n,6e4);o.onSignature(e,r=>{if(clearTimeout(i),!r.err){t("");return}n(r.err.toString())},"confirmed")})}function rr(o,e){o.length<1&&Es.logWithError(`no instructions provided: ${o.toString()}`),e.length<1&&Es.logWithError(`no signers provided:, ${e.toString()}`);let t=new Ds;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...o);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<qs}catch{return!1}}function ce(o,e){let[t,n]=nl.findProgramAddressSync(o,e);return{publicKey:t,nonce:n}}function qn({instructions:o,payer:e,signers:t}){return rr(o,[e,...t])}function Un({instructions:o,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Fs.generate().publicKey.toString()}){let r=new il({payerKey:e,recentBlockhash:n,instructions:o}).compileToV0Message(Object.values(t!=null?t:{}));try{return Buffer.from(new Ws(r).serialize()).toString("base64").length<qs}catch{return!1}}var rl=o=>Buffer.isBuffer(o)?o:o instanceof Uint8Array?Buffer.from(o.buffer,o.byteOffset,o.byteLength):Buffer.from(o),sl=o=>{let e=o.serialize({requireAllSignatures:!1,verifySignatures:!1});o instanceof Ws&&(e=rl(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function on(o){let e=[];return o.forEach(t=>{t instanceof Ds&&(t.recentBlockhash||(t.recentBlockhash=ol.toBase58()),t.feePayer||(t.feePayer=Fs.generate().publicKey)),e.push(sl(t))}),console.log("simulate tx string:",e),e}function Pe(o,e,t){return ce([o.toBuffer(),(t!=null?t:ul).toBuffer(),e.toBuffer()],new al("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as ae}from"@solana/web3.js";var Us=new ae("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Gs=new ae("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Gn=new ae("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Hf=new ae("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Zf=new ae("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),sr=new ae("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Xs=new ae("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),$f=new ae("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),zs=new ae("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Xi=new ae("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),zi=new ae("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Qi=new ae("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),Jf=new ae("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),ey=new ae("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),cl=new ae("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),ll=new ae("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),ml=new ae("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),dl=new ae("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Qs=new ae("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),ty=new ae("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),ny=new ae("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),pl=new ae("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),fl=new ae("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),yl=new ae("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),Xn={IDO_PROGRAM_ID_V1:cl,IDO_PROGRAM_ID_V2:ll,IDO_PROGRAM_ID_V3:ml,IDO_PROGRAM_ID_V4:dl};var iy={SERUM_MARKET:ae.default,OPENBOOK_MARKET:new ae("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:ae.default,FarmV3:new ae("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new ae("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new ae("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new ae("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new ae("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new ae("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new ae("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new ae("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new ae("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:pl,CREATE_CPMM_POOL_AUTH:fl,CREATE_CPMM_POOL_FEE_ACC:yl,FEE_DESTINATION_ID:new ae("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR")};import ht from"bn.js";var zn=1e4;function ye(o,e,t,n){if(e===void 0)return{amount:o,fee:void 0,expirationTime:void 0};let i=F(R({},e),{olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}}),r=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,s=new ht(r.maximumFee.toString()),a=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(r.transferFeeBasisPoints===zn){let u=new ht(r.maximumFee.toString());return{amount:o.add(u),fee:u,expirationTime:a}}else{let u=Yt(o.mul(new ht(zn)),new ht(zn-r.transferFeeBasisPoints)),c=new ht(r.maximumFee.toString()),l=u.sub(o).gt(c)?o.add(c):u,m=Yt(l.mul(new ht(r.transferFeeBasisPoints)),new ht(zn)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let u=Yt(o.mul(new ht(r.transferFeeBasisPoints)),new ht(zn)),c=u.gt(s)?s:u;return{amount:o,fee:c,expirationTime:a}}}function kt(o,e){return o===void 0?e:e===void 0?o:Math.min(o,e)}function Yt(o,e){let{div:t,mod:n}=o.divmod(e);return n.gt(new ht(0))?t.add(new ht(1)):t}import{PublicKey as Ys,AddressLookupTableAccount as Yi}from"@solana/web3.js";async function ar({connection:o,address:e}){let t=await bt(o,[...new Set(e.map(i=>i.toString()))].map(i=>new Ys(i))),n={};for(let i=0;i<e.length;i++){let r=t[i],s=e[i];if(!r)continue;let a=new Yi({key:s,state:Yi.deserialize(r.data)});n[s.toString()]=a,ji[s.toString()]=a}return n}var ji={"2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17":new Yi({key:new Ys("2immgwYNHBbyVQKVGCEkgWpi53bLwWNRMB5G2nbgYV17"),state:Yi.deserialize(Buffer.from("AQAAAP//////////d49+DAAAAAAAAQZMWvw7GUNJdaccNBVnb57OKakxL2BHLYvhRwVILRsgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMGRm/lIRcy/+ytunLDm+e8jOW7xfcSayxDmzpAAAAABt324ddloZPZy+FGzut5rBy0he1fWzeROoz1hX7/AKkG3fbh7nWP3hhCXbzkbM3athr8TYO5DSf+vfko2KGL/AVKU1D4XciC1hSlVnJ4iilt3x6rq9CmBniISTL07vagBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvDQdRqCgtphMF/imcN7mY5YRx2xE1A3MQ+L4QRaYK9u4GRfZP3LsAd00a+IkCpA22UNQMKdq5BFbJuwuOLqc8zxCTDlqxBG8J0HcxtfogQHDK06ukzfaXiNDKAob1MqBHS9lJxDYCwz8gd5DtFqNSTKG5l1zxIaKpDP/sffi2is1H9aKveyXSu5StXElYRl9SD5As0DHE4N0GLnf84/siiKXVyp4Ez121kLcUui/jLLFZEz/BwZK3Ilf9B9OcsEAeDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu9N9LMnrw/JNO0hqMVB4rk/2ou4AB1loQ7FZoPwut2o4KZB+0p9xnbrQKw038qjpHar+PyDwvxBRcu5hpHw3dguezeWv+IwvgW5icu8EGkhGa9AkFPPJT7VMSFb8xowveU=","base64"))})};import{PublicKey as Qn,sendAndConfirmTransaction as ur,Transaction as Yn,TransactionMessage as jn,VersionedTransaction as Hn}from"@solana/web3.js";import bl from"axios";var Hi=class{constructor(e){this.instructions=[];this.endInstructions=[];this.lookupTableAddress=[];this.signers=[];this.instructionTypes=[];this.endInstructionTypes=[];this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.api=e.api}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){var n;let e=(await bl.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=(n=e==null?void 0:e[15])!=null?n:{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=Ui(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:r=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...r),this.lookupTableAddress.push(...s.filter(a=>a!==Qn.default.toString())),this}async versionBuild({txVersion:e,extInfo:t}){return e===0?await this.buildV0(R({},t||{})):this.build(t)}build(e){var n;let t=new Yn;return this.allInstructions.length&&t.add(...this.allInstructions),t.feePayer=this.feePayer,((n=this.owner)==null?void 0:n.signer)&&!this.signers.some(i=>i.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:t,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async i=>{var c;let{recentBlockHash:r,skipPreflight:s=!0,sendAndConfirm:a}=i||{},u=r!=null?r:await In(this.connection,this.blockhashCommitment);if(t.recentBlockhash=u,this.signers.length&&t.sign(...this.signers),on([t]),(c=this.owner)!=null&&c.isKeyPair)return{txId:a?await ur(this.connection,t,this.signers.find(m=>m.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(t.serialize(),{skipPreflight:s}),signedTx:t};if(this.signAllTransactions){let l=await this.signAllTransactions([t]);return{txId:await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){var c;let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),r=t.filter(l=>l.transaction.instructions.length>0),s=[i,...r.map(l=>l.transaction)],a=[this.signers,...r.map(l=>l.signers)],u=[...this.instructionTypes,...r.map(l=>l.instructionTypes).flat()];return(c=this.owner)!=null&&c.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:u,execute:async l=>{var b;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:y=!0}=l||{},f=p!=null?p:await In(this.connection,this.blockhashCommitment);if((b=this.owner)!=null&&b.isKeyPair){if(m){let g=[];for(let P of s){let A=await ur(this.connection,P,this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:y});g.push(A)}return{txIds:g,signedTxs:s}}return{txIds:await await Promise.all(s.map(async g=>(g.recentBlockhash=f,await this.connection.sendRawTransaction(g.serialize(),{skipPreflight:y})))),signedTxs:s}}if(this.signAllTransactions){let g=s.map((A,h)=>(A.recentBlockhash=f,a[h].length&&A.sign(...a[h]),A));on(g);let P=await this.signAllTransactions(g);if(m){let A=0,h=[],I=async()=>{if(!P[A])return;let T=await this.connection.sendRawTransaction(P[A].serialize(),{skipPreflight:y});h.push({txId:T,status:"sent",signedTx:P[A]}),d==null||d([...h]),A++,this.connection.onSignature(T,S=>{let B=h.findIndex(C=>C.txId===T);B>-1&&(h[B].status=S.err?"error":"success"),d==null||d([...h]),S.err||I()},"processed"),this.connection.getSignatureStatus(T)};return await I(),{txIds:h.map(T=>T.txId),signedTxs:P}}else{let A=[];for(let h=0;h<P.length;h+=1){let I=await this.connection.sendRawTransaction(P[h].serialize(),{skipPreflight:y});A.push(I)}return{txIds:A,signedTxs:P}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e){var f;let y=e||{},{lookupTableCache:t={},lookupTableAddress:n=[],forerunCreate:i,recentBlockhash:r}=y,s=Ce(y,["lookupTableCache","lookupTableAddress","forerunCreate","recentBlockhash"]),a=R(R({},this.cluster==="devnet"?{}:ji),t),u=Array.from(new Set([...n,...this.lookupTableAddress])),c=[];for(let b of u)a[b]===void 0&&c.push(new Qn(b));let l=await ar({connection:this.connection,address:c});for(let[b,g]of Object.entries(l))a[b]=g;let m=i?Qn.default.toBase58():r!=null?r:await In(this.connection,this.blockhashCommitment),d=new jn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(a));((f=this.owner)==null?void 0:f.signer)&&!this.signers.some(b=>b.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new Hn(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async b=>{var A;let{skipPreflight:g=!0,sendAndConfirm:P}=b||{};if(on([p]),(A=this.owner)!=null&&A.isKeyPair){let h=await this.connection.sendTransaction(p,{skipPreflight:g});return P&&await Gi(this.connection,h),{txId:h,signedTx:p}}if(this.signAllTransactions){let h=await this.signAllTransactions([p]);return{txId:await this.connection.sendTransaction(h[0],{skipPreflight:g}),signedTx:h[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){var c;let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),r=t.filter(l=>l.builder.instructions.length>0),s=[i,...r.map(l=>l.transaction)],a=[this.signers,...r.map(l=>l.signers)],u=[...this.instructionTypes,...r.map(l=>l.instructionTypes).flat()];return(c=this.owner)!=null&&c.signer&&a.forEach(l=>{l.some(m=>m.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(l,m)=>{l.sign(a[m])}),{builder:this,transactions:s,signers:a,instructionTypes:u,buildProps:n,execute:async l=>{var f;let{sequentially:m,onTxUpdate:d,recentBlockHash:p,skipPreflight:y=!0}=l||{};if(p&&s.forEach(b=>b.message.recentBlockhash=p),on(s),(f=this.owner)!=null&&f.isKeyPair){if(m){let b=[];for(let g of s){let P=await this.connection.sendTransaction(g,{skipPreflight:y});await Gi(this.connection,P),b.push(P)}return{txIds:b,signedTxs:s}}return{txIds:await Promise.all(s.map(async b=>await this.connection.sendTransaction(b,{skipPreflight:y}))),signedTxs:s}}if(this.signAllTransactions){let b=await this.signAllTransactions(s);if(m){let g=0,P=[],A=async()=>{if(!b[g])return;let h=await this.connection.sendTransaction(b[g],{skipPreflight:y});P.push({txId:h,status:"sent",signedTx:b[g]}),d==null||d([...P]),g++,this.connection.onSignature(h,I=>{let T=P.findIndex(S=>S.txId===h);T>-1&&(P[T].status=I.err?"error":"success"),d==null||d([...P]),I.err||A()},"processed"),this.connection.getSignatureStatus(h)};return A(),{txIds:[],signedTxs:b}}else{let g=[];for(let P=0;P<b.length;P+=1){let A=await this.connection.sendTransaction(b[P],{skipPreflight:y});g.push(A)}return{txIds:g,signedTxs:b}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){var l;let c=e||{},{computeBudgetConfig:t}=c,n=Ce(c,["computeBudgetConfig"]),i=t?Ui(t):{instructions:[],instructionTypes:[]},r=this.signers.reduce((m,d)=>F(R({},m),{[d.publicKey.toBase58()]:d}),{}),s=[],a=[],u=[];if(this.allInstructions.forEach(m=>{let d=[...u,m],p=t?[...i.instructions,...d]:d,f=[...new Set(d.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat()).values()].map(b=>new Qn(b));if(u.length<12&&qn({instructions:p,payer:this.feePayer,signers:f})||qn({instructions:d,payer:this.feePayer,signers:f}))u.push(m);else{if(u.length===0)throw Error("item ins too big");qn({instructions:t?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:f})?s.push(new Yn().add(...i.instructions,...u)):s.push(new Yn().add(...u)),a.push(Array.from(new Set(u.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat())).map(b=>r[b]).filter(b=>b!==void 0)),u=[m]}}),u.length>0){let d=[...new Set(u.map(p=>p.keys.filter(y=>y.isSigner).map(y=>y.pubkey.toString())).flat()).values()].map(p=>r[p]).filter(p=>p!==void 0);qn({instructions:t?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:d.map(p=>p.publicKey)})?s.push(new Yn().add(...i.instructions,...u)):s.push(new Yn().add(...u)),a.push(d)}return s.forEach(m=>m.feePayer=this.feePayer),(l=this.owner)!=null&&l.signer&&a.forEach(m=>{m.some(d=>d.publicKey.equals(this.owner.publicKey))||m.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:this.instructionTypes,execute:async m=>{var g;let{sequentially:d,onTxUpdate:p,recentBlockHash:y,skipPreflight:f=!0}=m||{},b=y!=null?y:await In(this.connection,this.blockhashCommitment);if(s.forEach(async(P,A)=>{P.recentBlockhash=b,a[A].length&&P.sign(...a[A])}),on(s),(g=this.owner)!=null&&g.isKeyPair){if(d){let P=[];for(let A of s){let h=await ur(this.connection,A,this.signers.find(I=>I.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:f});P.push(h)}return{txIds:P,signedTxs:s}}return{txIds:await Promise.all(s.map(async P=>await this.connection.sendRawTransaction(P.serialize(),{skipPreflight:f}))),signedTxs:s}}if(this.signAllTransactions){let P=await this.signAllTransactions(s);if(d){let A=0,h=[],I=async()=>{if(!P[A])return;let T=await this.connection.sendRawTransaction(P[A].serialize(),{skipPreflight:f});h.push({txId:T,status:"sent",signedTx:P[A]}),p==null||p([...h]),A++,this.connection.onSignature(T,S=>{let B=h.findIndex(C=>C.txId===T);B>-1&&(h[B].status=S.err?"error":"success"),p==null||p([...h]),S.err||I()},"processed"),this.connection.getSignatureStatus(T)};return await I(),{txIds:h.map(T=>T.txId),signedTxs:P}}else{let A=[];for(let h=0;h<P.length;h+=1){let I=await this.connection.sendRawTransaction(P[h].serialize(),{skipPreflight:f});A.push(I)}return{txIds:A,signedTxs:P}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuildV0(e){var g;let b=e||{},{computeBudgetConfig:t,lookupTableCache:n={},lookupTableAddress:i=[]}=b,r=Ce(b,["computeBudgetConfig","lookupTableCache","lookupTableAddress"]),s=R(R({},this.cluster==="devnet"?{}:ji),n),a=Array.from(new Set([...this.lookupTableAddress,...i])),u=[];for(let P of a)s[P]===void 0&&u.push(new Qn(P));let c=await ar({connection:this.connection,address:u});for(let[P,A]of Object.entries(c))s[P]=A;let l=t?Ui(t):{instructions:[],instructionTypes:[]},m=await In(this.connection,this.blockhashCommitment),d=this.signers.reduce((P,A)=>F(R({},P),{[A.publicKey.toBase58()]:A}),{}),p=[],y=[],f=[];if(this.allInstructions.forEach(P=>{let A=[...f,P],h=t?[...l.instructions,...A]:A;if(f.length<12&&Un({instructions:h,payer:this.feePayer,lookupTableAddressAccount:s})||Un({instructions:A,payer:this.feePayer,lookupTableAddressAccount:s}))f.push(P);else{if(f.length===0)throw Error("item ins too big");let I={};for(let T of[...new Set(a)])s[T]!==void 0&&(I[T]=s[T]);if(t&&Un({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let T=new jn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));p.push(new Hn(T))}else{let T=new jn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));p.push(new Hn(T))}y.push(Array.from(new Set(f.map(T=>T.keys.filter(S=>S.isSigner).map(S=>S.pubkey.toString())).flat())).map(T=>d[T]).filter(T=>T!==void 0)),f=[P]}}),f.length>0){let A=[...new Set(f.map(h=>h.keys.filter(I=>I.isSigner).map(I=>I.pubkey.toString())).flat()).values()].map(h=>d[h]).filter(h=>h!==void 0);if(t&&Un({instructions:[...l.instructions,...f],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:m})){let h=new jn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...l.instructions,...f]}).compileToV0Message(Object.values(s));p.push(new Hn(h))}else{let h=new jn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...f]}).compileToV0Message(Object.values(s));p.push(new Hn(h))}y.push(A)}return(g=this.owner)!=null&&g.signer&&y.forEach(P=>{P.some(A=>A.publicKey.equals(this.owner.publicKey))||P.push(this.owner.signer)}),{builder:this,transactions:p,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async P=>{var S;let{sequentially:A,onTxUpdate:h,recentBlockHash:I,skipPreflight:T=!0}=P||{};if(p.map(async(B,C)=>{y[C].length&&B.sign(y[C]),I&&(B.message.recentBlockhash=I)}),on(p),(S=this.owner)!=null&&S.isKeyPair){if(A){let B=[];for(let C of p){let x=await this.connection.sendTransaction(C,{skipPreflight:T});await Gi(this.connection,x),B.push(x)}return{txIds:B,signedTxs:p}}return{txIds:await Promise.all(p.map(async B=>await this.connection.sendTransaction(B,{skipPreflight:T}))),signedTxs:p}}if(this.signAllTransactions){let B=await this.signAllTransactions(p);if(A){let C=0,x=[],L=async()=>{if(!B[C])return;let W=await this.connection.sendTransaction(B[C],{skipPreflight:T});x.push({txId:W,status:"sent",signedTx:B[C]}),h==null||h([...x]),C++,this.connection.onSignature(W,N=>{let Z=x.findIndex(G=>G.txId===W);Z>-1&&(x[Z].status=N.err?"error":"success"),h==null||h([...x]),N.err||L()},"processed"),this.connection.getSignatureStatus(W)};return L(),{txIds:[],signedTxs:B}}else{let C=[];for(let x=0;x<B.length;x+=1){let L=await this.connection.sendTransaction(B[x],{skipPreflight:T});C.push(L)}return{txIds:C,signedTxs:B}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:r||{}}}};var Re={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://tokens.jup.ag/tokens?tags=lst,community",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",JITO:"https://mainnet.block-engine.jito.wtf",JITO_TRANSACTION:"/api/v1/transactions",JITO_BUNDLE:"/api/v1/bundles"},Wy=R({},Re);var js="ray_tab_hash",cr="ray_req_hash",gl=()=>{if(typeof window===void 0)return"";let o=sessionStorage.getItem(js);return o||(o=`ray-${Date.now()}`,sessionStorage.setItem(js,o)),o},Zi=async n=>{var i=n,{logCount:o=1e3,removeLastLog:e}=i,t=Ce(i,["logCount","removeLastLog"]);if(typeof window===void 0)return new Promise(s=>s());let r=JSON.parse(localStorage.getItem(cr)||"[]").slice(0,o-1);e&&r.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),r.unshift(F(R({},t),{time:Date.now(),session:gl()}));try{localStorage.setItem(cr,JSON.stringify(r))}catch{if(e){let s=!1,a=JSON.stringify(t.data).substring(0,100);for(r[0].data=a+(a.length>100?"...":"");!s;){r.pop();let u=JSON.stringify(t.data).substring(0,100);r[0].data=u+(u.length>100?"...":"");try{localStorage.setItem(cr,JSON.stringify(r)),s=!0}catch{s=!1}}return new Promise(u=>u())}return Zi(F(R({},t),{logCount:o,removeLastLog:!0}))}};var $i=se("Raydium_Api"),lr=new Map;var Ji=class{constructor({cluster:e,timeout:t,logRequests:n,logCount:i,urlConfigs:r}){this.cluster=e,this.urlConfigs=r||{},this.logCount=i||1e3,this.api=Hs.create({baseURL:this.urlConfigs.BASE_HOST||Re.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:u,url:c}=s;return $i.debug(`${a==null?void 0:a.toUpperCase()} ${u}${c}`),s},s=>($i.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:u,status:c}=s,{method:l,baseURL:m,url:d}=a;return n&&Zi({status:c,url:`${m}${d}`,params:a.params,data:u,logCount:this.logCount}),$i.debug(`${l==null?void 0:l.toUpperCase()} ${m}${d}  ${c}`),u},s=>{let{config:a,response:u={}}=s,{status:c}=u,{method:l,baseURL:m,url:d}=a;return n&&Zi({status:c,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),$i.error(`${l.toUpperCase()} ${m}${d} ${c||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||Re.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||Re.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||Re.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await Hs.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(i=>i.numSlots);return n.reduce((i,r)=>i+r,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||Re.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||Re.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||Re.TOKEN_LIST)).data}async getJupTokenList(){return this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||Re.JUP_TOKEN_LIST})}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||Re.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:i="desc",page:r=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||Re.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${i}&page=${r}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||Re.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],i=t.filter(s=>lr.has(s)?(n.push(lr.get(s)),!1):!0),r=[];return i.length&&(r=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||Re.POOL_KEY_BY_ID)+`?ids=${i.join(",")}`)).data.filter(Boolean),r.forEach(a=>{lr.set(a.id,a)})),n.concat(r)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:i="all",sort:r="default",order:s="desc",page:a=1}=e,[u,c]=[t&&ot(t).toBase58(),n&&n!=="undefined"?ot(n).toBase58():""],[l,m]=c&&u>c?[c,u]:[u,c];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||Re.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${i}&poolSortField=${r}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||Re.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||Re.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||Re.CHECK_AVAILABILITY)).data}async sendTxToJito(e,t){let n=t?this.urlConfigs.JITO_BUNDLE||Re.JITO_BUNDLE:this.urlConfigs.JITO_TRANSACTION||Re.JITO_TRANSACTION;return(await this.api.post(n,{jsonrpc:"2.0",id:1,method:t?"sendBundle":"sendTransaction",params:e},{baseURL:this.urlConfigs.JITO||Re.JITO})).data}};var eo="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",Zs="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as ao,SystemProgram as zl}from"@solana/web3.js";import{AccountLayout as Kn,createAssociatedTokenAccountInstruction as hr,TOKEN_PROGRAM_ID as Zt,TOKEN_2022_PROGRAM_ID as Ql}from"@solana/spl-token";var mr=(...o)=>o.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Ie=class{constructor({scope:e,moduleName:t}){this.disabled=!1;this.scope=e,this.logger=se(t)}createTxBuilder(e){return this.scope.checkOwner(),new Hi({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(mr(e))}logInfo(...e){this.logger.info(mr(e))}logAndCreateError(...e){let t=mr(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as Dl,SystemProgram as Wl}from"@solana/web3.js";import ql from"bn.js";import{createCloseAccountInstruction as Ul,createInitializeAccountInstruction as Gl,createTransferInstruction as Xl,TOKEN_PROGRAM_ID as Sn}from"@solana/spl-token";import{Keypair as vl,PublicKey as ma}from"@solana/web3.js";import Vl from"bn.js";import{TOKEN_PROGRAM_ID as El}from"@solana/spl-token";function wl(o){return o instanceof Uint8Array||o!=null&&typeof o=="object"&&o.constructor.name==="Uint8Array"}function dr(o,...e){if(!wl(o))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(o.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${o.length}`)}function pr(o,e=!0){if(o.destroyed)throw new Error("Hash instance has been destroyed");if(e&&o.finished)throw new Error("Hash#digest() has already been called")}function $s(o,e){dr(o);let t=e.outputLen;if(o.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var no=o=>new DataView(o.buffer,o.byteOffset,o.byteLength),Tt=(o,e)=>o<<32-e|o>>>e;var Tb=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Al(o){if(typeof o!="string")throw new Error(`utf8ToBytes expected string, got ${typeof o}`);return new Uint8Array(new TextEncoder().encode(o))}function fr(o){return typeof o=="string"&&(o=Al(o)),dr(o),o}var to=class{clone(){return this._cloneInto()}},Ib={}.toString;function Js(o){let e=n=>o().update(fr(n)).digest(),t=o();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>o(),e}function Pl(o,e,t,n){if(typeof o.setBigUint64=="function")return o.setBigUint64(e,t,n);let i=BigInt(32),r=BigInt(4294967295),s=Number(t>>i&r),a=Number(t&r),u=n?4:0,c=n?0:4;o.setUint32(e+u,s,n),o.setUint32(e+c,a,n)}var ea=(o,e,t)=>o&e^~o&t,ta=(o,e,t)=>o&e^o&t^e&t,io=class extends to{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=no(this.buffer)}update(e){pr(this);let{view:t,buffer:n,blockLen:i}=this;e=fr(e);let r=e.length;for(let s=0;s<r;){let a=Math.min(i-this.pos,r-s);if(a===i){let u=no(e);for(;i<=r-s;s+=i)this.process(u,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){pr(this),$s(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:r}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>i-s&&(this.process(n,0),s=0);for(let m=s;m<i;m++)t[m]=0;Pl(n,i-8,BigInt(this.length*8),r),this.process(n,0);let a=no(e),u=this.outputLen;if(u%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let c=u/4,l=this.get();if(c>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<c;m++)a.setUint32(4*m,l[m],r)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:r,destroyed:s,pos:a}=this;return e.length=i,e.pos=a,e.finished=r,e.destroyed=s,i%t&&e.buffer.set(n),e}};var hl=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),jt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Ht=new Uint32Array(64),yr=class extends io{constructor(){super(64,32,8,!1),this.A=jt[0]|0,this.B=jt[1]|0,this.C=jt[2]|0,this.D=jt[3]|0,this.E=jt[4]|0,this.F=jt[5]|0,this.G=jt[6]|0,this.H=jt[7]|0}get(){let{A:e,B:t,C:n,D:i,E:r,F:s,G:a,H:u}=this;return[e,t,n,i,r,s,a,u]}set(e,t,n,i,r,s,a,u){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=r|0,this.F=s|0,this.G=a|0,this.H=u|0}process(e,t){for(let m=0;m<16;m++,t+=4)Ht[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=Ht[m-15],p=Ht[m-2],y=Tt(d,7)^Tt(d,18)^d>>>3,f=Tt(p,17)^Tt(p,19)^p>>>10;Ht[m]=f+Ht[m-7]+y+Ht[m-16]|0}let{A:n,B:i,C:r,D:s,E:a,F:u,G:c,H:l}=this;for(let m=0;m<64;m++){let d=Tt(a,6)^Tt(a,11)^Tt(a,25),p=l+d+ea(a,u,c)+hl[m]+Ht[m]|0,f=(Tt(n,2)^Tt(n,13)^Tt(n,22))+ta(n,i,r)|0;l=c,c=u,u=a,a=s+p|0,s=r,r=i,i=n,n=p+f|0}n=n+this.A|0,i=i+this.B|0,r=r+this.C|0,s=s+this.D|0,a=a+this.E|0,u=u+this.F|0,c=c+this.G|0,l=l+this.H|0,this.set(n,i,r,s,a,u,c,l)}roundClean(){Ht.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var na=Js(()=>new yr);import{PublicKey as Nl}from"@solana/web3.js";import aa,{isBN as ua}from"bn.js";import{bits as kl,BitStructure as Nb,blob as Tl,Blob as Mb,cstr as _b,f32 as vb,f32be as Vb,f64 as Eb,f64be as Fb,greedy as Db,Layout as Il,ns64 as Wb,ns64be as qb,nu64 as Bl,nu64be as Ub,offset as Gb,s16 as Xb,s16be as zb,s24 as Qb,s24be as Yb,s32 as xl,s32be as jb,s40 as Hb,s40be as Zb,s48 as $b,s48be as Jb,s8 as eg,seq as Sl,struct as tg,Structure as Kl,u16 as Cl,u16be as ng,u24 as ig,u24be as og,u32 as Rl,u32be as rg,u40 as sg,u40be as ag,u48 as ug,u48be as cg,u8 as Ll,UInt as Ol,union as lg,Union as mg,unionLayoutDiscriminator as dg,utf8 as pg}from"@solana/buffer-layout";var oo=Il,ia=Kl;var br=Ol;var oa=Ll,Ot=Cl;var gr=Rl;var ra=Bl;var qe=xl;var sa=Sl;var be=Tl;var wr=kl;var rn=class extends oo{constructor(t,n,i){super(t,i);this.blob=be(t),this.signed=n}decode(t,n=0){let i=new aa(this.blob.decode(t,n),10,"le");return this.signed?i.fromTwos(this.span*8).clone():i}encode(t,n,i=0){return typeof t=="number"&&(t=new aa(t)),this.signed&&(t=t.toTwos(this.span*8)),this.blob.encode(t.toArrayLike(Buffer,"le",this.span),n,i)}},ro=class extends oo{constructor(t){super(8,t);this._lower=wr(gr(),!1),this._upper=wr(gr(),!1)}addBoolean(t){this._lower.fields.length<32?this._lower.addBoolean(t):this._upper.addBoolean(t)}decode(t,n=0){let i=this._lower.decode(t,n),r=this._upper.decode(t,n+this._lower.span);return R(R({},i),r)}encode(t,n,i=0){return this._lower.encode(t,n,i)+this._upper.encode(t,n,i+this._lower.span)}};function U(o){return new br(1,o)}function Ge(o){return new br(4,o)}function w(o){return new rn(8,!1,o)}function $(o){return new rn(16,!1,o)}function ca(o){return new rn(1,!0,o)}function Bn(o){return new rn(8,!0,o)}function la(o){return new rn(16,!0,o)}var so=class extends oo{constructor(t,n,i,r){super(t.span,r);this.layout=t,this.decoder=n,this.encoder=i}decode(t,n){return this.decoder(this.layout.decode(t,n))}encode(t,n,i){return this.layout.encode(this.encoder(t),n,i)}getSpan(t,n){return this.layout.getSpan(t,n)}};function K(o){return new so(be(32),e=>new Nl(e),e=>e.toBuffer(),o)}function Xe(o){return new so(oa(),Ml,_l,o)}function Ml(o){if(o===0)return!1;if(o===1)return!0;throw new Error("Invalid bool: "+o)}function _l(o){return o?1:0}var Ar=class extends ia{decode(e,t){return super.decode(e,t)}};function E(o,e,t){return new Ar(o,e,t)}function X(o,e,t){let n,i=typeof e=="number"?e:ua(e)?e.toNumber():new Proxy(e,{get(r,s){if(!n){let a=Reflect.get(r,"count");n=ua(a)?a.toNumber():a,Reflect.set(r,"count",n)}return Reflect.get(r,s)},set(r,s,a){return s==="count"&&(n=a),Reflect.set(r,s,a)}});return sa(o,i,t)}var xn=E([K("mint"),K("owner"),w("amount"),Ge("delegateOption"),K("delegate"),U("state"),Ge("isNativeOption"),w("isNative"),w("delegatedAmount"),Ge("closeAuthorityOption"),K("closeAuthority")]);var _g=se("Raydium_Util");function da({owner:o,solAccountResp:e,tokenAccountResp:t}){let n=[],i=[];for(let{pubkey:r,account:s}of t.value){let a=xn.decode(s.data),{mint:u,amount:c}=a;n.push({publicKey:r,mint:u,amount:c,isAssociated:Pe(o,u,s.owner).publicKey.equals(r),isNative:!1,programId:s.owner}),i.push({pubkey:r,accountInfo:a,programId:s.owner})}return e&&n.push({mint:ma.default,amount:new Vl(e.lamports),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:i}}function et({fromPublicKey:o,programId:e=El}){let t=vl.generate().publicKey.toBase58().slice(0,32);return{publicKey:Fl(o,t,e),seed:t}}function Fl(o,e,t){let n=Buffer.concat([o.toBuffer(),Buffer.from(e),t.toBuffer()]),i=na(n);return new ma(i)}function Pr(o){let{mint:e,tokenAccount:t,owner:n,programId:i=Sn}=o;return Gl(t,e,n,i)}function Nt(o){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:i,programId:r=Sn}=o;return Ul(e,t,i,n,r)}async function Mt(o){let{connection:e,amount:t,commitment:n,payer:i,owner:r,skipCloseAccount:s}=o,a=await e.getMinimumBalanceForRentExemption(xn.span,n),u=j(t).add(new ql(a)),c=et({fromPublicKey:i,programId:Sn});return{addresses:{newAccount:c.publicKey},signers:[],instructions:[Wl.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:c.seed,newAccountPubkey:c.publicKey,lamports:u.toNumber(),space:xn.span,programId:Sn}),Pr({mint:new Dl(De.address),tokenAccount:c.publicKey,owner:r,programId:Sn})],instructionTypes:[V.CreateAccount,V.InitAccount],endInstructionTypes:s?[]:[V.CloseAccount],endInstructions:s?[]:[Nt({tokenAccount:c.publicKey,payer:i,owner:r})]}}function pa({source:o,destination:e,owner:t,amount:n,multiSigners:i=[],tokenProgram:r=Sn}){return Xl(o,e,t,BigInt(String(n)),i,r)}var $n=class extends Ie{constructor(t){super(t);this._tokenAccounts=[];this._tokenAccountRawInfos=[];this._accountListener=[];this._clientOwnedToken=!1;this._accountFetchTime=0;let{tokenAccounts:n,tokenAccountRawInfos:i}=t;this._tokenAccounts=n||[],this._tokenAccountRawInfos=i||[],this._clientOwnedToken=!!(n||i)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}updateTokenAccount({tokenAccounts:t,tokenAccountRawInfos:n}){return t&&(this._tokenAccounts=t),n&&(this._tokenAccountRawInfos=n),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(t){return this._accountListener.push(t),this}removeAccountChangeListener(t){return this._accountListener=this._accountListener.filter(n=>n!==t),this}getAssociatedTokenAccount(t,n){return Pe(this.scope.ownerPubKey,t,n).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(t){if(this._clientOwnedToken||!(t!=null&&t.forceUpdate)&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<1e3*60*3)return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let i=R(R({},{}),t),[r,s,a]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Zt},i.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Ql},i.commitment)]),{tokenAccounts:u,tokenAccountRawInfos:c}=da({owner:this.scope.ownerPubKey,solAccountResp:r,tokenAccountResp:{context:s.context,value:[...s.value,...a.value]}});return this._tokenAccounts=u,this._tokenAccountRawInfos=c,this._accountFetchTime=Date.now(),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>this.fetchWalletTokenAccounts({forceUpdate:!0}),t==null?void 0:t.commitment),{tokenAccounts:u,tokenAccountRawInfos:c}}async getCreatedTokenAccount({mint:t,programId:n=Zt,associatedOnly:i=!0}){await this.fetchWalletTokenAccounts();let r=this._tokenAccounts.filter(({mint:a})=>a==null?void 0:a.equals(t)).sort((a,u)=>a.amount.lt(u.amount)?1:-1),s=this.getAssociatedTokenAccount(t,n);for(let a of r){let{publicKey:u}=a;if(u&&(!i||i&&s.equals(u)))return u}}async getOrCreateTokenAccount(t){var y,f,b,g;await this.fetchWalletTokenAccounts();let{mint:n,createInfo:i,associatedOnly:r,owner:s,notUseTokenAccount:a=!1,skipCloseAccount:u=!1,checkCreateATAOwner:c=!1}=t,l=new ao(t.tokenProgram||Zt),m=this.getAssociatedTokenAccount(n,new ao(l)),d=(a?[]:this.tokenAccountRawInfos).filter(P=>P.accountInfo.mint.equals(n)&&(!r||P.pubkey.equals(m))).sort((P,A)=>P.accountInfo.amount.lt(A.accountInfo.amount)?1:-1);if(i===void 0||d.length>0)return d.length>0?{account:d[0].pubkey}:{};let p={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(r){let P=hr(s,m,s,n,l);if(c){let A=await this.scope.connection.getAccountInfo(m);if(A===null)(y=p.instructions)==null||y.push(P),p.instructionTypes.push(V.CreateATA);else if(!(A.owner.equals(l)&&Kn.decode(A.data).mint.equals(n)&&Kn.decode(A.data).owner.equals(s)))throw Error(`create ata check error -> mint: ${n.toString()}, ata: ${m.toString()}`)}else p.instructions.push(P),p.instructionTypes.push(V.CreateATA);if(n.equals(z)&&i.amount){let A=await Mt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:i.payer||this.scope.ownerPubKey,amount:(f=i.amount)!=null?f:0,skipCloseAccount:u});p.instructions.push(...A.instructions||[]),p.endInstructions.push(...A.endInstructions||[]),p.instructionTypes.push(...A.instructionTypes||[]),p.endInstructionTypes.push(...A.endInstructionTypes||[]),i.amount&&(p.instructions.push(pa({source:A.addresses.newAccount,destination:m,owner:this.scope.ownerPubKey,amount:i.amount,tokenProgram:Zt})),p.instructionTypes.push(V.TransferAmount))}return u||(p.endInstructions.push(Nt({owner:s,payer:i.payer||s,tokenAccount:m,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:m,instructionParams:p}}else{let P=et({fromPublicKey:s,programId:l}),A=await this.scope.connection.getMinimumBalanceForRentExemption(Kn.span),h=zl.createAccountWithSeed({fromPubkey:s,basePubkey:s,seed:P.seed,newAccountPubkey:P.publicKey,lamports:A+Number((g=(b=i.amount)==null?void 0:b.toString())!=null?g:0),space:Kn.span,programId:l});return p.instructions.push(h,Pr({mint:n,tokenAccount:P.publicKey,owner:this.scope.ownerPubKey,programId:l})),p.instructionTypes.push(V.CreateAccount),p.instructionTypes.push(V.InitAccount),u||(p.endInstructions.push(Nt({owner:s,payer:i.payer||s,tokenAccount:P.publicKey,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:P.publicKey,instructionParams:p}}}async checkOrCreateAta({mint:t,programId:n=Zt,autoUnwrapWSOLToSOL:i}){var u;await this.fetchWalletTokenAccounts();let r=(u=this.scope.account.tokenAccounts.find(({mint:c})=>(c==null?void 0:c.toBase58())===t.toBase58()))==null?void 0:u.publicKey,s=this.scope.ownerPubKey,a={};if(!r){let c=this.getAssociatedTokenAccount(t,n),l=await hr(s,c,s,t,n);a.instructions=[l],a.instructionTypes=[V.CreateATA],r=c}return i&&z.toBase58()===t.toBase58()&&(a.endInstructions=[Nt({owner:s,payer:s,tokenAccount:r,programId:n})],a.endInstructionTypes=[V.CloseAccount]),{pubKey:r,newInstructions:a}}async handleTokenAccount(t){let{side:n,amount:i,mint:r,programId:s=Zt,tokenAccount:a,payer:u=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:l,checkCreateATAOwner:m}=t,d=this.getAssociatedTokenAccount(r,s);if(new ao(z).equals(r)){let p=await Mt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:u,amount:i,skipCloseAccount:l});return R({tokenAccount:p.addresses.newAccount},p)}else if(!a||n==="out"&&!d.equals(a)&&!c){let p=[],y=hr(this.scope.ownerPubKey,d,this.scope.ownerPubKey,r,s);if(m){let f=await this.scope.connection.getAccountInfo(d);if(f===null)p.push(y);else if(!(f.owner.equals(Zt)&&Kn.decode(f.data).mint.equals(r)&&Kn.decode(f.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${r.toString()}, ata: ${d.toString()}`)}else p.push(y);return{tokenAccount:d,instructions:p,instructionTypes:[V.CreateATA]}}return{tokenAccount:a}}async processTokenAccount(t){let{mint:n,programId:i=Zt,amount:r,useSOLBalance:s,handleTokenAccount:a}=t,u,c=this.createTxBuilder();if(n.equals(new ao(z))&&s){let l=await this.handleTokenAccount({side:"in",amount:r||0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:d}=l,p=Ce(l,["tokenAccount"]);u=d,c.addInstruction(p)}else if(u=await this.getCreatedTokenAccount({mint:n,associatedOnly:!1,programId:i}),!u&&a){let m=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:n,bypassAssociatedCheck:!0,programId:i}),{tokenAccount:d}=m,p=Ce(m,["tokenAccount"]);u=d,c.addInstruction(p)}return R({tokenAccount:u},c.AllTxData)}};import{PublicKey as ge,SystemProgram as lm}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as mm}from"@solana/spl-token";import{PublicKey as ba}from"@solana/web3.js";var kr=E([U("instruction")]),Tr=E([U("instruction")]),Yl=E([w("rewardState"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardLastUpdateTime"),w("totalReward"),w("totalRewardEmissioned"),w("rewardClaimed"),w("rewardPerSecond"),$("accRewardPerShare"),K("rewardVault"),K("rewardMint"),K("rewardSender"),w("rewardType"),X(w(),15,"padding")]),jl=E([w("state"),w("nonce"),K("lpVault"),K("rewardVault"),K(),K(),w(),w(),w("totalReward"),$("perShareReward"),w("lastSlot"),w("perSlotReward")]),Hl=E([w("state"),w("nonce"),K("lpVault"),K("rewardVaultA"),w("totalRewardA"),$("perShareRewardA"),w("perSlotRewardA"),U("option"),K("rewardVaultB"),be(7),w("totalRewardB"),$("perShareRewardB"),w("perSlotRewardB"),w("lastSlot"),K()]),Zl=E([w(),w("state"),w("nonce"),w("validRewardTokenNum"),$("rewardMultiplier"),w("rewardPeriodMax"),w("rewardPeriodMin"),w("rewardPeriodExtend"),K("lpMint"),K("lpVault"),X(Yl,5,"rewardInfos"),K("creator"),K(),X(w(),32,"padding")]),$l=new Proxy(jl,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return F(R({},i),{version:3,rewardInfos:[{rewardVault:i.rewardVault,totalReward:i.totalReward,perSlotReward:i.perSlotReward,perShareReward:i.perShareReward}]})}:Reflect.get(o,e,t)}}),Jl=new Proxy(Hl,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return F(R({},i),{version:5,rewardInfos:[{rewardVault:i.rewardVaultA,totalReward:i.totalRewardA,perSlotReward:i.perSlotRewardA,perShareReward:i.perShareRewardA},{rewardVault:i.rewardVaultB,totalReward:i.totalRewardB,perSlotReward:i.perSlotRewardB,perShareReward:i.perShareRewardB}]})}:Reflect.get(o,e,t)}}),uo=new Proxy(Zl,{get(o,e,t){return e==="decode"?(...n)=>{let i=o.decode(...n);return F(R({},i),{version:6,rewardInfos:i.rewardInfos.map(r=>{var s;return F(R({},r),{rewardType:((s=Object.entries($t).find(a=>String(a[1])===r.rewardType.toString()))!=null?s:["Standard SPL"])[0]})})})}:Reflect.get(o,e,t)}}),em=E([w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),Ir=E([U("instruction"),w("nonce"),X(em,5,"rewardTimeInfo")]),Br=E([U("instruction"),w("rewardReopenTime"),w("rewardEndTime"),w("rewardPerSecond")]),xr=E([U("instruction"),w("isSet"),w("rewardPerSecond"),w("rewardOpenTime"),w("rewardEndTime"),w("rewardType")]),pw=E([w("state"),K("id"),K("owner"),w("deposited"),X(w(),1,"rewardDebts")]),Sr=E([w("state"),K("id"),K("owner"),w("deposited"),X($(),1,"rewardDebts"),w(""),w("voteLockedBalance"),X(w(),15)]),fw=E([w("state"),K("id"),K("owner"),w("deposited"),X(w(),2,"rewardDebts")]),fa=E([w("state"),K("id"),K("owner"),w("deposited"),X($(),2,"rewardDebts"),X(w(),17)]),ya=E([w(),w("state"),K("id"),K("owner"),w("deposited"),X($(),5,"rewardDebts"),X(w(),16)]),rt=E([U("instruction"),w("amount")]),tm=E([K("mint"),K("grantAuthority"),w("baselineVoteWeightScaledFactor"),w("maxExtraLockupVoteWeightScaledFactor"),w("lockupSaturationSecs"),ca("digitShift"),X(U(),7,"reserved1"),X(w(),7,"reserved2")]),nm=E([be(8),K("governanceProgramId"),K("realm"),K("realmGoverningTokenMint"),K("realmAuthority"),X(U(),32,"reserved1"),X(tm,4,"votingMints"),Bn("timeOffset"),U("bump"),X(U(),7,"reserved2"),X(w(),11,"reserved3")]),im=E([Bn("startTime"),Bn("endTime"),U("kind"),X(U(),15,"reserved")]),om=E([X(im,1,"lockup"),w("amountDeposited_native"),w("amountInitiallyLockedNative"),Xe("isUsed"),Xe("allowClawback"),U("votingMintConfigIdx"),X(U(),29,"reserved")]),rm=E([be(8),K("voterAuthority"),K("registrar"),X(om,32,"deposits"),U("voterBump"),U("voterWweightRecordBump"),X(U(),94,"reserved")]);var kw=se("Raydium_farm_config"),ga=new ba("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),wa=new ba("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1");var Aa={3:Sr,5:fa,6:ya},Kr=o=>[3,5,6].indexOf(o)!==-1,Cr=o=>{var s;let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=o,i=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`,r={3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${i}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${i}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${i}`}};return(s=r[e])==null?void 0:s.call(r)},$t={"Standard SPL":0,"Option tokens":1},lt={[Us.toString()]:3,[Gs.toString()]:5,[Gn.toString()]:6};import{PublicKey as me,SystemProgram as ka,SYSVAR_CLOCK_PUBKEY as co,SYSVAR_RENT_PUBKEY as um,TransactionInstruction as It}from"@solana/web3.js";import Ta from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as eA,createAssociatedTokenAccountInstruction as tA,TOKEN_PROGRAM_ID as Jt}from"@solana/spl-token";import sm from"bn.js";var am=se("Raydium.farm.util");function Jn({programId:o,poolId:e,mint:t,type:n}){let{publicKey:i}=ce([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],o);return i}function mt({programId:o,poolId:e,owner:t,version:n}){let{publicKey:i}=ce([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],o);return i}var Pa=({programId:o,poolId:e})=>ce([e.toBuffer()],o);function ha(o){return{isSet:new sm(1),rewardPerSecond:j(o.perSecond),rewardOpenTime:j(o.openTime),rewardEndTime:j(o.endTime),rewardType:j($t[o.rewardType])}}function Rr(o){return j(o.endTime).sub(j(o.openTime)).mul(j(o.perSecond))}function ei(o){let e=Aa[o];return e||am.logWithError("invalid version",o),e}var cm=se("Raydium_farm_instruction"),dA={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function ti(o){let{version:e,id:t,ledger:n,programId:i,owner:r}=o,s={3:9,5:10}[e];s||cm.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(kr.span);kr.encode({instruction:s},a);let u=[k({pubkey:t}),k({pubkey:n}),k({pubkey:r,isWritable:!1}),k({pubkey:ka.programId,isWritable:!1}),k({pubkey:um,isWritable:!1})];return{instruction:new It({programId:i,keys:u,data:a}),instructionType:V.FarmV3CreateLedger}}function Ia(o){var n;let e=Buffer.alloc(Ir.span);Ir.encode({instruction:0,nonce:new Ta(o.nonce),rewardTimeInfo:o.rewardInfoConfig},e);let t=[...Zo,k({pubkey:o.farmId}),k({pubkey:o.farmAuthority,isWritable:!1}),k({pubkey:o.lpVault}),k({pubkey:o.lpMint,isWritable:!1}),k({pubkey:o.lockVault}),k({pubkey:o.lockMint,isWritable:!1}),k({pubkey:(n=o.lockUserAccount)!=null?n:Ne}),k({pubkey:o.owner,isWritable:!1,isSigner:!0})];for(let i of o.rewardInfo)t.push(k({pubkey:i.rewardMint,isWritable:!1}),k({pubkey:i.rewardVault}),k({pubkey:i.userRewardToken}));return{instruction:new It({programId:o.programId,keys:t,data:e}),instructionType:V.FarmV6Create}}function Ba(o){let e=Buffer.alloc(Tr.span);Tr.encode({instruction:5},e);let t=[k({pubkey:Jt,isWritable:!1}),k({pubkey:o.id}),k({pubkey:o.authority,isWritable:!1}),k({pubkey:o.lpVault,isWritable:!1}),k({pubkey:o.rewardVault}),k({pubkey:o.userRewardToken}),k({pubkey:o.owner,isWritable:!1,isSigner:!0})];return{instruction:new It({programId:o.programId,keys:t,data:e}),instructionType:V.FarmV6CreatorWithdraw}}function Lr({payer:o,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:i}){let r=Buffer.alloc(Br.span);Br.encode({instruction:3,rewardReopenTime:j(i.openTime),rewardEndTime:j(i.endTime),rewardPerSecond:j(i.perSecond)},r);let s=[k({pubkey:Jt,isWritable:!1}),k({pubkey:n.id}),k({pubkey:n.lpVault,isWritable:!1}),k({pubkey:e}),k({pubkey:t}),k({pubkey:o,isWritable:!1,isSigner:!0})];return new It({programId:n.programId,keys:s,data:r})}function Or({payer:o,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:i}){let r=Buffer.alloc(xr.span);xr.encode({instruction:4,isSet:new Ta(1),rewardPerSecond:j(i.perSecond),rewardOpenTime:j(i.openTime),rewardEndTime:j(i.endTime),rewardType:j($t[i.rewardType])},r);let s=[...Zo,k({pubkey:t.id}),k({pubkey:t.authority,isWritable:!1}),k({pubkey:i.mint,isWritable:!1}),k({pubkey:n}),k({pubkey:e}),k({pubkey:o,isWritable:!1,isSigner:!0})];return new It({programId:t.programId,keys:s,data:r})}function ni(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s}=o,[a,u]=[new me(e.programId),new me(e.id)],c=mt({programId:a,poolId:u,owner:r,version:6}),l=Buffer.alloc(rt.span);rt.encode({instruction:2,amount:j(s)},l);let m=[k({pubkey:Jt,isWritable:!1}),k({pubkey:u}),k({pubkey:new me(t.authority),isWritable:!1}),k({pubkey:new me(t.lpVault)}),k({pubkey:c}),k({pubkey:r,isWritable:!1,isSigner:!0}),k({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(k({pubkey:new me(t.rewardInfos[d].vault)})),m.push(k({pubkey:i[d]}));return new It({programId:a,keys:m,data:l})}function ii(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new me(e.programId),new me(e.id)],l=mt({programId:u,poolId:c,owner:r,version:5}),m=Buffer.alloc(rt.span);rt.encode({instruction:12,amount:j(s)},m);let d=[k({pubkey:c}),k({pubkey:new me(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:r,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new me(t.lpVault)}),k({pubkey:i[0]}),k({pubkey:new me(t.rewardInfos[0].vault)}),k({pubkey:co,isWritable:!1}),k({pubkey:Jt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(k({pubkey:i[p]})),d.push(k({pubkey:new me(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(k({pubkey:p}));return new It({programId:u,keys:d,data:m})}function oi(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new me(e.programId),new me(e.id)],l=mt({programId:u,poolId:c,owner:r,version:3}),m=Buffer.alloc(rt.span);rt.encode({instruction:11,amount:j(s)},m);let d=[k({pubkey:c}),k({pubkey:new me(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:r,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new me(t.lpVault)}),k({pubkey:i[0]}),k({pubkey:new me(t.rewardInfos[0].vault)}),k({pubkey:co,isWritable:!1}),k({pubkey:Jt,isWritable:!1})];if(a)for(let p of a)d.push(k({pubkey:p}));return new It({programId:u,keys:d,data:m})}function xa(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new me(e.programId),new me(e.id)],l=mt({programId:u,poolId:c,owner:r,version:3}),m=Buffer.alloc(rt.span);rt.encode({instruction:10,amount:j(s)},m);let d=[k({pubkey:c}),k({pubkey:new me(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:r,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new me(t.lpVault)}),k({pubkey:i[0]}),k({pubkey:new me(t.rewardInfos[0].vault)}),k({pubkey:co,isWritable:!1}),k({pubkey:Jt,isWritable:!1})];if(a)for(let p of a)d.push(k({pubkey:p}));return new It({programId:u,keys:d,data:m})}function Sa(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s,userAuxiliaryLedgers:a}=o,[u,c]=[new me(e.programId),new me(e.id)],l=mt({programId:u,poolId:c,owner:r,version:5}),m=Buffer.alloc(rt.span);rt.encode({instruction:11,amount:j(s)},m);let d=[k({pubkey:c}),k({pubkey:new me(t.authority),isWritable:!1}),k({pubkey:l}),k({pubkey:r,isWritable:!1,isSigner:!0}),k({pubkey:n}),k({pubkey:new me(t.lpVault)}),k({pubkey:i[0]}),k({pubkey:new me(t.rewardInfos[0].vault)}),k({pubkey:co,isWritable:!1}),k({pubkey:Jt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(k({pubkey:i[p]})),d.push(k({pubkey:new me(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(k({pubkey:p}));return new It({programId:u,keys:d,data:m})}function Ka(o){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:r,amount:s}=o,[a,u]=[new me(e.programId),new me(e.id)],c=mt({programId:a,poolId:u,owner:r,version:6}),l=Buffer.alloc(rt.span);rt.encode({instruction:1,amount:j(s)},l);let m=[k({pubkey:Jt,isWritable:!1}),k({pubkey:ka.programId,isWritable:!1}),k({pubkey:u}),k({pubkey:new me(t.authority),isWritable:!1}),k({pubkey:new me(t.lpVault)}),k({pubkey:c}),k({pubkey:r,isWritable:!1,isSigner:!0}),k({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(k({pubkey:new me(t.rewardInfos[d].vault)})),m.push(k({pubkey:i[d]}));return new It({programId:a,keys:m,data:l})}var ri=class extends Ie{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(Ne)){let n=await Mt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:Rr(F(R({},t),{openTime:t.openTime.toString(),endTime:t.endTime.toString()}))});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:i=Gn,txVersion:r}){this.checkDisabled(),this.scope.checkOwner();let a={lpMint:new ge(e.lpMint.address),lockInfo:{lockMint:ga,lockVault:wa},version:6,rewardInfos:t,programId:i},u=this.createTxBuilder(),c=n!=null?n:this.scope.ownerPubKey,l=et({fromPublicKey:c,programId:a.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(uo.span);u.addInstruction({instructions:[lm.createAccountWithSeed({fromPubkey:c,basePubkey:c,seed:l.seed,newAccountPubkey:l.publicKey,lamports:m,space:uo.span,programId:a.programId})]});let{publicKey:d,nonce:p}=Pa({programId:new ge(a.programId),poolId:l.publicKey}),y=Jn({programId:a.programId,poolId:l.publicKey,mint:a.lpMint,type:"lpVault"}),f=[],b=[];for(let I of a.rewardInfos){I.openTime>=I.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",I.openTime.toString()),isNaN($t[I.rewardType])&&this.logAndCreateError("rewardType error",I.rewardType),Number(I.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",I.perSecond),f.push(ha(I));let{rewardPubKey:T,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:I,payer:c});S&&u.addInstruction(S),T||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let B=I.mint.equals(Ne)?new ge(De.address):I.mint;b.push({rewardMint:B,rewardVault:Jn({programId:a.programId,poolId:l.publicKey,mint:B,type:"rewardVault"}),userRewardToken:T})}let{account:g,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({mint:new ge(a.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});P&&u.addInstruction(P),g||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:A,instructionType:h}=Ia({farmId:l.publicKey,owner:this.scope.ownerPubKey,farmAuthority:d,lpVault:y,lpMint:a.lpMint,lockVault:a.lockInfo.lockVault,lockMint:a.lockInfo.lockMint,lockUserAccount:g,programId:a.programId,rewardInfo:b,rewardInfoConfig:f,nonce:p});return u.addInstruction({instructions:[A],instructionTypes:[h]}).versionBuild({txVersion:r,extInfo:{farmId:l.publicKey,farmAuthority:d,lpVault:y,lockUserAccount:g,nonce:p}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:i}){var b;let r=lt[e.programId];r!==6&&this.logAndCreateError("invalid farm version ",r);let s=We((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,c=n.mint.equals(Ne)?new ge(De.address):n.mint,l=a.rewardInfos.findIndex(g=>new ge(g.mint.address).equals(c)),m=s.rewardInfos[l];m||this.logAndCreateError("configuration does not exist","rewardMint",c);let d=(b=m.vault)!=null?b:Ne,p=this.createTxBuilder(),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return f&&p.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),p.addInstruction({instructions:[Lr({payer:this.scope.ownerPubKey,rewardVault:d,userRewardTokenPub:y,farmKeys:a,rewardInfo:n})],instructionTypes:[V.FarmV6Restart]}).versionBuild({txVersion:i})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:i}){var l;let r=lt[e.programId];r!==6&&this.logAndCreateError("invalid farm version ",r);let s=We((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),a={id:s.id,rewardInfos:e.rewardInfos,lpVault:s.lpVault,programId:s.programId};n.forEach(m=>{m.openTime>=m.endTime&&this.logAndCreateError("start time error","newRewardInfo",m)});let u=t||this.scope.ownerPubKey,c=this.createTxBuilder();for(let m of n){let d=m.mint.equals(Ne)?new ge(De.address):m.mint,p=a.rewardInfos.findIndex(A=>new ge(A.mint.address).equals(d)),y=s.rewardInfos[p];y||this.logAndCreateError("configuration does not exist","rewardMint",d);let f=(l=y.vault)!=null?l:Ne,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:m,payer:u});g&&c.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let P=Lr({payer:this.scope.ownerPubKey,rewardVault:f,userRewardTokenPub:b,farmKeys:a,rewardInfo:m});c.addInstruction({instructions:[P],instructionTypes:[V.FarmV6Restart]})}return c.versionBuild({txVersion:i})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:i,payer:r}=e,s=lt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=We((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r!=null?r:this.scope.ownerPubKey,c=this.createTxBuilder(),l=i.mint.equals(Ne)?new ge(De.address):i.mint,m=Jn({programId:new ge(n.programId),poolId:new ge(n.id),mint:l,type:"rewardVault"}),{rewardPubKey:d,newInstruction:p}=await this._getUserRewardInfo({rewardInfo:i,payer:u});return p&&c.addInstruction(p),d||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),i.mint=l,c.addInstruction({instructions:[Or({payer:this.scope.ownerPubKey,userRewardTokenPub:d,farmKeys:a,rewardVault:m,rewardInfo:i})],instructionTypes:[V.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:i,payer:r}=e,s=lt[n.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=We((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r!=null?r:this.scope.ownerPubKey,c=this.createTxBuilder();for(let l of i){let m=l.mint.equals(Ne)?new ge(De.address):l.mint,d=Jn({programId:new ge(n.programId),poolId:new ge(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:l,payer:u});y&&c.addInstruction(y),p||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let f=Or({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:a,rewardVault:d,rewardInfo:F(R({},l),{mint:m})});c.addInstruction({instructions:[f],instructionTypes:[V.FarmV6CreatorAddReward]})}return c.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:i,feePayer:r,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:c,computeBudgetConfig:l}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:d}=n,p=lt[d];Kr(p)||this.logAndCreateError("invalid farm program:",n.programId);let[y,f]=[new ge(n.programId),new ge(n.id)],b=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],g=mt({programId:y,poolId:f,owner:this.scope.ownerPubKey,version:p}),P=this.createTxBuilder();P.addCustomComputeBudget(l);let A={};for(let N of this.scope.account.tokenAccounts)if(a){let Z=Pe(this.scope.ownerPubKey,N.mint,N.programId).publicKey;N.publicKey&&Z.equals(N.publicKey)&&(A[N.mint.toString()]=N.publicKey)}else A[N.mint.toString()]=N.publicKey;let h=b.lpMint,I=A[h.address];I||this.logAndCreateError("you don't have any lp","lp zero",A);let T=[];for(let N of m){let Z=s&&N.mint.address===z.toString(),G=A[N.mint.address];if(!G){let{account:D,instructionParams:je}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:N.mint.programId,mint:new ge(N.mint.address),notUseTokenAccount:Z,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!Z,associatedOnly:Z?!1:a,checkCreateATAOwner:u});G=D,je&&P.addInstruction(je)}A[N.mint.address]=G,T.push(G)}let S,B=await this.scope.connection.getAccountInfo(g);if(B&&(S=ei(p).decode(B.data)),n.programId!==Gn.toString()&&!S){let{instruction:N,instructionType:Z}=ti({id:f,programId:y,version:p,ledger:g,owner:this.scope.ownerPubKey});P.addInstruction({instructions:[N],instructionTypes:[Z]})}let C=Cr({version:p,rewardInfos:m,rewardTokenAccountsPublicKeys:T});C&&this.logAndCreateError(C);let x={amount:j(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:b,lpAccount:I,rewardAccounts:T,userAuxiliaryLedgers:c==null?void 0:c.map(N=>new ge(N))},L=p===6?Ka(x):p===5?Sa(x):xa(x),W={3:V.FarmV3Deposit,5:V.FarmV5Deposit,6:V.FarmV6Deposit};return P.addInstruction({instructions:[L],instructionTypes:[W[p]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:i,deposited:r,useSOLBalance:s,feePayer:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m}=e,{rewardInfos:d}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let p=lt[n.programId];Kr(p)||this.logAndCreateError("invalid farm program:",n.programId);let y=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],f=this.createTxBuilder();f.addCustomComputeBudget(m);let b={};for(let C of this.scope.account.tokenAccounts)if(u){let x=Pe(this.scope.ownerPubKey,C.mint).publicKey;C.publicKey&&x.equals(C.publicKey)&&(b[C.mint.toString()]=C.publicKey)}else b[C.mint.toString()]=C.publicKey;if(r)r.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else{let C=mt({programId:new ge(n.programId),poolId:new ge(n.id),owner:this.scope.ownerPubKey,version:p}),x=await this.scope.connection.getAccountInfo(C);if(x)ei(p).decode(x.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(p!==6&&(l||[]).length>0){let{instruction:L,instructionType:W}=ti({id:new ge(y.id),programId:new ge(y.programId),version:p,ledger:C,owner:this.scope.ownerPubKey});f.addInstruction({instructions:[L],instructionTypes:[W]})}else this.logAndCreateError("no lp data",{farmId:n.id,version:p,ledgerData:x})}let g=y.lpMint.address,P=s&&g===z.toString(),A=b[g.toString()];if(!A){let{account:C,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.lpMint.programId,mint:new ge(g),notUseTokenAccount:P,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:P?!1:u,checkCreateATAOwner:c});A=C,x&&f.addInstruction(x)}b[g.toString()]=A;let h=[];for(let C of d){let x=s&&C.mint.address===z.toString(),L=b[C.mint.address];if(!L){let{account:W,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:C.mint.programId,mint:new ge(C.mint.address),notUseTokenAccount:x,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!x,associatedOnly:x?!1:u,checkCreateATAOwner:c});L=W,N&&f.addInstruction(N)}b[C.mint.address]=L,h.push(L)}let I=Cr({version:p,rewardInfos:d,rewardTokenAccountsPublicKeys:h});I&&this.logAndCreateError(I);let T={amount:j(i),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:y,lpAccount:A,rewardAccounts:h,userAuxiliaryLedgers:l==null?void 0:l.map(C=>new ge(C))},S=p===6?ni(T):p===5?ii(T):oi(T),B={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};return f.addInstruction({instructions:[S],instructionTypes:[B[p]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n}){var p;this.scope.checkOwner();let i=We((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),r=lt[e.programId];r!==6&&this.logAndCreateError("invalid farm version",r);let s=e.rewardInfos.findIndex(y=>y.mint.address===Ne.toString()?new ge(De.address):t),a=i.rewardInfos[s];a||this.logAndCreateError("withdraw mint error","rewardInfos",e);let u=(p=a==null?void 0:a.vault)!=null?p:Ne,c=this.createTxBuilder(),l;if(t.equals(Ne)){let y=await Mt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:Rr(F(R({},a),{openTime:a.openTime,endTime:a.endTime,perSecond:new O(a.perSecond).mul(10**a.mint.decimals).toString()}))});l=y.addresses.newAccount,c.addInstruction(y)}else{let y=await this.scope.account.getCreatedTokenAccount({mint:t});y===null?(l=await this.scope.account.getAssociatedTokenAccount(t),c.addInstruction({instructions:[mm(this.scope.ownerPubKey,l,this.scope.ownerPubKey,t)],instructionTypes:[V.CreateATA]})):l=y}let{instruction:m,instructionType:d}=Ba({programId:i.programId,id:i.id,authority:i.authority,lpVault:i.lpVault,rewardVault:u,userRewardToken:l,owner:this.scope.ownerPubKey});return c.addInstruction({instructions:[m],instructionTypes:[d]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:u,computeBudgetConfig:c}=e,l=this.createTxBuilder(),m={};for(let y of this.scope.account.tokenAccounts)if(r){let f=Pe(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(m[y.mint.toString()]=y.publicKey)}else m[y.mint.toString()]=y.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>F(R({},y),{[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:g,id:P}=y,A=lt[f],h=b.address,I=n&&h===z.toString(),T=m[h];if(!T){let{account:W,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new ge(h),notUseTokenAccount:I,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:I?!1:r,checkCreateATAOwner:s});T=W,N&&l.addInstruction(N)}m[h.toString()]=T;let S=[];for(let W of g){let N=n&&W.mint.address===z.toString(),Z=m[W.mint.address];if(!Z){let{account:G,instructionParams:D}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:W.mint.programId,mint:new ge(W.mint.address),notUseTokenAccount:N,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!N,associatedOnly:N?!1:r,checkCreateATAOwner:s});Z=G,D&&l.addInstruction(D)}m[W.mint.address]=Z,S.push(Z)}let B=p[P],C={amount:ct,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:B,lpAccount:T,rewardAccounts:S,userAuxiliaryLedgers:a==null?void 0:a.map(W=>new ge(W))},x=A===6?ni(C):A===5?ii(C):oi(C),L={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};l.addInstruction({instructions:[x],instructionTypes:[L[A]]})}return u===1?l.sizeCheckBuild({computeBudgetConfig:c}):l.sizeCheckBuildV0({computeBudgetConfig:c})}};import{PublicKey as Qe}from"@solana/web3.js";import{AccountLayout as Zm,NATIVE_MINT as uu,TOKEN_PROGRAM_ID as On}from"@solana/spl-token";import{Keypair as Wr,PublicKey as q,SystemProgram as Cn,TransactionInstruction as ut}from"@solana/web3.js";import Qa from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ya,TOKEN_2022_PROGRAM_ID as Vt,TOKEN_PROGRAM_ID as Le}from"@solana/spl-token";import km from"bn.js";import dt from"bn.js";var Be=new dt(0),st=new dt(1),_t=new dt(-1),at=new dt(1).shln(64),lo=new dt(1).shln(128),Nr=at.sub(st),si=64,Ca=lo.subn(1),ze=-443636,He=-ze,pt=new dt("4295048016"),ft=new dt("79226673521066979257578248091"),mo=new dt("4295048017"),po=new dt("79226673521066979257578248090"),Ra=16,La="59543866431248",Oa="184467440737095516",Na="15793534762490258745",fo=new dt(10).pow(new dt(6));var Ma={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},UA=new dt("18446744073700000000");import re from"bn.js";function yo(o){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,o,!1),new Uint8Array(e)}function Mr(o,e){let t=0;for(let n=o-1;n>=0&&!e.testn(n);n--)t++;return t}function _r(o,e){let t=0;for(let n=0;n<o&&!e.testn(n);n++)t++;return t}function ai(o,e){for(let t=0;t<o;t++)if(e.testn(t))return!1;return!0}function _a(o,e){return ai(o,e)?null:Mr(o,e)}function va(o,e){return ai(o,e)?null:_r(o,e)}var jA=Buffer.from("amm_config","utf8"),dm=Buffer.from("pool","utf8"),pm=Buffer.from("pool_vault","utf8"),fm=Buffer.from("pool_reward_vault","utf8"),Va=Buffer.from("position","utf8"),ym=Buffer.from("tick_array","utf8"),bm=Buffer.from("operation","utf8"),gm=Buffer.from("pool_tick_array_bitmap_extension","utf8"),wm=Buffer.from("observation","utf8");function Ea(o,e,t,n){return ce([dm,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function vr(o,e,t){return ce([pm,e.toBuffer(),t.toBuffer()],o)}function Fa(o,e,t){return ce([fm,e.toBuffer(),t.toBuffer()],o)}function pe(o,e,t){return ce([ym,e.toBuffer(),yo(t)],o)}function en(o,e,t,n){return ce([Va,e.toBuffer(),yo(t),yo(n)],o)}function tt(o,e){return ce([Va,e.toBuffer()],o)}function bo(o){return ce([Buffer.from("metadata","utf8"),Tn.toBuffer(),o.toBuffer()],Tn)}function ui(o){return ce([bm],o)}function nt(o,e){return ce([gm,e.toBuffer()],o)}function Da(o,e){return ce([wm,e.toBuffer()],o)}var Am=Buffer.from("locked_position","utf8");function Vr(o,e){return ce([Am,e.toBuffer()],o)}import{PublicKey as Bt}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as Wa}from"@solana/spl-token";import he from"bn.js";import Kt from"bn.js";var ci=class{static getfeeGrowthInside(e,t,n){let i=new Kt(0),r=new Kt(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,r=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),r=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new Kt(0),a=new Kt(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let u=ne.wrappingSubU128(ne.wrappingSubU128(e.feeGrowthGlobalX64A,i),s),c=ne.wrappingSubU128(ne.wrappingSubU128(e.feeGrowthGlobalX64B,r),a);return{feeGrowthInsideX64A:u,feeGrowthInsideBX64:c}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=ne.mulDivFloor(ne.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,at),u=t.tokenFeesOwedA.add(a),c=ne.mulDivFloor(ne.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,at),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,i),a=ne.mulDivFloor(ne.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,at),u=t.tokenFeesOwedA.add(a),c=ne.mulDivFloor(ne.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,at),l=t.tokenFeesOwedB.add(c);return{tokenFeeAmountA:u,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let r=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=ne.wrappingSubU128(u,c.growthInsideLastX64),m=ne.mulDivFloor(l,t.liquidity,at),d=c.rewardAmountOwed.add(m);r.push(d)}return r}static GetPositionRewards(e,t,n,i){let r=[],s=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let a=0;a<s.length;a++){let u=s[a],c=t.rewardInfos[a],l=ne.wrappingSubU128(u,c.growthInsideLastX64),m=ne.mulDivFloor(l,t.liquidity,at),d=c.rewardAmountOwed.add(m);r.push(d)}return r}static getRewardGrowthInside(e,t,n,i){let r=[];for(let s=0;s<i.length;s++){let a=new Kt(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Kt(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ne.wrappingSubU128(ne.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),u))}return r}static getRewardGrowthInsideV2(e,t,n,i){let r=[];for(let s=0;s<i.length;s++){let a=new Kt(0);t.liquidityGross.eqn(0)?a=i[s].rewardGrowthGlobalX64:e<t.tick?a=i[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let u=new Kt(0);n.liquidityGross.eqn(0)||(e<n.tick?u=n.rewardGrowthsOutsideX64[s]:u=i[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ne.wrappingSubU128(ne.wrappingSubU128(i[s].rewardGrowthGlobalX64,a),u))}return r}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:r,epochInfo:s}){var b,g,P,A;let a=te.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),u=te.getSqrtPriceX64FromTick(t.tickLower),c=te.getSqrtPriceX64FromTick(t.tickUpper),l=r?1+i:1-i,m=le.getAmountsFromLiquidity(a,u,c,n,r),[d,p]=[ye(m.amountA,(b=e.mintA.extensions)==null?void 0:b.feeConfig,s,!0),ye(m.amountB,(g=e.mintB.extensions)==null?void 0:g.feeConfig,s,!0)],[y,f]=[ye(new Kt(new O(m.amountA.toString()).mul(l).toFixed(0)),(P=e.mintA.extensions)==null?void 0:P.feeConfig,s,!0),ye(new Kt(new O(m.amountB.toString()).mul(l).toFixed(0)),(A=e.mintB.extensions)==null?void 0:A.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:kt(d.expirationTime,p.expirationTime)}}};var Pm=15,ue=class{static async getTickArrays(e,t,n,i,r,s,a){let u=[],c=Y.getTickArrayStartIndexByTick(i,r),l=Y.getInitializedTickArrayInRange(s,a,r,c,Math.floor(Pm/2));for(let p=0;p<l.length;p++){let{publicKey:y}=pe(t,n,l[p]);u.push(y)}let m=(await bt(e,u)).map(p=>p!==null?li.decode(p.data):null),d={};for(let p=0;p<u.length;p++){let y=m[p];y!==null&&(d[y.startTickIndex]=F(R({},y),{address:u[p]}))}return d}static nextInitializedTick(e,t,n,i,r,s){let{initializedTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}=this.nextInitializedTickInOneArray(e,t,n,i,r,s);for(;a==null||a.liquidityGross.lten(0);){if(c=Y.getNextTickArrayStartIndex(c,r,s),this.checkIsValidStartIndex(c,r))throw new Error("No enough initialized tickArray");let l=n[c];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,u,c]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:u,tickArrayStartTickIndex:c}}static nextInitializedTickArray(e,t,n,i,r){let s=Math.floor(e/ue.tickCount(t)),a=n?Y.searchLowBitFromStart(i,r,s-1,1,t):Y.searchHightBitFromStart(i,r,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let r;if(i){let a=Me-1;for(;a>=0;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){r=u;break}a=a-1}}else{let a=0;for(;a<Me;){let u=n.ticks[a];if(u.liquidityGross.gtn(0)){r=u;break}a=a+1}}let{publicKey:s}=pe(e,t,n.startTickIndex);return{nextTick:r,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,r,s){let a=Y.getTickArrayStartIndexByTick(i,r),u=Math.floor((i-a)/r),c=n[a];if(c==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;u>=0;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u-1}else for(u=u+1;u<Me;){let d=c.ticks[u];if(d.liquidityGross.gtn(0)){l=d;break}u=u+1}let{publicKey:m}=pe(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:c.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(Y.checkIsOutOfBoundary(e)){if(e>He)return!1;let n=Y.getTickArrayStartIndexByTick(ze,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Me*e}};var Er=14,vt=class{static maxTickInTickarrayBitmap(e){return e*Me*sn}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let r=n*i;return e<0?{minValue:-r,maxValue:-r+n}:{minValue:r,maxValue:r+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!ue.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let r=this.maxTickInTickarrayBitmap(n),s=i?t-ue.tickCount(n):t+ue.tickCount(n);if(s<-r||s>=r)return{isInit:!1,tickIndex:t};let a=n*Me,u=s/a+512;s<0&&s%a!=0&&u--;let c=Math.abs(u);if(i){let l=e.shln(1024-c-1),m=_a(1024,l);if(m!==null){let d=(c-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-r}}else{let l=e.shrn(c),m=va(1024,l);if(m!==null){let d=(c+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:r-ue.tickCount(n)}}}},mi=class{static getBitmapOffset(e,t){if(!ue.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=vt.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=vt.maxTickInTickarrayBitmap(e),n=-t;if(He<=t)throw Error(`extensionTickBoundary check error: ${He}, ${t}`);if(n<=ze)throw Error(`extensionTickBoundary check error: ${n}, ${ze}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),r=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:Y.mergeTickArrayBitmap(i).testn(r),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let r=ue.tickCount(t),s=n?e-r:e+r,{tickarrayBitmap:a}=this.getBitmap(s,t,i);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:r,maxValue:s}=vt.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(i){let u=Y.mergeTickArrayBitmap(e).shln(sn-1-a),c=ai(512,u)?null:Mr(512,u);if(c!==null){let l=t-c*ue.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:r}}else{let u=Y.mergeTickArrayBitmap(e).shrn(a),c=ai(512,u)?null:_r(512,u);if(c!==null){let l=t+c*ue.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-ue.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%vt.maxTickInTickarrayBitmap(t),i=Math.floor(n/ue.tickCount(t));return e<0&&n!=0&&(i=sn-i),i}};var xe=class{static getOutputAmountAndRemainAccounts(e,t,n,i,r,s=!1){let a=n.toBase58()===e.mintA.address,u=[],{isExist:c,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!c||l===void 0||!m)throw new Error("Invalid tick array");u.push(m);let{allTrade:d,amountCalculated:p,accounts:y,sqrtPriceX64:f,feeAmount:b}=an.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,l,r,s);return u.push(...y),{allTrade:d,expectedAmountOut:p.mul(_t),remainingAccounts:u,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,i,r){let s=n.toBase58()===e.mintB.address,a=[],{isExist:u,startIndex:c,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!u||c===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=pe(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:y}=an.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(_t),c,r);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=xe.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?mi.checkTickArrayIsInit(ue.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):Y.checkTickArrayIsInitialized(Y.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=pe(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:a}}let{isExist:r,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,ue.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(r){let{publicKey:a}=pe(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/ue.tickCount(e.tickSpacing)),i=t?Y.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):Y.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=ue.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:r}=vt.nextInitializedTickArrayStartIndex(Y.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:r};t=r;let{isInit:s,tickIndex:a}=mi.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<ze||t>He)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:r}){var a,u,c;let s=[];for(let l=0;l<r.length;l++){let m=r[l],d=(c=(a=t.rewardDefaultInfos[l])==null?void 0:a.mint.programId)!=null?c:(u=await e.getAccountInfo(m.tokenMint))==null?void 0:u.owner;if(d===void 0)throw Error("get new reward mint info error");let p=F(R({},m),{perSecond:ne.x64ToDecimal(m.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Bt(d)});if(p.tokenMint.equals(Bt.default))continue;if(n<=p.openTime.toNumber()||i.eq(Be)){s.push(p);continue}let y=new he(Math.min(p.endTime.toNumber(),n)),f=y.sub(p.lastUpdateTime),b=ne.mulDivFloor(f,p.emissionsPerSecondX64,i),g=p.rewardGrowthGlobalX64.add(b),P=ne.mulDivFloor(f,p.emissionsPerSecondX64,at),A=p.rewardTotalEmissioned.add(P);s.push(F(R({},p),{rewardGrowthGlobalX64:g,rewardTotalEmissioned:A,lastUpdateTime:y}))}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let r of t){let s=Y.getTickArrayStartIndexByTick(r,e);if(s>=n||s<i)return!0}return!1}static tickRange(e){let t=vt.maxTickInTickarrayBitmap(e),n=-t;return t>He&&(t=ue.getArrayStartIndex(He,e)+ue.tickCount(e)),n<ze&&(n=ue.getArrayStartIndex(ze,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!ue.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/ue.tickCount(t)*sn}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await _e(e,t.map(s=>({pubkey:s})),{batchRequest:n}),r={};for(let s of i)s.accountInfo!==null&&(r[s.pubkey.toString()]=Ua.decode(s.accountInfo.data));return r}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},r=[];for(let u of t){let c=Y.getTickArrayStartIndexByTick(u.tickCurrent,u.tickSpacing),l=Y.getInitializedTickArrayInRange(u.tickArrayBitmap,u.exBitmapInfo,u.tickSpacing,c,7);for(let m of l){let{publicKey:d}=pe(u.programId,u.id,m);r.push({pubkey:d}),i[d.toString()]=u.id}}let s=await _e(e,r,{batchRequest:n}),a={};for(let u of s){if(!u.accountInfo)continue;let c=i[u.pubkey.toString()];if(!c)continue;a[c.toString()]===void 0&&(a[c.toString()]={});let l=li.decode(u.accountInfo.data);a[c.toString()][l.startTickIndex]=F(R({},l),{address:u.pubkey})}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:r=!0}){var a;let s=[];for(let u=0;u<e.length;u++){let c=e[u];c!==null&&(s.find(l=>l.equals(c.state.programId))||s.push(c.state.programId))}if(n){let u=n.tokenAccounts.map(d=>d.accountInfo.mint),c=[];for(let d of u)for(let p of s)c.push(tt(p,d).publicKey);let l=await bt(t,c,{batchRequest:i}),m={};for(let d of l){if(d===null)continue;let p=go.decode(d.data),y=p.poolId.toString(),f=e.find(B=>B.state.id.toBase58()===y);if(f===void 0)continue;let b=f.state,g=Y._getTickPriceLegacy({poolInfo:b,tick:p.tickLower,baseIn:!0}),P=Y._getTickPriceLegacy({poolInfo:b,tick:p.tickUpper,baseIn:!0}),{amountA:A,amountB:h}=le.getAmountsFromLiquidity(b.sqrtPriceX64,g.tickSqrtPriceX64,P.tickSqrtPriceX64,p.liquidity,!1),I=1/(1-Math.sqrt(Math.sqrt(g.price.div(P.price).toNumber())));f.positionAccount=[...(a=f.positionAccount)!=null?a:[],{poolId:p.poolId,nftMint:p.nftMint,priceLower:g.price,priceUpper:P.price,amountA:A,amountB:h,tickLower:p.tickLower,tickUpper:p.tickUpper,liquidity:p.liquidity,feeGrowthInsideLastX64A:p.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:p.feeGrowthInsideLastX64B,tokenFeesOwedA:p.tokenFeesOwedA,tokenFeesOwedB:p.tokenFeesOwedB,rewardInfos:p.rewardInfos.map(B=>F(R({},B),{pendingReward:new he(0)})),leverage:I,tokenFeeAmountA:new he(0),tokenFeeAmountB:new he(0)}];let T=await Y.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickLower,f.state.tickSpacing),S=await Y.getTickArrayAddressByTick(f.state.programId,p.poolId,p.tickUpper,f.state.tickSpacing);m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickLower}`]=T,m[`${f.state.programId.toString()}-${p.poolId.toString()}-${p.tickUpper}`]=S}if(r){let d=Object.values(m),p=await bt(t,d,{batchRequest:i}),y={};for(let f=0;f<d.length;f++){let b=p[f];if(b===null)continue;let g=d[f].toString();y[g]=li.decode(b.data)}for(let{state:f,positionAccount:b}of e)if(!!b)for(let g of b){let P=`${f.programId.toString()}-${f.id.toString()}-${g.tickLower}`,A=`${f.programId.toString()}-${f.id.toString()}-${g.tickUpper}`,h=y[m[P].toString()],I=y[m[A].toString()],T=h.ticks[Y.getTickOffsetInArray(g.tickLower,f.tickSpacing)],S=I.ticks[Y.getTickOffsetInArray(g.tickUpper,f.tickSpacing)],{tokenFeeAmountA:B,tokenFeeAmountB:C}=await ci.GetPositionFees(f,g,T,S),x=await ci.GetPositionRewards(f,g,T,S);g.tokenFeeAmountA=B.gte(new he(0))?B:new he(0),g.tokenFeeAmountB=C.gte(new he(0))?C:new he(0);for(let L=0;L<x.length;L++)g.rewardInfos[L].pendingReward=x[L].gte(new he(0))?x[L]:new he(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:r,slippage:s,priceLimit:a=new O(0),catchLiquidityInsufficient:u=!1}){var W;let c,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new O(0))?c=l?pt.add(new he(1)):ft.sub(new he(1)):c=te.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=ye(r,m,i,!1),{allTrade:y,expectedAmountOut:f,remainingAccounts:b,executionPrice:g,feeAmount:P}=xe.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub((W=p.fee)!=null?W:Be),c,u),A=ye(f,d,i,!1),h=te.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),I=l?h:new O(1).div(h),T=f.mul(new he(Math.floor((1-s)*1e10))).div(new he(1e10)),S=ye(T,d,i,!1),B=l?e.currentPrice:new O(1).div(e.currentPrice),C=new O(I).sub(B).abs(),x=B,L=new ve(new O(C).mul(10**15).toFixed(0),new O(x).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:p,amountOut:A,minAmountOut:S,expirationTime:kt(p.expirationTime,A.expirationTime),currentPrice:e.currentPrice,executionPrice:I,priceImpact:L,fee:P,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:r,epochInfo:s,catchLiquidityInsufficient:a=!1}){let u=i.address===e.mintB.address,[c,l]=u?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new Te(F(R({},c),{mint:c.address,isToken2022:c.programId===Wa.toBase58()})),new Te(F(R({},l),{mint:l.address,isToken2022:l.programId===Wa.toBase58()}))],{allTrade:p,realAmountIn:y,amountOut:f,minAmountOut:b,expirationTime:g,currentPrice:P,executionPrice:A,priceImpact:h,fee:I,remainingAccounts:T,executionPriceX64:S}=xe.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Bt(c.address),amountIn:n,slippage:r,epochInfo:s,catchLiquidityInsufficient:a}),B=F(R({},y),{amount:new fe(m,y.amount),fee:y.fee===void 0?void 0:new fe(m,y.fee)}),C=F(R({},f),{amount:new fe(d,f.amount),fee:f.fee===void 0?void 0:new fe(d,f.fee)}),x=F(R({},b),{amount:new fe(d,b.amount),fee:b.fee===void 0?void 0:new fe(d,b.fee)}),L=new Je({baseToken:m,denominator:new he(10).pow(new he(20+m.decimals)),quoteToken:d,numerator:P.mul(new O(10**(20+d.decimals))).toFixed(0)}),W=new Je({baseToken:m,denominator:new he(10).pow(new he(20+m.decimals)),quoteToken:d,numerator:A.mul(new O(10**(20+d.decimals))).toFixed(0)}),N=new fe(m,I);return{allTrade:p,realAmountIn:B,amountOut:C,minAmountOut:x,expirationTime:g,currentPrice:L,executionPrice:W,priceImpact:h,fee:N,remainingAccounts:T,executionPriceX64:S}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountOut:r,slippage:s,priceLimit:a=new O(0)}){var x;let u=n.toBase58()===e.mintA.address,c={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new O(0))?l=u?ft.sub(new he(1)):pt.add(new he(1)):l=te.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=ye(r,c[n.toString()],i,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:y,feeAmount:f}=xe.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub((x=m.fee)!=null?x:Be),l),b=u?e.mintB.address:e.mintA.address,g=ye(d,c[b],i,!1),P=te.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),A=u?P:new O(1).div(P),h=d.mul(new he(Math.floor((1+s)*1e10))).div(new he(1e10)),I=ye(h,c[b],i,!0),T=u?e.currentPrice:new O(1).div(e.currentPrice),S=new O(A).sub(T).abs(),B=T,C=new ve(new O(S).mul(10**15).toFixed(0),new O(B).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:I,realAmountOut:m,expirationTime:kt(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:A,priceImpact:C,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){var y,f,b;let r=e[t],s=Y.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=Y.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),u=Math.max(s,r.priceMin),l=Math.min(a,r.priceMax)-u,m=a-s,d=r.priceMax-r.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:r.feeApr*p,rewardsApr:[((y=r.rewardApr[0])!=null?y:0)*p,((f=r.rewardApr[1])!=null?f:0)*p,((b=r.rewardApr[2])!=null?b:0)*p],apr:r.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:r,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:u}){let c=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[ot(e.mintA.address).toString()],d=i[ot(e.mintB.address).toString()],p=e.mintA.decimals,y=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=te.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),b=te.getSqrtPriceX64FromTick(s),g=te.getSqrtPriceX64FromTick(a),{amountSlippageA:P,amountSlippageB:A}=le.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:h,amountSlippageB:I}=le.getAmountsFromLiquidityWithSlippage(f,b,g,r,!1,!1,0),T=new O(P.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(A.toString()).div(new O(10).pow(y)).mul(d.value)),S=new O(h.toString()).div(new O(10).pow(p)).mul(m.value).add(new O(I.toString()).div(new O(10).pow(y)).mul(d.value)),B=new O(1).div(T.add(S)),x=new O(l.volumeFee).mul(365).div(c).mul(B).mul(100).toNumber(),L=3600*24*365,W=e.rewardDefaultInfos.map(N=>{var D,je;let Z=N.mint.decimals,G=i[N.mint.address];return u<((D=N.startTime)!=null?D:0)||u>((je=N.endTime)!=null?je:0)||!N.perSecond||!G||Z===void 0?0:new O(G.value).mul(new O(N.perSecond).mul(L)).div(new O(10).pow(Z)).mul(B).mul(100).toNumber()});return{feeApr:x,rewardsApr:W,apr:x+W.reduce((N,Z)=>N+Z,0)}}static getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:r,slippage:s,add:a,epochInfo:u,amountHasFee:c}){var g,P;let l=te.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),m=te.getSqrtPriceX64FromTick(n),d=te.getSqrtPriceX64FromTick(i),p=a?1-s:1+s,y=ye(r,(g=e[t?"mintA":"mintB"].extensions)==null?void 0:g.feeConfig,u,!c),f=new he(new O(y.amount.sub((P=y.fee)!=null?P:Be).toString()).mul(p).toFixed(0)),b;if(l.lte(m))b=t?le.getLiquidityFromTokenAmountA(m,d,f,!a):new he(0);else if(l.lte(d)){let A=le.getLiquidityFromTokenAmountA(l,d,f,!a),h=le.getLiquidityFromTokenAmountB(m,l,f);b=t?A:h}else b=t?new he(0):le.getLiquidityFromTokenAmountB(m,d,f);return xe.getAmountsFromLiquidity({epochInfo:u,poolInfo:e,tickLower:n,tickUpper:i,liquidity:b,slippage:s,add:a})}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:r,slippage:s,add:a}){var b,g,P,A;let u=te.getSqrtPriceX64FromTick(n),c=te.getSqrtPriceX64FromTick(i),l=a?1+s:1-s,m=le.getAmountsFromLiquidity(te.priceToSqrtPriceX64(new O(t.price),t.mintA.decimals,t.mintB.decimals),u,c,r,a),[d,p]=[ye(m.amountA,(b=t.mintA.extensions)==null?void 0:b.feeConfig,e,!0),ye(m.amountB,(g=t.mintB.extensions)==null?void 0:g.feeConfig,e,!0)],[y,f]=[ye(m.amountA.muln(l),(P=t.mintA.extensions)==null?void 0:P.feeConfig,e,!0),ye(m.amountB.muln(l),(A=t.mintB.extensions)==null?void 0:A.feeConfig,e,!0)];return{liquidity:r,amountA:d,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:kt(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let i=t.filter(u=>!n[u.id]).map(u=>new Bt(u.id));(await bt(e,i)).forEach((u,c)=>{!u||(n[i[c].toBase58()]=un.decode(u.data))});let s=t.map(u=>nt(new Bt(u.programId),new Bt(u.id)).publicKey),a=await xe.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((u,c)=>F(R({},u),{[c.id]:F(R({},n[c.id]),{id:new Bt(c.id),version:6,programId:new Bt(c.programId),mintA:c.mintA,mintB:c.mintB,ammConfig:F(R({},c.config),{id:new Bt(c.config.id),fundOwner:""}),currentPrice:new O(c.price),exBitmapInfo:a[nt(new Bt(c.programId),new Bt(c.id)).publicKey.toBase58()],startTime:n[c.id].startTime.toNumber()})}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};var Fr={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function qa(o){return F(R({},o),{type:"Concentrated",programId:o.programId.toString(),id:o.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:o.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:o.ammConfig.tradeFeeRate,openTime:o.startTime.toString(),tvl:0,day:Fr,week:Fr,month:Fr,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:F(R({},o.ammConfig),{id:o.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]})})}var ne=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),r=i.div(n);return i.mod(n).eq(Be)||(r=r.add(st)),r}static mulDivFloor(e,t,n){if(n.eq(Be))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(Be))throw new Error("division by 0");return e.mul(t).add(n.sub(st)).div(n)}static x64ToDecimal(e,t){return new O(e.toString()).div(O.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new re(e.mul(O.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(lo).sub(t).mod(lo)}};function Ve(o,e){return Dr(o.mul(e),64,256)}function hm(o,e,t){let n=o.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function Dr(o,e,t){let n=o.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var te=class{static sqrtPriceX64ToPrice(e,t,n){return ne.x64ToDecimal(e).pow(2).mul(O.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ne.decimalToX64(e.mul(O.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(Be))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Be))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(Be))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Be))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(Be))return e;let r=t.shln(si);if(i){let s=r,a=r.add(n.mul(e));return a.gte(s)?ne.mulDivCeil(s,e,a):ne.mulDivRoundingUp(s,st,s.div(e).add(n))}else{let s=n.mul(e);if(!r.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=r.sub(s);return ne.mulDivCeil(r,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let r=n.shln(si);if(i)return e.add(r.div(t));{let s=ne.mulDivRoundingUp(r,st,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<ze||e>He)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new re("18445821805675395072"):new re("18446744073709551616");return(t&2)!=0&&(n=Ve(n,new re("18444899583751176192"))),(t&4)!=0&&(n=Ve(n,new re("18443055278223355904"))),(t&8)!=0&&(n=Ve(n,new re("18439367220385607680"))),(t&16)!=0&&(n=Ve(n,new re("18431993317065453568"))),(t&32)!=0&&(n=Ve(n,new re("18417254355718170624"))),(t&64)!=0&&(n=Ve(n,new re("18387811781193609216"))),(t&128)!=0&&(n=Ve(n,new re("18329067761203558400"))),(t&256)!=0&&(n=Ve(n,new re("18212142134806163456"))),(t&512)!=0&&(n=Ve(n,new re("17980523815641700352"))),(t&1024)!=0&&(n=Ve(n,new re("17526086738831433728"))),(t&2048)!=0&&(n=Ve(n,new re("16651378430235570176"))),(t&4096)!=0&&(n=Ve(n,new re("15030750278694412288"))),(t&8192)!=0&&(n=Ve(n,new re("12247334978884435968"))),(t&16384)!=0&&(n=Ve(n,new re("8131365268886854656"))),(t&32768)!=0&&(n=Ve(n,new re("3584323654725218816"))),(t&65536)!=0&&(n=Ve(n,new re("696457651848324352"))),(t&131072)!=0&&(n=Ve(n,new re("26294789957507116"))),(t&262144)!=0&&(n=Ve(n,new re("37481735321082"))),e>0&&(n=Ca.div(n)),n}static getTickFromPrice(e,t,n){return te.getTickFromSqrtPriceX64(te.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(ft)||e.lt(pt))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new re(t-64),i=hm(n,32,128),r=new re("8000000000000000","hex"),s=0,a=new re(0),u=t>=64?e.shrn(t-63):e.shln(63-t);for(;r.gt(new re(0))&&s<Ra;){u=u.mul(u);let y=u.shrn(127);u=u.shrn(63+y.toNumber()),a=a.add(r.mul(y)),r=r.shrn(1),s+=1}let c=a.shrn(32),m=i.add(c).mul(new re(La)),d=Dr(m.sub(new re(Oa)),64,128).toNumber(),p=Dr(m.add(new re(Na)),64,128).toNumber();return d==p?d:te.getSqrtPriceX64FromTick(p).lte(e)?p:d}},cn=class{static getTickWithPriceAndTickspacing(e,t,n,i){let s=te.getTickFromSqrtPriceX64(te.priceToSqrtPriceX64(e,n,i))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,i){let r=cn.getTickWithPriceAndTickspacing(e,t,n,i),s=te.getSqrtPriceX64FromTick(r);return te.sqrtPriceX64ToPrice(s,n,i)}},le=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Be))throw new Error("sqrtPriceX64A must greater than 0");let r=n.ushln(si),s=t.sub(e);return i?ne.mulDivRoundingUp(ne.mulDivCeil(r,s,t),st,e):ne.mulDivFloor(r,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Be))throw new Error("sqrtPriceX64A must greater than 0");return i?ne.mulDivCeil(n,t.sub(e),at):ne.mulDivFloor(n,t.sub(e),at)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let r=n.mul(e).mul(t),s=t.sub(e),a=r.div(s);return i?ne.mulDivRoundingUp(a,st,Nr):a.shrn(si)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ne.mulDivFloor(n,Nr,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return le.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let s=le.getLiquidityFromTokenAmountA(e,n,i,!1),a=le.getLiquidityFromTokenAmountB(t,e,r);return s.lt(a)?s:a}else return le.getLiquidityFromTokenAmountB(t,n,r)}static getAmountsFromLiquidity(e,t,n,i,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:le.getTokenAmountAFromLiquidity(t,n,i,r),amountB:new re(0)};if(e.lt(n)){let s=le.getTokenAmountAFromLiquidity(e,n,i,r),a=le.getTokenAmountBFromLiquidity(t,e,i,r);return{amountA:s,amountB:a}}else return{amountA:new re(0),amountB:le.getTokenAmountBFromLiquidity(t,n,i,r)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,r,s,a){let{amountA:u,amountB:c}=le.getAmountsFromLiquidity(e,t,n,i,s),l=r?1+a:1-a,m=new re(new O(u.toString()).mul(l).toFixed(0)),d=new re(new O(c.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:r,add:s,epochInfo:a,amountAddFee:u}){var P,A,h,I;let c=te.priceToSqrtPriceX64(new O(e.price),e.mintA.decimals,e.mintB.decimals),l=te.getSqrtPriceX64FromTick(t),m=te.getSqrtPriceX64FromTick(n),d=s?1+r:1-r,p=le.getAmountsFromLiquidity(c,l,m,i,s),[y,f]=[ye(p.amountA,(P=e.mintA.extensions)==null?void 0:P.feeConfig,a,u),ye(p.amountB,(A=e.mintB.extensions)==null?void 0:A.feeConfig,a,u)],[b,g]=[ye(new re(new O(p.amountA.toString()).mul(d).toFixed(0)),(h=e.mintA.extensions)==null?void 0:h.feeConfig,a,u),ye(new re(new O(p.amountB.toString()).mul(d).toFixed(0)),(I=e.mintB.extensions)==null?void 0:I.feeConfig,a,u)];return{liquidity:i,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:kt(y.expirationTime,f.expirationTime)}}},an=class{static swapCompute(e,t,n,i,r,s,a,u,c,l,m,d,p,y,f=!1){if(d.eq(Be))throw new Error("amountSpecified must not be 0");if(y||(y=s?pt.add(st):ft.sub(st)),s){if(y.lt(pt))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(ft))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let b=d.gt(Be),g={amountSpecifiedRemaining:d,amountCalculated:Be,sqrtPriceX64:m,tick:c>p?Math.min(p+ue.tickCount(l)-1,c):p,accounts:[],liquidity:u,feeAmount:new re(0)},P=p,A=n[p],h=0,I=!s&&A.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(Be)&&!g.sqrtPriceX64.eq(y);){h>10;let T={};T.sqrtPriceStartX64=g.sqrtPriceX64;let S=Y.nextInitTick(A,g.tick,l,s,I),B=S||null,C=null;if(!(B!=null&&B.liquidityGross.gtn(0))){let L=xe.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:r},P,s);if(!L.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}P=L.nextStartIndex;let{publicKey:W}=pe(e,t,P);C=W,A=n[P];try{B=Y.firstInitializedTick(A,s)}catch{throw Error("not found next tick info")}}T.tickNext=B.tick,T.initialized=B.liquidityGross.gtn(0),p!==P&&C&&(g.accounts.push(C),p=P),T.tickNext<ze?T.tickNext=ze:T.tickNext>He&&(T.tickNext=He),T.sqrtPriceNextX64=te.getSqrtPriceX64FromTick(T.tickNext);let x;if(s&&T.sqrtPriceNextX64.lt(y)||!s&&T.sqrtPriceNextX64.gt(y)?x=y:x=T.sqrtPriceNextX64,[g.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=an.swapStepCompute(g.sqrtPriceX64,x,g.liquidity,g.amountSpecifiedRemaining,a),g.feeAmount=g.feeAmount.add(T.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),g.amountCalculated=g.amountCalculated.sub(T.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(T.amountOut),g.amountCalculated=g.amountCalculated.add(T.amountIn.add(T.feeAmount))),g.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let L=B.liquidityNet;s&&(L=L.mul(_t)),g.liquidity=le.addDelta(g.liquidity,L)}I=T.tickNext!=g.tick&&!s&&A.startTickIndex===T.tickNext,g.tick=s?T.tickNext-1:T.tickNext}else if(g.sqrtPriceX64!=T.sqrtPriceStartX64){let L=te.getTickFromSqrtPriceX64(g.sqrtPriceX64);I=L!=g.tick&&!s&&A.startTickIndex===L,g.tick=L}++h}try{let{nextStartIndex:T,isExist:S}=ue.nextInitializedTickArray(g.tick,l,s,i,r);S&&p!==T&&(g.accounts.push(pe(e,t,T).publicKey),p=T)}catch{}return{allTrade:!0,amountSpecifiedRemaining:Be,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,i,r){let s={sqrtPriceX64Next:new re(0),amountIn:new re(0),amountOut:new re(0),feeAmount:new re(0)},a=e.gte(t),u=i.gte(Be);if(u){let l=ne.mulDivFloor(i,fo.sub(new re(r.toString())),fo);s.amountIn=a?le.getTokenAmountAFromLiquidity(t,e,n,!0):le.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=te.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?le.getTokenAmountBFromLiquidity(t,e,n,!1):le.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(_t).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=te.getNextSqrtPriceX64FromOutput(e,n,i.mul(_t),a);let c=t.eq(s.sqrtPriceX64Next);return a?(c&&u||(s.amountIn=le.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),c&&!u||(s.amountOut=le.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=c&&u?s.amountIn:le.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=c&&!u?s.amountOut:le.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!u&&s.amountOut.gt(i.mul(_t))&&(s.amountOut=i.mul(_t)),u&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=i.sub(s.amountIn):s.feeAmount=ne.mulDivCeil(s.amountIn,new re(r),fo.sub(new re(r))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};var Me=60,sn=512,Y=class{static getTickArrayAddressByTick(e,t,n,i){let r=Y.getTickArrayStartIndexByTick(n,i),{publicKey:s}=pe(e,t,r);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=Y.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=Me)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=ue.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*ue.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Me,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*Me,r=Math.floor(t/i)+512,s=Math.abs(r);return{isInitialized:e.testn(s),startIndex:(s-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Me:e+t*Me}static mergeTickArrayBitmap(e){let t=new km(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,r){let s=Math.floor(i/(n*Me));return[...Y.searchLowBitFromStart(e,t,s-1,r,n),...Y.searchHightBitFromStart(e,t,s,r,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return Y.searchHightBitFromStart(e,t,0,sn,n)}static getAllInitializedTickArrayInfo(e,t,n,i,r){let s=[],a=Y.getAllInitializedTickArrayStartIndex(n,i,r);for(let u of a){let{publicKey:c}=pe(e,t,u);s.push({tickArrayStartIndex:u,tickArrayAddress:c})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>Y.mergeTickArrayBitmap(c)),a=[];for(;n>=-7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n--,a.length===i)break}let u=ue.tickCount(r);return a.map(c=>c*u)}static searchHightBitFromStart(e,t,n,i,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(c=>Y.mergeTickArrayBitmap(c)),a=[];for(;n<7680;){let c=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[c].testn(l)&&a.push(n),n++,a.length===i)break}let u=ue.tickCount(r);return a.map(c=>c*u)}static checkIsOutOfBoundary(e){return e<ze||e>He}static nextInitTick(e,t,n,i,r){if(ue.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(i)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(r||(a=a+1);a<Me;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=Me-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Me;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=te.getSqrtPriceX64FromTick(t),r=te.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:i}:{tick:t,price:new O(1).div(r),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new O(1).div(t),r=cn.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=te.getSqrtPriceX64FromTick(r),a=te.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new O(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=te.getSqrtPriceX64FromTick(t),r=te.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:i}:{tick:t,price:new O(1).div(r),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new O(1).div(t),r=cn.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=te.getSqrtPriceX64FromTick(r),a=te.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new O(1).div(a)}}};var Ga=E([be(8),U("bump"),Ot("index"),K(""),Ge("protocolFeeRate"),Ge("tradeFeeRate"),Ot("tickSpacing"),X(w(),8,"")]),Tm=E([Ge("blockTimestamp"),Bn("tickCumulative"),X(w(),4)]),Xa=E([be(8),Xe("initialized"),w("recentEpoch"),Ot("observationIndex"),K("poolId"),X(Tm,100,"observations"),X(w(),4)]),Im=E([U("rewardState"),w("openTime"),w("endTime"),w("lastUpdateTime"),$("emissionsPerSecondX64"),w("rewardTotalEmissioned"),w("rewardClaimed"),K("tokenMint"),K("tokenVault"),K("creator"),$("rewardGrowthGlobalX64")]),un=E([be(8),U("bump"),K("ammConfig"),K("creator"),K("mintA"),K("mintB"),K("vaultA"),K("vaultB"),K("observationId"),U("mintDecimalsA"),U("mintDecimalsB"),Ot("tickSpacing"),$("liquidity"),$("sqrtPriceX64"),qe("tickCurrent"),Ge(),$("feeGrowthGlobalX64A"),$("feeGrowthGlobalX64B"),w("protocolFeesTokenA"),w("protocolFeesTokenB"),$("swapInAmountTokenA"),$("swapOutAmountTokenB"),$("swapInAmountTokenB"),$("swapOutAmountTokenA"),U("status"),X(U(),7,""),X(Im,3,"rewardInfos"),X(w(),16,"tickArrayBitmap"),w("totalFeesTokenA"),w("totalFeesClaimedTokenA"),w("totalFeesTokenB"),w("totalFeesClaimedTokenB"),w("fundFeesTokenA"),w("fundFeesTokenB"),w("startTime"),X(w(),15*4-3,"padding")]),Bm=E([$("growthInsideLastX64"),w("rewardAmountOwed")]),go=E([be(8),U("bump"),K("nftMint"),K("poolId"),qe("tickLower"),qe("tickUpper"),$("liquidity"),$("feeGrowthInsideLastX64A"),$("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),X(Bm,3,"rewardInfos"),X(w(),8,"")]),ih=E([be(8),U("bump"),K("poolId"),qe("tickLowerIndex"),qe("tickUpperIndex"),$("liquidity"),$("feeGrowthInsideLastX64A"),$("feeGrowthInsideLastX64B"),w("tokenFeesOwedA"),w("tokenFeesOwedB"),X($(),3,"rewardGrowthInside"),X(w(),8,"")]),xm=E([qe("tick"),la("liquidityNet"),$("liquidityGross"),$("feeGrowthOutsideX64A"),$("feeGrowthOutsideX64B"),X($(),3,"rewardGrowthsOutsideX64"),X(Ge(),13,"")]),li=E([be(8),K("poolId"),qe("startTickIndex"),X(xm,Me,"ticks"),U("initializedTickCount"),X(U(),115,"")]),za=E([be(329),X(K(),100,"whitelistMints")]),Ua=E([be(8),K("poolId"),X(X(w(),8),Er,"positiveTickArrayBitmap"),X(X(w(),8),Er,"negativeTickArrayBitmap")]),oh=E([w(),U("bump"),K("owner"),K("poolId"),K("positionId"),K("nftAccount"),X(w(),8)]);Xa.span;var ja=se("Raydium_Clmm"),xt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},Sm=[188,37,179,131,82,150,84,73],Km=[16,72,250,198,14,162,212,19],Ae=class{static createPoolInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,y){let f=E([$("sqrtPriceX64"),w("startTime")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:Cn.programId,isSigner:!1,isWritable:!1},{pubkey:At,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,startTime:y},g);let P=Buffer.from([...xt.createPool,...g]);return new ut({keys:b,programId:e,data:P})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:i,mintB:r,ammConfigId:s,initialPriceX64:a,startTime:u}=e,[c,l]=[new q(i.address),new q(r.address)],{publicKey:m}=Ea(t,s,c,l),{publicKey:d}=Da(t,m),{publicKey:p}=vr(t,m,c),{publicKey:y}=vr(t,m,l),f=[this.createPoolInstruction(t,m,n,s,d,c,p,new q(i.programId||Le),l,y,new q(r.programId||Le),nt(t,m).publicKey,a,u)];return{signers:[],instructions:f,instructionTypes:[V.CreateAccount,V.ClmmCreatePool],address:{poolId:m,observationId:d,mintAVault:p,mintBVault:y},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,y,f,b,g,P,A,h,I,T,S,B,C,x){let L=E([qe("tickLowerIndex"),qe("tickUpperIndex"),qe("tickArrayLowerStartIndex"),qe("tickArrayUpperStartIndex"),$("liquidity"),w("amountMaxA"),w("amountMaxB"),Xe("withMetadata"),U("optionBaseFlag"),Xe("baseFlag")]),W=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[]],N=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:At,isSigner:!1,isWritable:!1},{pubkey:Cn.programId,isSigner:!1,isWritable:!1},{pubkey:Le,isSigner:!1,isWritable:!1},{pubkey:Ya,isSigner:!1,isWritable:!1},{pubkey:Tn,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...W],Z=Buffer.alloc(L.span);L.encode({tickLowerIndex:P,tickUpperIndex:A,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:I,liquidity:T,amountMaxA:S,amountMaxB:B,withMetadata:C==="create",baseFlag:!1,optionBaseFlag:0},Z);let G=Buffer.from([...xt.openPosition,...Z]);return new ut({keys:N,programId:e,data:G})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[d,p]=[new q(e.programId),new q(e.id)],y;if(l)y=new q((await l(1))[0]);else{let B=Wr.generate();m.push(B),y=B.publicKey}let f=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),b=Y.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:g}=pe(d,p,f),{publicKey:P}=pe(d,p,b),{publicKey:A}=Pe(n.wallet,y,Le),{publicKey:h}=bo(y),{publicKey:I}=tt(d,y),{publicKey:T}=en(d,p,i,r),S=this.openPositionFromLiquidityInstruction(d,n.feePayer,p,n.wallet,y,A,h,T,g,P,I,n.tokenAccountA,n.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),i,r,f,b,s,a,u,c);return{signers:m,instructions:[S],instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:y,tickArrayLower:g,tickArrayUpper:P,positionNftAccount:A,metadataAccount:h,personalPosition:I,protocolPosition:T}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:u,withMetadata:c,getEphemeralSigners:l}){let m=[],[d,p]=[new q(e.programId),new q(e.id)],y;if(l)y=new q((await l(1))[0]);else{let B=Wr.generate();m.push(B),y=B.publicKey}let f=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),b=Y.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:g}=pe(d,p,f),{publicKey:P}=pe(d,p,b),{publicKey:A}=Pe(n.wallet,y,Le),{publicKey:h}=bo(y),{publicKey:I}=tt(d,y),{publicKey:T}=en(d,p,i,r),S=this.openPositionFromBaseInstruction(d,n.feePayer,p,n.wallet,y,A,h,T,g,P,I,n.tokenAccountA,n.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),i,r,f,b,c,s,a,u,xe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?nt(d,p).publicKey:void 0);return{address:{nftMint:y,tickArrayLower:g,tickArrayUpper:P,positionNftAccount:A,metadataAccount:h,personalPosition:I,protocolPosition:T},instructions:[S],signers:m,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,y,f,b,g,P,A,h,I,T,S,B,C,x){let L=E([qe("tickLowerIndex"),qe("tickUpperIndex"),qe("tickArrayLowerStartIndex"),qe("tickArrayUpperStartIndex"),$("liquidity"),w("amountMaxA"),w("amountMaxB"),Xe("withMetadata"),U("optionBaseFlag"),Xe("baseFlag")]),W=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[]],N=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:At,isSigner:!1,isWritable:!1},{pubkey:Cn.programId,isSigner:!1,isWritable:!1},{pubkey:Le,isSigner:!1,isWritable:!1},{pubkey:Ya,isSigner:!1,isWritable:!1},{pubkey:Tn,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...W],Z=Buffer.alloc(L.span);L.encode({tickLowerIndex:P,tickUpperIndex:A,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:I,liquidity:new Qa(0),amountMaxA:S==="MintA"?B:C,amountMaxB:S==="MintA"?C:B,withMetadata:T==="create",baseFlag:S==="MintA",optionBaseFlag:1},Z);let G=Buffer.from([...xt.openPosition,...Z]);return new ut({keys:N,programId:e,data:G})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:u,withMetadata:c,getEphemeralSigners:l}){let m,d=[];if(l)m=new q((await l(1))[0]);else{let B=Wr.generate();d.push(B),m=B.publicKey}let[p,y]=[new q(e.programId),new q(e.id)],f=Y.getTickArrayStartIndexByTick(i,e.config.tickSpacing),b=Y.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:g}=pe(p,y,f),{publicKey:P}=pe(p,y,b),{publicKey:A}=Pe(n.wallet,m,Le),{publicKey:h}=bo(m),{publicKey:I}=tt(p,m),{publicKey:T}=en(p,y,i,r),S=this.openPositionFromLiquidityInstruction(p,n.wallet,y,n.wallet,m,A,h,T,g,P,I,n.tokenAccountA,n.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(t.mintA.address),new q(t.mintB.address),i,r,f,b,s,a,u,c,xe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[f,b])?nt(p,y).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:g,tickArrayUpper:P,positionNftAccount:A,metadataAccount:h,personalPosition:I,protocolPosition:T},instructions:[S],signers:d,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,r){let s=E([]),a=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:Cn.programId,isSigner:!1,isWritable:!1},{pubkey:Le,isSigner:!1,isWritable:!1}],u=Buffer.alloc(s.span);s.encode({},u);let c=Buffer.from([...xt.closePosition,...u]);return new ut({keys:a,programId:e,data:c})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i}){let r=new q(e.programId),{publicKey:s}=Pe(n.wallet,i.nftMint,Le),{publicKey:a}=tt(r,i.nftMint),u=[];return u.push(this.closePositionInstruction(r,n.wallet,i.nftMint,s,a)),{address:{positionNftAccount:s,personalPosition:a},signers:[],instructions:u,instructionTypes:[V.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,y,f,b,g,P){let A=E([$("liquidity"),w("amountMaxA"),w("amountMaxB"),U("optionBaseFlag"),Xe("baseFlag")]),h=[...P?[{pubkey:P,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Le,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(A.span);A.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},T);let S=Buffer.from([...xt.increaseLiquidity,...T]);return new ut({keys:I,programId:e,data:S})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:r,amountMaxA:s,amountMaxB:a}){let[u,c]=[new q(e.programId),new q(e.id)],l=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=pe(u,c,l),{publicKey:p}=pe(u,c,m),{publicKey:y}=Pe(i.wallet,n.nftMint,Le),{publicKey:f}=tt(u,n.nftMint),{publicKey:b}=en(u,c,n.tickLower,n.tickUpper),g=this.increasePositionFromLiquidityInstruction(u,i.wallet,y,f,c,b,d,p,i.tokenAccountA,i.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),r,s,a,xe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?nt(u,c).publicKey:void 0);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:y,personalPosition:f,protocolPosition:b},signers:[],instructions:[g],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:r,baseAmount:s,otherAmountMax:a}){let[u,c]=[new q(e.programId),new q(e.id)],l=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:d}=pe(u,c,l),{publicKey:p}=pe(u,c,m),{publicKey:y}=Pe(i.wallet,n.nftMint,Le),{publicKey:f}=tt(u,n.nftMint),{publicKey:b}=en(u,c,n.tickLower,n.tickUpper);return{address:{tickArrayLower:d,tickArrayUpper:p,positionNftAccount:y,personalPosition:f,protocolPosition:b},instructions:[this.increasePositionFromBaseInstruction(u,i.wallet,y,f,c,b,d,p,i.tokenAccountA,i.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),r,s,a,xe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[l,m])?nt(u,c).publicKey:void 0)],signers:[],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,y,f,b,g,P){let A=E([$("liquidity"),w("amountMaxA"),w("amountMaxB"),U("optionBaseFlag"),Xe("baseFlag")]),h=[...P?[{pubkey:P,isSigner:!1,isWritable:!0}]:[]],I=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Le,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(A.span);A.encode({liquidity:new Qa(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},T);let S=Buffer.from([...xt.increaseLiquidity,...T]);return new ut({keys:I,programId:e,data:S})}static decreaseLiquidityInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,y,f,b,g,P,A){let h=E([$("liquidity"),w("amountMinA"),w("amountMinB")]),I=[...A?[{pubkey:A,isSigner:!1,isWritable:!0}]:[],...f.map(C=>[{pubkey:C.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:C.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:C.rewardMint,isSigner:!1,isWritable:!1}]).flat()],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Le,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:Di,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...I],S=Buffer.alloc(h.span);h.encode({liquidity:b,amountMinA:g,amountMinB:P},S);let B=Buffer.from([...xt.decreaseLiquidity,...S]);return new ut({keys:T,programId:e,data:B})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:r,amountMinA:s,amountMinB:a,programId:u}){let[c,l]=[new q(e.programId),new q(e.id)],m=Y.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=Y.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=pe(c,l,m),{publicKey:y}=pe(c,l,d),{publicKey:f}=Pe(i.wallet,n.nftMint,u),{publicKey:b}=tt(c,n.nftMint),{publicKey:g}=en(c,l,n.tickLower,n.tickUpper),P=[];for(let I=0;I<e.rewardDefaultInfos.length;I++)P.push({poolRewardVault:new q(t.rewardInfos[I].vault),ownerRewardVault:i.rewardAccounts[I],rewardMint:new q(e.rewardDefaultInfos[I].mint.address)});let A=[],h=this.decreaseLiquidityInstruction(c,i.wallet,f,b,l,g,p,y,i.tokenAccountA,i.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),P,r,s,a,xe.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?nt(c,l).publicKey:void 0);return A.push(h),{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:A,instructionTypes:[V.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,r,s,a,u,c,l,m,d,p,y,f,b,g){let P=E([w("amount"),w("otherAmountThreshold"),$("sqrtPriceLimitX64"),Xe("isBaseInput")]),A=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(S=>({pubkey:S,isSigner:!1,isWritable:!0}))],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Le,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:Di,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...A],I=Buffer.alloc(P.span);P.encode({amount:p,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},I);let T=Buffer.from([...xt.swap,...I]);return new ut({keys:h,programId:e,data:T})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,inputMint:r,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:u,remainingAccounts:c}){let[l,m]=[new q(e.programId),new q(e.id)],[d,p]=[new q(t.vault.A),new q(t.vault.B)],[y,f]=[new q(e.mintA.address),new q(e.mintB.address)],b=e.mintA.address===r.toString(),g=[this.swapInstruction(l,i.wallet,m,new q(e.config.id),b?i.tokenAccountA:i.tokenAccountB,b?i.tokenAccountB:i.tokenAccountA,b?d:p,b?p:d,b?y:f,b?f:y,c,n,s,a,u,!0,nt(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,outputMint:r,amountOut:s,amountInMax:a,sqrtPriceLimitX64:u,remainingAccounts:c}){let[l,m]=[new q(e.programId),new q(e.id)],[d,p]=[new q(t.vault.A),new q(t.vault.B)],[y,f]=[new q(e.mintA.address),new q(e.mintB.address)],b=e.mintA.address===r.toBase58(),g=[this.swapInstruction(l,i.wallet,m,new q(e.config.id),b?i.tokenAccountB:i.tokenAccountA,b?i.tokenAccountA:i.tokenAccountB,b?p:d,b?d:p,b?f:y,b?y:f,c,n,s,a,u,!1,nt(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,r,s,a,u,c,l,m,d){let p=E([w("openTime"),w("endTime"),$("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Cn.programId,isSigner:!1,isWritable:!1},{pubkey:At,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:j(l),endTime:j(m),emissionsPerSecondX64:d},f);let b=Buffer.from([...xt.initReward,...f]);return new ut({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[r,s]=[new q(e.programId),new q(e.id)],a=Fa(r,s,i.mint).publicKey,u=ui(r).publicKey,c=[this.initRewardInstruction(r,n.wallet,s,u,new q(e.config.id),n.tokenAccount,i.programId,i.mint,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:u},signers:[],instructions:c,instructionTypes:[V.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,r,s,a,u,c,l,m,d){let p=E([U("rewardIndex"),$("emissionsPerSecondX64"),w("openTime"),w("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Le,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:c,emissionsPerSecondX64:d,openTime:j(l),endTime:j(m)},f);let b=Buffer.from([...xt.setRewardEmissions,...f]);return new ut({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[r,s]=[new q(e.programId),new q(e.id)],a,u,c;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===i.mint.toString()&&(a=d,u=new q(t.rewardInfos[d].vault),c=new q(t.rewardInfos[d].mint.address));(a===void 0||u===void 0)&&ja.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=ui(r).publicKey,m=[this.setRewardInstruction(r,n.wallet,s,l,new q(e.config.id),n.tokenAccount,u,c,a,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:u,operationId:l},signers:[],instructions:m,instructionTypes:[V.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,r,s,a){let u=E([U("rewardIndex")]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Le,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:Di,isSigner:!1,isWritable:!1}],l=Buffer.alloc(u.span);u.encode({rewardIndex:a},l);let m=Buffer.from([...xt.collectReward,...l]);return new ut({keys:c,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[r,s]=[new q(e.programId),new q(e.id)],a,u;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.toString()&&(a=l,u=new q(t.rewardInfos[l].vault));(a===void 0||u===void 0)&&ja.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let c=[this.collectRewardInstruction(r,n.wallet,s,n.tokenAccount,u,i,a)];return{address:{rewardVault:u},signers:[],instructions:c,instructionTypes:[V.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:i,positionNft:r}){let{publicKey:s}=Pe(i,r,Le),{publicKey:a}=tt(n,r),u=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Vr(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:Le,isSigner:!1,isWritable:!1},{pubkey:Cn.programId,isSigner:!1,isWritable:!1}];return new ut({keys:u,programId:e,data:Buffer.from(Sm)})}static harvestLockPositionInstruction(e){let[t,n]=[new q(e.poolKeys.programId),new q(e.poolKeys.id)],i=Y.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),r=Y.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=pe(t,n,i),{publicKey:a}=pe(t,n,r),{publicKey:u}=Pe(e.owner,e.ownerPosition.nftMint,Le),{publicKey:c}=tt(t,e.ownerPosition.nftMint),{publicKey:l}=en(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let y=0;y<e.poolKeys.rewardInfos.length;y++)m.push({poolRewardVault:new q(e.poolKeys.rewardInfos[y].vault),ownerRewardVault:e.ownerRewardAccounts[y],rewardMint:new q(e.poolKeys.rewardInfos[y].mint.address)});let d=[...m.map(y=>[{pubkey:y.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:Vr(e.programId,c).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new q(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new q(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:Le,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:kn,isSigner:!1,isWritable:!1},{pubkey:new q(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new q(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...d];return new ut({keys:p,programId:e.programId,data:Buffer.from(Km)})}};var Ph=E([Ge("mintAuthorityOption"),K("mintAuthority"),w("supply"),U("decimals"),U("isInitialized"),Ge("freezeAuthorityOption"),K("freezeAuthority")]);import{PublicKey as Ih}from"@solana/web3.js";import{MintLayout as xh,TOKEN_PROGRAM_ID as Kh}from"@solana/spl-token";var wo=o=>new Te({mint:o.address,decimals:o.decimals,symbol:o.symbol,name:o.name}),di=i=>{var r=i,{amount:o,isRaw:e,name:t}=r,n=Ce(r,["amount","isRaw","name"]);return new fe(new Te({mint:ot(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),o,e,t)};var Ze=i=>{var r=i,{address:o,programId:e,decimals:t}=r,n=Ce(r,["address","programId","decimals"]);return R({chainId:101,address:ot(o).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{}},n)},tn=o=>o?F(R({},o),{transferFeeConfigAuthority:o.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:o.withdrawWithheldAuthority.toBase58(),withheldAmount:o.withheldAmount.toString(),olderTransferFee:F(R({},o.olderTransferFee),{epoch:o.olderTransferFee.epoch.toString(),maximumFee:o.olderTransferFee.maximumFee.toString()}),newerTransferFee:F(R({},o.newerTransferFee),{epoch:o.newerTransferFee.epoch.toString(),maximumFee:o.newerTransferFee.maximumFee.toString()})}):void 0;import Ha from"bn.js";var qr=new Ha(25),Ao=new Ha(1e4);import{PublicKey as Ct,SystemProgram as qm,SYSVAR_RENT_PUBKEY as Zh,TransactionInstruction as Ln}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Um,TOKEN_PROGRAM_ID as fi}from"@solana/spl-token";var Ur=E([U("instruction"),w("amountIn"),w("minAmountOut")]),Gr=E([U("instruction"),w("maxAmountIn"),w("amountOut")]),Uh=E([U("instruction"),U("nonce")]),Cm=E([U("instruction"),U("nonce"),w("startTime")]),Po=E([w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalValue"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),$("swapBaseInAmount"),$("swapQuoteOutAmount"),w("swapBase2QuoteFee"),$("swapQuoteInAmount"),$("swapBaseOutAmount"),w("swapQuote2BaseFee"),K("baseVault"),K("quoteVault"),K("baseMint"),K("quoteMint"),K("lpMint"),K("openOrders"),K("marketId"),K("marketProgramId"),K("targetOrders"),K("withdrawQueue"),K("lpVault"),K("owner"),w("lpReserve"),X(w(),3,"padding")]),Gh=E([w("accountType"),w("status"),w("nonce"),w("maxOrder"),w("depth"),w("baseDecimal"),w("quoteDecimal"),w("state"),w("resetFlag"),w("minSize"),w("volMaxCutRatio"),w("amountWaveRatio"),w("baseLotSize"),w("quoteLotSize"),w("minPriceMultiplier"),w("maxPriceMultiplier"),w("systemDecimalsValue"),w("abortTradeFactor"),w("priceTickMultiplier"),w("priceTick"),w("minSeparateNumerator"),w("minSeparateDenominator"),w("tradeFeeNumerator"),w("tradeFeeDenominator"),w("pnlNumerator"),w("pnlDenominator"),w("swapFeeNumerator"),w("swapFeeDenominator"),w("baseNeedTakePnl"),w("quoteNeedTakePnl"),w("quoteTotalPnl"),w("baseTotalPnl"),w("poolOpenTime"),w("punishPcAmount"),w("punishCoinAmount"),w("orderbookToInitTime"),$("swapBaseInAmount"),$("swapQuoteOutAmount"),$("swapQuoteInAmount"),$("swapBaseOutAmount"),w("swapQuote2BaseFee"),w("swapBase2QuoteFee"),K("baseVault"),K("quoteVault"),K("baseMint"),K("quoteMint"),K("lpMint"),K("modelDataAccount"),K("openOrders"),K("marketId"),K("marketProgramId"),K("targetOrders"),K("owner"),X(w(),64,"padding")]),Xr=E([U("instruction"),w("baseAmountIn"),w("quoteAmountIn"),w("fixedSide"),w("otherAmountMin")]),zr=E([U("instruction"),w("lpAmount"),w("baseAmountMin"),w("quoteAmountMin")]);var Za=E([w("fee")]);import{PublicKey as Rm}from"@solana/web3.js";var Rn=new Rm("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),mn=5e4,Lm=E([w("x"),w("y"),w("price")]),Om=E([w("accountType"),w("status"),w("multiplier"),w("validDataCount"),X(Lm,mn,"DataElement")]);function Nm(o,e){return[0,mn-2]}function Mm(o){return[0,mn-2]}function _m(o){return[0,mn-2]}function vm(o,e,t){let[n,i]=Nm(e,t),r=n,s=i,a=0,u=e*o.multiplier/t;for(;r<=s;){if(a=Math.floor((s+r)/2),a===0||a>=mn-2)return[a,a,!1];let c=o.DataElement[a].x*o.multiplier/o.DataElement[a].y,l=o.DataElement[a-1].x*o.multiplier/o.DataElement[a-1].y,m=o.DataElement[a+1].x*o.multiplier/o.DataElement[a+1].y;if(u===c)return[a,a,!0];if(u===l)return[a-1,a-1,!0];if(u===m)return[a+1,a+1,!0];if(u<l)s=a-1;else{if(u>l&&u<c)return[a-1,a,!0];if(u>c&&u<m)return[a,a+1,!0];r=a+1}}return[a,a,!1]}function Qr(o,e,t){let[n,i,r]=vm(o,e,t);if(!r)return 0;if(n===i){let s=o.DataElement[n].x;return e*o.multiplier/s}else{let s=o.DataElement[n].x,a=o.DataElement[n].y,u=o.DataElement[i].x,c=o.DataElement[i].y,l=t*(u*a-s*c),m=s*l,d=(u-s)*(e*a-s*t)*c,p=m+d;return e*o.multiplier*l/p}}function ln(o,e,t){return e*o.multiplier/t}function $a(o,e,t){return e*t/o.multiplier}function Vm(o,e){let[t,n]=Mm(e),i=t,r=n,s=0,a=e;for(;i<r;){if(s=Math.floor((r+i)/2),s<=0||s>mn-2)return[s,s,!1];let u=o.DataElement[s].x,c=o.DataElement[s-1].x,l=o.DataElement[s+1].x;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<c)r=s-1;else{if(a>c&&a<u)return[s-1,s,!0];if(a>u&&a<l)return[s,s+1,!0];i=s+1}}return[s,s,!1]}function Em(o,e){let[t,n]=_m(e),i=t,r=n,s=0,a=e;for(;i<=r;){if(s=Math.floor((r+i)/2),s<=0||s>=mn-2)return[s,s,!1];let u=o.DataElement[s].y,c=o.DataElement[s-1].y,l=o.DataElement[s+1].y;if(a===u)return[s,s,!0];if(a===c)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)i=s+1;else{if(a<c&&a>u)return[s-1,s,!0];if(a<u&&a>l)return[s,s+1,!0];r=s-1}}return[s,s,!1]}function Ja(o,e,t,n){let i=n?e+t:e-t,[r,s,a]=Vm(o,i);if(!a)return[0,0,!1,a];if(r===s)return[o.DataElement[s].price,o.DataElement[s].y,!1,a];{let u=o.DataElement[r].x,c=o.DataElement[s].x,l=o.DataElement[r].price,m=o.DataElement[s].price,d=o.DataElement[r].y,p=o.DataElement[s].y;if(e>=u&&e<=c)return n?[m,p,!0,a]:[l,d,!0,a];{let y,f;return n?(y=l+(m-l)*(e-u)/(c-u),f=d-(i-u)*o.multiplier/m):(y=l+(m-l)*(e-u)/(c-u),f=p+(c-i)*o.multiplier/l),[y,f,!1,a]}}}function Fm(o,e,t,n){let i=n?e-t:e+t,[r,s,a]=Em(o,i);if(!a)return[0,0,!1,a];if(r===s)return[o.DataElement[s].price,o.DataElement[s].x,!1,a];{let u=o.DataElement[r].x,c=o.DataElement[s].x,l=o.DataElement[r].price,m=o.DataElement[s].price,d=o.DataElement[r].y,p=o.DataElement[s].y;if(e>=p&&e<=d)return n?[m,c,!0,a]:[l,u,!0,a];{let y,f;return n?(y=l+(m-l)*(d-e)/(d-p),f=u+m*(d-i)/o.multiplier):(y=l+(m-l)*(d-e)/(d-p),f=c-l*(i-p)/o.multiplier),[y,f,!1,a]}}}function Dm(o,e){let t=Ja(o,e,0,!1);return t[3]?t[0]:0}function eu(o,e,t,n){let i=Qr(o,e,t),r=ln(o,e,i),s=ln(o,t,i),a=ln(o,n,i),u=!0,[c,l,m,d]=Ja(o,r,a,u);if(!d)return 0;if(m)return n*o.multiplier/c;{let p=s-l;return $a(o,p,i)}}function tu(o,e,t,n){let i=Qr(o,e,t),r=ln(o,e,i),s=ln(o,t,i),a=ln(o,n,i),u=!1,[c,l,m,d]=Fm(o,s,a,u);if(!d)return 0;if(m)return n*c/o.multiplier;{let p=r-l;return $a(o,p,i)}}function Wm(o){let e=Om.decode(o);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function nu(o,e,t,n){let i=Dm(o,ln(o,e,Qr(o,e,t)))/o.multiplier;return n?i:1/i}var pi=class{constructor({connection:e}){this._layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(Rn);e&&(this._layoutData=Wm(e==null?void 0:e.data))}}};var iu=se("Raydium_liquidity_instruction");function ou(o){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:i,quoteAmountIn:r,fixedSide:s,otherAmountMin:a}=o,u=Buffer.alloc(Xr.span);Xr.encode({instruction:3,baseAmountIn:j(i),quoteAmountIn:j(r),otherAmountMin:j(a),fixedSide:s==="base"?ct:vs},u);let c=[k({pubkey:fi,isWritable:!1}),k({pubkey:new Ct(e.id)}),k({pubkey:new Ct(t.authority),isWritable:!1}),k({pubkey:new Ct(t.openOrders),isWritable:!1}),k({pubkey:new Ct(t.targetOrders)}),k({pubkey:new Ct(e.lpMint.address)}),k({pubkey:new Ct(t.vault.A)}),k({pubkey:new Ct(t.vault.B)})];return e.pooltype.includes("StablePool")&&c.push(k({pubkey:Rn})),c.push(k({pubkey:new Ct(e.marketId),isWritable:!1}),k({pubkey:n.baseTokenAccount}),k({pubkey:n.quoteTokenAccount}),k({pubkey:n.lpTokenAccount}),k({pubkey:n.owner,isWritable:!1,isSigner:!0}),k({pubkey:new Ct(t.marketEventQueue),isWritable:!1})),new Ln({programId:new Ct(e.programId),keys:c,data:u})}function Yr(o){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:i,baseAmountMin:r,quoteAmountMin:s}=o,a=We(t),u=4;if(e.pooltype.includes("StablePool")&&(u=5),u===4||u===5){let c=Buffer.alloc(zr.span);zr.encode({instruction:4,lpAmount:j(i),baseAmountMin:j(r),quoteAmountMin:j(s)},c);let l=[k({pubkey:fi,isWritable:!1}),k({pubkey:a.id}),k({pubkey:a.authority,isWritable:!1}),k({pubkey:a.openOrders}),k({pubkey:a.targetOrders}),k({pubkey:a.mintLp.address}),k({pubkey:a.vault.A}),k({pubkey:a.vault.B})];return u===5?l.push(k({pubkey:Rn})):(l.push(k({pubkey:a.id})),l.push(k({pubkey:a.id}))),l.push(k({pubkey:a.marketProgramId,isWritable:!1}),k({pubkey:a.marketId}),k({pubkey:a.marketBaseVault}),k({pubkey:a.marketQuoteVault}),k({pubkey:a.marketAuthority,isWritable:!1}),k({pubkey:n.lpTokenAccount}),k({pubkey:n.baseTokenAccount}),k({pubkey:n.quoteTokenAccount}),k({pubkey:n.owner,isWritable:!1,isSigner:!0}),k({pubkey:a.marketEventQueue}),k({pubkey:a.marketBids}),k({pubkey:a.marketAsks})),new Ln({programId:a.programId,keys:l,data:c})}return new Ln({programId:a.programId,keys:[]})}function ru({programId:o,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:i,coinMint:r,pcMint:s,coinVault:a,pcVault:u,withdrawQueue:c,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:g,nonce:P,openTime:A,coinAmount:h,pcAmount:I,ammConfigId:T,feeDestinationId:S}){let B=E([U("instruction"),U("nonce"),w("openTime"),w("pcAmount"),w("coinAmount")]),C=[{pubkey:fi,isSigner:!1,isWritable:!1},{pubkey:Um,isSigner:!1,isWritable:!1},{pubkey:qm.programId,isSigner:!1,isWritable:!1},{pubkey:At,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:T,isSigner:!1,isWritable:!1},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],x=Buffer.alloc(B.span);return B.encode({instruction:1,nonce:P,openTime:A,coinAmount:h,pcAmount:I},x),{instruction:new Ln({keys:C,programId:o,data:x}),instructionType:V.AmmV4CreatePool}}function Gm({poolKeys:o,userKeys:e,amountIn:t,minAmountOut:n},i){let r=We(o),s=Buffer.alloc(Ur.span);Ur.encode({instruction:9,amountIn:j(t),minAmountOut:j(n)},s);let a=[k({pubkey:fi,isWritable:!1}),k({pubkey:r.id}),k({pubkey:r.authority,isWritable:!1}),k({pubkey:r.openOrders})];return i===4&&a.push(k({pubkey:r.targetOrders})),a.push(k({pubkey:r.vault.A}),k({pubkey:r.vault.B})),i===5&&a.push(k({pubkey:Rn})),a.push(k({pubkey:r.marketProgramId,isWritable:!1}),k({pubkey:r.marketId}),k({pubkey:r.marketBids}),k({pubkey:r.marketAsks}),k({pubkey:r.marketEventQueue}),k({pubkey:r.marketBaseVault}),k({pubkey:r.marketQuoteVault}),k({pubkey:r.marketAuthority,isWritable:!1}),k({pubkey:e.tokenAccountIn}),k({pubkey:e.tokenAccountOut}),k({pubkey:e.owner,isWritable:!1})),new Ln({programId:r.programId,keys:a,data:s})}function Xm({poolKeys:o,userKeys:e,maxAmountIn:t,amountOut:n},i){let r=We(o),s=Buffer.alloc(Gr.span);Gr.encode({instruction:11,maxAmountIn:j(t),amountOut:j(n)},s);let a=[k({pubkey:fi,isWritable:!1}),k({pubkey:r.id}),k({pubkey:r.authority,isWritable:!1}),k({pubkey:r.openOrders}),k({pubkey:r.targetOrders}),k({pubkey:r.vault.A}),k({pubkey:r.vault.B})];return i===5&&a.push(k({pubkey:Rn})),a.push(k({pubkey:r.marketProgramId,isWritable:!1}),k({pubkey:r.marketId}),k({pubkey:r.marketBids}),k({pubkey:r.marketAsks}),k({pubkey:r.marketEventQueue}),k({pubkey:r.marketBaseVault}),k({pubkey:r.marketQuoteVault}),k({pubkey:r.marketAuthority,isWritable:!1}),k({pubkey:e.tokenAccountIn}),k({pubkey:e.tokenAccountOut}),k({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Ln({programId:r.programId,keys:a,data:s})}function ho(o){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:r,fixedSide:s}=o;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return Gm(F(R({},a),{amountIn:i,minAmountOut:r}),t);if(s==="out")return Xm(F(R({},a),{maxAmountIn:i,amountOut:r}),t);iu.logWithError("invalid params","params",o)}throw iu.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}import{PublicKey as Ym}from"@solana/web3.js";import Pk from"bn.js";import{TOKEN_PROGRAM_ID as jm}from"@solana/spl-token";import{PublicKey as zm}from"@solana/web3.js";var Qm=se("Raydium_liquidity_serum");function su({programId:o,marketId:e}){let t=[e.toBuffer()],n=0,i;for(;n<100;){try{let r=t.concat(Buffer.from([n]),Buffer.alloc(7));i=zm.createProgramAddressSync(r,o)}catch(r){if(r instanceof TypeError)throw r;n++;continue}return{publicKey:i,nonce:n}}throw Qm.logWithError("unable to find a viable program address nonce","params",{programId:o,marketId:e}),new Error("unable to find a viable program address nonce")}function ko({programId:o}){let{publicKey:e}=ce([Buffer.from("amm_config_account_seed","utf-8")],o);return e}function dn({name:o,programId:e,marketId:t}){let{publicKey:n}=ce([e.toBuffer(),t.toBuffer(),Buffer.from(o,"utf-8")],e);return n}function Hm({programId:o,marketId:e}){let{publicKey:t}=ce([o.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],o);return t}function Hr({programId:o}){return ce([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],o)}function au({version:o,marketVersion:e,marketId:t,baseMint:n,quoteMint:i,baseDecimals:r,quoteDecimals:s,programId:a,marketProgramId:u}){let c=dn({name:"amm_associated_seed",programId:a,marketId:t}),l=dn({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=Hr({programId:a}),p=dn({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=dn({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=dn({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=Hm({programId:a,marketId:t}),g=dn({name:"target_associated_seed",programId:a,marketId:t}),P=dn({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:A}=su({programId:u,marketId:t});return{id:c,baseMint:n,quoteMint:i,lpMint:l,baseDecimals:r,quoteDecimals:s,lpDecimals:r,version:o,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:y,lpVault:f,openOrders:b,targetOrders:g,withdrawQueue:P,marketVersion:e,marketProgramId:u,marketId:t,marketAuthority:A,lookupTableAccount:Ym.default,configId:ko({programId:a})}}var jr={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},To=o=>{let e={},t=jm.toBase58();return Object.keys(o).map(n=>{let i=o[n],[r,s]=[i.baseMint.toBase58(),i.quoteMint.toBase58()];e[n]={id:n,version:4,status:i.status.toNumber(),programId:i.programId.toBase58(),mintA:Ze({address:r,programId:t,decimals:i.baseDecimal.toNumber()}),mintB:Ze({address:s,programId:t,decimals:i.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:i.poolPrice.toNumber(),mintAmountA:new O(i.mintAAmount.toString()).div(10**i.baseDecimal.toNumber()).toNumber(),mintAmountB:new O(i.mintBAmount.toString()).div(10**i.quoteDecimal.toNumber()).toNumber(),baseReserve:i.baseReserve,quoteReserve:i.quoteReserve,feeRate:new O(i.tradeFeeNumerator.toString()).div(i.tradeFeeDenominator.toString()).toNumber(),openTime:i.poolOpenTime.toString(),tvl:0,day:jr,week:jr,month:jr,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:i.marketId.toBase58(),configId:ko({programId:i.programId}).toBase58(),lpPrice:0,lpAmount:0,lpMint:Ze({address:i.lpMint.toBase58(),programId:t,decimals:Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())}),burnPercent:0}}),e};import Ee from"bn.js";var yi=class extends Ie{constructor(t){super(t);this.stableLayout=new pi({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:t,amount:n,slippage:i,baseIn:r}){let s=new Ee(new O(n).mul(10**t[r?"mintA":"mintB"].decimals).toFixed(0)),a=wo(t[r?"mintB":"mintA"]),[u,c]=[new Ee(new O(t.mintAmountA).mul(10**t.mintA.decimals).toString()),new Ee(new O(t.mintAmountB).mul(10**t.mintB.decimals).toString())],l=new Ee(new O(t.lpAmount).mul(10**t.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",u.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",r?t.mintA.symbol:t.mintB.symbol,"amountIn:",s.toString(),"anotherToken:",r?t.mintB.symbol:t.mintA.symbol,"slippage:",`${i.toSignificant()}%`,"baseReserve",u.toString(),"quoteReserve",c.toString());let m=r?"base":"quote";this.logDebug("input side:",m);let d=ct;s.isZero()||(d=m==="base"?qi(s.mul(c),u):qi(s.mul(u),c)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",l.toString());let p=qi(s.mul(l),m==="base"?u:c);this.logDebug("liquidity:",p.toString());let y=new ve(new Ee(1)).add(i),f=new ve(new Ee(1)).sub(i),b=y.mul(d).quotient,g=f.mul(d).quotient,P=new fe(a,d),A=new fe(a,b),h=new fe(a,g);return this.logDebug("anotherAmount:",P.toFixed(),"maxAnotherAmount:",A.toFixed()),{anotherAmount:P,maxAnotherAmount:A,minAnotherAmount:h,liquidity:p}}async getAmmPoolKeys(t){return(await this.scope.api.fetchPoolKeysById({idList:[t]}))[0]}async addLiquidity(t){let{poolInfo:n,poolKeys:i,amountInA:r,amountInB:s,otherAmountMin:a,fixedSide:u,config:c,txVersion:l,computeBudgetConfig:m}=t;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",r,"amountInB:",s),(r.isZero()||s.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:r.toFixed(),amountInB:s.toFixed()});let{account:d}=this.scope,{bypassAssociatedCheck:p,checkCreateATAOwner:y}=R({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),[f,b]=[r.token,s.token],g=await d.getCreatedTokenAccount({mint:f.mint,associatedOnly:!1}),P=await d.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1});!g&&!P&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",d.tokenAccounts);let A=await d.getCreatedTokenAccount({mint:new Qe(n.lpMint.address)}),h=[f,b],I=[g,P],T=[r.raw,s.raw],S=r.token.mint.toBase58()===n.mintA.address?"base":"quote",B="base";["quote","base"].includes(S)||this.logAndCreateError("invalid fixedSide","fixedSide",u),S==="quote"?(h.reverse(),I.reverse(),T.reverse(),B=u==="a"?"quote":"base"):S==="base"&&(B=u==="a"?"base":"quote");let[C,x]=h,[L,W]=I,[N,Z]=T,G=i!=null?i:await this.getAmmPoolKeys(n.id),D=this.createTxBuilder(),wn=await d.handleTokenAccount({side:"in",amount:N,mint:C.mint,tokenAccount:L,bypassAssociatedCheck:p,checkCreateATAOwner:y}),{tokenAccount:je}=wn,bn=Ce(wn,["tokenAccount"]);D.addInstruction(bn);let Si=await d.handleTokenAccount({side:"in",amount:Z,mint:x.mint,tokenAccount:W,bypassAssociatedCheck:p,checkCreateATAOwner:y}),{tokenAccount:nn}=Si,Dt=Ce(Si,["tokenAccount"]);D.addInstruction(Dt);let Ki=await d.handleTokenAccount({side:"out",amount:0,mint:new Qe(n.lpMint.address),tokenAccount:A,bypassAssociatedCheck:p,checkCreateATAOwner:y}),{tokenAccount:gn}=Ki,Wt=Ce(Ki,["tokenAccount"]);return D.addInstruction(Wt),D.addInstruction({instructions:[ou({poolInfo:n,poolKeys:G,userKeys:{baseTokenAccount:je,quoteTokenAccount:nn,lpTokenAccount:gn,owner:this.scope.ownerPubKey},baseAmountIn:N,quoteAmountIn:Z,otherAmountMin:a.raw,fixedSide:B})],instructionTypes:[n.pooltype.includes("StablePool")?V.AmmV5AddLiquidity:V.AmmV4AddLiquidity],lookupTableAddress:G.lookupTableAccount?[G.lookupTableAccount]:[]}),D.addCustomComputeBudget(m),l===0&&await D.buildV0(),D.build()}async removeLiquidity(t){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:n,poolKeys:i,lpAmount:r,baseAmountMin:s,quoteAmountMin:a,config:u,txVersion:c,computeBudgetConfig:l}=t,m=i!=null?i:await this.getAmmPoolKeys(n.id),[d,p,y]=[new Qe(n.mintA.address),new Qe(n.mintB.address),new Qe(n.lpMint.address)];this.logDebug("lpAmount:",r),this.logDebug("baseAmountMin:",s),this.logDebug("quoteAmountMin:",a),r.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",r.toString());let{account:f}=this.scope,b=await f.getCreatedTokenAccount({mint:y,associatedOnly:!1});b||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",f.tokenAccounts);let g=await f.getCreatedTokenAccount({mint:d}),P=await f.getCreatedTokenAccount({mint:p}),A=this.createTxBuilder(),{bypassAssociatedCheck:h,checkCreateATAOwner:I}=R({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},u),x=await f.handleTokenAccount({side:"out",amount:0,mint:d,tokenAccount:g,bypassAssociatedCheck:h,checkCreateATAOwner:I}),{tokenAccount:T}=x,S=Ce(x,["tokenAccount"]);A.addInstruction(S);let L=await f.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:P,bypassAssociatedCheck:h,checkCreateATAOwner:I}),{tokenAccount:B}=L,C=Ce(L,["tokenAccount"]);return A.addInstruction(C),A.addInstruction({instructions:[Yr({poolInfo:n,poolKeys:m,userKeys:{lpTokenAccount:b,baseTokenAccount:T,quoteTokenAccount:B,owner:this.scope.ownerPubKey},lpAmount:r,baseAmountMin:s,quoteAmountMin:a})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity]}),A.addCustomComputeBudget(l),c===0?await A.buildV0():A.build()}async removeAllLpAndCreateClmmPosition({poolInfo:t,clmmPoolInfo:n,removeLpAmount:i,createPositionInfo:r,farmInfo:s,userFarmLpAmount:a,base:u,computeBudgetConfig:c,payer:l,userAuxiliaryLedgers:m,tokenProgram:d=On,checkCreateATAOwner:p=!0,getEphemeralSigners:y,txVersion:f}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(t.mintA.address===n.mintA.address||t.mintA.address===n.mintB.address)||!(t.mintB.address===n.mintA.address||t.mintB.address===n.mintB.address))throw Error("mint check error");let b=this.createTxBuilder();b.addCustomComputeBudget(c);let g={};for(let D of this.scope.account.tokenAccountRawInfos)(g[D.accountInfo.mint.toString()]===void 0||Pe(this.scope.ownerPubKey,D.accountInfo.mint,On).publicKey.equals(D.pubkey))&&(g[D.accountInfo.mint.toString()]=D.pubkey);let P=g[t.lpMint.address];if(P===void 0)throw Error("find lp account error in trade accounts");let A=i.add(a!=null?a:new Ee(0)),h=t.mintA.address===Te.WSOL.mint.toString(),I=t.mintB.address===Te.WSOL.mint.toString(),{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:On,mint:new Qe(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:p});if(b.addInstruction(S||{}),T===void 0)throw new Error("base token account not found");let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:On,mint:new Qe(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:I?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:!0,checkCreateATAOwner:p});if(b.addInstruction(C||{}),B===void 0)throw new Error("quote token account not found");if(g[t.mintA.address]=T,g[t.mintB.address]=B,s!==void 0&&!(a!=null&&a.isZero())){let D=lt[s.programId],je=mt({programId:new Qe(s.programId),poolId:new Qe(s.id),owner:this.scope.ownerPubKey,version:D}),bn,nn=await this.scope.connection.getAccountInfo(je);if(nn&&(bn=ei(D).decode(nn.data)),D!==6&&!bn){let{instruction:qt,instructionType:Fo}=ti({id:new Qe(s.id),programId:new Qe(s.programId),version:D,ledger:je,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[qt],instructionTypes:[Fo]})}let Dt=[];for(let qt of s.rewardInfos){let Fo=qt.mint.address===Te.WSOL.mint.toString();if(g[qt.mint.address])Dt.push(g[qt.mint.address]);else{let{account:as,instructionParams:us}=await this.scope.account.getOrCreateTokenAccount({mint:new Qe(qt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!Fo,createInfo:{payer:l||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:p});as||this.logAndCreateError("farm reward account not found:",qt.mint.address),us&&b.addInstruction(us),Dt.push(as)}}let gn=(await this.scope.api.fetchFarmKeysById({ids:s.id}))[0],Wt={userAuxiliaryLedgers:m,amount:a,owner:this.scope.ownerPubKey,farmInfo:s,farmKeys:gn,lpAccount:P,rewardAccounts:Dt},wn=lt[s.programId],Si=wn===6?ni(Wt):wn===5?ii(Wt):oi(Wt),Ki={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};b.addInstruction({instructions:[Si],instructionTypes:[Ki[wn]]})}let x=await this.getAmmPoolKeys(t.id),L=Yr({poolInfo:t,poolKeys:x,userKeys:{lpTokenAccount:P,baseTokenAccount:T,quoteTokenAccount:B,owner:this.scope.ownerPubKey},lpAmount:A,baseAmountMin:0,quoteAmountMin:0});b.addInstruction({instructions:[L],instructionTypes:[t.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity],lookupTableAddress:x.lookupTableAccount?[x.lookupTableAccount]:[]});let[W,N]=t.mintA.address===n.mintA.address?[T,B]:[B,T],Z=await this.scope.clmm.getClmmPoolKeys(n.id),G=await Ae.openPositionFromBaseInstructions(F(R({poolInfo:n,poolKeys:Z,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:W,tokenAccountB:N},withMetadata:"create"},r),{base:u,getEphemeralSigners:y}));return b.addInstruction({instructions:[...G.instructions],signers:G.signers,instructionTypes:[...G.instructionTypes],lookupTableAddress:Z.lookupTableAccount?[Z.lookupTableAccount]:[]}),f===0?b.sizeCheckBuildV0():b.sizeCheckBuild()}async createPoolV4({programId:t,marketInfo:n,baseMintInfo:i,quoteMintInfo:r,baseAmount:s,quoteAmount:a,startTime:u,ownerInfo:c,associatedOnly:l=!1,checkCreateATAOwner:m=!1,tokenProgram:d,txVersion:p,feeDestinationId:y,computeBudgetConfig:f}){var W;let b=c.feePayer||((W=this.scope.owner)==null?void 0:W.publicKey),g=c.useSOLBalance&&i.mint.equals(uu),P=c.useSOLBalance&&r.mint.equals(uu),A=this.createTxBuilder(),{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:g?{payer:b,amount:s}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:l,checkCreateATAOwner:m});A.addInstruction(I||{});let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:P?{payer:b,amount:a}:void 0,notUseTokenAccount:P,skipCloseAccount:!P,associatedOnly:P?!1:l,checkCreateATAOwner:m});if(A.addInstruction(S||{}),h===void 0||T===void 0)throw Error("you don't has some token account");let B=au({version:4,marketVersion:3,marketId:n.marketId,baseMint:i.mint,quoteMint:r.mint,baseDecimals:i.decimals,quoteDecimals:r.decimals,programId:t,marketProgramId:n.programId}),C={programId:t,ammId:B.id,ammAuthority:B.authority,ammOpenOrders:B.openOrders,lpMint:B.lpMint,coinMint:B.baseMint,pcMint:B.quoteMint,coinVault:B.baseVault,pcVault:B.quoteVault,withdrawQueue:B.withdrawQueue,ammTargetOrders:B.targetOrders,poolTempLp:B.lpVault,marketProgramId:B.marketProgramId,marketId:B.marketId,ammConfigId:B.configId,feeDestinationId:y},{instruction:x,instructionType:L}=ru(F(R({},C),{userWallet:this.scope.ownerPubKey,userCoinVault:h,userPcVault:T,userLpVault:Pe(this.scope.ownerPubKey,B.lpMint,d).publicKey,nonce:B.nonce,openTime:u,coinAmount:s,pcAmount:a}));return A.addInstruction({instructions:[x],instructionTypes:[L]}),A.addCustomComputeBudget(f),A.versionBuild({txVersion:p,extInfo:{address:C}})}async getCreatePoolFee({programId:t}){let n=ko({programId:t}),i=await this.scope.connection.getAccountInfo(n,{dataSlice:{offset:536,length:8}});if(i===null)throw Error("get config account error");return Za.decode(i.data).fee}computeAmountOut({poolInfo:t,amountIn:n,mintIn:i,mintOut:r,slippage:s}){let[a,u]=[i.toString(),r.toString()];if(a!==t.mintA.address&&a!==t.mintB.address)throw new Error("toke not match");if(u!==t.mintA.address&&u!==t.mintB.address)throw new Error("toke not match");let{baseReserve:c,quoteReserve:l}=t,m=[c,l],d=[t.mintA.decimals,t.mintB.decimals],p=a==t.mintA.address?"base":"quote";p==="quote"&&(m.reverse(),d.reverse());let[y,f]=m,[b,g]=d,P=t.version===4,A;if(P)A=new O(f.toString()).div(10**g).div(new O(y.toString()).div(10**b));else{let N=nu(this.stableLayout.stableModelData,c.toNumber(),l.toNumber(),!1);p==="quote"?A=new O(1e6).div(N*1e6):A=new O(N*1e6).div(1e6)}let h=n,I=new Ee(0),T=new Ee(0);if(!h.isZero())if(P){T=Yt(h.mul(qr),Ao);let N=h.sub(T),Z=y.add(N);I=f.mul(N).div(Z)}else{T=h.mul(new Ee(2)).div(new Ee(1e4));let N=h.sub(T);p==="quote"?I=new Ee(eu(this.stableLayout.stableModelData,l.toNumber(),c.toNumber(),N.toNumber())):I=new Ee(tu(this.stableLayout.stableModelData,l.toNumber(),c.toNumber(),N.toNumber()))}let S=new Ee(new O(I.toString()).mul(1-s).toFixed(0)),B=I,C=S,x=new O(I.toString()).div(new O(h.sub(T).toString()).toFixed(0));!h.isZero()&&!I.isZero()&&(x=new O(I.toString()).div(10**g).div(new O(h.sub(T).toString()).div(10**b)));let L=A.sub(x).div(A).mul(100);return{amountOut:B,minAmountOut:C,currentPrice:A,executionPrice:x,priceImpact:L,fee:T}}computeAmountIn({poolInfo:t,amountOut:n,mintIn:i,mintOut:r,slippage:s}){let{baseReserve:a,quoteReserve:u}=t;i.toString()!==t.mintA.address&&i.toString()!==t.mintB.address&&this.logAndCreateError("mintIn does not match pool"),r.toString()!==t.mintA.address&&r.toString()!==t.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",a.toString()),this.logDebug("quoteReserve:",u.toString());let c=i.toString()===t.mintA.address,[l,m]=c?[t.mintA,t.mintB]:[t.mintB,t.mintA];this.logDebug("currencyOut:",m.symbol||m.address),this.logDebug("amountOut:",new O(n.toString()).div(10**m.decimals).toDecimalPlaces(m.decimals).toString(),l.symbol||l.address),this.logDebug("slippage:",`${s*100}%`);let d=[a,u],p=c?"quote":"base";p==="base"&&d.reverse(),this.logDebug("output side:",p);let[y,f]=d,b=new O(f.toString()).div(10**t[c?"mintB":"mintA"].decimals).div(new O(y.toString()).div(10**t[c?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${l.symbol||l.address} \u2248 ${b.toString()} ${m.symbol||m.address}`),this.logDebug("currentPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(b).toString()} ${l.symbol||l.address}`);let g=new Ee(0),P=n;if(!P.isZero()){P.gt(f)&&(P=f.sub(new Ee(1)));let C=f.sub(P);g=y.mul(P).div(C).mul(Ao).div(Ao.sub(qr))}let A=new Ee(new O(g.toString()).mul(1+s).toFixed(0)),h=g,I=A;this.logDebug("amountIn:",new O(h.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString()),this.logDebug("maxAmountIn:",new O(I.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString());let T=null;!g.isZero()&&!P.isZero()&&(T=new O(P.toString()).div(10**m.decimals).div(new O(g.toString()).div(10**l.decimals)),this.logDebug("executionPrice:",`1 ${m.symbol||m.address} \u2248 ${T.toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`),this.logDebug("executionPrice invert:",`1 ${m.symbol||m.address} \u2248 ${new O(1).div(T).toDecimalPlaces(Math.max(t.mintA.decimals,t.mintB.decimals)).toString()} ${l.symbol||l.address}`));let S=b.mul(h.toString()),B=S.sub(n.toString()).abs().div(S);return this.logDebug("priceImpact:",`${B.toString()}%`),{amountIn:h,maxAmountIn:I,currentPrice:b,executionPrice:T,priceImpact:B}}async swap({poolInfo:t,poolKeys:n,amountIn:i,amountOut:r,inputMint:s,fixedSide:a,txVersion:u,config:c,computeBudgetConfig:l}){let m=this.createTxBuilder(),{associatedOnly:d=!0,inputUseSolBalance:p=!0,outputUseSolBalance:y=!0}=c||{},[f,b]=s===t.mintA.address?[t.mintA,t.mintB]:[t.mintB,t.mintA],g=p&&f.address===z.toBase58(),P=y&&b.address===z.toBase58(),{account:A,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:On,mint:new Qe(f.address),owner:this.scope.ownerPubKey,createInfo:g?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!g,notUseTokenAccount:g,associatedOnly:d});m.addInstruction(h||{}),A||this.logAndCreateError("input token account not found",{token:f.symbol||f.address,tokenAccountIn:A,inputTokenUseSolBalance:g,associatedOnly:d});let{account:I,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:On,mint:new Qe(b.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!P,notUseTokenAccount:P,associatedOnly:P?!1:d});m.addInstruction(T||{}),I===void 0&&this.logAndCreateError("output token account not found",{token:b.symbol||b.address,tokenAccountOut:I,outputTokenUseSolBalance:P,associatedOnly:d});let S=n||await this.getAmmPoolKeys(t.id),B=4;return t.pooltype.includes("StablePool")&&(B=5),m.addInstruction({instructions:[ho({version:B,poolKeys:S,userKeys:{tokenAccountIn:A,tokenAccountOut:I,owner:this.scope.ownerPubKey},amountIn:i,amountOut:r,fixedSide:a})],instructionTypes:[B===4?V.AmmV4SwapBaseIn:V.AmmV5SwapBaseIn]}),m.addCustomComputeBudget(l),m.versionBuild({txVersion:u})}async getRpcPoolInfo(t){return(await this.getRpcPoolInfos([t]))[t]}async getRpcPoolInfos(t,n){let i=await _e(this.scope.connection,t.map(l=>({pubkey:new Qe(l)})),n),r={},s=[];for(let l=0;l<t.length;l++){let m=i[l];if(m===null||!m.accountInfo)throw Error("fetch pool info error: "+String(t[l]));let d=Po.decode(m.accountInfo.data);r[String(t[l])]=F(R({},d),{programId:m.accountInfo.owner}),s.push(d.baseVault,d.quoteVault)}let a={},u=await _e(this.scope.connection,s.map(l=>({pubkey:new Qe(l)})),n);for(let l=0;l<s.length;l++){let m=u[l].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[l]);a[String(s[l])]=new Ee(Zm.decode(m.data).amount.toString())}let c={};for(let[l,m]of Object.entries(r)){let d=a[m.baseVault.toString()].sub(m.baseNeedTakePnl),p=a[m.quoteVault.toString()].sub(m.quoteNeedTakePnl);c[l]=F(R({},m),{baseReserve:d,mintAAmount:a[m.baseVault.toString()],mintBAmount:a[m.quoteVault.toString()],quoteReserve:p,poolPrice:new O(p.toString()).div(new O(10).pow(m.quoteDecimal.toString())).div(new O(d.toString()).div(new O(10).pow(m.baseDecimal.toString())))})}return c}async getPoolInfoFromRpc({poolId:t}){let n=await this.getRpcPoolInfo(t),i=To({[t]:n}),r=i[t],s=await this.scope.tradeV2.computePoolToPoolKeys({pools:[i[t]],ammRpcData:{[t]:n}});return{poolRpcData:n,poolInfo:r,poolKeys:s[0]}}};import{PublicKey as ie}from"@solana/web3.js";import it from"bn.js";import{AccountLayout as cu,TOKEN_PROGRAM_ID as lu}from"@solana/spl-token";var bi=class extends Ie{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){var A;let{programId:t,owner:n=((A=this.scope.owner)==null?void 0:A.publicKey)||ie.default,mint1:i,mint2:r,ammConfig:s,initialPrice:a,startTime:u,computeBudgetConfig:c,forerunCreate:l,getObserveState:m,txVersion:d}=e,p=this.createTxBuilder(),[y,f,b]=new it(new ie(i.address).toBuffer()).gt(new it(new ie(r.address).toBuffer()))?[r,i,new O(1).div(a)]:[i,r,a],g=te.priceToSqrtPriceX64(b,y.decimals,f.decimals),P=await Ae.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:y,mintB:f,ammConfigId:s.id,initialPriceX64:g,startTime:u,forerunCreate:!m&&l});return p.addInstruction(P),p.addCustomComputeBudget(c),p.versionBuild({txVersion:d,extInfo:{address:F(R({},P.address),{programId:t.toString(),id:P.address.poolId.toString(),mintA:y,mintB:f,openTime:u.toString(),vault:{A:P.address.mintAVault.toString(),B:P.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}}),mockPoolInfo:R({type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:P.address.poolId.toString(),mintA:y,mintB:f,feeRate:s.tradeFeeRate,openTime:u.toString(),programId:t.toString(),price:b.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0},Ma),forerunCreate:l}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",getEphemeralSigners:d,computeBudgetConfig:p,txVersion:y}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let f=this.createTxBuilder(),b=null,g=null,P=n.useSOLBalance&&e.mintA.address===z.toString(),A=n.useSOLBalance&&e.mintB.address===z.toString(),[h,I]=s==="MintA"?[a,u]:[u,a],{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:P||h.isZero()?{payer:this.scope.ownerPubKey,amount:h}:void 0,skipCloseAccount:!P,notUseTokenAccount:P,associatedOnly:P?!1:c,checkCreateATAOwner:l});T&&(b=T),f.addInstruction(S||{});let{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:A||I.isZero()?{payer:this.scope.ownerPubKey,amount:I}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:c,checkCreateATAOwner:l});B&&(g=B),f.addInstruction(C||{}),(!b||!g)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:b==null?void 0:b.toBase58(),ownerTokenAccountB:g==null?void 0:g.toBase58()});let x=t||await this.getClmmPoolKeys(e.id),L=await Ae.openPositionFromBaseInstructions({poolInfo:e,poolKeys:x,ownerInfo:F(R({},n),{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g}),tickLower:i,tickUpper:r,base:s,baseAmount:a,otherAmountMax:u,withMetadata:m,getEphemeralSigners:d});return f.addInstruction(L),f.addCustomComputeBudget(p),f.versionBuild({txVersion:y,extInfo:R({},L.address)})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:i,amountMaxB:r,tickLower:s,tickUpper:a,liquidity:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,computeBudgetConfig:p,getEphemeralSigners:y}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let f=this.createTxBuilder(),b=null,g=null,P=n.useSOLBalance&&e.mintA.address===z.toBase58(),A=n.useSOLBalance&&e.mintB.address===z.toBase58(),{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:P||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!P,notUseTokenAccount:P,associatedOnly:P?!1:c,checkCreateATAOwner:l});h&&(b=h),f.addInstruction(I||{});let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:A||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:A?!1:c,checkCreateATAOwner:l});T&&(g=T),f.addInstruction(S||{}),(b===void 0||g===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let B=t||await this.getClmmPoolKeys(e.id),C=await Ae.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:B,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},tickLower:s,tickUpper:a,liquidity:u,amountMaxA:i,amountMaxB:r,withMetadata:m,getEphemeralSigners:y});return f.addInstruction(C),f.addCustomComputeBudget(p),f.versionBuild({txVersion:d,extInfo:{address:C.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:i,amountMaxA:r,amountMaxB:s,liquidity:a,ownerInfo:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txVersion:d}=e,p=this.createTxBuilder(),y,f,b=u.useSOLBalance&&t.mintA.address===z.toString(),g=u.useSOLBalance&&t.mintB.address===z.toString(),{account:P,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ie(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:b||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!b,associatedOnly:b?!1:c,checkCreateATAOwner:l});P&&(y=P),p.addInstruction(A||{});let{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ie(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:g||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:g,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:l});h&&(f=h),p.addInstruction(I||{}),!y&&!f&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let T=n!=null?n:await this.getClmmPoolKeys(t.id),S=Ae.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:T,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:f},liquidity:a,amountMaxA:r,amountMaxB:s});return p.addInstruction(S),p.addCustomComputeBudget(m),p.versionBuild({txVersion:d,extInfo:{address:S.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:i,baseAmount:r,otherAmountMax:s,ownerInfo:a,associatedOnly:u=!0,checkCreateATAOwner:c=!1,computeBudgetConfig:l,txVersion:m}=e,d=this.createTxBuilder(),p,y,f=a.useSOLBalance&&t.mintA.address===z.toString(),b=a.useSOLBalance&&t.mintB.address===z.toString(),{account:g,instructionParams:P}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ie(t.mintA.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f||(i==="MintA"?r:s).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?r:s}:void 0,skipCloseAccount:!f,associatedOnly:f?!1:u,checkCreateATAOwner:c});g&&(p=g),d.addInstruction(P||{});let{account:A,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ie(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:b||(i==="MintA"?s:r).isZero()?{payer:this.scope.ownerPubKey,amount:i==="MintA"?s:r}:void 0,notUseTokenAccount:b,skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:c});A&&(y=A),d.addInstruction(h||{}),!p&&!y&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let I=await this.getClmmPoolKeys(t.id),T=Ae.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:I,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:p,tokenAccountB:y},base:i,baseAmount:r,otherAmountMax:s});return d.addInstruction(T),d.addCustomComputeBudget(l),d.versionBuild({txVersion:m,extInfo:{address:T.address}})}async decreaseLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:i,ownerInfo:r,amountMinA:s,amountMinB:a,liquidity:u,associatedOnly:c=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txVersion:d}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let p=this.createTxBuilder(),y=r.useSOLBalance&&t.mintA.address===z.toString(),f=r.useSOLBalance&&t.mintB.address===z.toString(),b,g,{account:P,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new ie(t.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,associatedOnly:y?!1:c,checkCreateATAOwner:l});b=P,A&&p.addInstruction(A);let{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new ie(t.mintB.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,associatedOnly:f?!1:c,checkCreateATAOwner:l});g=h,I&&p.addInstruction(I);let T=[];for(let x of t.rewardDefaultInfos){let L=r.useSOLBalance&&x.mint.address===z.toString(),W;if(x.mint.address===t.mintA.address)W=b;else if(x.mint.address===t.mintB.address)W=g;else{let{account:N,instructionParams:Z}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(x.mint.programId),mint:new ie(x.mint.address),notUseTokenAccount:L,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!L,associatedOnly:L?!1:c,checkCreateATAOwner:l});W=N,Z&&p.addInstruction(Z)}T.push(W)}!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let S=n!=null?n:await this.getClmmPoolKeys(t.id),B=await Ae.decreaseLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:i,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g,rewardAccounts:T},liquidity:u,amountMinA:s,amountMinB:a});p.addInstruction({instructions:B.instructions,instructionTypes:[V.ClmmDecreasePosition]});let C=R({},B.address);if(r.closePosition){let x=await Ae.closePositionInstructions({poolInfo:t,poolKeys:S,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:i});p.addInstruction({endInstructions:x.instructions,endInstructionTypes:x.instructionTypes}),C=R(R({},C),x.address)}return p.addCustomComputeBudget(m),p.versionBuild({txVersion:d,extInfo:{address:C}})}async lockPosition(e){let{programId:t=zi,authProgramId:n=Qi,poolProgramId:i=Xi,ownerPosition:r,computeBudgetConfig:s,txVersion:a}=e,u=this.createTxBuilder(),c=await Ae.lockPositionInstruction({programId:t,authProgramId:n,poolProgramId:i,owner:this.scope.ownerPubKey,positionNft:r.nftMint});return u.addInstruction({instructions:[c],instructionTypes:[V.ClmmLockPosition]}),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a})}async harvestLockPosition(e){let{programId:t=zi,authProgramId:n=Qi,ownerPosition:i,ownerInfo:r={useSOLBalance:!0},associatedOnly:s=!0,checkCreateATAOwner:a=!1,computeBudgetConfig:u,txVersion:c}=e,l=await this.getClmmPoolKeys(i.poolId.toString()),m=this.createTxBuilder(),d=r.useSOLBalance&&l.mintA.address===z.toString(),p=r.useSOLBalance&&l.mintB.address===z.toString(),y,f,{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.mintA.programId,mint:new ie(l.mintA.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!d,associatedOnly:d?!1:s,checkCreateATAOwner:a});y=b,g&&m.addInstruction(g);let{account:P,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.mintB.programId,mint:new ie(l.mintB.address),notUseTokenAccount:p,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!p,associatedOnly:p?!1:s,checkCreateATAOwner:a});f=P,A&&m.addInstruction(A);let h={},I=[];for(let S of l.rewardInfos){let B=r.useSOLBalance&&S.mint.address===z.toString(),C=h[S.mint.address];if(!C){let{account:x,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(S.mint.programId),mint:new ie(S.mint.address),notUseTokenAccount:B,owner:this.scope.ownerPubKey,skipCloseAccount:!B,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:B?!1:s});C=x,L&&m.addInstruction(L)}h[S.mint.address]=C,I.push(C)}let T=await Ae.harvestLockPositionInstruction({programId:t,authProgramId:n,poolKeys:l,ownerPosition:i,owner:this.scope.ownerPubKey,ownerRewardAccounts:I,userVaultA:y,userVaultB:f});return m.addInstruction({instructions:[T],instructionTypes:[V.ClmmHarvestLockPosition]}),m.addCustomComputeBudget(u),m.versionBuild({txVersion:c})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:i}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let r=this.createTxBuilder(),s=t!=null?t:await this.getClmmPoolKeys(e.id),a=Ae.closePositionInstructions({poolInfo:e,poolKeys:s,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n});return r.addInstruction(a).versionBuild({txVersion:i,extInfo:{address:a.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.address.toString()===z.toString(),l=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(n.mint.address),mint:new ie(n.mint.address),notUseTokenAccount:!!c,skipCloseAccount:!c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new it(new O(l.toFixed(0)).gte(l)?l.toFixed(0):l.add(1).toFixed(0))}:void 0,associatedOnly:c?!1:i,checkCreateATAOwner:r});d&&u.addInstruction(d),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let p=await this.getClmmPoolKeys(e.id),y=Ae.initRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new ie(n.mint.programId),mint:new ie(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ne.decimalToX64(n.perSecond)}});return u.addInstruction(y),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:y.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txVersion:u}){for(let m of i)m.endTime<=m.openTime&&this.logAndCreateError("reward time error","rewardInfo",m);let c=this.createTxBuilder(),l={};for(let m of i){let d=n.useSOLBalance&&m.mint.address===z.toString(),p=m.perSecond.mul(m.endTime-m.openTime),{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(m.mint.programId),mint:new ie(m.mint.address),notUseTokenAccount:!!d,skipCloseAccount:!d,owner:this.scope.ownerPubKey,createInfo:d?{payer:n.feePayer||this.scope.ownerPubKey,amount:new it(new O(p.toFixed(0)).gte(p)?p.toFixed(0):p.add(1).toFixed(0))}:void 0,associatedOnly:d?!1:r,checkCreateATAOwner:s});f&&c.addInstruction(f),y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let b=t!=null?t:await this.getClmmPoolKeys(e.id),g=Ae.initRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardInfo:{programId:new ie(m.mint.programId),mint:new ie(m.mint.address),openTime:m.openTime,endTime:m.endTime,emissionsPerSecondX64:ne.decimalToX64(m.perSecond)}});l=R(R({},l),g.address),c.addInstruction(g)}return c.addCustomComputeBudget(a),c.versionBuild({txVersion:u,extInfo:{address:l}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txVersion:a}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(),c=t.useSOLBalance&&n.mint.equals(z),{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:c,owner:this.scope.ownerPubKey,createInfo:c?{payer:t.feePayer||this.scope.ownerPubKey,amount:new it(new O(n.perSecond.sub(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.sub(n.endTime-n.openTime))?n.perSecond.sub(n.endTime-n.openTime).toFixed(0):n.perSecond.sub(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:c?!1:i,checkCreateATAOwner:r});m&&u.addInstruction(m),l||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let d=await this.getClmmPoolKeys(e.id),p=Ae.setRewardInstructions({poolInfo:e,poolKeys:d,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:l},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ne.decimalToX64(n.perSecond)}});return u.addInstruction(p),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:p.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txVersion:u}){let c=this.createTxBuilder(),l={};for(let m of i){m.endTime<=m.openTime&&this.logAndCreateError("reward time error","rewardInfo",m);let d=n.useSOLBalance&&m.mint.address===z.toString(),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(m.mint.programId),mint:new ie(m.mint.address),notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:d?{payer:n.feePayer||this.scope.ownerPubKey,amount:new it(new O(m.perSecond.sub(m.endTime-m.openTime).toFixed(0)).gte(m.perSecond.sub(m.endTime-m.openTime))?m.perSecond.sub(m.endTime-m.openTime).toFixed(0):m.perSecond.sub(m.endTime-m.openTime).add(1).toFixed(0))}:void 0,associatedOnly:d?!1:r,checkCreateATAOwner:s});y&&c.addInstruction(y),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=t!=null?t:await this.getClmmPoolKeys(e.id),b=Ae.setRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardInfo:{mint:new ie(m.mint.address),openTime:m.openTime,endTime:m.endTime,emissionsPerSecondX64:ne.decimalToX64(m.perSecond)}});c.addInstruction(b),l=R(R({},l),b.address)}return c.addCustomComputeBudget(a),c.versionBuild({txVersion:u,extInfo:{address:l}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1}){let s=e.rewardDefaultInfos.find(p=>p.mint.address===n.toString());s||this.logAndCreateError("reward mint error","not found reward mint",n);let a=this.createTxBuilder(),u=t.useSOLBalance&&n.equals(z),{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(s.mint.programId),mint:n,notUseTokenAccount:u,owner:this.scope.ownerPubKey,skipCloseAccount:!u,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:u?!1:i,checkCreateATAOwner:r});l&&a.addInstruction(l),c||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let m=await this.getClmmPoolKeys(e.id),d=Ae.collectRewardInstructions({poolInfo:e,poolKeys:m,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:c},rewardMint:n});return a.addInstruction(d),a.build({address:d.address})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:i=!0,checkCreateATAOwner:r=!1}){let s=this.createTxBuilder(),a={};for(let u of n){let c=e.rewardDefaultInfos.find(f=>f.mint.address===u.toString());if(!c){this.logAndCreateError("reward mint error","not found reward mint",u);continue}let l=t.useSOLBalance&&u.equals(z),{account:m,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(c.mint.programId),mint:u,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:l?!1:i,checkCreateATAOwner:r});m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),d&&s.addInstruction(d);let p=await this.getClmmPoolKeys(e.id),y=Ae.collectRewardInstructions({poolInfo:e,poolKeys:p,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardMint:u});s.addInstruction(y),a=R(R({},a),y.address)}return s.build({address:a})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:i,amountOutMin:r,priceLimit:s,observationId:a,ownerInfo:u,remainingAccounts:c,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p}){let y=this.createTxBuilder(),f=n.toString()===e.mintA.address,b=u.useSOLBalance&&e.mintA.address===z.toBase58(),g=u.useSOLBalance&&e.mintB.address===z.toBase58(),P;!s||s.equals(new O(0))?P=f?pt.add(new it(1)):ft.sub(new it(1)):P=te.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let A;if(!A){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:b||!f?{payer:u.feePayer||this.scope.ownerPubKey,amount:f?i:0}:void 0,associatedOnly:b?!1:l,checkCreateATAOwner:m});A=T,S&&y.addInstruction(S)}let h;if(!h){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,skipCloseAccount:!g,createInfo:g||f?{payer:u.feePayer||this.scope.ownerPubKey,amount:f?0:i}:void 0,associatedOnly:g?!1:l,checkCreateATAOwner:m});h=T,S&&y.addInstruction(S)}(!A||!h)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:A,ownerTokenAccountB:h,mintAUseSOLBalance:b,mintBUseSOLBalance:g,associatedOnly:l});let I=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(Ae.makeSwapBaseInInstructions({poolInfo:e,poolKeys:I,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:A,tokenAccountB:h},inputMint:new ie(n),amountIn:i,amountOutMin:r,sqrtPriceLimitX64:P,remainingAccounts:c})),y.addCustomComputeBudget(p),y.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:i,amountInMax:r,priceLimit:s,observationId:a,ownerInfo:u,remainingAccounts:c,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p}){let y=this.createTxBuilder(),f=n.toString()===e.mintB.address,b=u.useSOLBalance&&e.mintA.address===z.toBase58(),g=u.useSOLBalance&&e.mintB.address===z.toBase58(),P;!s||s.equals(new O(0))?P=n.toString()===e.mintB.address?pt.add(new it(1)):ft.sub(new it(1)):P=te.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let A;if(!A){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new ie(e.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,skipCloseAccount:!b,createInfo:b||!f?{payer:u.feePayer||this.scope.ownerPubKey,amount:f?r:0}:void 0,associatedOnly:b?!1:l,checkCreateATAOwner:m});A=T,S&&y.addInstruction(S)}let h;if(!h){let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new ie(e.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,skipCloseAccount:!g,createInfo:g||f?{payer:u.feePayer||this.scope.ownerPubKey,amount:f?0:r}:void 0,associatedOnly:g?!1:l,checkCreateATAOwner:m});h=T,S&&y.addInstruction(S)}(!A||!h)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:A,ownerTokenAccountB:h,mintAUseSOLBalance:b,mintBUseSOLBalance:g,associatedOnly:l});let I=t!=null?t:await this.getClmmPoolKeys(e.id);return y.addInstruction(Ae.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:I,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:A,tokenAccountB:h},outputMint:new ie(n),amountOut:i,amountInMax:r,sqrtPriceLimitX64:P,remainingAccounts:c})),y.addCustomComputeBudget(p),y.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:i,associatedOnly:r=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:u,computeBudgetConfig:c}){let l={};for(let d of this.scope.account.tokenAccountRawInfos)r?Pe(this.scope.ownerPubKey,d.accountInfo.mint,a).publicKey.equals(d.pubkey)&&(l[d.accountInfo.mint.toString()]=d.pubkey):l[d.accountInfo.mint.toString()]=d.pubkey;let m=this.createTxBuilder();for(let d of Object.values(e)){if(t[d.id]===void 0||!t[d.id].find(h=>!h.liquidity.isZero()||h.rewardInfos.find(I=>!I.rewardAmountOwed.isZero())))continue;let p=d,y=i.useSOLBalance&&p.mintA.address===z.toString(),f=i.useSOLBalance&&p.mintB.address===z.toString(),b=l[p.mintA.address];if(!b){let{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:p.mintA.programId,mint:new ie(p.mintA.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,skipCloseAccount:!y,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:y?!1:r,checkCreateATAOwner:s});b=h,I&&m.addInstruction(I)}let g=l[p.mintB.address];if(!g){let{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:p.mintB.programId,mint:new ie(p.mintB.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,skipCloseAccount:!f,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:f?!1:r,checkCreateATAOwner:s});g=h,I&&m.addInstruction(I)}l[p.mintA.address]=b,l[p.mintB.address]=g;let P=[];for(let h of p.rewardDefaultInfos){let I=i.useSOLBalance&&h.mint.address===z.toString(),T=l[h.mint.address];if(!T){let{account:S,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new ie(h.mint.programId),mint:new ie(h.mint.address),notUseTokenAccount:I,owner:this.scope.ownerPubKey,skipCloseAccount:!I,createInfo:{payer:i.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:I?!1:r});T=S,B&&m.addInstruction(B)}l[h.mint.address]=T,P.push(T)}let A=await this.getClmmPoolKeys(p.id);for(let h of t[d.id])if(n&&n[d.id]&&n[d.id][h.nftMint.toBase58()]){let I=Ae.harvestLockPositionInstruction({poolKeys:A,owner:this.scope.ownerPubKey,ownerPosition:h,ownerRewardAccounts:P,programId:zi,authProgramId:Qi,userVaultA:b,userVaultB:g});m.addInstruction({instructions:[I],instructionTypes:[V.ClmmHarvestLockPosition],lookupTableAddress:A.lookupTableAccount?[A.lookupTableAccount]:[]})}else{let I=Ae.decreaseLiquidityInstructions({poolInfo:p,poolKeys:A,ownerPosition:h,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g,rewardAccounts:P},liquidity:new it(0),amountMinA:new it(0),amountMinB:new it(0)});m.addInstruction(I)}}return u===0?m.sizeCheckBuildV0({computeBudgetConfig:c}):m.sizeCheckBuild({computeBudgetConfig:c})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(ui(e).publicKey);return t?za.decode(t.data).whitelistMints.filter(i=>!i.equals(ie.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new it(1))).map(s=>tt(new ie(e),s.accountInfo.mint).publicKey),i=await this.scope.connection.getMultipleAccountsInfo(n),r=[];return i.forEach(s=>{if(!s)return;let a=go.decode(s.data);r.push(a)}),r}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await _e(this.scope.connection,e.map(r=>({pubkey:new ie(r)})),t),i={};for(let r=0;r<e.length;r++){let s=n[r];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[r]));let a=un.decode(s.accountInfo.data),u=te.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();i[String(e[r])]=F(R({},a),{currentPrice:u,programId:s.accountInfo.owner})}return i}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(u=>e[u].ammConfig.toBase58())),i=await _e(this.scope.connection,Array.from(n).map(u=>({pubkey:new ie(u)}))),r={};i.forEach(u=>{!u.accountInfo||(r[u.pubkey.toBase58()]=Ga.decode(u.accountInfo.data))});let s=await xe.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(u=>{var m,d,p,y;let[c,l]=[e[u].mintA.toBase58(),e[u].mintB.toBase58()];return{id:u,programId:e[u].programId.toBase58(),mintA:Ze({address:c,decimals:e[u].mintDecimalsA,programId:t[c].programId.toBase58()||lu.toBase58(),extensions:{feeConfig:(m=t[c])!=null&&m.feeConfig?tn((d=t[c])==null?void 0:d.feeConfig):void 0}}),mintB:Ze({address:l,decimals:e[u].mintDecimalsB,programId:t[l].programId.toBase58()||lu.toBase58(),extensions:{feeConfig:(p=t[l])!=null&&p.feeConfig?tn((y=t[l])==null?void 0:y.feeConfig):void 0}}),price:e[u].currentPrice,config:F(R({},r[e[u].ammConfig.toBase58()]),{id:e[u].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]})}})}),a=await xe.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){var l;let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),i=await An({connection:this.scope.connection,mints:Array.from(n).map(m=>new ie(m))}),{computeClmmPoolInfo:r,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:i}),a=await _e(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),u=qa(r[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");u.mintAmountA=Number(cu.decode(a[0].accountInfo.data).amount.toString()),u.mintAmountB=Number(cu.decode((l=a[1].accountInfo)==null?void 0:l.data).amount.toString());let c=F(R({},r[e]),{id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},rewardInfos:[],config:u.config});return{poolInfo:u,poolKeys:c,computePoolInfo:r[e],tickData:s}}};import{PublicKey as Q}from"@solana/web3.js";import{AccountLayout as ud,NATIVE_MINT as Oo,TOKEN_PROGRAM_ID as Et}from"@solana/spl-token";import $r from"bn.js";import So from"decimal.js-light";import gi from"bn.js";function Io(o,e){if(e.isZero())throw Error("divisor is zero");return o.mod(e)}function $m(o,e){if(e.isZero())throw Error("rhs is zero");let t=o.div(e);if(t.isZero())throw Error("quotient is zero");let n=Io(o,e);return n.gt(Nn)&&(t=t.add(new gi(1)),e=o.div(t),n=Io(o,t),n.gt(Nn)&&(e=e.add(new gi(1)))),[t,e]}var Nn=new gi(0),Bo=class{static swapWithoutFees(e,t,n){let i=t.mul(n),r=t.add(e),[s,a]=$m(i,r),u=a.sub(t),c=n.sub(s);if(c.isZero())throw Error("destinationAmountSwapped is zero");return{sourceAmountSwapped:u,destinationAmountSwapped:c}}static lpTokensToTradingTokens(e,t,n,i,r){let s=e.mul(n).div(t),a=e.mul(i).div(t);if(r===0)return{tokenAmount0:s,tokenAmount1:a};if(r===1)return Io(e.mul(n),t).gt(Nn)&&s.gt(Nn)&&(s=s.add(new gi(1))),Io(e.mul(i),t).gt(Nn)&&a.gt(Nn)&&(a=a.add(new gi(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};import du from"bn.js";var Zr=new du(1e6);function Jm(o,e,t){return o.mul(e).add(t).sub(new du(1)).div(t)}function mu(o,e,t){return o.mul(e).div(t)}var xo=class{static tradingFee(e,t){return Jm(e,t,Zr)}static protocolFee(e,t){return mu(e,t,Zr)}static fundFee(e,t){return mu(e,t,Zr)}};var Ko=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,i){let r=xo.tradingFee(e,i),s=e.sub(r),{sourceAmountSwapped:a,destinationAmountSwapped:u}=Bo.swapWithoutFees(s,t,n),c=a.add(r);return{newSwapSourceAmount:t.add(c),newSwapDestinationAmount:n.sub(u),sourceAmountSwapped:c,destinationAmountSwapped:u,tradeFee:r}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:i,quoteReserve:r,outputMint:s,outputAmount:a}){let[u,c,l,m,d]=t.address===s.toString()?[i,r,e.decimals,t.decimals,e.address]:[r,i,t.decimals,e.decimals,t.address],p=new So(c.toString()).div(10**m).div(new So(u.toString()).div(10**l)),y=a.gte(c)?c.sub(new $r(1)):a,f=c.sub(y),b=Yt(u.mul(y),f),g=Yt(b.mul(new $r(1e6)),new $r(1e6).sub(n)),P=g.sub(b),A=new So(y.toString()).div(10**m).div(new So(g.toString()).div(10**l)),h=p.isZero()?0:A.sub(p).div(p).abs().toNumber();return{amountRealOut:y,amountIn:g,amountInWithoutFee:b,tradeFee:P,priceImpact:h}}};import Se from"bn.js";import{TransactionInstruction as wi}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as sd,TOKEN_2022_PROGRAM_ID as yu,TOKEN_PROGRAM_ID as es}from"@solana/spl-token";var ed=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),jT=Buffer.from("amm_config","utf8"),td=Buffer.from("pool","utf8"),nd=Buffer.from("pool_lp_mint","utf8"),id=Buffer.from("pool_vault","utf8"),od=Buffer.from("observation","utf8");function Mn(o){return ce([ed],o)}function Jr(o,e,t,n){return ce([td,e.toBuffer(),t.toBuffer(),n.toBuffer()],o)}function rd(o,e){return ce([nd,e.toBuffer()],o)}function pu(o,e,t){return ce([id,e.toBuffer(),t.toBuffer()],o)}function Co(o,e){return ce([od,e.toBuffer()],o)}function fu({poolId:o,programId:e,configId:t,mintA:n,mintB:i}){let r=Mn(e).publicKey,s=o||Jr(e,t,n,i).publicKey,a=rd(e,s).publicKey,u=pu(e,s,n).publicKey,c=pu(e,s,i).publicKey,l=Co(e,s).publicKey;return{poolId:s,configId:t,authority:r,lpMint:a,vaultA:u,vaultB:c,observationId:l}}var ad=se("Raydium_cpmm"),Ai={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173]};function bu(o,e,t,n,i,r,s,a,u,c,l,m,d,p,y,f,b,g,P,A){let h=E([w("amountMaxA"),w("amountMaxB"),w("openTime")]),I=Jr(o,t,r,s).publicKey,T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!i.equals(I),isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:es,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:sd,isSigner:!1,isWritable:!1},{pubkey:er,isSigner:!1,isWritable:!1},{pubkey:At,isSigner:!1,isWritable:!1}],S=Buffer.alloc(h.span);return h.encode({amountMaxA:g,amountMaxB:P,openTime:A},S),new wi({keys:T,programId:o,data:Buffer.from([...Ai.initialize,...S])})}function gu(o,e,t,n,i,r,s,a,u,c,l,m,d,p,y){let f=E([w("lpAmount"),w("amountMaxA"),w("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:es,isSigner:!1,isWritable:!1},{pubkey:yu,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return ad.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:y.toString()}),f.encode({lpAmount:d,amountMaxA:p,amountMaxB:y},g),new wi({keys:b,programId:o,data:Buffer.from([...Ai.deposit,...g])})}function wu(o,e,t,n,i,r,s,a,u,c,l,m,d,p,y){let f=E([w("lpAmount"),w("amountMinA"),w("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:es,isSigner:!1,isWritable:!1},{pubkey:yu,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:kn,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:d,amountMinA:p,amountMinB:y},g),new wi({keys:b,programId:o,data:Buffer.from([...Ai.withdraw,...g])})}function Ro(o,e,t,n,i,r,s,a,u,c,l,m,d,p,y,f){let b=E([w("amountIn"),w("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],P=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},P),new wi({keys:g,programId:o,data:Buffer.from([...Ai.swapBaseInput,...P])})}function Au(o,e,t,n,i,r,s,a,u,c,l,m,d,p,y,f){let b=E([w("amountInMax"),w("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],P=Buffer.alloc(b.span);return b.encode({amountInMax:y,amountOut:f},P),new wi({keys:g,programId:o,data:Buffer.from([...Ai.swapBaseOutput,...P])})}var Pu=E([be(8),U("bump"),Xe("disableCreatePool"),Ot("index"),w("tradeFeeRate"),w("protocolFeeRate"),w("fundFeeRate"),w("createPoolFee"),K("protocolOwner"),K("fundOwner"),X(w(),16)]),Lo=E([be(8),K("configId"),K("poolCreator"),K("vaultA"),K("vaultB"),K("mintLp"),K("mintA"),K("mintB"),K("mintProgramA"),K("mintProgramB"),K("observationId"),U("bump"),U("status"),U("lpDecimals"),U("mintDecimalA"),U("mintDecimalB"),w("lpAmount"),w("protocolFeesMintA"),w("protocolFeesMintB"),w("fundFeesMintA"),w("fundFeesMintB"),w("openTime"),X(w(),32)]);var Pi=class extends Ie{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t){return(await this.getRpcPoolInfos([e],t))[e]}async getRpcPoolInfos(e,t){let n=await _e(this.scope.connection,e.map(m=>({pubkey:new Q(m)}))),i={},r=new Set,s=[];for(let m=0;m<e.length;m++){let d=n[m];if(d.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let p=Lo.decode(d.accountInfo.data);i[String(e[m])]=F(R({},p),{programId:d.accountInfo.owner}),r.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let m=[...r],d=await _e(this.scope.connection,m.map(p=>({pubkey:new Q(p)})));for(let p=0;p<m.length;p++){let y=d[p].accountInfo;if(y===null)throw Error("fetch pool config error: "+m[p]);a[m[p]]=Pu.decode(y.data)}}let u={},c=await _e(this.scope.connection,s.map(m=>({pubkey:new Q(m)})));for(let m=0;m<s.length;m++){let d=c[m].accountInfo;if(d===null)throw Error("fetch vault info error: "+s[m]);u[String(s[m])]=new Se(ud.decode(d.data).amount.toString())}let l={};for(let[m,d]of Object.entries(i)){let p=u[d.vaultA.toString()].sub(d.protocolFeesMintA).sub(d.fundFeesMintA),y=u[d.vaultB.toString()].sub(d.protocolFeesMintB).sub(d.fundFeesMintB);l[m]=F(R({},d),{baseReserve:p,quoteReserve:y,vaultAAmount:u[d.vaultA.toString()],vaultBAmount:u[d.vaultB.toString()],configInfo:a[d.configId.toString()],poolPrice:new O(y.toString()).div(new O(10).pow(d.mintDecimalB)).div(new O(p.toString()).div(new O(10).pow(d.mintDecimalA)))})}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,i)=>{var u,c,l,m;let r=e[i],[s,a]=[r.mintA.toBase58(),r.mintB.toBase58()];return F(R({},n),{[i]:F(R({},r),{id:new Q(i),configInfo:r.configInfo,version:7,authority:Mn(r.programId).publicKey,mintA:Ze({address:s,decimals:r.mintDecimalA,programId:r.mintProgramA.toBase58(),extensions:{feeConfig:(u=t[s])!=null&&u.feeConfig?tn((c=t[s])==null?void 0:c.feeConfig):void 0}}),mintB:Ze({address:a,decimals:r.mintDecimalB,programId:r.mintProgramB.toBase58(),extensions:{feeConfig:(l=t[a])!=null&&l.feeConfig?tn((m=t[a])==null?void 0:m.feeConfig):void 0}})})})},{})}async getPoolInfoFromRpc(e){let t=await this.getRpcPoolInfo(e,!0),n=await An({connection:this.scope.connection,mints:[t.mintA,t.mintB]}),i=Ze({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?tn(n[t.mintA.toBase58()].feeConfig):void 0}}),r=Ze({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?tn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=Ze({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:Et.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},u={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:i,mintB:r,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new O(t.vaultAAmount.toString()).div(10**i.decimals).toNumber(),mintAmountB:new O(t.vaultBAmount.toString()).div(10**r.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:u,week:u,month:u,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:i,mintB:r,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Mn(t.programId).publicKey.toBase58(),mintLp:s,config:a},rpcData:t}}async createPool(d){var p=d,{poolId:e,programId:t,poolFeeAccount:n,startTime:i,ownerInfo:r,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:u,feeConfig:c,computeBudgetConfig:l}=p,m=Ce(p,["poolId","programId","poolFeeAccount","startTime","ownerInfo","associatedOnly","checkCreateATAOwner","txVersion","feeConfig","computeBudgetConfig"]);var Z,G,D;let y=r.feePayer||((Z=this.scope.owner)==null?void 0:Z.publicKey),f=new Se(new Q(m.mintA.address).toBuffer()).lte(new Se(new Q(m.mintB.address).toBuffer())),[b,g]=f?[m.mintA,m.mintB]:[m.mintB,m.mintA],[P,A]=f?[m.mintAAmount,m.mintBAmount]:[m.mintBAmount,m.mintAAmount],h=r.useSOLBalance&&b.address===Oo.toBase58(),I=r.useSOLBalance&&g.address===Oo.toBase58(),[T,S]=[new Q(b.address),new Q(g.address)],B=this.createTxBuilder(),{account:C,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({mint:T,tokenProgram:b.programId,owner:this.scope.ownerPubKey,createInfo:h?{payer:y,amount:P}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:s,checkCreateATAOwner:a});B.addInstruction(x||{});let{account:L,instructionParams:W}=await this.scope.account.getOrCreateTokenAccount({mint:new Q(g.address),tokenProgram:g.programId,owner:this.scope.ownerPubKey,createInfo:I?{payer:y,amount:A}:void 0,notUseTokenAccount:I,skipCloseAccount:!I,associatedOnly:I?!1:s,checkCreateATAOwner:a});if(B.addInstruction(W||{}),C===void 0||L===void 0)throw Error("you don't has some token account");let N=fu({poolId:e,programId:t,configId:new Q(c.id),mintA:T,mintB:S});return B.addInstruction({instructions:[bu(t,this.scope.ownerPubKey,new Q(c.id),N.authority,N.poolId,T,S,N.lpMint,C,L,Pe(this.scope.ownerPubKey,N.lpMint).publicKey,N.vaultA,N.vaultB,n,new Q((G=b.programId)!=null?G:Et),new Q((D=g.programId)!=null?D:Et),N.observationId,P,A,i)],instructionTypes:[V.CpmmCreatePool]}),B.addCustomComputeBudget(l),B.versionBuild({txVersion:u,extInfo:{address:F(R({},N),{mintA:b,mintB:g,programId:t,poolFeeAccount:n,feeConfig:c})}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:i,baseIn:r,slippage:s,computeResult:a,computeBudgetConfig:u,config:c,txVersion:l}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),i.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:i.toString()});let{account:m}=this.scope,{bypassAssociatedCheck:d,checkCreateATAOwner:p}=R({bypassAssociatedCheck:!1,checkCreateATAOwner:!1},c),y=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:f,inputAmountFee:b,anotherAmount:g}=a||this.computePairAmount({poolInfo:F(R({},t),{lpAmount:new O(y.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()}),baseReserve:y.baseReserve,quoteReserve:y.quoteReserve,slippage:new ve(0),baseIn:r,epochInfo:await this.scope.fetchEpochInfo(),amount:new O(i.toString()).div(10**(r?t.mintA.decimals:t.mintB.decimals))}),P=g.amount,A=t.mintA.address===Oo.toString(),h=t.mintB.address===Oo.toString(),I=this.createTxBuilder(),[T,S]=[new Q(t.mintA.address),new Q(t.mintB.address)],{account:B,instructionParams:C}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:A||(r?i:P).isZero()?{payer:this.scope.ownerPubKey,amount:r?i:P}:void 0,skipCloseAccount:!A,notUseTokenAccount:A,associatedOnly:!1,checkCreateATAOwner:p});I.addInstruction(C||{});let{account:x,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||(r?P:i).isZero()?{payer:this.scope.ownerPubKey,amount:r?P:i}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!1,checkCreateATAOwner:p});I.addInstruction(L||{}),!B&&!x&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",m.tokenAccounts);let W=await m.getCreatedTokenAccount({mint:new Q(t.lpMint.address)}),je=await m.handleTokenAccount({side:"out",amount:0,mint:new Q(t.lpMint.address),tokenAccount:W,bypassAssociatedCheck:d,checkCreateATAOwner:p}),{tokenAccount:N}=je,Z=Ce(je,["tokenAccount"]);I.addInstruction(Z);let G=n!=null?n:await this.getCpmmPoolKeys(t.id),D=new ve(new Se(1)).sub(s);return I.addInstruction({instructions:[gu(new Q(t.programId),this.scope.ownerPubKey,new Q(G.authority),new Q(t.id),N,B,x,new Q(G.vault.A),new Q(G.vault.B),T,S,new Q(t.lpMint.address),a?a==null?void 0:a.liquidity:D.mul(f).quotient,r?b.amount:P,r?P:b.amount)],instructionTypes:[V.CpmmAddLiquidity],lookupTableAddress:G.lookupTableAccount?[G.lookupTableAccount]:[]}),I.addCustomComputeBudget(u),I.versionBuild({txVersion:l})}async withdrawLiquidity(e){var N,Z;let{poolInfo:t,poolKeys:n,lpAmount:i,slippage:r,computeBudgetConfig:s,txVersion:a}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let u=new ve(new Se(1)).sub(r),c=await this.getRpcPoolInfo(t.id),[l,m]=[u.mul(i.mul(c.baseReserve).div(c.lpAmount)).quotient,u.mul(i.mul(c.quoteReserve).div(c.lpAmount)).quotient],d=await this.scope.fetchEpochInfo(),[p,y]=[ye(l,t.mintA.extensions.feeConfig,d,!1),ye(m,t.mintB.extensions.feeConfig,d,!1)],{account:f}=this.scope,b=this.createTxBuilder(),[g,P]=[new Q(t.mintA.address),new Q(t.mintB.address)],A=g.equals(z),h=P.equals(z),I,T,{account:S,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:A,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!A,associatedOnly:!A,checkCreateATAOwner:!1});I=S,B&&b.addInstruction(B);let{account:C,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!h,associatedOnly:!h,checkCreateATAOwner:!1});T=C,x&&b.addInstruction(x),(!I||!T)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",f.tokenAccounts);let L=await f.getCreatedTokenAccount({mint:new Q(t.lpMint.address)});L||this.logAndCreateError("cannot found lp token account","tokenAccounts",f.tokenAccounts);let W=n!=null?n:await this.getCpmmPoolKeys(t.id);return b.addInstruction({instructions:[wu(new Q(t.programId),this.scope.ownerPubKey,new Q(W.authority),new Q(t.id),L,I,T,new Q(W.vault.A),new Q(W.vault.B),g,P,new Q(t.lpMint.address),i,l.sub((N=p.fee)!=null?N:new Se(0)),m.sub((Z=y.fee)!=null?Z:new Se(0)))],instructionTypes:[V.CpmmWithdrawLiquidity],lookupTableAddress:W.lookupTableAccount?[W.lookupTableAccount]:[]}),b.addCustomComputeBudget(s),b.versionBuild({txVersion:a})}async swap(e){var C,x,L,W,N,Z;let{poolInfo:t,poolKeys:n,baseIn:i,fixedOut:r,inputAmount:s,swapResult:a,slippage:u=0,config:c,computeBudgetConfig:l,txVersion:m}=e,{bypassAssociatedCheck:d,checkCreateATAOwner:p,associatedOnly:y}=R({bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0},c),f=this.createTxBuilder(),[b,g]=[new Q(t.mintA.address),new Q(t.mintB.address)];r?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new Se((1+u)*1e4)).div(new Se(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new Se((1-u)*1e4)).div(new Se(1e4));let P=t.mintA.address===z.toBase58(),A=t.mintB.address===z.toBase58(),{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:b,tokenProgram:new Q((C=t.mintA.programId)!=null?C:Et),owner:this.scope.ownerPubKey,createInfo:P||!i?{payer:this.scope.ownerPubKey,amount:i?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:P,skipCloseAccount:!P,associatedOnly:P?!1:y,checkCreateATAOwner:p});I&&f.addInstruction(I);let{account:T,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:g,tokenProgram:new Q((x=t.mintB.programId)!=null?x:Et),owner:this.scope.ownerPubKey,createInfo:A||i?{payer:this.scope.ownerPubKey,amount:i?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:A,skipCloseAccount:!A,associatedOnly:A?!1:y,checkCreateATAOwner:p});S&&f.addInstruction(S),(!h||!T)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:h,mintBTokenAcc:T,mintAUseSOLBalance:P,mintBUseSOLBalance:A,associatedOnly:y});let B=n!=null?n:await this.getCpmmPoolKeys(t.id);return f.addInstruction({instructions:[r?Au(new Q(t.programId),this.scope.ownerPubKey,new Q(B.authority),new Q(B.config.id),new Q(t.id),i?h:T,i?T:h,new Q(B.vault[i?"A":"B"]),new Q(B.vault[i?"B":"A"]),new Q((N=t[i?"mintA":"mintB"].programId)!=null?N:Et),new Q((Z=t[i?"mintB":"mintA"].programId)!=null?Z:Et),i?b:g,i?g:b,Co(new Q(t.programId),new Q(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):Ro(new Q(t.programId),this.scope.ownerPubKey,new Q(B.authority),new Q(B.config.id),new Q(t.id),i?h:T,i?T:h,new Q(B.vault[i?"A":"B"]),new Q(B.vault[i?"B":"A"]),new Q((L=t[i?"mintA":"mintB"].programId)!=null?L:Et),new Q((W=t[i?"mintB":"mintA"].programId)!=null?W:Et),i?b:g,i?g:b,Co(new Q(t.programId),new Q(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[r?V.CpmmSwapBaseOut:V.ClmmSwapBaseIn]}),f.addCustomComputeBudget(l),f.versionBuild({txVersion:m})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:i}){let r=n.toString()===e.mintB.address,s=Ko.swap(t,r?e.baseReserve:e.quoteReserve,r?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new O(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),u=s.destinationAmountSwapped.mul(new Se((1-i)*1e4)).div(new Se(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:u,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:i,slippage:r,epochInfo:s,baseIn:a}){var h,I,T,S,B,C,x,L,W;let u=1-Number(r.toSignificant())/100,c=new Se(new O(i).mul(10**e[a?"mintA":"mintB"].decimals).mul(u).toFixed(0)),l=ye(c,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),m=c.sub((h=l.fee)!=null?h:new Se(0)),d=new Se(new O(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,O.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",c.toString(),"amountInFee:",(T=(I=l.fee)==null?void 0:I.toString())!=null?T:0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${r.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let y=m.mul(d).div(p==="base"?t:n),f={amount:ct,fee:void 0,expirationTime:void 0};if(!m.isZero()){let N=cd(y,t,n,d);this.logDebug("lpAmountData:",{amountA:N.amountA.toString(),amountB:N.amountB.toString()}),f=ye(N[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new ve(new Se(1)).add(r),g=new ve(new Se(1)).sub(r),P=ye(b.mul(f.amount.sub((S=f.fee)!=null?S:new Se(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),A=ye(g.mul(f.amount.sub((B=f.fee)!=null?B:new Se(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",(x=(C=f.fee)==null?void 0:C.toString())!=null?x:0,"maxAnotherAmount:",P.amount.toString(),"maxAnotherAmountFee:",(W=(L=P.fee)==null?void 0:L.toString())!=null?W:0),{inputAmountFee:l,anotherAmount:f,maxAnotherAmount:P,minAnotherAmount:A,liquidity:y}}};function cd(o,e,t,n){let i=o.mul(e).div(n);!i.isZero()&&!o.mul(e).mod(n).isZero()&&(i=i.add(new Se(1)));let r=o.mul(t).div(n);return!r.isZero()&&!o.mul(t).mod(n).isZero()&&(r=r.add(new Se(1))),{amountA:i,amountB:r}}import{PublicKey as fn}from"@solana/web3.js";import{createTransferInstruction as xu,TOKEN_PROGRAM_ID as Ke,TOKEN_2022_PROGRAM_ID as _o}from"@solana/spl-token";import vo from"bn.js";var hu={[sr.toBase58()]:3},ku={3:sr};var ts=E([be(5),be(8),K("ownAddress"),w("vaultSignerNonce"),K("baseMint"),K("quoteMint"),K("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),K("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),K("requestQueue"),K("eventQueue"),K("bids"),K("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),be(7)]),Tu={3:ts};import{PublicKey as Iu}from"@solana/web3.js";var No=se("Serum"),Mo=class{static getProgramId(e){let t=ku[e];return t||No.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=hu[t];return n||No.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Tu[e];return t||No.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],i=0,r;for(;i<100;){try{let s=n.concat(Buffer.from([i]),Buffer.alloc(7));r=Iu.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;i++;continue}return{publicKey:r,nonce:i}}return No.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Iu.default,nonce:i}}};import{PublicKey as ee,SystemProgram as ld,TransactionInstruction as md}from"@solana/web3.js";import pn from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as dd,TOKEN_2022_PROGRAM_ID as pd,TOKEN_PROGRAM_ID as fd}from"@solana/spl-token";function yd(o,e,t,n,i,r,s,a,u,c,l,m,d,p,y){var T;let f=[],b=[k({pubkey:fd,isWritable:!1}),k({pubkey:pd,isWritable:!1}),k({pubkey:dd,isWritable:!1}),k({pubkey:ld.programId,isWritable:!1}),k({pubkey:e,isSigner:!0})];b.push(k({pubkey:t})),b.push(k({pubkey:i}));let g=[u,c],P=[l,m],A=[r,s,a];for(let S=0;S<g.length;S++){let B=g[S],C=A[S]===B.mintA.address;if(b.push(k({pubkey:new ee(B.programId),isWritable:!1})),S===g.length-1?b.push(k({pubkey:i})):b.push(k({pubkey:n})),b.push(k({pubkey:new ee(A[S])})),b.push(k({pubkey:new ee(A[S+1])})),B.version===6){let x=P[S];b.push(k({pubkey:new ee(x.config.id)})),b.push(k({pubkey:new ee(x.id)})),b.push(k({pubkey:new ee(C?x.vault.A:x.vault.B)})),b.push(k({pubkey:new ee(C?x.vault.B:x.vault.A)})),b.push(k({pubkey:new ee(B.observationId)})),b.push(k({pubkey:kn})),b.push(k({pubkey:nt(new ee(B.programId),new ee(B.id)).publicKey})),f.push(bd(B.sqrtPriceX64.toString(),C));for(let L of(T=y[S])!=null?T:[])b.push(k({pubkey:new ee(L)}))}else if(B.version===5){let x=P[S];b.push(k({pubkey:new ee(x.id)})),b.push(k({pubkey:new ee(x.authority),isWritable:!1})),b.push(k({pubkey:new ee(x.marketProgramId)})),b.push(k({pubkey:new ee(x.marketAuthority)})),b.push(k({pubkey:zs,isWritable:!1})),b.push(k({pubkey:new ee(x.openOrders)})),b.push(k({pubkey:new ee(x.vault.A)})),b.push(k({pubkey:new ee(x.vault.B)})),b.push(k({pubkey:new ee(x.id)})),b.push(k({pubkey:new ee(x.id)})),b.push(k({pubkey:new ee(x.id)})),b.push(k({pubkey:new ee(x.id)})),b.push(k({pubkey:new ee(x.id)})),b.push(k({pubkey:new ee(x.id)})),b.push(k({pubkey:new ee(x.marketId)})),b.push(k({pubkey:new ee(x.marketBids)})),b.push(k({pubkey:new ee(x.marketAsks)})),b.push(k({pubkey:new ee(x.marketEventQueue)})),b.push(k({pubkey:new ee(x.marketBaseVault)})),b.push(k({pubkey:new ee(x.marketQuoteVault)}))}else if(B.version===4){let x=P[S],L=B.status!==1;b.push(k({pubkey:new ee(x.id)})),b.push(k({pubkey:new ee(x.authority),isWritable:!1})),b.push(k({pubkey:new ee(L?x.id:x.marketProgramId)})),b.push(k({pubkey:new ee(L?x.id:x.marketAuthority)})),b.push(k({pubkey:new ee(L?x.id:x.openOrders)})),b.push(k({pubkey:new ee(x.vault.A)})),b.push(k({pubkey:new ee(x.vault.B)})),b.push(k({pubkey:new ee(L?x.id:x.marketId)})),b.push(k({pubkey:new ee(L?x.id:x.marketBids)})),b.push(k({pubkey:new ee(L?x.id:x.marketAsks)})),b.push(k({pubkey:new ee(L?x.id:x.marketEventQueue)})),b.push(k({pubkey:new ee(L?x.id:x.marketBaseVault)})),b.push(k({pubkey:new ee(L?x.id:x.marketQuoteVault)}))}else if(B.version===7){let x=P[S];b.push(k({pubkey:new ee(x.authority)})),b.push(k({pubkey:new ee(x.config.id)})),b.push(k({pubkey:new ee(x.id)})),b.push(k({pubkey:new ee(C?x.vault.A:x.vault.B)})),b.push(k({pubkey:new ee(C?x.vault.B:x.vault.A)})),b.push(k({pubkey:new ee(B.observationId)}))}else throw Error("pool type error")}let h=E([U("insId"),w("amountIn"),w("amountOut"),X($(),f.length,"clmmPriceLimit")]),I=Buffer.alloc(h.span);return h.encode({insId:0,amountIn:d,amountOut:p,clmmPriceLimit:f},I),new md({keys:b,programId:o,data:I})}function bd(o,e){if(o)if(e){let t=new pn(o).div(new pn(25));return t.gt(mo)?t:mo}else{let t=new pn(o).mul(new pn(25));return t.lt(po)?t:po}else return e?mo:po}function Bu({routeProgram:o,ownerInfo:e,inputMint:t,swapInfo:n}){var i,r,s,a,u,c,l;if(n.routeType==="amm")if(n.poolInfo[0].version===6){let m=n.poolKey[0],d=We(m),p=t.equals(d.mintA.address)?pt.add(st):ft.sub(st);return Ae.makeSwapBaseInInstructions({poolInfo:m,poolKeys:m,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:d.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:d.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub((r=(i=n.minAmountOut.fee)==null?void 0:i.raw)!=null?r:new pn(0)),sqrtPriceLimitX64:p,remainingAccounts:(s=n.remainingAccounts[0])!=null?s:[]})}else if(n.poolInfo[0].version===7){let m=n.poolInfo[0],d=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[Ro(m.programId,e.wallet,m.authority,m.configId,m.id,e.sourceToken,e.destinationToken,d?m.vaultA:m.vaultB,d?m.vaultB:m.vaultA,d?m.mintProgramA:m.mintProgramB,d?m.mintProgramB:m.mintProgramA,new ee(m[d?"mintA":"mintB"].address),new ee(m[d?"mintB":"mintA"].address),m.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[d?V.CpmmSwapBaseIn:V.CpmmSwapBaseOut],address:{}}}else{let m=n.poolKey[0];return{signers:[],instructions:[ho({poolKeys:m,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub((u=(a=n.minAmountOut.fee)==null?void 0:a.raw)!=null?u:new pn(0)),fixedSide:"in"})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?V.AmmV5SwapBaseIn:V.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let m=n.poolInfo[0],d=n.poolInfo[1],p=n.poolKey[0],y=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[yd(o,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),m,d,p,y,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub((l=(c=n.minAmountOut.fee)==null?void 0:c.raw)!=null?l:new pn(0)),n.remainingAccounts)],instructionTypes:[V.RouteSwap],lookupTableAddress:[p.lookupTableAccount,y.lookupTableAccount].filter(f=>f!==void 0),address:{}}}else throw Error("route type error")}var Ft=new vo(0),hi=class extends Ie{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(z));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:i=1}=e,r=await this.getWSolAccounts(),s=this.createTxBuilder();s.addCustomComputeBudget(e.computeBudgetConfig);let a=await Mt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:0});s.addInstruction(a);let u=j(t);for(let c=0;c<r.length;c++)u.gte(r[c].amount)?(s.addInstruction({instructions:[Nt({tokenAccount:r[c].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),u.sub(r[c].amount)):s.addInstruction({instructions:[Nt({tokenAccount:r[c].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return s.versionBuild({txVersion:i})}async wrapWSol(e,t,n){let i=this.createTxBuilder(),r=await Mt({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return i.addInstruction(r),i.versionBuild({txVersion:n!=null?n:1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:i,routeProgram:r,txVersion:s}){let a=this.createTxBuilder(),u=e.amountIn,c=e.amountOut,l=u.amount.token.mint.equals(z),m=c.amount.token.mint.equals(z),d=u.amount.token.mint,p=c.amount.token.mint,{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?_o:Ke,mint:d,notUseTokenAccount:l,owner:this.scope.ownerPubKey,skipCloseAccount:!l,createInfo:l?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:l?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(f&&a.addInstruction(f),y===void 0)throw Error("input account check error");let b;if(e.routeType==="route")b=this.scope.account.getAssociatedTokenAccount(p,c.amount.token.isToken2022?_o:Ke);else{let{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:c.amount.token.isToken2022?_o:Ke,mint:p,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});b=h,I&&a.addInstruction(I)}m&&a.addInstruction({endInstructions:[Nt({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:b,programId:Ke})],endInstructionTypes:[V.CloseAccount]});let g;if(e.routeType==="route"){let h=e.middleToken;g=this.scope.account.getAssociatedTokenAccount(h.mint,h.isToken2022?_o:Ke)}let P=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),A=Bu({routeProgram:r,inputMint:d,swapInfo:F(R({},e),{poolInfo:[...e.poolInfoList],poolKey:P,outputMint:p}),ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:y,routeToken:g,destinationToken:b}});if(e.feeConfig!==void 0){let h=this.createTxBuilder();h.addInstruction({instructions:[xu(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]}),h.addInstruction(A);let{transactions:I}=s===0?await h.sizeCheckBuildV0():await h.sizeCheckBuild();I.length<2&&a.addInstruction({instructions:[xu(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]})}return a.addInstruction(A),s===0?a.sizeCheckBuildV0({computeBudgetConfig:i,address:A.address}):a.sizeCheckBuild({computeBudgetConfig:i,address:A.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Xs,clmm:n=Xi,cpmm:i=Qs}=e||{},r=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:Po.offsetOf("baseMint"),length:64}}),s=E([K("baseMint"),K("quoteMint")]),a=r.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),u=E([K("mintA"),K("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:un.span}],dataSlice:{offset:un.offsetOf("mintA"),length:64}})).map(p=>{let y=u.decode(p.account.data);return{id:p.pubkey,version:6,mintA:y.mintA,mintB:y.mintB}}),d=(await this.scope.connection.getProgramAccounts(i,{dataSlice:{offset:Lo.offsetOf("mintA"),length:64}})).map(p=>{let y=u.decode(p.account.data);return{id:p.pubkey,version:7,mintA:y.mintA,mintB:y.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:d}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:i,cpmmPools:r}){e=e.toString()===fn.default.toString()?z:e,t=t.toString()===fn.default.toString()?z:t;let s={},a={},u={},c=[],l={};for(let d of n!=null?n:[]){if((d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(c.push(d),a[d.id.toString()]=d),d.mintA.equals(e)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintB.equals(e)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintA.equals(t)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[p].out.push(d)}if(d.mintB.equals(t)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[p].out.push(d)}}let m=[];for(let d of i)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(c.push(d),s[d.id.toBase58()]=d,m.push(d)),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of r)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(c.push(d),u[d.id.toBase58()]=d),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:Ke,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of Object.keys(l)){if(l[d].in.length===1&&l[d].out.length===1&&l[d].in[0].id.equals(l[d].out[0].id)){delete l[d];continue}if(l[d].in.length===0||l[d].out.length===0){delete l[d];continue}let p=l[d];for(let y of p.in)for(let f of p.out)y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&u[y.id.toString()]===void 0?u[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y),f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&u[f.id.toString()]===void 0?u[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f)}return{directPath:c,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(u)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let i=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let r=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),s=To(r),a={};Object.values(s).forEach(f=>{i.delete(f.mintA.address),a[f.mintA.address]={address:new fn(f.mintA.address),programId:Ke,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},i.delete(f.mintB.address),a[f.mintB.address]={address:new fn(f.mintB.address),programId:Ke,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let u=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(u).forEach(f=>{let[b,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(Ke)?(i.delete(b),a[b]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(b),f.mintProgramB.equals(Ke)?(i.delete(g),a[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):i.add(g)}),console.log("fetching mints info, total: ",i.size);let c=await An({connection:this.scope.connection,mints:Array.from(i).map(f=>new fn(f))});a=R(R({},a),c);let l=this.scope.cpmm.toComputePoolInfos({pools:u,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:d,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:a}),y=Object.keys(e.routePathDict).reduce((f,b)=>F(R({},f),{[b]:F(R({},e.routePathDict[b]),{mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()])})}),{});return{mintInfos:a,ammPoolsRpcInfo:r,ammSimulateCache:s,clmmPoolsRpcInfo:m,computeClmmPoolInfo:d,computePoolTickData:p,computeCpmmData:l,routePathDict:y}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:i,simulateCache:r,tickCache:s,slippage:a,chainTime:u,epochInfo:c,feeConfig:l}){var g,P,A,h,I,T,S,B,C;let m=l===void 0?new vo(0):e.raw.mul(new vo(l.feeBps.toNumber())).div(new vo(1e4)),d=e.raw.sub(m),p=new fe(e.token,d),y=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},f=F(R({},t),{address:ot(t.address).toString()}),b=[];for(let x of n)try{b.push(F(R({},this.computeAmountOut({itemPool:x,tickCache:s,simulateCache:r,chainTime:u,epochInfo:c,slippage:a,outputToken:f,amountIn:p})),{feeConfig:y}))}catch(L){this.logDebug("direct error",x.version,x.id.toString(),L.message)}this.logDebug("direct done");for(let[x,L]of Object.entries(i)){let W={chainId:101,address:x,programId:L.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:L.mDecimals,tags:[],extensions:{}},N=L.in.map(G=>{try{return{pool:G,data:this.computeAmountOut({itemPool:G,tickCache:s,simulateCache:r,chainTime:u,epochInfo:c,slippage:a,outputToken:W,amountIn:p})}}catch(D){this.logDebug("route in error",G.version,G.id.toString(),D.message);return}}).sort((G,D)=>{var nn,Dt,gn,Wt;let je=G===void 0?Ft:G.data.amountOut.amount.raw.sub((Dt=(nn=G.data.amountOut.fee)==null?void 0:nn.raw)!=null?Dt:Ft),bn=D===void 0?Ft:D.data.amountOut.amount.raw.sub((Wt=(gn=D.data.amountOut.fee)==null?void 0:gn.raw)!=null?Wt:Ft);return je.lt(bn)?1:-1})[0];if(N===void 0)continue;let Z=new fe(wo(W),N.data.amountOut.amount.raw.sub((P=(g=N.data.amountOut.fee)==null?void 0:g.raw)!=null?P:Ft));for(let G of L.out)try{let D=this.computeAmountOut({itemPool:G,tickCache:s,simulateCache:r,chainTime:u,epochInfo:c,slippage:a,outputToken:f,amountIn:Z});b.push(F(R({},D),{allTrade:!!(N.data.allTrade&&D.allTrade),amountIn:N.data.amountIn,amountOut:D.amountOut,minAmountOut:D.minAmountOut,currentPrice:void 0,executionPrice:new O(new Je({baseToken:N.data.amountIn.amount.token,denominator:N.data.amountIn.amount.raw,quoteToken:D.amountOut.amount.token,numerator:D.amountOut.amount.raw.sub((h=(A=D.amountOut.fee)==null?void 0:A.raw)!=null?h:Ft)}).toFixed()),priceImpact:new O(N.data.priceImpact.add(D.priceImpact).toFixed()),fee:[N.data.fee[0],D.fee[0]],routeType:"route",poolInfoList:[N.pool,G],remainingAccounts:[N.data.remainingAccounts[0],D.remainingAccounts[0]],minMiddleAmountFee:(I=D.amountOut.fee)!=null&&I.raw?new fe(N.data.amountOut.amount.token,((S=(T=N.data.amountOut.fee)==null?void 0:T.raw)!=null?S:Ft).add((C=(B=D.amountOut.fee)==null?void 0:B.raw)!=null?C:Ft)):void 0,middleToken:N.data.amountOut.amount.token,poolReady:N.data.poolReady&&D.poolReady,poolType:[N.data.poolType,D.poolType],feeConfig:y,expirationTime:kt(N.data.expirationTime,D.expirationTime)}))}catch(D){this.logDebug("route out error",G.version,G.id.toString(),D.message)}}return b.filter(x=>(x.allTrade||this.logDebug(`pool ${x.poolInfoList.map(L=>L.id.toString()).join(",")} filter out since not all trade`),x.allTrade)).sort((x,L)=>x.amountOut.amount.raw.sub(L.amountOut.amount.raw).gt(Ft)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:i,epochInfo:r,slippage:s,outputToken:a,amountIn:u}){if(e.version===6){let{allTrade:c,realAmountIn:l,amountOut:m,minAmountOut:d,expirationTime:p,currentPrice:y,executionPrice:f,priceImpact:b,fee:g,remainingAccounts:P,executionPriceX64:A}=xe.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:u.raw,tokenOut:a,slippage:s,epochInfo:r,catchLiquidityInsufficient:!0});return{allTrade:c,amountIn:l,amountOut:m,minAmountOut:d,currentPrice:new O(y.toFixed()),executionPrice:new O(f.toFixed()),priceImpact:new O(b.toFixed()),fee:[g],remainingAccounts:[P],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<i,poolType:"CLMM",slippage:s,clmmExPriceX64:[A],expirationTime:kt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:c,executionPrice:l,amountOut:m,minAmountOut:d,priceImpact:p,fee:y}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:u.raw,slippage:s});return{allTrade:c,amountIn:{amount:u,fee:void 0,expirationTime:void 0},amountOut:{amount:di(F(R({},a),{amount:m})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:di(F(R({},a),{amount:d})),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new fe(u.token,y)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<i,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:c,minAmountOut:l,currentPrice:m,executionPrice:d,priceImpact:p,fee:y}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:u.raw,mintIn:u.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:u,fee:void 0,expirationTime:void 0},amountOut:{amount:di(F(R({},a),{amount:c})),fee:void 0,expirationTime:void 0},minAmountOut:{amount:di(F(R({},a),{amount:l})),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:d,priceImpact:p,fee:[new fe(u.token,y)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<i,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let i=new Set(e.filter(c=>c.version===6&&!t[c.id.toString()]).map(c=>c.id.toString()));if(i.size>0){let c=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(i)});Object.keys(c).forEach(l=>{t[l]=c[l]})}if(new Set(e.filter(c=>c.version===4&&!n[c.id.toString()]).map(c=>c.id.toString())).size>0){let c=await this.scope.liquidity.getRpcPoolInfos(Array.from(i));Object.keys(c).forEach(l=>{n[l]=c[l]})}let s=new Set(e.filter(c=>c.version===4).map(c=>c.marketId)),a={};s.size>0&&(await _e(this.scope.connection,Array.from(s).map(l=>({pubkey:new fn(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=ts.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:Mo.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let u=[];return e.forEach(c=>{if(c.version===6){let l=t[c.id.toString()],m={programId:c.programId.toBase58(),id:c.id.toBase58(),mintA:c.mintA,mintB:c.mintB,openTime:String(c.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:F(R({},c.ammConfig),{id:c.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}),rewardInfos:[]};u.push(m)}else if(c.version===4){let l=n[c.id.toString()],m=R({programId:c.programId,id:c.id,mintA:c.mintA,mintB:c.mintB,openTime:String(c.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:Hr({programId:new fn(c.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:c.lpMint},a[c.marketId]);u.push(m)}else c.version===7&&u.push({programId:c.programId.toBase58(),id:c.id.toBase58(),mintA:c.mintA,mintB:c.mintB,openTime:String(c.openTime),authority:Mn(c.programId).publicKey.toBase58(),vault:{A:c.vaultA.toBase58(),B:c.vaultB.toBase58()},mintLp:Ze({address:c.mintLp.toBase58(),programId:Ke.toBase58(),decimals:c.lpDecimals}),config:F(R({id:c.configId.toBase58()},c.configInfo),{protocolFeeRate:c.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:c.configInfo.tradeFeeRate.toNumber(),fundFeeRate:c.configInfo.fundFeeRate.toNumber(),createPoolFee:c.configInfo.createPoolFee.toString()})})}),u}};import{PublicKey as gd,Transaction as ns,TransactionInstruction as wd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ad}from"@solana/spl-token";import Su from"bn.js";var Ye=class extends Ie{static getPdaPoolId(e,t){return ce([Ye.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,i){return ce([Ye.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Su(i).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:i,chainTime:r}){if(n.length===0)return[];let s=n.map(l=>Ye.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<Ye.VERSION_PROJECT.length;l++)a.push(...s.map(m=>Ye.getPdaOwnerId(t,m,i,l).publicKey));let u=await bt(e,[...s,...a]),c=[];for(let l=0;l<u.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],y=a[l],f=u[d],b=u[n.length+l];if(!(f&&b)||f.data.length!==Ye.POOL_LAYOUT.span||b.data.length!==Ye.OWNER_LAYOUT.span)continue;let g=Ye.POOL_LAYOUT.decode(f.data),P=Ye.OWNER_LAYOUT.decode(b.data),A=g.openTime.toNumber(),h=g.endTime.toNumber(),I=P.tokenInfo.map(B=>B.debtAmount.gt(new Su(0))).filter(B=>!B).length!==3,T=r>A&&r<h&&g.status===1,S=I&&T;c.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:y,snapshotLpAmount:P.lpAmount,project:Ye.VERSION_PROJECT[m],openTime:A,endTime:h,canClaim:S,canClaimErrorType:I?T?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((B,C)=>({mintAddress:B.mintAddress,mintVault:B.mintVault,mintDecimals:B.mintDecimals,perLpLoss:B.perLpLoss,debtAmount:P.tokenInfo[C].debtAmount.add(P.tokenInfo[C].claimedAmount)}))})}return c}async makeClaimTransaction({poolInfo:e,ownerInfo:t}){t.wallet||this.scope.checkOwner();let n=this.createTxBuilder(),i=t.wallet||this.scope.ownerPubKey,r=[];for(let u of e.tokenInfo){let{account:c,instructionParams:l}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Te.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!u.mintAddress.equals(Te.WSOL.mint),associatedOnly:u.mintAddress.equals(Te.WSOL.mint)?!1:t.associatedOnly});l&&n.addInstruction(l),r.push(c)}n.addInstruction({instructions:[Ye.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:i,ownerPda:e.ownerAccountId,claimAddress:r}})]});let{transaction:s,signers:a}=n.build();return[{transaction:s,signer:a}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t}){let n=this.createTxBuilder(),i=t.wallet||this.scope.ownerPubKey,r={};for(let c of e){let l=[];for(let m of c.tokenInfo){let{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(Te.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!m.mintAddress.equals(Te.WSOL.mint),associatedOnly:m.mintAddress.equals(Te.WSOL.mint)?!1:t.associatedOnly});p&&n.addInstruction(p),d&&(r[m.mintAddress.toString()]=d,l.push(d))}n.addInstruction({instructions:[Ye.makeClaimInstruction({programId:c.programId,poolInfo:c,ownerInfo:{wallet:i,ownerPda:c.ownerAccountId,claimAddress:l}})]})}let{transaction:s,signers:a}=n.build(),u=n.allInstructions;return rr(u,[i,...a.map(c=>c.publicKey)])?[{transaction:s,signer:a}]:[{transaction:new ns().add(...u.slice(0,n.AllTxData.instructions.length-1)),signer:a},{transaction:new ns().add(...u.slice(n.AllTxData.instructions.length-1)),signer:[]},{transaction:new ns().add(...n.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let i=E([]),r=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(u=>({pubkey:u,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:u})=>({pubkey:u,isSigner:!1,isWritable:!0})),{pubkey:Ad,isSigner:!1,isWritable:!1}],s=Buffer.alloc(i.span);i.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new wd({keys:r,programId:e,data:a})}},yt=Ye;yt.CLAIMED_NUM=3,yt.POOL_LAYOUT=E([be(8),U("bump"),U("status"),w("openTime"),w("endTime"),K("ammId"),X(E([U("mintDecimals"),K("mintAddress"),K("mintVault"),w("perLpLoss"),w("totalClaimedAmount")]),Ye.CLAIMED_NUM,"tokenInfo"),X(w(),10,"padding")]),yt.OWNER_LAYOUT=E([be(8),U("bump"),U("version"),K("poolId"),K("owner"),w("lpAmount"),X(E([K("mintAddress"),w("debtAmount"),w("claimedAmount")]),Ye.CLAIMED_NUM,"tokenInfo"),X(w(),4,"padding")]),yt.DEFAULT_POOL_ID=["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new gd(e)),yt.SEED_CONFIG={pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}},yt.VERSION_PROJECT=[void 0,"Francium","Tulip","Larix"];import{PublicKey as ki}from"@solana/web3.js";import Ti from"bn.js";import{TOKEN_PROGRAM_ID as Ou}from"@solana/spl-token";import{SystemProgram as yn,SYSVAR_RENT_PUBKEY as hd,Transaction as Ku,TransactionInstruction as kd}from"@solana/web3.js";import{createInitializeAccountInstruction as Cu,TOKEN_PROGRAM_ID as Ru}from"@solana/spl-token";function Pd(o="accountFlags"){let e=new ro(o);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var is=E([be(5),Pd("accountFlags"),K("ownAddress"),w("vaultSignerNonce"),K("baseMint"),K("quoteMint"),K("baseVault"),w("baseDepositsTotal"),w("baseFeesAccrued"),K("quoteVault"),w("quoteDepositsTotal"),w("quoteFeesAccrued"),w("quoteDustThreshold"),K("requestQueue"),K("eventQueue"),K("bids"),K("asks"),w("baseLotSize"),w("quoteLotSize"),w("feeRateBps"),w("referrerRebatesAccrued"),be(7)]);function Td({programId:o,marketInfo:e}){let t=E([U("version"),Ge("instruction"),w("baseLotSize"),w("quoteLotSize"),Ot("feeRateBps"),w("vaultSignerNonce"),w("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:hd,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),i=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},i),new kd({keys:n,programId:o,data:i})}async function Lu({connection:o,wallet:e,marketInfo:t}){var s,a,u,c,l,m,d,p;let n=new Ku,i=await o.getMinimumBalanceForRentExemption(165);n.add(yn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:i,space:165,programId:Ru}),yn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:i,space:165,programId:Ru}),Cu(t.baseVault.publicKey,t.baseMint,t.vaultOwner),Cu(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner));let r=new Ku;return r.add(yn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await o.getMinimumBalanceForRentExemption(is.span),space:is.span,programId:t.programId}),yn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:await o.getMinimumBalanceForRentExemption((s=t.requestQueueSpace)!=null?s:5120+12),space:(a=t.requestQueueSpace)!=null?a:5120+12,programId:t.programId}),yn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:await o.getMinimumBalanceForRentExemption((u=t.eventQueueSpace)!=null?u:262144+12),space:(c=t.eventQueueSpace)!=null?c:262144+12,programId:t.programId}),yn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:await o.getMinimumBalanceForRentExemption((l=t.orderbookQueueSpace)!=null?l:65536+12),space:(m=t.orderbookQueueSpace)!=null?m:65536+12,programId:t.programId}),yn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:await o.getMinimumBalanceForRentExemption((d=t.orderbookQueueSpace)!=null?d:65536+12),space:(p=t.orderbookQueueSpace)!=null?p:65536+12,programId:t.programId}),Td({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.InitAccount,V.InitAccount]},{transaction:r,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.InitMarket]}]}var _n=class extends Ie{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:i,dexProgramId:r,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:u,txVersion:c,computeBudgetConfig:l}){let m=this.scope.ownerPubKey,d=et({fromPublicKey:m,programId:r}),p=et({fromPublicKey:m,programId:r}),y=et({fromPublicKey:m,programId:r}),f=et({fromPublicKey:m,programId:r}),b=et({fromPublicKey:m,programId:r}),g=et({fromPublicKey:m,programId:Ou}),P=et({fromPublicKey:m,programId:Ou}),A=0,h=new Ti(100);function I(){let W=new Ti(0);for(;;)try{return{vaultOwner:ki.createProgramAddressSync([d.publicKey.toBuffer(),W.toArrayLike(Buffer,"le",8)],r),vaultSignerNonce:W}}catch{if(W.iaddn(1),W.gt(new Ti(25555)))throw Error("find vault owner error")}}let{vaultOwner:T,vaultSignerNonce:S}=I(),B=new Ti(Math.round(10**e.decimals*n)),C=new Ti(Math.round(n*10**t.decimals*i));if(B.eq(ct))throw Error("lot size is too small");if(C.eq(ct))throw Error("tick size or lot size is too small");let x=await Lu({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:r,id:d,baseMint:e.mint,quoteMint:t.mint,baseVault:g,quoteVault:P,vaultOwner:T,requestQueue:p,eventQueue:y,bids:f,asks:b,feeRateBps:A,quoteDustThreshold:h,vaultSignerNonce:S,baseLotSize:B,quoteLotSize:C,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:u}}),L=this.createTxBuilder();L.addInstruction({instructions:x[0].transaction.instructions,signers:x[0].signer});for await(let W of x.slice(1,x.length))L.addInstruction({instructions:W.transaction.instructions,signers:W.signer,instructionTypes:W.instructionTypes});return c===0?L.sizeCheckBuildV0({computeBudgetConfig:l,address:{marketId:d.publicKey,requestQueue:p.publicKey,eventQueue:y.publicKey,bids:f.publicKey,asks:b.publicKey,baseVault:g.publicKey,quoteVault:P.publicKey,baseMint:new ki(e.mint),quoteMin:new ki(t.mint)}}):L.sizeCheckBuild({computeBudgetConfig:l,address:{marketId:d.publicKey,requestQueue:p.publicKey,eventQueue:y.publicKey,bids:f.publicKey,asks:b.publicKey,baseVault:g.publicKey,quoteVault:P.publicKey,baseMint:new ki(e.mint),quoteMin:new ki(t.mint)}})}};import{PublicKey as Bi}from"@solana/web3.js";import _u from"bn.js";import{SYSVAR_CLOCK_PUBKEY as Bd,TransactionInstruction as Nu}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Mu}from"@solana/spl-token";var Id=E([U("instruction"),ra("amount")]),Ii=E([U("instruction")]);function Vo({programId:o},e){let t=[{pubkey:Mu,isSigner:!1,isWritable:!1},{pubkey:Ns,isSigner:!1,isWritable:!1},...Object.entries(e).map(([i,r])=>({pubkey:r,isSigner:i==="userOwner",isWritable:!["authority","userOwner"].includes(i)}))],n=Buffer.alloc(Ii.span);return Ii.encode({instruction:2},n),new Nu({keys:t,programId:o,data:n})}function os(o){let{poolConfig:e,userKeys:t,side:n}=o,i=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,r=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Ii.span);Ii.encode({instruction:2},s);let a=[{pubkey:Mu,isWritable:!1,isSigner:!1},{pubkey:Bd,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:r,isWritable:!0,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new Nu({programId:e.programId,keys:a,data:s})}var xd={[Xn.IDO_PROGRAM_ID_V1.toString()]:1,[Xn.IDO_PROGRAM_ID_V2.toString()]:2,[Xn.IDO_PROGRAM_ID_V3.toString()]:3,[Xn.IDO_PROGRAM_ID_V4.toString()]:4},vn=class extends Ie{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:i=!1,txVersion:r}){let s=this.createTxBuilder(),a=xd[t.programId];a||this.logAndCreateError("invalid version",a);let u=We(t),[c,l]=[!new _u(e.coin).isZero(),!new _u(e.pc).isZero()],m=u.projectInfo.mint.address.equals(z),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:i});!d&&c&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),c&&p&&s.addInstruction(p);let y=u.buyInfo.mint.address.equals(z),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,notUseTokenAccount:y,associatedOnly:y?!1:n,checkCreateATAOwner:i});if(!d&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&b&&s.addInstruction(b),(!d||!f)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),a===3)return s.addInstruction({instructions:[...c?[Vo({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:d,userIdoInfo:new Bi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...l?[Vo({programId:new Bi(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:f,userIdoInfo:new Bi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:r});if(a<3)return!c&&!l&&this.logAndCreateError("no claimable rewards"),s.addInstruction({instructions:[Vo({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:f,userBaseTokenAccount:d,userIdoInfo:new Bi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:r});let g={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:d,quoteTokenAccount:f,ledgerAccount:new Bi(e.userIdoInfo),owner:this.scope.ownerPubKey}};return s.addInstruction({instructions:[...c?[os(F(R({},g),{side:"base"}))]:[],...l?[os(F(R({},g),{side:"quote"}))]:[]]}).versionBuild({txVersion:r})}};import{PublicKey as Sd}from"@solana/web3.js";import{MintLayout as Kd,TOKEN_2022_PROGRAM_ID as rs,TOKEN_PROGRAM_ID as ss}from"@solana/spl-token";var xi=class extends Ie{constructor(t){super(t);this._tokenList=[];this._tokenMap=new Map;this._blackTokenMap=new Map;this._mintGroup={official:new Set,jup:new Set,extra:new Set};this._whiteMap=new Set;this._extraTokenList=[]}async load(t){this.checkDisabled();let{forceUpdate:n=!1,type:i="strict"}=t||{},{mintList:r,blacklist:s,whiteList:a}=await this.scope.fetchV3TokenList(n),u=await this.scope.fetchJupTokenList(n);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Map,this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(a),this._tokenMap.set(Qt.address,Qt),this._mintGroup.official.add(Qt.address),s.forEach(c=>{this._blackTokenMap.set(c.address,F(R({},c),{priority:-1}))}),r.forEach(c=>{var l;this._blackTokenMap.has(c.address)||(this._tokenMap.set(c.address,F(R({},c),{type:"raydium",priority:2,programId:(l=c.programId)!=null?l:c.tags.includes("token-2022")?rs.toBase58():ss.toBase58()})),this._mintGroup.official.add(c.address))}),u.forEach(c=>{var l;this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,F(R({},c),{type:"jupiter",priority:1,programId:(l=c.programId)!=null?l:c.tags.includes("token-2022")?rs.toBase58():ss.toBase58(),tags:c.freezeAuthority?[...c.tags||[],"hasFreeze"]:c.tags})),this._mintGroup.jup.add(c.address))}),this._extraTokenList.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,F(R({},c),{type:"extra",priority:1,programId:c.programId||c.tags.includes("token-2022")?rs.toBase58():ss.toBase58()})),this._mintGroup.extra.add(c.address))}),this._tokenList=Array.from(this._tokenMap).map(c=>c[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(t){if(!t)throw new Error("please input mint");let n=t.toString(),i=this._tokenMap.get(n);if(i)return i;if(n.toLocaleUpperCase()==="SOL")return Qt;let r=(await this.scope.api.getTokenInfo([n]))[0];if(r)return this._mintGroup.extra.add(n),this._tokenMap.set(n,F(R({},r),{priority:2})),r;let s=await this.scope.connection.getAccountInfo(new Sd(n));if(!s)throw new Error(`mint address not found: ${n}`);let a=Kd.decode(s.data),u=n.toString().substring(0,6),c={chainId:101,address:n,programId:s.owner.toBase58(),logoURI:"",symbol:u,name:u,decimals:a.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(n),this._tokenMap.set(n,c),c}};var Eo=class{constructor(e){this.rawBalances=new Map;let{connection:t,cluster:n,owner:i,api:r,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:u,blockhashCommitment:c="confirmed"}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=i?new Pt(i):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=c,this.api=r,this._apiCacheTime=u||5*60*1e3,this.logger=se("Raydium"),this.farm=new ri({scope:this,moduleName:"Raydium_Farm"}),this.account=new $n({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new yi({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new xi({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new hi({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new bi({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new Pi({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new yt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new _n({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new vn({scope:this,moduleName:"Raydium_ido"}),this.availability={};let l=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:l,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){var l;let t=Cd({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:i,logCount:r,logRequests:s,urlConfigs:a}=t,u=new Ji({cluster:n,timeout:i,urlConfigs:a,logCount:r,logRequests:s}),c=new Eo(F(R({},t),{api:u}));return await c.fetchAvailabilityStatus((l=e.disableFeatureCheck)!=null?l:!0),e.disableLoadToken||await c.token.load({type:e.jupTokenType}),c}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(eo);return this._owner.publicKey}setOwner(e){return this._owner=e?new Pt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(Zs);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw this.logger.error(eo),new Error(eo)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(i=>F(R({},i),{mintAuthority:i.mint_authority||void 0,freezeAuthority:i.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){var e;return(e=this._chainTime)==null?void 0:e.value}async chainTimeOffset(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.offset)||0)}async currentBlockChainTime(){var e;return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),((e=this._chainTime)==null?void 0:e.value.chainTime)||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};export{Eo as Raydium};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=raydium.mjs.map